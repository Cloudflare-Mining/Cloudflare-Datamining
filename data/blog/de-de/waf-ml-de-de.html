<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/03/image5-1.png" class="kg-image" alt="Improving the WAF with Machine Learning"></figure>
	<p>Cloudflare verarbeitet 32 Millionen HTTP-Anfragen pro Sekunde und wird von mehr als 22 % aller Websites genutzt, deren Webserver <a href="https://w3techs.com/technologies/details/ws-cloudflare" target="_blank">W3Techs</a> bekannt ist. Cloudflare ist in der einzigartigen Lage, den Datenverkehr jeder fünften Internetwebsite zu schützen. Dies ermöglicht es Cloudflare, Bedrohungen zu erkennen, sobald sie auftreten, und zu verfolgen, wie sie sich entwickeln und modifizieren. </p>
	<p>Die Web Application Firewall (WAF) ist das Herzstück der Sicherheits-Toolbox von Cloudflare. Managed Rules sind eine wichtige Funktion der <a href="https://www.cloudflare.com/de-de/learning/ddos/glossary/web-application-firewall-waf/" target="_blank">WAF</a>. Es handelt sich dabei um eine Sammlung von Regeln, die vom Analystenteam von Cloudflare erstellt wurden und die Anfragen blockieren, wenn sie Muster bekannter Angriffe aufweisen. Diese verwalteten Regeln funktionieren hervorragend bei Mustern bekannter Angriffsvektoren, da sie ausgiebig getestet wurden, um sowohl falsch-negative (Übersehen eines Angriffs) als auch falsch-positive (Ermittlung eines Angriffs, obwohl es keinen gibt) zu minimieren. Der Nachteil ist, dass verwaltete Regeln oft Angriffsvariationen (auch bekannt als Bypässe) übersehen, da statische Regex-basierte Regeln von Natur aus empfindlich auf Signaturvariationen reagieren, die z.B. durch Fuzzing-Techniken eingeführt werden. </p>
	<p>Dieses Problem haben wir bei der Veröffentlichung von <a href="https://blog.cloudflare.com/de-de/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns-de-de/">Schutzmechanismen für log4j</a> erlebt. Einige Tage lang, nachdem die Schwachstelle bekannt wurde, mussten wir die Regeln ständig aktualisieren, um Variationen und Mutationen anzupassen, da Angreifer versuchten, die WAF zu umgehen. Außerdem erfordert die Optimierung der Regeln ein erhebliches menschliches Eingreifen und funktioniert in der Regel erst, nachdem Umgehungen identifiziert oder sogar ausgenutzt wurden. Damit ist der Schutz eher reaktiv als proaktiv. </p>
	<p>Heute freuen wir uns, verwaltete Regelsätze (Managed Rulesets; wie OWASP und Cloudflare Managed) durch ein neues Tool zu ergänzen. Dieses Tool soll Umgehungen und bösartige Nutzdaten ohne menschliches Zutun identifizieren, bevor sie ausgenutzt werden. Kunden können jetzt auf Signale eines Machine-Learning-basierten Modells zugreifen. Dieses Modell wurde auf der Grundlage der Klassifizierung von gutem/schädlichem Datenverkehr durch verwaltete Regeln und erweiterte Daten trainiert. Ziel ist es, einen besseren Schutz für ein breiteres Spektrum an alten und neuen Angriffsarten zu bieten. </p>
	<p>Freuen Sie sich jetzt auf unsere neue Machine Learning-basierte WAF-Erkennung. </p>
	<p>Die neue Erkennung ist im frühen Zugang (Early Access) für Enterprise-, Pro- und Biz-Kunden verfügbar. Bitte <a href="https://jira.cfops.it/browse/MOE-4523" target="_blank">tragen Sie sich in die Warteliste ein</a>, wenn Sie sie testen möchten. Langfristig wird sie für die Kunden der höheren Tarifstufen verfügbar sein.</p>
	<h1 id="die-erste-selbstlernende-waf">Die erste selbstlernende WAF</h1>
	<p>Das neue Erkennungssystem ergänzt die bestehenden verwalteten Regelsätze, indem es drei wesentliche Vorteile bietet:</p>
	<ol>
		<li>Es läuft über Ihren gesamten Traffic. Jede Anfrage wird nach der Wahrscheinlichkeit bewertet, dass sie z.B. einen SQLi- oder XSS-Angriff enthält. Damit bietet WAF-Analytics ab sofort ein noch besseres Nutzererlebnis. Sie können nun Trends und Muster in Ihrem gesamten Datenverkehr erkunden.</li>
		<li>Die Erkennungsrate verbessert sich aufgrund des vergangenen Datenverkehrs und des Feedbacks. Das Modell wird mit gutem und schädlichem Datenverkehr trainiert, der durch verwaltete Regeln für den gesamten Cloudflare-Traffic kategorisiert wird. So können kleine Websites den gleichen Schutz erhalten wie die größten Internetwebsites.</li>
		<li>Performance neu definiert. Die Machine Learning-Engine identifiziert Umgehungen und Anomalien, bevor sie von menschlichen Forschern ausgenutzt oder identifiziert werden. </li>
	</ol>
	<p>Das Geheimnis ist eine Kombination aus zahlreichen, leistungsstarken Elementen. Dies umfasst innovative Modellierung mittels maschinellem Lernen und einen riesigen Bestand an Trainingsdaten, der auf den Angriffen basiert, die wir täglich abwehren. Weitere Elemente sind Techniken zur Datenerweiterung, das richtige Bewertungs- und Test-Framework, das auf dem Prinzip des Verhaltenstests basiert, und modernster Technik, die es uns ermöglicht, jede Anfrage mit vernachlässigbarer Latenzzeit zu bewerten.</p>
	<h1 id="ein-neues-waf-erlebnis">Ein neues WAF-Erlebnis</h1>
	<p>Die neue Erkennung basiert auf dem Paradigma, das mit <a href="https://blog.cloudflare.com/introducing-bot-analytics/">Bot Analytics</a> eingeführt wurde. Diesem Ansatz folgend wird jede Anfrage bewertet und eine Punktzahl zugewiesen, unabhängig davon, ob wir Maßnahmen ergreifen. Da wir jede Anfrage bewerten, können die Benutzer sehen, wie sich die Bewertung im Laufe der Zeit für den gesamten an ihren Server gerichteten Datenverkehr entwickelt.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2022/03/image3-11.png" class="kg-image" alt="Customers can use the machine learning categorization engine to identify trends in their traffic.">
		<figcaption>Kunden können die Engine zur Kategorisierung durch maschinelles Lernen nutzen, um Trends in ihrem Datenverkehr zu erkennen.</figcaption>
	</figure>
	<p>Darüber hinaus können Benutzer das Histogramm der Bewertung von Anfragen für einen bestimmten Angriffsvektor (z. B. SQLi) visualisieren. So finden Sie heraus, welcher Wert ein guter Wert ist, um guten von schädlichem Datenverkehr zu unterscheiden. </p>
	<p>Die eigentliche Abwehr erfolgt über benutzerdefinierte WAF-Regeln, bei denen anhand des Scores entschieden wird, welche Anfragen blockiert werden sollen. Damit können Kunden Regeln erstellen, deren Logik jeden Parameter der HTTP-Anfragen umfasst, einschließlich der dynamischen Felder, die von Cloudflare ausgefüllt werden, wie z.B. Bot-Scores.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2022/03/image2-29.png" class="kg-image" alt="Firewall rule built on waf ml score.">
		<figcaption>Firewall-Regel auf Basis des WAF ML-Score.</figcaption>
	</figure>
	<p>Wir prüfen nun, ob wir diesen Ansatz auch für die verwalteten Regeln (OWASP und Cloudflare Managed) anwenden können. Kunden werden in der Lage sein, Trends zu erkennen und Regeln auf der Grundlage von Mustern zu erstellen, die bei der Betrachtung des gesamten Datenverkehrs sichtbar werden. Anstatt Regeln auf der Grundlage von Versuch und Irrtum zu erstellen, protokollieren Sie den Datenverkehr, um sie zu validieren und schließlich den Schutz durchzusetzen.</p>
	<h1 id="wie-funktioniert-s">Wie funktioniert's?</h1>
	<p>Auf maschinellem Lernen basierende Erkennungen ergänzen die bestehenden verwalteten Regelsätze, wie OWASP und Cloudflare Managed. Das System basiert auf Modellen, die entwickelt wurden, um Variationen von Angriffsmustern und Anomalien zu erkennen, ohne dass die Forscher oder der Endbenutzer dies direkt überwachen müssen. </p>
	<p>Ab heute stellen wir Scores für zwei Angriffsvektoren zur Verfügung: SQL-Injection und Cross Site Scripting. Benutzer können benutzerdefinierte WAF/Firewall-Regeln mit drei separaten Scores erstellen: einen Gesamtscore (cf.waf.ml.score), einen für SQLi und einen für XSS (cf.waf.ml.score.sqlibzw. cf.waf.ml.score.xss,). Die Scores können Werte zwischen 1 und 99 annehmen, wobei 1 definitiv bösartig ist und 99 für zulässigen Datenverkehr steht.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2022/03/image4-1.png" class="kg-image" alt="Histogram of the score across all traffic hitting an application.">
		<figcaption>Histogramm des Scores für den gesamten Traffic, der auf eine Anwendung trifft.</figcaption>
	</figure>
	<p>Das Modell wird dann auf der Grundlage des von den bestehenden WAF-Regeln klassifizierten Datenverkehrs trainiert und arbeitet mit einer transformierten Version der ursprünglichen Anfrage. Dadurch können die Fingerprints von Angriffen einfacher identifiziert werden. </p>
	<p>Für jede Anfrage bewertet das Modell jeden Teil der Anfrage unabhängig voneinander. So lässt sich feststellen, wo bösartige Nutzdaten identifiziert wurden, z. B. im Textkörper der Anfrage, im URI oder in den Kopfzeilen.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2022/03/image1-30.png" class="kg-image" alt="The detection engine provides a breakdown of where the threats were found (for example, body, URI, headers).">
		<figcaption>Die Detection Engine liefert eine Aufschlüsselung, wo die Bedrohungen gefunden wurden (z.B. Body, URI, Header).</figcaption>
	</figure>
	<p>In der Theorie hört sich das sehr einfach an. Aber es gibt eine Reihe von Herausforderungen, die die Entwickler von Cloudflare lösen mussten, um dieses Ziel zu erreichen. Dazu gehören der Aufbau eines zuverlässigen Datensatzes, eine skalierbare Datenkennzeichnung, die Auswahl der richtigen Modellarchitektur und die Anforderung, die Kategorisierung bei <em>jeder</em> Anfrage auszuführen, die über das globale Netzwerk von Cloudflare verarbeitet wird (d. h. 32 Millionen Mal pro Sekunde). </p>
	<p>In den kommenden Wochen wird das Engineering-Team eine Reihe von Blog-Beiträgen veröffentlichen, die ein besseres Verständnis dafür vermitteln, wie die Lösungim Detailfunktioniert.</p>
	<h1 id="der-blick-nach-vorn">Der Blick nach vorn</h1>
	<p>In den kommenden Monaten werden wir unseren Kunden die neue Detection Engine zugänglich machen und ihr Feedback zur Performance einholen. Langfristig planen wir, die Detection Engine so zu erweitern, dass sie alle Angriffsvektoren abdeckt, die bereits durch verwaltete Regeln identifiziert wurden. Zudem werden wir die durch das maschinelle Lernmodell blockierten Angriffe nutzen, um unsere verwalteten Regelsätze weiter zu verbessern.</p>
</div>