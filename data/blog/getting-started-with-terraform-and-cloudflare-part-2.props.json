{
	"initialReadingTime": "8",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Patrick R. Donahue",
				"slug": "patrick",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/1LQFonIW7hvlt7UKRMOzlk/1922ffdb4fc76d32f8d039753ad6eb16/patrick.png",
				"location": "San Francisco, CA",
				"website": "https://www.cloudflare.com",
				"twitter": "@prdonahue",
				"facebook": null
			}
		],
		"excerpt": "Continue exploring Terraform with Cloudflare by enabling load balancing, creating page rules, and rolling back changes.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/3RjSXgMC8ct7LBS5x2dK3n/d1d3709e5ecb537be502b8a63bc823f4/getting-started-with-terraform-and-cloudflare-part-2.png",
		"featured": false,
		"html": "<p><i>In </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1/\"><i>Part 1 of Getting Started with Terraform</i></a><i>, we explained how Terraform lets developers store Cloudflare configuration in their own source code repository, institute change management processes that include code review, track their configuration versions and history over time, and easily roll back changes as needed.</i></p><p><i>We covered </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1#installingterraform\"><i>installing Terraform</i></a><i>, </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1#helloworld\"><i>provider initialization</i></a><i>, </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1#trackingchangehistory\"><i>storing configuration in git</i></a><i>, </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1#applyingzonesettings\"><i>applying zone settings</i></a><i>, and </i><a href=\"/getting-started-with-terraform-and-cloudflare-part-1#managingratelimits\"><i>managing rate limits</i></a><i>. This post continues the Cloudflare Terraform provider walkthrough with examples of </i><a href=\"#addingloadbalancing\"><i>load balancing</i></a><i>, </i><a href=\"#usingpagerules\"><i>page rules</i></a><i>, </i><a href=\"#reviewingandrollingbackchanges\"><i>reviewing and rolling back configuration</i></a><i>, and </i><a href=\"#importingexistingstateandconfiguration\"><i>importing state</i></a><i>.</i></p><h3>Reviewing the current configuration</h3><p>Before we build on Part 1, let&#39;s quickly review what we configured in that post. Because our configuration is in git, we can easily view the current configuration and change history that got us to this point.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git log\ncommit e1c38cf6f4230a48114ce7b747b77d6435d4646c\nAuthor: Me\nDate:   Mon Apr 9 12:34:44 2018 -0700\n\n    Step 4 - Update /login rate limit rule from &#039;simulate&#039; to &#039;ban&#039;.\n\ncommit 0f7e499c70bf5994b5d89120e0449b8545ffdd24\nAuthor: Me\nDate:   Mon Apr 9 12:22:43 2018 -0700\n\n    Step 4 - Add rate limiting rule to protect /login.\n\ncommit d540600b942cbd89d03db52211698d331f7bd6d7\nAuthor: Me\nDate:   Sun Apr 8 22:21:27 2018 -0700\n\n    Step 3 - Enable TLS 1.3, Always Use HTTPS, and SSL Strict mode.\n\ncommit 494c6d61b918fce337ca4c0725c9bbc01e00f0b7\nAuthor: Me\nDate:   Sun Apr 8 19:58:56 2018 -0700\n\n    Step 2 - Ignore terraform plugin directory and state file.\n\ncommit 5acea176050463418f6ac1029674c152e3056bc6\nAuthor: Me\nDate:   Sun Apr 8 19:52:13 2018 -0700\n\n    Step 2 - Initial commit with webserver definition.</pre></code>\n            <p>We&#39;ll get into more detail about reviewing and rolling back to prior versions of configuration <a href=\"#reviewingandrollingbackchanges\">later in this post</a>, but for now let&#39;s review the current version.</p><p>In lines 1-4 below, we configured the Cloudflare Terraform provider. Initially we stored our email address and API key in the <code>cloudflare.tf</code> file, but for security reasons we removed them before committing to a git repository.</p><p>In lines 6-8, we define a <code>variable</code> that can be interpolated into <code>resources</code> definitions. Terraform can be used to mass configure multiple zones through the use of variables, as we&#39;ll explore in a future post.</p><p>Lines 10-16 tell Cloudflare to create a DNS <code>A</code> record for <code>www.${var.domain}</code> using IP address <code>203.0.113.10</code>. Later in this post, we&#39;ll explore adding a second webserver and load balancing between the two origins.</p><p>Lines 18-26 apply zone-wide settings and lines 28-54 define a rate limiting rule to protect against credential stuffing and other brute force attacks.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ cat -n cloudflare.tf \n     1\tprovider &quot;cloudflare&quot; {\n     2\t  # email pulled from $CLOUDFLARE_EMAIL\n     3\t  # token pulled from $CLOUDFLARE_TOKEN\n     4\t}\n     5\t\n     6\tvariable &quot;domain&quot; {\n     7\t  default = &quot;example.com&quot;\n     8\t}\n     9\t\n    10\tresource &quot;cloudflare_record&quot; &quot;www&quot; {\n    11\t  domain  = &quot;${var.domain}&quot;\n    12\t  name    = &quot;www&quot;\n    13\t  value   = &quot;203.0.113.10&quot;\n    14\t  type    = &quot;A&quot;\n    15\t  proxied = true\n    16\t}\n    17\t\n    18\tresource &quot;cloudflare_zone_settings_override&quot; &quot;example-com-settings&quot; {\n    19\t  name = &quot;${var.domain}&quot;\n    20\t\n    21\t  settings {\n    22\t    tls_1_3 = &quot;on&quot;\n    23\t    automatic_https_rewrites = &quot;on&quot;\n    24\t    ssl = &quot;strict&quot;\n    25\t  }\n    26\t}\n    27\t\n    28\tresource &quot;cloudflare_rate_limit&quot; &quot;login-limit&quot; {\n    29\t  zone = &quot;${var.domain}&quot;\n    30\t\n    31\t  threshold = 5\n    32\t  period = 60\n    33\t  match {\n    34\t    request {\n    35\t      url_pattern = &quot;${var.domain}/login&quot;\n    36\t      schemes = [&quot;HTTP&quot;, &quot;HTTPS&quot;]\n    37\t      methods = [&quot;POST&quot;]\n    38\t    }\n    39\t    response {\n    40\t      statuses = [401, 403]\n    41\t      origin_traffic = true\n    42\t    }\n    43\t  }\n    44\t  action {\n    45\t    mode = &quot;ban&quot;\n    46\t    timeout = 300\n    47\t    response {\n    48\t      content_type = &quot;text/plain&quot;\n    49\t      body = &quot;You have failed to login 5 times in a 60 second period and will be blocked from attempting to login again for the next 5 minutes.&quot;\n    50\t    }\n    51\t  }\n    52\t  disabled = false\n    53\t  description = &quot;Block failed login attempts (5 in 1 min) for 5 minutes.&quot;\n    54\t}</pre></code>\n            <h3>Adding load balancing</h3><p>Thanks to the <a href=\"/getting-started-with-terraform-and-cloudflare-part-1#managingratelimits\">rate limiting set up in part 1</a>, our login page is protected against credential brute force attacks. Now it&#39;s time to focus on performance and reliability. Imagine organic traffic has grown for your webserver, and this traffic is increasingly global. It’s time to spread these requests to your origin over multiple data centers.</p><p>Below we&#39;ll add a second origin for some basic round robining, and then use the <a href=\"https://www.cloudflare.com/load-balancing/\">Cloudflare Load Balancing</a> product to fail traffic over as needed. We&#39;ll then enhance our load balancing configuration through the use of &quot;geo steering&quot; to serve results from an origin server that is geographically closest to your end users.</p><h4>1. Add another DNS record for <code>www</code></h4><p>To get started, we&#39;ll add a DNS record for a second web server, which is located in Asia. The IP address for this server is <code>198.51.100.15</code>.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git checkout -b step5-loadbalance\nSwitched to a new branch &#039;step5-loadbalance&#039;\n\n$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_record&quot; &quot;www-asia&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;www&quot;\n  value   = &quot;198.51.100.15&quot;\n  type    = &quot;A&quot;\n  proxied = true\n}\nEOF</pre></code>\n            <p>Note that while the name of the resource is different as Terraform resources of the same type must be uniquely named, the DNS name, i.e., what your customers will type in their browser, is the same: &quot;www&quot;.</p><h4>2. Preview and merge the changes</h4><p>Below we&#39;ll check the <code>terraform plan</code>, merge and apply the changes.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan | grep -v &quot;&lt;computed&gt;&quot;\n...\nTerraform will perform the following actions:\n\n  + cloudflare_record.www-asia\n      domain:      &quot;example.com&quot;\n      name:        &quot;www&quot;\n      proxied:     &quot;true&quot;\n      type:        &quot;A&quot;\n      value:       &quot;198.51.100.15&quot;\n\n\nPlan: 1 to add, 0 to change, 0 to destroy.</pre></code>\n            \n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git add cloudflare.tf\n$ git commit -m &quot;Step 5 - Add additional &#039;www&#039; DNS record for Asia data center.&quot;\n[step5-loadbalance 6761a4f] Step 5 - Add additional &#039;www&#039; DNS record for Asia data center.\n 1 file changed, 7 insertions(+)\n\n$ git checkout master\nSwitched to branch &#039;master&#039;\n\n$ git merge step5-loadbalance \nUpdating e1c38cf..6761a4f\nFast-forward\n cloudflare.tf | 7 +++++++\n 1 file changed, 7 insertions(+)</pre></code>\n            <h4>3. Apply and verify the changes</h4><p>Let&#39;s add the second DNS record for <a href=\"http://www.example.com\">www.example.com</a>:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform apply --auto-approve\n...\ncloudflare_record.www-asia: Creating...\n  created_on:  &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  domain:      &quot;&quot; =&gt; &quot;example.com&quot;\n  hostname:    &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  metadata.%:  &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  modified_on: &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  name:        &quot;&quot; =&gt; &quot;www&quot;\n  proxiable:   &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  proxied:     &quot;&quot; =&gt; &quot;true&quot;\n  ttl:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  type:        &quot;&quot; =&gt; &quot;A&quot;\n  value:       &quot;&quot; =&gt; &quot;198.51.100.15&quot;\n  zone_id:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\ncloudflare_record.www-asia: Creation complete after 1s (ID: fda39d8c9bf909132e82a36bab992864)\n\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.</pre></code>\n            <p>With the second DNS record in place, let&#39;s try making some requests to see where the traffic is served from:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ curl https://www.example.com\nHello, this is 203.0.113.10!\n\n$ curl https://www.example.com\nHello, this is 203.0.113.10!\n\n$ curl https://www.example.com\nHello, this is 198.51.100.15!\n\n$ curl https://www.example.com\nHello, this is 203.0.113.10!</pre></code>\n            <p>As you can see above, there is no discernible pattern for which origin receives the request. When Cloudflare connects to an origin with multiple DNS records, one of the IP addresses is selected at random. If both of these IPs are in the same data center and sessions can be shared (i.e., it doesn&#39;t matter if the same user hops between origin servers), this may work fine. However, for anything more complicated such as origins in different geographies or active health checks, you&#39;re going to want to use Cloudflare&#39;s Load Balancing product.</p><h4>4. Switch to using Cloudflare Load Balancing</h4><p>Before proceeding, make sure that your account is enabled for Load Balancing. If you&#39;re on an Enterprise plan, you should ask your Customer Success Manager to do this; otherwise, you can subscribe to Load Balancing within the Cloudflare Dashboard.</p><p>As described in the <a href=\"https://support.cloudflare.com/hc/en-us/articles/115000081911-Tutorial-How-to-Set-Up-Load-Balancing-Intelligent-Failover-on-Cloudflare\">load balancing tutorial</a> on the Cloudflare Support site, you will need to do three things:</p><p>i. Create a monitor to run health checks against your origin serversii. Create a pool of one or more origin servers that will receive load balanced trafficiii. Create a load balancer with an external hostname, e.g., <a href=\"http://www.example.com\">www.example.com</a>, and one or more pools</p><h5>i. Define and create the health check (&quot;monitor&quot;)</h5><p>To monitor our origins we&#39;re going to create a basic health check that makes a GET request to each origin on the URL <a href=\"https://www.example.com\">https://www.example.com</a>. If the origin returns the 200/OK status code within 5 seconds, we&#39;ll consider it healthy. If it fails to do so three (3) times in a row, we&#39;ll consider it unhealthy. This health check will be run once per minute from several regions, and send an email notification to <a href=\"mailto:you@example.com\">you@example.com</a> if any failures are detected.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git checkout step5-loadbalance\nSwitched to branch &#039;step5-loadbalance&#039;\n\n$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_load_balancer_monitor&quot; &quot;get-root-https&quot; {\n  expected_body = &quot;alive&quot;\n  expected_codes = &quot;200&quot;\n  method = &quot;GET&quot;\n  timeout = 5\n  path = &quot;/&quot;\n  interval = 60\n  retries = 2\n  check_regions = [&quot;WNAM&quot;, &quot;ENAM&quot;, &quot;WEU&quot;, &quot;EEU&quot;, &quot;SEAS&quot;, &quot;NEAS&quot;]\n  description = &quot;GET / over HTTPS - expect 200&quot;\n}\nEOF</pre></code>\n            <h5>ii. Define and create the pool of origins</h5><p>We will call our pool &quot;www-servers” and add two origins to it: <code>www-us</code> (<code>203.0.113.10</code>) and www-asia (<code>198.51.100.15</code>). For now, we&#39;ll skip any sort of <a href=\"https://support.cloudflare.com/hc/en-us/articles/115000540888-Load-Balancing-Geographic-Regions\">geo routing</a>.</p><p>Note that we reference the monitor we added in the last step. When applying this confirmation, Terraform will figure out that it first needs to create the monitor so that it can look up the ID and provide to the pool we wish to create.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_load_balancer_pool&quot; &quot;www-servers&quot; {\n  name = &quot;www-servers&quot;\n  monitor = &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;\n  origins {\n    name = &quot;www-us&quot;\n    address = &quot;203.0.113.10&quot;\n  }\n  origins {\n    name = &quot;www-asia&quot;\n    address = &quot;198.51.100.15&quot;\n  }\n  description = &quot;www origins&quot;\n  enabled = true\n  minimum_origins = 1\n  notification_email = &quot;you@example.com&quot;\n}\nEOF</pre></code>\n            <h5>iii. Define and create the load balancer</h5><p>Note that when you create a load balancer (LB), it will <a href=\"https://support.cloudflare.com/hc/en-us/articles/115004954407-How-Does-a-Load-Balancer-Interact-with-Existing-DNS-Records-\">replace any existing DNS records with the same name</a>. For example, when we create the &quot;<a href=\"http://www.example.com\">www.example.com</a>&quot; LB below, it will supersede the two www DNS records that you have previously defined. One benefit of leaving these DNS records in place is that if you temporarily disable load balancing, connections to this hostname will still be possible as shown above.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {\n  zone = &quot;example.com&quot;\n  name = &quot;www-lb&quot;\n  default_pool_ids = [&quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;]\n  fallback_pool_id = &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;\n  description = &quot;example load balancer&quot;\n  proxied = true\n}\nEOF</pre></code>\n            <h5>iv. Preview and merge the changes</h5><p>As usual, we take a look at the proposed plan before we apply any changes:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan\n...\nTerraform will perform the following actions:\n\n  + cloudflare_load_balancer.www-lb\n      id:                         &lt;computed&gt;\n      created_on:                 &lt;computed&gt;\n      default_pool_ids.#:         &lt;computed&gt;\n      description:                &quot;example load balancer&quot;\n      fallback_pool_id:           &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;\n      modified_on:                &lt;computed&gt;\n      name:                       &quot;www-lb&quot;\n      pop_pools.#:                &lt;computed&gt;\n      proxied:                    &quot;true&quot;\n      region_pools.#:             &lt;computed&gt;\n      ttl:                        &lt;computed&gt;\n      zone:                       &quot;example.com&quot;\n      zone_id:                    &lt;computed&gt;\n\n  + cloudflare_load_balancer_monitor.get-root-https\n      id:                         &lt;computed&gt;\n      created_on:                 &lt;computed&gt;\n      description:                &quot;GET / over HTTPS - expect 200&quot;\n      expected_body:              &quot;alive&quot;\n      expected_codes:             &quot;200&quot;\n      interval:                   &quot;60&quot;\n      method:                     &quot;GET&quot;\n      modified_on:                &lt;computed&gt;\n      path:                       &quot;/&quot;\n      retries:                    &quot;2&quot;\n      timeout:                    &quot;5&quot;\n      type:                       &quot;http&quot;\n\n  + cloudflare_load_balancer_pool.www-servers\n      id:                         &lt;computed&gt;\n      check_regions.#:            &quot;6&quot;\n      check_regions.1151265357:   &quot;SEAS&quot;\n      check_regions.1997072153:   &quot;WEU&quot;\n      check_regions.2367191053:   &quot;EEU&quot;\n      check_regions.2826842289:   &quot;ENAM&quot;\n      check_regions.2992567379:   &quot;WNAM&quot;\n      check_regions.3706632574:   &quot;NEAS&quot;\n      created_on:                 &lt;computed&gt;\n      description:                &quot;www origins&quot;\n      enabled:                    &quot;true&quot;\n      minimum_origins:            &quot;1&quot;\n      modified_on:                &lt;computed&gt;\n      monitor:                    &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;\n      name:                       &quot;www-servers&quot;\n      notification_email:         &quot;you@example.com&quot;\n      origins.#:                  &quot;2&quot;\n      origins.3039426352.address: &quot;198.51.100.15&quot;\n      origins.3039426352.enabled: &quot;true&quot;\n      origins.3039426352.name:    &quot;www-asia&quot;\n      origins.4241861547.address: &quot;203.0.113.10&quot;\n      origins.4241861547.enabled: &quot;true&quot;\n      origins.4241861547.name:    &quot;www-us&quot;\n\n\nPlan: 3 to add, 0 to change, 0 to destroy.</pre></code>\n            <p>The plan looks good so let&#39;s go ahead, merge it in, and apply it.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git add cloudflare.tf\n$ git commit -m &quot;Step 5 - Create load balancer (LB) monitor, LB pool, and LB.&quot;\n[step5-loadbalance bc9aa9a] Step 5 - Create load balancer (LB) monitor, LB pool, and LB.\n 1 file changed, 35 insertions(+)\n\n$ terraform apply --auto-approve\n...\ncloudflare_load_balancer_monitor.get-root-https: Creating...\n  created_on:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  description:    &quot;&quot; =&gt; &quot;GET / over HTTPS - expect 200&quot;\n  expected_body:  &quot;&quot; =&gt; &quot;alive&quot;\n  expected_codes: &quot;&quot; =&gt; &quot;200&quot;\n  interval:       &quot;&quot; =&gt; &quot;60&quot;\n  method:         &quot;&quot; =&gt; &quot;GET&quot;\n  modified_on:    &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  path:           &quot;&quot; =&gt; &quot;/&quot;\n  retries:        &quot;&quot; =&gt; &quot;2&quot;\n  timeout:        &quot;&quot; =&gt; &quot;5&quot;\n  type:           &quot;&quot; =&gt; &quot;http&quot;\ncloudflare_load_balancer_monitor.get-root-https: Creation complete after 1s (ID: 4238142473fcd48e89ef1964be72e3e0)\ncloudflare_load_balancer_pool.www-servers: Creating...\n  check_regions.#:            &quot;&quot; =&gt; &quot;6&quot;\n  check_regions.1151265357:   &quot;&quot; =&gt; &quot;SEAS&quot;\n  check_regions.1997072153:   &quot;&quot; =&gt; &quot;WEU&quot;\n  check_regions.2367191053:   &quot;&quot; =&gt; &quot;EEU&quot;\n  check_regions.2826842289:   &quot;&quot; =&gt; &quot;ENAM&quot;\n  check_regions.2992567379:   &quot;&quot; =&gt; &quot;WNAM&quot;\n  check_regions.3706632574:   &quot;&quot; =&gt; &quot;NEAS&quot;\n  created_on:                 &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  description:                &quot;&quot; =&gt; &quot;www origins&quot;\n  enabled:                    &quot;&quot; =&gt; &quot;true&quot;\n  minimum_origins:            &quot;&quot; =&gt; &quot;1&quot;\n  modified_on:                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  monitor:                    &quot;&quot; =&gt; &quot;4238142473fcd48e89ef1964be72e3e0&quot;\n  name:                       &quot;&quot; =&gt; &quot;www-servers&quot;\n  notification_email:         &quot;&quot; =&gt; &quot;you@example.com&quot;\n  origins.#:                  &quot;&quot; =&gt; &quot;2&quot;\n  origins.3039426352.address: &quot;&quot; =&gt; &quot;198.51.100.15&quot;\n  origins.3039426352.enabled: &quot;&quot; =&gt; &quot;true&quot;\n  origins.3039426352.name:    &quot;&quot; =&gt; &quot;www-asia&quot;\n  origins.4241861547.address: &quot;&quot; =&gt; &quot;203.0.113.10&quot;\n  origins.4241861547.enabled: &quot;&quot; =&gt; &quot;true&quot;\n  origins.4241861547.name:    &quot;&quot; =&gt; &quot;www-us&quot;\ncloudflare_load_balancer_pool.www-servers: Creation complete after 0s (ID: 906d2a7521634783f4a96c062eeecc6d)\ncloudflare_load_balancer.www-lb: Creating...\n  created_on:         &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  default_pool_ids.#: &quot;&quot; =&gt; &quot;1&quot;\n  default_pool_ids.0: &quot;&quot; =&gt; &quot;906d2a7521634783f4a96c062eeecc6d&quot;\n  description:        &quot;&quot; =&gt; &quot;example load balancer&quot;\n  fallback_pool_id:   &quot;&quot; =&gt; &quot;906d2a7521634783f4a96c062eeecc6d&quot;\n  modified_on:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  name:               &quot;&quot; =&gt; &quot;www-lb&quot;\n  pop_pools.#:        &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  proxied:            &quot;&quot; =&gt; &quot;true&quot;\n  region_pools.#:     &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  ttl:                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\n  zone:               &quot;&quot; =&gt; &quot;example.com&quot;\n  zone_id:            &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\ncloudflare_load_balancer.www-lb: Creation complete after 1s (ID: cb94f53f150e5c1a65a07e43c5d4cac4)\n\nApply complete! Resources: 3 added, 0 changed, 0 destroyed.</pre></code>\n            <h5>iv. Test the changes</h5><p>With load balancing in place, let&#39;s run those curl requests again to see where the traffic is served from:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ for i in {1..4}; do curl https://www.example.com &amp;&amp; sleep 5; done\nHello, this is 198.51.100.15!\n\nHello, this is 203.0.113.10!\n\nHello, this is 198.51.100.15!\n\nHello, this is 203.0.113.10!</pre></code>\n            <p>Great, we&#39;re now seeing each request load balanced evenly across the two origins we defined.</p><h3>Using page rules</h3><p>Earlier we configured zone settings that apply to all of example.com. Now we&#39;re going to add an exception to these settings by using <a href=\"https://www.cloudflare.com/features-page-rules/\">Page Rules</a>.</p><p>Specifically, we&#39;re going to turn increase the security level for a URL we know is expensive to render (and cannot be cached): <a href=\"https://www.example.com/expensive-db-call\">https://www.example.com/expensive-db-call</a>. Additionally, we&#39;re going to add a redirect from the previous URL we used to host this page.</p><h4>1. Create a new branch and append the page rule</h4><p>As usual we&#39;ll create a new branch and append our configuration.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git checkout -b step6-pagerule\nSwitched to a new branch &#039;step6-pagerule&#039;\n\n$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_page_rule&quot; &quot;increase-security-on-expensive-page&quot; {\n  zone = &quot;${var.domain}&quot;\n  target = &quot;www.${var.domain}/expensive-db-call&quot;\n  priority = 10\n\n  actions = {\n    security_level = &quot;under_attack&quot;,\n  }\n}\n\nresource &quot;cloudflare_page_rule&quot; &quot;redirect-to-new-db-page&quot; {\n  zone = &quot;${var.domain}&quot;\n  target = &quot;www.${var.domain}/old-location.php&quot;\n  priority = 10\n\n  actions = {\n    forwarding_url {\n      url = &quot;https://www.${var.domain}/expensive-db-call&quot;\n      status_code = 301\n    }\n  }\n}\nEOF</pre></code>\n            <h4>2. Preview and merge the changes</h4><p>You know the drill: preview the changes Terraform is going to make and then merge them into the master branch.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan\n...\nTerraform will perform the following actions:\n\n  + cloudflare_page_rule.increase-security-on-expensive-page\n      id:                                     &lt;computed&gt;\n      actions.#:                              &quot;1&quot;\n      actions.0.always_use_https:             &quot;false&quot;\n      actions.0.disable_apps:                 &quot;false&quot;\n      actions.0.disable_performance:          &quot;false&quot;\n      actions.0.disable_security:             &quot;false&quot;\n      actions.0.security_level:               &quot;under_attack&quot;\n      priority:                               &quot;10&quot;\n      status:                                 &quot;active&quot;\n      target:                                 &quot;www.example.com/expensive-db-call&quot;\n      zone:                                   &quot;example.com&quot;\n      zone_id:                                &lt;computed&gt;\n\n  + cloudflare_page_rule.redirect-to-new-db-page\n      id:                                     &lt;computed&gt;\n      actions.#:                              &quot;1&quot;\n      actions.0.always_use_https:             &quot;false&quot;\n      actions.0.disable_apps:                 &quot;false&quot;\n      actions.0.disable_performance:          &quot;false&quot;\n      actions.0.disable_security:             &quot;false&quot;\n      actions.0.forwarding_url.#:             &quot;1&quot;\n      actions.0.forwarding_url.0.status_code: &quot;301&quot;\n      actions.0.forwarding_url.0.url:         &quot;https://www.example.com/expensive-db-call&quot;\n      priority:                               &quot;10&quot;\n      status:                                 &quot;active&quot;\n      target:                                 &quot;www.example.com/old-location.php&quot;\n      zone:                                   &quot;example.com&quot;\n      zone_id:                                &lt;computed&gt;\n\n\nPlan: 2 to add, 0 to change, 0 to destroy.</pre></code>\n            \n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git add cloudflare.tf\n\n$ git commit -m &quot;Step 6 - Add two Page Rules.&quot;\n[step6-pagerule d4fec16] Step 6 - Add two Page Rules.\n 1 file changed, 23 insertions(+)\n\n$ git checkout master\nSwitched to branch &#039;master&#039;\n\n$ git merge step6-pagerule \nUpdating 7a2ac34..d4fec16\nFast-forward\n cloudflare.tf | 23 +++++++++++++++++++++++\n 1 file changed, 23 insertions(+)\n3. Apply And Verify The Changes\nFirst we&#039;ll test requesting the (now missing) old location of the expensive-to-render page.</pre></code>\n            \n            <pre class=\"language-bash\"><code class=\"language-bash\">$ curl -vso /dev/null https://www.example.com/old-location.php 2&gt;&amp;1 | grep &quot;&lt; HTTP\\|Location&quot;\n&lt; HTTP/1.1 404 Not Found</pre></code>\n            <p>As expected, it can&#39;t be found. Let&#39;s apply the Page Rules, including the redirect that should fix this error.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform apply --auto-approve\n...\ncloudflare_page_rule.redirect-to-new-db-page: Creating...\n  actions.#:                              &quot;0&quot; =&gt; &quot;1&quot;\n  actions.0.always_use_https:             &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_apps:                 &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_performance:          &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_security:             &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.forwarding_url.#:             &quot;0&quot; =&gt; &quot;1&quot;\n  actions.0.forwarding_url.0.status_code: &quot;&quot; =&gt; &quot;301&quot;\n  actions.0.forwarding_url.0.url:         &quot;&quot; =&gt; &quot;https://www.example.com/expensive-db-call&quot;\n  priority:                               &quot;&quot; =&gt; &quot;10&quot;\n  status:                                 &quot;&quot; =&gt; &quot;active&quot;\n  target:                                 &quot;&quot; =&gt; &quot;www.example.com/old-location.php&quot;\n  zone:                                   &quot;&quot; =&gt; &quot;example.com&quot;\n  zone_id:                                &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\ncloudflare_page_rule.increase-security-on-expensive-page: Creating...\n  actions.#:                     &quot;0&quot; =&gt; &quot;1&quot;\n  actions.0.always_use_https:    &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_apps:        &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_performance: &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.disable_security:    &quot;&quot; =&gt; &quot;false&quot;\n  actions.0.security_level:      &quot;&quot; =&gt; &quot;under_attack&quot;\n  priority:                      &quot;&quot; =&gt; &quot;10&quot;\n  status:                        &quot;&quot; =&gt; &quot;active&quot;\n  target:                        &quot;&quot; =&gt; &quot;www.example.com/expensive-db-call&quot;\n  zone:                          &quot;&quot; =&gt; &quot;example.com&quot;\n  zone_id:                       &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;\ncloudflare_page_rule.redirect-to-new-db-page: Creation complete after 3s (ID: c5c40ff2dc12416b5fe4d0541980c591)\ncloudflare_page_rule.increase-security-on-expensive-page: Creation complete after 6s (ID: 1c13fdb84710c4cc8b11daf7ffcca449)\n\nApply complete! Resources: 2 added, 0 changed, 0 destroyed.</pre></code>\n            <p>With the Page Rules in place, let&#39;s try that call again, along with the <a href=\"/introducing-im-under-attack-mode/\">I&#39;m Under Attack Mode</a> test:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ curl -vso /dev/null https://www.example.com/old-location.php 2&gt;&amp;1 | grep &quot;&lt; HTTP\\|Location&quot;\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Location: https://www.upinatoms.com/expensive-db-call\n\n$ curl -vso /dev/null https://www.upinatoms.com/expensive-db-call 2&gt;&amp;1 | grep &quot;&lt; HTTP&quot;\n&lt; HTTP/1.1 503 Service Temporarily Unavailable</pre></code>\n            <p>Great, they work as expected! In the first case, the Cloudflare edge responds with a <code>301</code> redirecting the browser to the new location. In the second case it initially responds with a <code>503</code> (as is consistent with the &quot;I Am Under Attack” mode).</p><h3>Reviewing and rolling back changes</h3><p>We&#39;ve come a long way! Now it&#39;s time to tear it all down. Well, maybe just part of it.</p><p>Sometimes when you deploy configuration changes you later determine that they need to be rolled back. You could be performance testing a new configuration and want to revert to your previous configuration when done testing. Or maybe you fat-fingered an IP address and brought your entire site down (#hugops).</p><p>Either way, if you&#39;ve determined you want to revert your configuration, all you need to do is check the desired branch out and ask Terraform to move your Cloudflare settings back in time. And note that if you accidentally brought your site down you should consider establishing a good strategy for peer reviewing pull requests (rather than merging directly to primary, as I do here for brevity)!</p><h4>1. Reviewing your configuration history</h4><p>Before we figure out how far back in time we want to rollback, let&#39;s take a look at our (git) versioned history.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git log\ncommit d4fec164581bec44684a4d59bb80aec1f1da5a6e\nAuthor: Me\nDate:   Wed Apr 18 22:04:52 2018 -0700\n\n    Step 6 - Add two Page Rules.\n\ncommit bc9aa9a465a4c8d6deeaa0491814c9f364e9aa8a\nAuthor: Me\nDate:   Sun Apr 15 23:58:35 2018 -0700\n\n    Step 5 - Create load balancer (LB) monitor, LB pool, and LB.\n\ncommit 6761a4f754e77322629ba4e90a90a3defa1fd4b6\nAuthor: Me\nDate:   Wed Apr 11 11:20:25 2018 -0700\n\n    Step 5 - Add additional &#039;www&#039; DNS record for Asia data center.\n\ncommit e1c38cf6f4230a48114ce7b747b77d6435d4646c\nAuthor: Me\nDate:   Mon Apr 9 12:34:44 2018 -0700\n\n    Step 4 - Update /login rate limit rule from &#039;simulate&#039; to &#039;ban&#039;.\n\ncommit 0f7e499c70bf5994b5d89120e0449b8545ffdd24\nAuthor: Me\nDate:   Mon Apr 9 12:22:43 2018 -0700\n\n    Step 4 - Add rate limiting rule to protect /login.\n\ncommit d540600b942cbd89d03db52211698d331f7bd6d7\nAuthor: Me\nDate:   Sun Apr 8 22:21:27 2018 -0700\n\n    Step 3 - Enable TLS 1.3, Always Use HTTPS, and SSL Strict mode.\n\ncommit 494c6d61b918fce337ca4c0725c9bbc01e00f0b7\nAuthor: Me\nDate:   Sun Apr 8 19:58:56 2018 -0700\n\n    Step 2 - Ignore terraform plugin directory and state file.\n\ncommit 5acea176050463418f6ac1029674c152e3056bc6\nAuthor: Me\nDate:   Sun Apr 8 19:52:13 2018 -0700\n\n    Step 2 - Initial commit with webserver definition.\n\nAnother nice benefit of storing your Cloudflare configuration in git is that you can see who made the change, as well as who reviewed and approved the change (assuming you&#039;re peer reviewing pull requests).</pre></code>\n            <h4>2. Examining specific historical changes</h4><p>To begin with, let&#39;s see what the last change we made was.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git show\ncommit d4fec164581bec44684a4d59bb80aec1f1da5a6e\nAuthor: Me\nDate:   Wed Apr 18 22:04:52 2018 -0700\n\n    Step 6 - Add two Page Rules.\n\ndiff --git a/cloudflare.tf b/cloudflare.tf\nindex 0b39450..ef11d8a 100644\n--- a/cloudflare.tf\n+++ b/cloudflare.tf\n@@ -94,3 +94,26 @@ resource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {\n   description = &quot;example load balancer&quot;\n   proxied = true\n }\n+\n+resource &quot;cloudflare_page_rule&quot; &quot;increase-security-on-expensive-page&quot; {\n+  zone = &quot;${var.domain}&quot;\n+  target = &quot;www.${var.domain}/expensive-db-call&quot;\n+  priority = 10\n+\n+  actions = {\n+    security_level = &quot;under_attack&quot;,\n+  }\n+}\n+\n+resource &quot;cloudflare_page_rule&quot; &quot;redirect-to-new-db-page&quot; {\n+  zone = &quot;${var.domain}&quot;\n+  target = &quot;www.${var.domain}/old-location.php&quot;\n+  priority = 10\n+\n+  actions = {\n+    forwarding_url {\n+      url = &quot;https://${var.domain}/expensive-db-call&quot;\n+      status_code = 301\n+    }\n+  }\n+}</pre></code>\n            <p>Now let&#39;s look at the past few changes:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git log -p -3\n\n... \n// page rule config from above\n...\n\ncommit bc9aa9a465a4c8d6deeaa0491814c9f364e9aa8a\nAuthor: Me\nDate:   Sun Apr 15 23:58:35 2018 -0700\n\n    Step 5 - Create load balancer (LB) monitor, LB pool, and LB.\n\ndiff --git a/cloudflare.tf b/cloudflare.tf\nindex b92cb6f..195b646 100644\n--- a/cloudflare.tf\n+++ b/cloudflare.tf\n@@ -59,3 +59,38 @@ resource &quot;cloudflare_record&quot; &quot;www-asia&quot; {\n   type    = &quot;A&quot;\n   proxied = true\n }\n+resource &quot;cloudflare_load_balancer_monitor&quot; &quot;get-root-https&quot; {\n+  expected_body = &quot;alive&quot;\n+  expected_codes = &quot;200&quot;\n+  method = &quot;GET&quot;\n+  timeout = 5\n+  path = &quot;/&quot;\n+  interval = 60\n+  retries = 2\n+  description = &quot;GET / over HTTPS - expect 200&quot;\n+}\n+resource &quot;cloudflare_load_balancer_pool&quot; &quot;www-servers&quot; {\n+  name = &quot;www-servers&quot;\n+  monitor = &quot;${cloudflare_load_balancer_monitor.get-root-https.id}&quot;\n+  check_regions = [&quot;WNAM&quot;, &quot;ENAM&quot;, &quot;WEU&quot;, &quot;EEU&quot;, &quot;SEAS&quot;, &quot;NEAS&quot;]\n+  origins {\n+    name = &quot;www-us&quot;\n+    address = &quot;203.0.113.10&quot;\n+  }\n+  origins {\n+    name = &quot;www-asia&quot;\n+    address = &quot;198.51.100.15&quot;\n+  }\n+  description = &quot;www origins&quot;\n+  enabled = true\n+  minimum_origins = 1\n+  notification_email = &quot;you@example.com&quot;\n+}\n+resource &quot;cloudflare_load_balancer&quot; &quot;www-lb&quot; {\n+  zone = &quot;${var.domain}&quot;\n+  name = &quot;www-lb&quot;\n+  default_pool_ids = [&quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;]\n+  fallback_pool_id = &quot;${cloudflare_load_balancer_pool.www-servers.id}&quot;\n+  description = &quot;example load balancer&quot;\n+  proxied = true\n+}\n\ncommit 6761a4f754e77322629ba4e90a90a3defa1fd4b6\nAuthor: Me\nDate:   Wed Apr 11 11:20:25 2018 -0700\n\n    Step 5 - Add additional &#039;www&#039; DNS record for Asia data center.\n\ndiff --git a/cloudflare.tf b/cloudflare.tf\nindex 9f25a0c..b92cb6f 100644\n--- a/cloudflare.tf\n+++ b/cloudflare.tf\n@@ -52,3 +52,10 @@ resource &quot;cloudflare_rate_limit&quot; &quot;login-limit&quot; {\n   disabled = false\n   description = &quot;Block failed login attempts (5 in 1 min) for 5 minutes.&quot;\n }\n+resource &quot;cloudflare_record&quot; &quot;www-asia&quot; {\n+  domain  = &quot;${var.domain}&quot;\n+  name    = &quot;www&quot;\n+  value   = &quot;198.51.100.15&quot;\n+  type    = &quot;A&quot;\n+  proxied = true\n+}</pre></code>\n            <h4>3. Redeploying the previous configuration</h4><p>Imagine that shortly after we <a href=\"#usingpagerules\">deployed the Page Rules</a>, we got a call from the Product team that manages this page: &quot;The URL was only being used by one customer and is no longer needed, let&#39;s drop the security setting and redirect.”</p><p>While you could always edit the config file directly and delete those entries, it&#39;s easier to let git do it for us. To begin with, let&#39;s ask git to revert the last commit (without rewriting history).</p><h5>i. Revert the branch to the previous commit</h5>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ git revert HEAD~1..HEAD\n[master f9a6f7d] Revert &quot;Step 6 - Bug fix.&quot;\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n$ git log -2\ncommit f9a6f7db72ea1437e146050a5e7556052ecc9a1a\nAuthor: Me\nDate:   Wed Apr 18 23:28:09 2018 -0700\n\n    Revert &quot;Step 6 - Add two Page Rules.&quot;\n    \n    This reverts commit d4fec164581bec44684a4d59bb80aec1f1da5a6e.\n\ncommit d4fec164581bec44684a4d59bb80aec1f1da5a6e\nAuthor: Me\nDate:   Wed Apr 18 22:04:52 2018 -0700\n\n    Step 6 - Add two Page Rules.</pre></code>\n            <h5>ii. Preview the changes</h5><p>As expected, Terraform is indicating it will remove the two Page Rules we just created.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan\n...\nAn execution plan has been generated and is shown below.\nResource actions are indicated with the following symbols:\n  - destroy\n\nTerraform will perform the following actions:\n\n  - cloudflare_page_rule.increase-security-on-expensive-page\n\n  - cloudflare_page_rule.redirect-to-new-db-page\n\n\nPlan: 0 to add, 0 to change, 2 to destroy.</pre></code>\n            <h5>iv. Apply the changes</h5><p>The changes look good, so let&#39;s ask Terraform to roll our Cloudflare configuration back.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform apply --auto-approve\n...\ncloudflare_page_rule.redirect-to-new-db-page: Destroying... (ID: c5c40ff2dc12416b5fe4d0541980c591)\ncloudflare_page_rule.increase-security-on-expensive-page: Destroying... (ID: 1c13fdb84710c4cc8b11daf7ffcca449)\ncloudflare_page_rule.increase-security-on-expensive-page: Destruction complete after 0s\ncloudflare_page_rule.redirect-to-new-db-page: Destruction complete after 1s\n\nApply complete! Resources: 0 added, 0 changed, 2 destroyed.</pre></code>\n            <p>Two resources destroyed, as expected. We&#39;ve rolled back to the previous version.</p><h3>Importing existing state and configuration</h3><p>An important point to understand about Terraform is that it is only able to manage configuration that it created, or was explicitly told about after the fact. The reason for this limitation is that Terraform relies on a local <a href=\"https://www.terraform.io/docs/state/\">state file</a> that maps the resource names defined in your configuration file, e.g., <code>cloudflare_load_balancer.www-lb</code> to the IDs generated by Cloudflare&#39;s API.</p><p>When Terraform makes calls to Cloudflare&#39;s API to create new resources , it persists those IDs to a state file; by default, the <code>terraform.tfstate</code> file in your directory is used, but this can be a remote location as will be discussed in a future blog post. These IDs are later looked up and refreshed when you call <code>terraform plan</code> and <code>terraform apply</code>.</p><p>If you&#39;ve configured Cloudflare through other means, e.g., by logging into the Cloudflare Dashboard or making <code>curl</code> calls to <code>api.cloudflare.com</code>, Terraform does not (yet) have these resource IDs in the state file. To manage this preexisting configuration you will need to first i) reproduce the configuration in your config file and; ii) import resources one-by-one by providing their IDs and resource names.</p><h4>1. Reviewing your current state file</h4><p>Before importing resources created by other means, let&#39;s take a look at how an existing DNS records is represented in the state file.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ cat terraform.tfstate | jq &#039;.modules[].resources[&quot;cloudflare_record.www&quot;]&#039;\n{\n  &quot;type&quot;: &quot;cloudflare_record&quot;,\n  &quot;depends_on&quot;: [],\n  &quot;primary&quot;: {\n    &quot;id&quot;: &quot;c38d3103767284e7cd14d5dad3ab8669&quot;,\n    &quot;attributes&quot;: {\n      &quot;created_on&quot;: &quot;2018-04-08T00:37:33.76321Z&quot;,\n      &quot;data.%&quot;: &quot;0&quot;,\n      &quot;domain&quot;: &quot;example.com&quot;,\n      &quot;hostname&quot;: &quot;www.example.com&quot;,\n      &quot;id&quot;: &quot;c38d3103767284e7cd14d5dad3ab8669&quot;,\n      &quot;metadata.%&quot;: &quot;2&quot;,\n      &quot;metadata.auto_added&quot;: &quot;false&quot;,\n      &quot;metadata.managed_by_apps&quot;: &quot;false&quot;,\n      &quot;modified_on&quot;: &quot;2018-04-08T00:37:33.76321Z&quot;,\n      &quot;name&quot;: &quot;www&quot;,\n      &quot;priority&quot;: &quot;0&quot;,\n      &quot;proxiable&quot;: &quot;true&quot;,\n      &quot;proxied&quot;: &quot;true&quot;,\n      &quot;ttl&quot;: &quot;1&quot;,\n      &quot;type&quot;: &quot;A&quot;,\n      &quot;value&quot;: &quot;203.0.113.10&quot;,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;\n    },\n    &quot;meta&quot;: {\n      &quot;schema_version&quot;: &quot;1&quot;\n    },\n    &quot;tainted&quot;: false\n  },\n  &quot;deposed&quot;: [],\n  &quot;provider&quot;: &quot;provider.cloudflare&quot;\n}</pre></code>\n            <p>As shown in the above JSON, the <code>cloudflare_record</code> resource named &quot;www&quot; has a unique ID of <code>c38d3103767284e7cd14d5dad3ab8669</code>. This ID is what gets interpolated into the API call that Terraform makes to Cloudflare to pull the latest configuration during the plan stage, e.g.,</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">GET https://api.cloudflare.com/client/v4/zones/:zone_id/dns_records/c38d3103767284e7cd14d5dad3ab8669</pre></code>\n            <h4>2. Importing existing Cloudflare resources</h4><p>To import an existing record, e.g., another DNS record, you need two things:</p><ol><li><p>The unique identifier that Cloudflare uses to identify the record</p></li><li><p>The resource name to which you wish to map this identifier</p></li></ol><h5>i. Download IDs and configuration from api.cloudflare.com</h5><p>We start by making an API call to Cloudflare to enumerate the DNS records in our account. The output below has been filtered to show only MX records, as these are what we&#39;ll be importing.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ curl https://api.cloudflare.com/client/v4/zones/$EXAMPLE_COM_ZONEID \\\n       -H &quot;X-Auth-Email: you@example.com&quot; -H &quot;X-Auth-Key: $CF_API_KEY&quot; \\\n       -H &quot;Content-Type: application/json&quot; | jq .\n\n{\n  &quot;result&quot;: [\n    {\n      &quot;id&quot;: &quot;8ea8c36c8530ee01068c65c0ddc4379b&quot;,\n      &quot;type&quot;: &quot;MX&quot;,\n      &quot;name&quot;: &quot;example.com&quot;,\n      &quot;content&quot;: &quot;alt1.aspmx.l.google.com&quot;,\n      &quot;proxiable&quot;: false,\n      &quot;proxied&quot;: false,\n      &quot;ttl&quot;: 1,\n      &quot;priority&quot;: 15,\n      &quot;locked&quot;: false,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,\n      &quot;zone_name&quot;: &quot;example.com&quot;,\n      &quot;modified_on&quot;: &quot;2016-11-06T01:11:50.163221Z&quot;,\n      &quot;created_on&quot;: &quot;2016-11-06T01:11:50.163221Z&quot;,\n      &quot;meta&quot;: {\n        &quot;auto_added&quot;: false,\n        &quot;managed_by_apps&quot;: false\n      }\n    },\n    {\n      &quot;id&quot;: &quot;ad0e9ff2479b13c5fbde77a02ea6fa2c&quot;,\n      &quot;type&quot;: &quot;MX&quot;,\n      &quot;name&quot;: &quot;example.com&quot;,\n      &quot;content&quot;: &quot;alt2.aspmx.l.google.com&quot;,\n      &quot;proxiable&quot;: false,\n      &quot;proxied&quot;: false,\n      &quot;ttl&quot;: 1,\n      &quot;priority&quot;: 15,\n      &quot;locked&quot;: false,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,\n      &quot;zone_name&quot;: &quot;example.com&quot;,\n      &quot;modified_on&quot;: &quot;2016-11-06T01:12:00.915649Z&quot;,\n      &quot;created_on&quot;: &quot;2016-11-06T01:12:00.915649Z&quot;,\n      &quot;meta&quot;: {\n        &quot;auto_added&quot;: false,\n        &quot;managed_by_apps&quot;: false\n      }\n    },\n    {\n      &quot;id&quot;: &quot;ad6ee69519cd02a0155a56b6d64c278a&quot;,\n      &quot;type&quot;: &quot;MX&quot;,\n      &quot;name&quot;: &quot;example.com&quot;,\n      &quot;content&quot;: &quot;alt3.aspmx.l.google.com&quot;,\n      &quot;proxiable&quot;: false,\n      &quot;proxied&quot;: false,\n      &quot;ttl&quot;: 1,\n      &quot;priority&quot;: 20,\n      &quot;locked&quot;: false,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,\n      &quot;zone_name&quot;: &quot;example.com&quot;,\n      &quot;modified_on&quot;: &quot;2016-11-06T01:12:12.899684Z&quot;,\n      &quot;created_on&quot;: &quot;2016-11-06T01:12:12.899684Z&quot;,\n      &quot;meta&quot;: {\n        &quot;auto_added&quot;: false,\n        &quot;managed_by_apps&quot;: false\n      }\n    },\n    {\n      &quot;id&quot;: &quot;baf6655f33738b7fd902630858878206&quot;,\n      &quot;type&quot;: &quot;MX&quot;,\n      &quot;name&quot;: &quot;example.com&quot;,\n      &quot;content&quot;: &quot;alt4.aspmx.l.google.com&quot;,\n      &quot;proxiable&quot;: false,\n      &quot;proxied&quot;: false,\n      &quot;ttl&quot;: 1,\n      &quot;priority&quot;: 20,\n      &quot;locked&quot;: false,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,\n      &quot;zone_name&quot;: &quot;example.com&quot;,\n      &quot;modified_on&quot;: &quot;2016-11-06T01:12:22.599272Z&quot;,\n      &quot;created_on&quot;: &quot;2016-11-06T01:12:22.599272Z&quot;,\n      &quot;meta&quot;: {\n        &quot;auto_added&quot;: false,\n        &quot;managed_by_apps&quot;: false\n      }\n    },\n    {\n      &quot;id&quot;: &quot;a96d72b3c6afe3077f9e9c677fb0a556&quot;,\n      &quot;type&quot;: &quot;MX&quot;,\n      &quot;name&quot;: &quot;example.com&quot;,\n      &quot;content&quot;: &quot;aspmx.lo.google.com&quot;,\n      &quot;proxiable&quot;: false,\n      &quot;proxied&quot;: false,\n      &quot;ttl&quot;: 1,\n      &quot;priority&quot;: 10,\n      &quot;locked&quot;: false,\n      &quot;zone_id&quot;: &quot;e2e6491340be87a3726f91fc4148b126&quot;,\n      &quot;zone_name&quot;: &quot;example.com&quot;,\n      &quot;modified_on&quot;: &quot;2016-11-06T01:11:27.700386Z&quot;,\n      &quot;created_on&quot;: &quot;2016-11-06T01:11:27.700386Z&quot;,\n      &quot;meta&quot;: {\n        &quot;auto_added&quot;: false,\n        &quot;managed_by_apps&quot;: false\n      }\n    },\n\n    ...\n  ]\n}</pre></code>\n            <h5>ii. Create Terraform configuration for existing records</h5><p>In the previous step, we found 5 MX records that we wish to add.</p><p>ID</p><p>Priority</p><p>Content</p><p>a96d72b3c6afe3077f9e9c677fb0a556</p><p>10</p><p>aspmx.lo.google.com</p><p>8ea8c36c8530ee01068c65c0ddc4379b</p><p>15</p><p>alt1.aspmx.l.google.com</p><p>ad0e9ff2479b13c5fbde77a02ea6fa2c</p><p>15</p><p>alt2.aspmx.l.google.com</p><p>ad6ee69519cd02a0155a56b6d64c278a</p><p>20</p><p>alt3.aspmx.l.google.com</p><p>baf6655f33738b7fd902630858878206</p><p>20</p><p>alt4.aspmx.l.google.com</p><p>Before importing, we need to create Terraform configuration and give each record a unique name that can be referenced during the import.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ cat &gt;&gt; cloudflare.tf &lt;&lt;&#039;EOF&#039;\nresource &quot;cloudflare_record&quot; &quot;mx-10&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;${var.domain}&quot;\n  value   = &quot;aspmx.lo.google.com&quot;\n  type    = &quot;MX&quot;\n  priority = &quot;10&quot;\n}\nresource &quot;cloudflare_record&quot; &quot;mx-15-1&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;${var.domain}&quot;\n  value   = &quot;alt1.aspmx.l.google.com&quot;\n  type    = &quot;MX&quot;\n  priority = &quot;15&quot;\n}\nresource &quot;cloudflare_record&quot; &quot;mx-15-2&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;${var.domain}&quot;\n  value   = &quot;alt2.aspmx.l.google.com&quot;\n  type    = &quot;MX&quot;\n  priority = &quot;15&quot;\n}\nresource &quot;cloudflare_record&quot; &quot;mx-20-1&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;${var.domain}&quot;\n  value   = &quot;alt3.aspmx.l.google.com&quot;\n  type    = &quot;MX&quot;\n  priority = &quot;20&quot;\n}\nresource &quot;cloudflare_record&quot; &quot;mx-20-2&quot; {\n  domain  = &quot;${var.domain}&quot;\n  name    = &quot;${var.domain}&quot;\n  value   = &quot;alt3.aspmx.l.google.com&quot;\n  type    = &quot;MX&quot;\n  priority = &quot;20&quot;\n}\nEOF</pre></code>\n            <h5>iii. Import resources into Terraform state</h5><p>Before we import the records, let&#39;s look at what would happen if we ran a <code>terraform apply</code>.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan | grep Plan\nPlan: 5 to add, 0 to change, 0 to destroy.</pre></code>\n            <p>Terraform does not know that these records already exist on Cloudflare, so until the import completes it will attempt to create them as new records. Below we import them one-by-one, specifying the name of the resource and the <code>zoneName/resourceID</code> returned by api.cloudflare.com.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform import cloudflare_record.mx-10 example.com/a96d72b3c6afe3077f9e9c677fb0a556\ncloudflare_record.mx-10: Importing from ID &quot;example.com/a96d72b3c6afe3077f9e9c677fb0a556&quot;...\ncloudflare_record.mx-10: Import complete!\n  Imported cloudflare_record (ID: a96d72b3c6afe3077f9e9c677fb0a556)\ncloudflare_record.mx-10: Refreshing state... (ID: a96d72b3c6afe3077f9e9c677fb0a556)\n\nImport successful!\n\nThe resources that were imported are shown above. These resources are now in\nyour Terraform state and will henceforth be managed by Terraform.\n\n$ terraform import cloudflare_record.mx-15-1 example.com/8ea8c36c8530ee01068c65c0ddc4379b\ncloudflare_record.mx-15-1: Importing from ID &quot;example.com/8ea8c36c8530ee01068c65c0ddc4379b&quot;...\ncloudflare_record.mx-15-1: Import complete!\n  Imported cloudflare_record (ID: 8ea8c36c8530ee01068c65c0ddc4379b)\ncloudflare_record.mx-15-1: Refreshing state... (ID: 8ea8c36c8530ee01068c65c0ddc4379b)\n\nImport successful!\n\nThe resources that were imported are shown above. These resources are now in\nyour Terraform state and will henceforth be managed by Terraform.\n\n$ terraform import cloudflare_record.mx-15-2 example.com/ad0e9ff2479b13c5fbde77a02ea6fa2c\ncloudflare_record.mx-15-2: Importing from ID &quot;example.com/ad0e9ff2479b13c5fbde77a02ea6fa2c&quot;...\ncloudflare_record.mx-15-2: Import complete!\n  Imported cloudflare_record (ID: ad0e9ff2479b13c5fbde77a02ea6fa2c)\ncloudflare_record.mx-15-2: Refreshing state... (ID: ad0e9ff2479b13c5fbde77a02ea6fa2c)\n\nImport successful!\n\nThe resources that were imported are shown above. These resources are now in\nyour Terraform state and will henceforth be managed by Terraform.\n\n$ terraform import cloudflare_record.mx-20-1 example.com/ad6ee69519cd02a0155a56b6d64c278a\ncloudflare_record.mx-20-1: Importing from ID &quot;example.com/ad6ee69519cd02a0155a56b6d64c278a&quot;...\ncloudflare_record.mx-20-1: Import complete!\n  Imported cloudflare_record (ID: ad6ee69519cd02a0155a56b6d64c278a)\ncloudflare_record.mx-20-1: Refreshing state... (ID: ad6ee69519cd02a0155a56b6d64c278a)\n\nImport successful!\n\nThe resources that were imported are shown above. These resources are now in\nyour Terraform state and will henceforth be managed by Terraform.\n\n$ terraform import cloudflare_record.mx-20-2 example.com/baf6655f33738b7fd902630858878206\ncloudflare_record.mx-20-2: Importing from ID &quot;example.com/baf6655f33738b7fd902630858878206&quot;...\ncloudflare_record.mx-20-2: Import complete!\n  Imported cloudflare_record (ID: baf6655f33738b7fd902630858878206)\ncloudflare_record.mx-20-2: Refreshing state... (ID: baf6655f33738b7fd902630858878206)\n\nImport successful!\n\nThe resources that were imported are shown above. These resources are now in\nyour Terraform state and will henceforth be managed by Terraform.</pre></code>\n            <p>Now when we run <code>terraform plan</code> it no longer wants to (re-)create the above records.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ terraform plan | grep changes\nNo changes. Infrastructure is up-to-date.</pre></code>\n            <h3>Wrapping up</h3><p>That&#39;s it for today! We covered the <a href=\"#addingloadbalancing\">Load Balancing</a> and <a href=\"#usingpagerules\">Page Rules</a> resources, as well as demonstrated how to <a href=\"#reviewingandrollingbackchanges\">review and roll back configuration changes</a>, and <a href=\"#importingexistingstateandconfiguration\">import state</a>.</p><p>Stay tuned for future Terraform blog posts, where we plan to show how to manage state effectively in a group setting, go multi-cloud with Terraform, and much more.</p>",
		"id": "1MMQdxQ3AKGQ3JVvoMYFgB",
		"localeList": {
			"name": "Getting started with Terraform and Cloudflare (Part 2 of 2) Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2018-04-30T17:20:45.000+01:00",
		"slug": "getting-started-with-terraform-and-cloudflare-part-2",
		"tags": [
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "4PjcrP7azfu8cw8rGcpYoM",
				"name": "Terraform",
				"slug": "terraform"
			},
			{
				"id": "z8ZZrDbXCT44IU6BaHLWl",
				"name": "Load Balancing",
				"slug": "loadbalancing"
			},
			{
				"id": "5VvYFsAHWSvCVOGdBUbUmi",
				"name": "Page Rules",
				"slug": "page-rules"
			},
			{
				"id": "6agYbJnOhJ7B2ie9Ctf2cf",
				"name": "HashiCorp",
				"slug": "hashicorp"
			},
			{
				"id": "6lhzEBz2B56RKa4nUEAGYJ",
				"name": "Programming",
				"slug": "programming"
			}
		],
		"title": "Getting started with Terraform and Cloudflare (Part 2 of 2)",
		"updated_at": "2024-08-27T02:22:23.358Z",
		"url": "https://blog.cloudflare.com/getting-started-with-terraform-and-cloudflare-part-2"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}