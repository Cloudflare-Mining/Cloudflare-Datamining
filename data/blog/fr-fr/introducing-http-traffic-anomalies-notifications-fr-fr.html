<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/Traffic-anomalies-1.png" class="kg-image" alt="Introducing notifications for HTTP Traffic Anomalies" loading="lazy" width="2401" height="1350"></figure>
	<p>Lorsqu'il s'agit de la gestion de propriétés Internet, la différence entre un petit souci technique et un incident majeur est souvent une affaire de rapidité. La diffusion proactive d'alertes joue un rôle crucial ; c'est pourquoi nous sommes ravis de lancer les notifications <a href="https://www.google.com/url?q=https%3A%2F%2Fblog.cloudflare.com%2Fsmarter-origin-service-level-monitoring%2F&amp;sa=D&amp;source=docs&amp;ust=1698694388627308&amp;usg=AOvVaw1WK7Q5k0aSP-e4N0VwjL7v" target="_blank">HTTP Error Rate</a>, qui permettent aux administrateurs d'être informés des erreurs que rencontrent les utilisateurs finaux.</p>
	<p>Mais qu'en est-il des problèmes qui ne se manifestent pas sous forme d'erreurs, à l'image d'une baisse soudaine du trafic ou d'un pic de trafic ?</p>
	<p>Aujourd'hui, nous sommes ravis d'annoncer la disponibilité des notifications d'anomalies de trafic pour les clients Enterprise. Ces notifications se déclenchent lorsque Cloudflare détecte des changements inattendus du trafic, vous offrant ainsi une précieuse nouvelle perspective de l'intégrité de vos systèmes.</p>
	<p>Des changements inattendus du trafic peuvent être révélateurs d'un certain nombre de choses. Si vous gérez un site d'e-commerce et vous constatez un pic de trafic, c'est peut-être une bonne nouvelle : les clients affluent vers votre site de vente, ou votre publicité vient d'être diffusée pendant une émission de télévision très regardée. Toutefois, cela peut aussi signifier qu'un problème est survenu : un utilisateur a peut-être accidentellement désactivé une règle de pare-feu, et ce que vous observez maintenant est un afflux de trafic malveillant. Quoi qu'il en soit, peut-être souhaitez-vous être informé qu'un changement s'est produit.</p>
	<p>De même, une baisse soudaine du trafic peut avoir de nombreuses significations. Peut-être est-ce le vendredi après-midi, et vos collaborateurs se déconnectent et n'accèdent plus au site web de votre entreprise. En revanche, peut-être qu'un lien vers votre site ne fonctionne plus, empêchant vos clients potentiels d'y accéder. Chaque minute pendant laquelle le trafic est faible pourrait entraîner une perte de revenus potentielle ; vous avez donc tout intérêt à être informé le plus rapidement possible de la situation, afin de mener l'enquête.</p>
	<h3 id="comment-savons-nous-quand-vous-alerter">Comment savons-nous quand vous alerter ?</h3>
	<p>Calculer efficacement des anomalies dans des séries de données temporelles est une tâche difficile. La méthode la plus simple consiste à utiliser des seuils de base. Toutefois, comme nous l'avons mentionné <a href="https://blog.cloudflare.com/smarter-origin-service-level-monitoring">dans un précédent article de blog</a>, les seuils simples s'avèrent peu précis lorsqu'il s'agit de déterminer l'existence avérée d'un problème. Le nombre de cas limites est trop élevé pour que cette approche soit efficace.</p>
	<p>En revanche, calculer les anomalies dans les erreurs HTTP est une tâche relativement facile. Nous savons qu'en règle générale, le nombre d'erreurs devrait être très faible ; aussi, tout pic constitue un problème et doit donc faire l'objet d'une alerte. C'est pourquoi nous utilisons les <a href="https://sre.google/workbook/alerting-on-slos" target="_blank">objectifs de niveau de service</a> (Service Level Objectives, SLO) pour calculer les anomalies pour nos <a href="https://developers.cloudflare.com/notifications/notification-available/#traffic-monitoring" target="_blank">notifications HTTP Error Rate</a>.</p>
	<p>Cependant, le déroulement de l'analyse du trafic HTTP est semblable à l'approche mise en œuvre par les <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">événements de sécurité Cloudflare</a> : il existe une base de référence générale d'événements qui est calculée à partir des tendances historiques. Tout écart par rapport à cette base de référence peut faire l'objet d'une alerte. En raison de ces similitudes, nous avons décidé d'utiliser les mêmes calculs pour les notifications d'anomalies de trafic que pour les notifications d'événements de sécurité : les <a href="https://blog.cloudflare.com/get-notified-when-your-site-is-under-attack">cotes z</a>. Il s'agit d'une comparaison de la valeur actuelle avec la moyenne sur une période donnée. La cote z correspond au nombre d'écarts-types par rapport à la moyenne de la valeur actuelle.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image4-6.png" class="kg-image" alt="" loading="lazy" width="1292" height="898">
		<figcaption><i>Graphique représentant le trafic HTTP par rapport aux cotes z. La courbe bleue représente le trafic HTTP, la courbe violette représente la limite positive de la cote z du trafic et la courbe verte représente la limite négative de la cote z du trafic.</i></figcaption>
	</figure>
	<p>Pour les notifications d'anomalies de trafic, nous comparons le trafic au cours des 5 dernières minutes (l'intervalle court) à la moyenne du trafic des 4 dernières heures (l'intervalle long). Des cotes z positives indiquent un pic, et des cotes z négatives indiquent une baisse. Si la valeur actuelle s'écarte de plus de 3,5 écarts-types de la moyenne, nous transmettons une alerte. Nous effectuons des mesures toutes les 5 minutes, ce qui nous permet d'être alertés en temps utile en cas de hausse ou de baisse du trafic.</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image2-9.png" class="kg-image" alt="" loading="lazy" width="1375" height="125">
		<figcaption><i>La zone verte correspond à l'intervalle long et la zone rouge à l'intervalle court.</i></figcaption>
	</figure>
	<p>Si nos notifications d'événements de sécurité se déclenchent uniquement en présence d'un pic d'événements de sécurité (une baisse est presque toujours une bonne nouvelle), dans le cas des anomalies du trafic, nous transmettons des notifications à la fois pour les pics <em>et</em> pour les baisses. En effet, une baisse du trafic HTTP est probablement révélatrice d'un problème, tandis qu'un pic peut être une bonne ou mauvaise nouvelle.</p>
	<p>À l'instar des événements de sécurité, les notifications d'anomalies de trafic prennent en charge des <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">seuils minimaux</a>. Ainsi, même si nous déterminons qu'un événement se situe au-delà de 3,5 écarts-types, si le nombre d'événements est insignifiant, nous ne transmettons pas d'alerte. Un pic doit être constitué d'au moins 200 requêtes, et une baisse doit représenter une chute d'au moins 200 requêtes. Cela permet d'éliminer le bruit des notifications, puisque nous ne transmettons pas d'alerte en cas de pics ou de baisses de moindre importance.</p>
	<h3 id="approfondissons-un-peu">Approfondissons un peu</h3>
	<p>Cloudflare stocke des statistiques échantillonnées sur les requêtes qui transitent sur son réseau <a href="https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse">dans Clickhouse</a>. Toutes les minutes, nous échantillonnons le trafic HTTP dans Clickhouse et le stockons dans une instance de VictoriaMetrics, une solution de stockage de données chronologiques. VictoriaMetrics nous fournit gratuitement des fonctions algorithmiques prêtes à l'emploi et s'est avérée être bien adaptée à notre scénario d'utilisation. Nous avons choisi VictoriaMetrics pour plusieurs raisons.</p>
	<p>Premièrement, la solution est simple à configurer et utiliser. En tant qu'équipe, nous aspirons à optimiser nos processus afin de réduire notre charge opérationnelle, et VictoriaMetrics s'est montrée excellente jusqu'à présent. Deuxièmement, VictoriaMetrics a la capacité d'évoluer horizontalement, ce qui signifie que nous pouvons l'utiliser dans un mode à haute disponibilité. Pour un système tel que celui-ci, où nous recherchons une solution fiable pour calculer des informations temporellement sensibles pour nos clients, l'exigence de haute disponibilité est essentielle. Enfin, pendant nos tests, nous avons constaté que VictoriaMetrics utilisait environ un tiers de la mémoire que consommait Prometheus, un produit alternatif similaire, dans le même scénario d'utilisation.</p>
	<p>Une fois que nous disposons de données dans VictoriaMetrics, nous pouvons exécuter des requêtes sur celles-ci et déterminer si nous devons alerter ou non nos clients, en fonction des configurations de notification qu'ils ont préalablement définies. À cette fin, nous utilisons notre système de notification d'alertes existant, <a href="https://blog.cloudflare.com/new-tools-to-monitor-your-server-and-avoid-downtime">auquel nous avons consacré un premier article de blog en 2019</a>. Nous savons que nous pouvons compter, pour le dernier kilomètre, sur notre système de notification actuel pour transmettre ces notifications critiques à nos clients.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image1-9.png" class="kg-image" alt="" loading="lazy" width="1999" height="387">
		<figcaption><i>Flux de données de la requête HTTP jusqu'à la notification</i></figcaption>
	</figure>
	<h6 id="setting-up-the-notification"><em>Setting up the Notification </em></h6>
	<p>Pour configurer cette notification, accédez à l'onglet « Notifications » du tableau de bord. Sélectionnez le type de notification « Anomalies de trafic ». Comme pour toutes les notifications de Cloudflare, vous pouvez nommer et décrire votre notification et choisir de quelle manière vous souhaitez être informé.</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image5-3.png" class="kg-image" alt="" loading="lazy" width="1999" height="482">
		<figcaption><i>Notification d'anomalies de trafic sur le tableau de bord</i></figcaption>
	</figure>
	<p>Vous pouvez choisir les domaines que vous souhaitez surveiller afin d'identifier d'éventuelles anomalies de trafic, si vous souhaitez inclure le trafic ayant déjà été atténué par les produits de protection contre les attaques DoS ou de pare-feu WAF de Cloudflare, ainsi que la présence de codes d'état spécifiques que vous souhaitez inclure ou exclure. Vous pouvez également choisir d'être alerté en cas de pics de trafic, de baisses de trafic ou de ces deux événements.</p>
	<p>Nous sommes ravis d'utiliser ce système pour permettre à nos clients Enterprise de recevoir de précieuses notifications concernant l'intégrité générale de leurs systèmes. Accédez à l'onglet Notifications du tableau de bord pour découvrir dès maintenant cette nouvelle notification !</p>
</div>