{
	"initialReadingTime": "3",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Zack Proser",
				"slug": "zackp",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/4w1aOdTZ5bLzlLN3G6Kqnw/ef28351975767a7d70ddd324fc81b037/zackp.jpeg",
				"location": null,
				"website": "https://zackproser.com",
				"twitter": "@zackproser",
				"facebook": null
			}
		],
		"excerpt": "We deployed a Cloudflare worker in front of www.cloudflare.com and api.cloudflare.com, that has since served over <X> million requests. Here's what we learned about debugging and \"failing open\" when writing workers.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/625Bpi9sa9TW6Y31S7FMbT/43483f09efa26d24c776e764d7e31c50/dogfooding-edge-workers.png",
		"featured": false,
		"html": "<p>On the WWW team, we’re responsible for Cloudflare’s REST APIs, account management services and the dashboard experience. We take security and <a href=\"https://www.cloudflare.com/learning/privacy/what-is-pci-dss-compliance/\">PCI compliance</a> seriously, which means we move quickly to stay up to date with regulations and relevant laws.</p><p>A <a href=\"/deprecating-old-tls-versions-on-cloudflare-dashboard-and-api/\">recent compliance project</a> had a requirement of detecting certain end user request data at the edge, and reacting to it both in API responses as well as visually in the dashboard. We realized that this was an excellent opportunity to dogfood Cloudflare Workers.</p><h3>Deploying workers to <a href=\"http://www.cloudflare.com\">www.cloudflare.com</a> and api.cloudflare.com</h3><p>In this blog post, we’ll break down the problem we solved using a single worker that we shipped to multiple hosts, share the annotated source code of our worker, and share some best practices and tips and tricks we discovered along the way.</p><p>Since being deployed, <b>our worker has served over 400 million requests</b> for both calls to api.cloudflare.com and the <a href=\"http://www.cloudflare.com\">www.cloudflare.com</a> dashboard.</p><h3>The task</h3><p>First, we needed to detect when a client was connecting to our services using an outdated TLS protocol. Next, we wanted to pass this information deeper into our application stack so that we could act upon it and conditionally decorate our responses with notices providing a heads up about the imminent changes.</p><p>Our Edge team was quick to create a patch to capture TLS connection information for every incoming request, but how would we propagate it to our application layer where it could be acted upon?</p><h3>The solution</h3><p>The Workers team made a modification to the core platform to ingest the TLS protocol version data sent from the edge, making it available in the workers environment as a property of the cf object available to the worker Javascript context (You can now use this property in your own workers).</p><p>With our workers able to inspect the TLS protocol versions of requests, we needed only to append a custom HTTP header containing this information before forwarding them into our application layer.</p><p>Our APIs use this data to add deprecation warnings to responses, and our UI uses it to display banners explaining the upcoming changes.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/1TlooYc7slpilLJyFkXxD5/a5b4c4259ae19217bdae2692e63ed21a/tls-deprecation-banner.png\" alt=\"tls-deprecation-banner\" class=\"kg-image\" width=\"2464\" height=\"1110\" loading=\"lazy\"/>\n            \n            </figure><p>Let&#39;s now take a look at the source code for our worker.</p><h3>Anatomy of a fail open worker</h3>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">/**\n * Cloudflare workers implement the service worker spec\n * See: https://developers.cloudflare.com/workers/about/ for an intro\n *\n * Binding an event handler to the fetch event allows your worker to intercept a request for your zone\n */\naddEventListener(&#039;fetch&#039;, event =&gt; {\n    /**\n     * In the event of an uncaught exception, fail open as if the  worker did not exist\n     * If you&#039;re not sure what you&#039;re doing, it&#039;s recommended you include this call\n     * as the very first thing your worker does in its fetch event listener\n     *\n     * If you do not include this call, but your worker encounters an uncaught exception\n     * while processing your request, your user will see an edge-level error page\n     * instead of a response from your site, app or API\n     *\n     * Read on below for more info on deciding whether to\n     * fail open or fail closed in your workers\n     */\n    event.passThroughOnException()\n    //This allows you to return your own Response object from your worker\n    event.respondWith(requestWithTLSHeader(event))\n})\n/**\n * Calls out to our Sentry account to create an exception event\n *\n * Note that for this to work properly with the event.waitUntil() call in the\n * exception block within requestWithTLSHeader, this function must return a promise\n *\n * @returns {Promise}\n */\nfunction promisifiedSentryLog(ex) {\n    //Change these constants to your own Sentry values if you want to use this script\n    const sentryProjectId = &#039;&lt;Replace-Me-With-Your-Sentry-Project-Id&gt;&#039;\n    const sentryAPIKey = &#039;&lt;Replace-Me-With-Your-Sentry-API-Key&gt;&#039;\n    const sentrySecretKey = &#039;&lt;Replace-Me-With-Your-Sentry-Secret-Key&gt;&#039;\n    //Manually configure our call to Sentry\n    let b = {\n        project: sentryProjectId,\n        logger: &quot;javascript&quot;,\n        platform: &quot;javascript&quot;,\n        exception: {\n            values: [\n                { type: &quot;Error&quot;, value: ((ex) &amp;&amp; (ex.message)) ? ex.message : &#039;Unknown&#039; }\n            ]\n        }\n    }\n    let sentryUrl = `https://sentry.io/api/${sentryProjectId}/store/?sentry_version=7&amp;sentry_client=raven-js%2F3.24.2&amp;sentry_key=${sentryAPIKey}&amp;sentry_secret=${sentrySecretKey}`\n    /**\n     * Fire off a POST request to Sentry&#039;s API, which includes our project\n     * and credentials information, plus arbitrary logging data\n     *\n     * In this case, we&#039;re passing along the exception message,\n     * but you could use this pattern to log anything you want\n     *\n     * Keep in mind that fetch returns a promise,\n     * which is what makes this function compatible with event.waitUntil\n     */\n    return fetch(sentryUrl, { body: JSON.stringify(b), method: &#039;POST&#039; })\n}\n/**\n * Creates a new request for the backend that mirrors the incoming request,\n * with the addition of a new header that specifies which TLS version was used\n * in the connection to the edge\n *\n * This is the main function that contains the core logic for this worker\n *\n * It works by checking for the presence of a property &#039;tlsVersion&#039; that is being forwarded\n * from the edge into the workers platform so that worker scripts can access it\n *\n * The worker starts with a default TLS header. If the tlsVersion property,\n * which represents the version of the TLS protocol the client connected with,\n * is present, the worker sets its local tlsVersion variable to the value of this property\n *\n * It then wraps the incoming request headers in a new headers object,\n * which enables us to append our own custom X-Client-SSL-Protocol header\n *\n * The worker then forwards the original request\n * (overriding the headers with our new headers object) to the origin\n *\n * Now, our application layer can act upon this information\n * to show modals and include deprecation warnings as necessary\n *\n * @returns {Promise}\n */\nasync function requestWithTLSHeader(event) {\n    //It&#039;s strongly recommended that you wrap your core worker logic in a try / catch block\n    try {\n        let tlsVersion = &quot;NONE&quot;\n        //Create a new Headers object that includes the original request&#039;s headers\n        let reqHeaders = new Headers(request.headers)\n        if (event &amp;&amp; event.request &amp;&amp; event.request.cf &amp;&amp; event.request.cf.tlsVersion &amp;&amp; typeof event.request.cf.tlsVersion === &quot;string&quot; &amp;&amp; event.request.cf.tlsVersion !== &quot;&quot;) {\n            tlsVersion = event.request.cf.tlsVersion\n        }\n        //Add our new header\n        reqHeaders.append(&#039;X-Client-SSL-Protocol&#039;, tlsVersion)\n        //Extend the original request&#039;s headers with our own, but otherwise fetch the original request\n        return await fetch(event.request, { headers: reqHeaders })\n    } catch (ex) {\n        /**\n         * Signal the runtime that it should wait until the promise resolves\n         *\n         * This avoids race conditions where the runtime stops execution before\n         * our async Sentry task completes\n         *\n         * If you do not do this, the passthrough subrequest will race\n         * your pending asychronous request to Sentry, and you will\n         * miss many events / fail to capture them correctly\n         */\n        event.waitUntil(promisifiedSentryLog(ex))\n        /**\n         * Intentionally throw the exception in order to trigger the pass-through\n         * behavior defined by event.passThroughOnException()\n         *\n         * This means that our worker will fail open - and not block requests\n         * to our backend services due to unexpected exceptions\n         */\n        throw ex\n    }\n}</pre></code>\n            <p>The above Workers script was updated on 5/17/18 to correct how the Sentry&#39;s API works.</p><h3>Asynchrony, logging and alerts via Sentry</h3><p>We decided to use Sentry to capture events we sent from our worker, but you could follow this same pattern with any similar service.</p><p>The critical piece to making this work is understanding that you must signal the Cloudflare worker runtime that it needs to wait upon your asynchronous logging subrequest (and not cancel it).</p><p>You do this by:</p><ol><li><p>Ensuring that your logging function returns a promise (what your promise resolves to does not matter)</p></li><li><p>Wrapping your call to your logging function in event.waitUntil as we have done above</p></li></ol><p>This pattern fixes a common race condition: if you don&#39;t leverage event.waitUntil, the runtime will race the passthrough subrequest and your logging subrequest.</p><p>If the passthrough subrequest completes significantly faster than your logging subrequest, the logging request could be cancelled. In practice, you&#39;ll notice this issue manifesting as dropped logging messages - whether or not a given exception will be logged properly becomes a roll of the dice on every request.</p><p>For additional insight, check out our <a href=\"https://developers.cloudflare.com/workers/writing-workers/debugging-tips/\">official guide to debugging Cloudflare workers</a>.</p><h3>Failing open to ensure service continuity</h3><p>A key consideration when designing your worker is failure behavior. Depending on what your particular worker is accomplishing, you either want it to fail open or failed closed. Failing open means that if something goes horribly wrong, the original request will be passed through as if your worker did not exist, while failing closed means that a request that raises an exception in your worker will not be processed further.</p><p>If you are editing metadata, collecting metrics, or adding new non-critical HTTP headers, to name a few examples, you probably don&#39;t want an unhandled exception in your worker to prevent the request from being serviced.</p><p>In this case, you can leverage <b>event.passThroughOnException</b> as we have above, and it&#39;s recommended that you call this method in the first line of your fetch event handler. This sets a flag that the Cloudflare worker request handler can inspect in case of an exception to determine the desired passthrough behavior.</p><p>On the other hand, if you&#39;re employing your worker in a security-centric role, tasking it with blocking malicious requests from nefarious bots, or blocking access to sensitive endpoints when valid security credentials are not supplied, you may want your worker to fail closed. This is the default behavior, and it will prevent requests that raise exceptions in your worker from being processed further.</p><p>Our services are in the critical path for our customers, yet our use case was to conditionally add a new HTTP header, so we knew we wanted to fail open.</p><h3>Having your worker generate PagerDuty and Hipchat alerts</h3><p>Now that you&#39;ve done the work to get data from your worker logged to Sentry, you can leverage Sentry&#39;s PagerDuty integration to configure alerts for exceptions that occur in your workers.</p><p>This will increase your team&#39;s confidence in your worker-based solutions, and alert you immediately to any new issues that occur in production.</p><h3>Share your worker recipes</h3><p>You can find additional worker recipes and examples in our <a href=\"https://developers.cloudflare.com/workers/about/\">official documentation</a>.</p><p>Have you written a worker that you&#39;d like to share? <a href=\"mailto:community@cloudflare.com\">Send it to us</a> and you might get featured on our blog or added to our <a href=\"https://developers.cloudflare.com/workers/recipes/a-b-testing/\">Cloudflare worker recipe collection</a> with a credit.</p>",
		"id": "6V3yF64ARlzJBFHFso2V4L",
		"localeList": {
			"name": "Dogfooding Cloudflare Workers Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2018-05-04T17:20:00.000+01:00",
		"slug": "dogfooding-edge-workers",
		"tags": [
			{
				"id": "78aSAeMjGNmCuetQ7B4OgU",
				"name": "JavaScript",
				"slug": "javascript"
			},
			{
				"id": "5x72ei67SoD11VQ0uqFtpF",
				"name": "API",
				"slug": "api"
			},
			{
				"id": "5cye1Bh5KxFh3pKSnX8Dsy",
				"name": "Serverless",
				"slug": "serverless"
			},
			{
				"id": "6hbkItfupogJP3aRDAq6v8",
				"name": "Cloudflare Workers",
				"slug": "workers"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "3JAY3z7p7An94s6ScuSQPf",
				"name": "Developer Platform",
				"slug": "developer-platform"
			}
		],
		"title": "Dogfooding Cloudflare Workers",
		"updated_at": "2024-08-27T02:22:14.805Z",
		"url": "https://blog.cloudflare.com/dogfooding-edge-workers"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}