<div class="mb2 gray5">8 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5Iaz5UkTMNCYyZakvJpVFW/7c1f4202aeff8ed3b4d9001b33ab0e52/Cloudflare-Internship--copy_2x.png" alt="" class="kg-image" width="2048" height="1025" loading="lazy">

	</figure>
	<p>Back in the summer of 2017 I was an intern at Cloudflare. During the scholastic year I was a graduate student working on <a href="https://en.wikipedia.org/wiki/Automorphic_form">automorphic forms</a> and <a href="https://icerm.brown.edu/programs/sp-f15">computational Langlands</a> at Berkeley: a part of number theory with deep connections to <a href="https://en.wikipedia.org/wiki/Representation_theory">representation theory</a>, aimed at uncovering some of the deepest facts about <a href="https://en.wikipedia.org/wiki/Algebraic_number_field">number fields</a>. I had also gotten involved in Internet standardization and security research, but much more on the applied side.</p>
	<p>While I had published papers in computer security and had coded for my dissertation, building and deploying new protocols to production systems was going to be new. Going from the academic environment of little day to day supervision to the industrial one of more direction; from greenfield code that would only ever be run by one person to large projects that had to be understandable by a team; from goals measured in years or even decades, to goals measured in days, weeks, or quarters; these transitions would present some challenges.</p>
	<p>Cloudflare at that stage was a very different company from what it is now. Entire products and offices simply did not exist. <a href="https://www.cloudflare.com/products/argo-smart-routing">Argo</a>, now a mainstay of our offering for sophisticated companies, was slowly emerging. <a href="https://teams.cloudflare.com/access/index.html">Access</a>, which has been helping safeguard employees working from home these past weeks, was then experiencing teething issues. <a href="https://workers.cloudflare.com">Workers</a> was being extensively developed for launch that autumn. <a href="https://blog.cloudflare.com/introducing-quicksilver-configuration-distribution-at-internet-scale">Quicksilver</a> was still in the slow stages of replacing KyotoTycoon. Lisbon wasn’t on the map, and Austin was very new.</p>
	<h3>Day 1</h3>
	<p>My first job was to get my laptop working. Quickly I discovered that despite the promise of using either Mac or Linux, only Mac was supported as a local development environment. Most Linux users would take a good part of a month to tweak all the settings and get the local development environment up. I didn’t have months. After three days, I broke down and got a Mac.</p>
	<p>Needless to say I asked for some help. Like a drowning man in quicksand, I managed to attract three engineers to this near insoluble problem of the edge dev stack, and after days of hacking on it, fixing problems that had long been ignored, we got it working well enough to test a few things. That development environment is now gone and replaced with one built Kubernetes VMs, and works much better that way. When things work on your machine, you can now send everyone your machine.</p>
	<h3>Speeding up</h3>
	<p>With setup complete enough, it was on to the problem we needed to solve. Our goal was to implement a set of three interrelated Internet drafts, one defining secondary certificates, one defining external authentication with TLS certificates, and a third permitting servers to advertise the websites they could serve.</p>
	<p><a href="https://tools.ietf.org/html/draft-ietf-tls-exported-authenticator-11">External authentication</a> is a TLS feature that permits a server or a client on an already opened connection to prove its possession of the private key of another certificate. This proof of possession is tied to the TLS connection, avoiding attacks on bearer tokens caused by the lack of this binding.</p>
	<p><a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2-secondary-certs-05">Secondary certificates</a> is an HTTP/2 feature enabling clients and servers to send certificates together with proof that they actually know the private key. This feature has many applications such as certificate-based authentication, but also enables us to prove that we are permitted to serve the websites we claim to serve.</p>
	<p>The last draft was the <a href="https://tools.ietf.org/html/rfc8336">HTTP/2 ORIGIN frame</a>. The ORIGIN frame enables a website to advertise other sites that it could serve, permitting more connection reuse than allowed under the traditional rules. Connection reuse is an important part of browser performance as it avoids much of the setup of a connection.</p>
	<p>These drafts solved an important problem for Cloudflare. Many resources such as JavaScript, CSS, and images hosted by one website can be used by others. Because Cloudflare proxies so many different websites, our servers have often cached these resources as well. Browsers though, do not know that these different websites are made faster by Cloudflare, and as a result they repeat all the steps to request the subresources again. This takes unnecessary time since there is an established and usable perfectly good connection already. If the browser could know this, it could use the connection again.</p>
	<p>We could only solve this problem by getting browsers and the broader community of TLS implementers on board. Some of these drafts such as external authentication and secondary certificates had a broader set of motivations, such as getting certificate based authentication to work with HTTP/2 and TLS 1.3. All of these needs had to be addressed in the drafts, even if we were only implementing a subset of the uses.</p>
	<p>Successful standards cover the use cases that are needed while being simple enough to implement and achieve interoperability. Implementation experience is essential to achieving this success: a standard with no implementations fails to incorporate hard won lessons. Computers are hard.</p>
	<h3>Prototype</h3>
	<p>My first goal was to set up a simple prototype to test the much more complex production implementation, as well as to share outside of Cloudflare so that others could have confidence in their implementations. But these drafts that had to be implemented in the prototype were incremental improvements to an already massive stack of TLS and HTTP standards.</p>
	<p>I decided it would be easiest to build on top of an already existing implementation of TLS and HTTP. I picked the Go standard library as my base: it’s simple, readable, and in a language I was already familiar with. There was already a basic demo showcasing support in Firefox for the ORIGIN frame, and it would be up to me to extend it.</p>
	<p>Using that as my starting point I was able in 3 weeks to set up a demonstration server and a client. This showed good progress, and that nothing in the specification was blocking implementation. But without integrating it into our servers for further experimentation so that we might &nbsp;discover rare issues that could be showstoppers. This was a bitter lesson learned from TLS 1.3, where it took months to track down a <a href="https://mailarchive.ietf.org/arch/msg/tls/i9blmvG2BEPf1s1OJkenHknRw9c">single brand of printer</a> that was incompatible with the standard, and forced a change.</p>
	<h3>From Prototype to Production</h3>
	<p>We also wanted to understand the benefits with some real world data, to convince others that this approach was worthwhile. Our position as a provider to many websites globally gives us diverse, real world data on performance that we use to make our products better, and perhaps more important, to learn lessons that help everyone make the Internet better. As a result we had to implement this in production: the experimental framework for TLS 1.3 development had been removed and we didn’t have an environment for experimentation.</p>
	<p>At the time everything at Cloudflare was based on variants of NGINX. We had extended it with modules to implement features like <a href="https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details">Keyless</a> and customized certificate handling to meet our needs, but much of the business logic was and is carried out in Lua via OpenResty.</p>
	<p>Lua has many virtues, but at the time both the TLS termination and the core business logic lived in the same repo despite being different processes at runtime. This made it very difficult to understand what code was running when, and changes to basic libraries could create problems for both. The build system for this creation had the significant disadvantage of building the same targets with different settings. Lua also is a very dynamic language, but unlike the dynamic languages I was used to, there was no way to interact with the system as it was running on requests.</p>
	<p>The first step was implementing the ORIGIN frame. In implementing this, we had to figure out which sites hosted the subresources used by the page we were serving. Luckily, we already had this logic to enable server push support driven by Link headers. Building on this let me quickly get ORIGIN working.</p>
	<p>This work wasn’t the only thing I was up to as an intern. I was also participating in weekly team meetings, attending our engineering presentations, and getting a sense of what life was like at Cloudflare. We had an excursion for interns to the Computer History Museum in Mountain View and Moffett Field, where we saw the base museum.</p>
	<p>The next challenge was getting the CERTIFICATE frame to work. This was a much deeper problem. NGINX processes a request in phases, and some of the phases, like the header processing phase, do not permit network I/O without locking up the event loop. Since we are parsing the headers to determine what to send, the frame is created in the header processing phase. But finding a certificate and telling Keyless to sign it required network I/O.</p>
	<p>The standard solution to this problem is to have Lua execute a timer callback, in which network I/O is possible. But this context doesn’t have any data from the request: some serious refactoring was needed to create a way to get the keyless module to function outside the context of a request.</p>
	<p>Once the signature was created, the battle was half over. Formatting the CERTIFICATE frame was simple, but it had to be stuck into the connection associated with the request that had demanded it be created. And there was no reason to expect the request was still alive, and no way to know what state it was in when the request was handled by the Keyless module.</p>
	<p>To handle this issue I made a shared btree indexed by a number containing space for the data to be passed back and forth. This enabled the request to record that it was ready to send the CERTIFICATE frame and Keyless to record that it was ready with a frame to send. Whichever of these happened second would do the work to enqueue the frame to send out.</p>
	<p>This was not an easy solution: the Keyless module had been written years before and largely unmodified. It fundamentally assumed it could access data from the request, and changing this assumption opened the door to difficult to diagnose bugs. It integrates into BoringSSL callbacks through some pretty tricky mechanisms.</p>
	<p>However, I was able to test it using the client from the prototype and it worked. Unfortunately when I pushed the commit in which it worked upstream, the CI system could not find the git repo where the client prototype was due to a setting I forgot to change. The CI system unfortunately didn’t associate this failure with the branch, but attempted to check it out whenever it checked out any other branch people were working on. Murphy ensured my accomplishment had happened on a Friday afternoon Pacific time, and the team that manages the SSL server was then exclusively in London…</p>
	<p>Monday morning the issue was quickly fixed, and whatever tempers had frayed were smoothed over when we discovered the deficiency in the CI system that had enabled a single branch to break every build. It’s always tricky to work in a global team. Later Alessandro flew to San Francisco for a number of projects with the team here and we worked side by side trying to get a demonstration working on a test site. Unfortunately there was some difficulty tracking down a bug that prevented it working in production. We had run out of time, and my internship was over. &nbsp;Alessandro flew back to London, and I flew to Idaho to see the eclipse.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/30sarsTRFHEjBNBnEUxUAO/7bd313870e2fb94a88d546795e16aaac/eclipse-glasses_2x.png" alt="" class="kg-image" width="1884" height="422" loading="lazy">

	</figure>
	<h3>The End</h3>
	<p>Ultimately we weren’t able to integrate this feature into the software at our edge: the risks of such intrusive changes for a very experimental feature outweighed the benefits. With not much prospect of support by clients, it would be difficult to get the real savings in performance promised. There also were nontechnical issues in standardization that have made this approach more difficult to implement: any form of traffic direction that doesn’t obey DNS creates issues for network debugging, and there were concerns about the impact of certificate misissuance.</p>
	<p>While the project was less successful than I hoped it would be, I learned a lot of important skills: collaborating on large software projects, working with git, and communicating with other implementers about issues we found. &nbsp;I also got a taste of what it would be like to be on the Research team at Cloudflare and turning research from idea into practical reality and this ultimately confirmed my choice to go into industrial research.</p>
	<p>I’ve now returned to Cloudflare full-time, working on extensions for TLS as well as time synchronization. These drafts have continued to progress through the standardization process, and we’ve contributed some of the code I wrote as a starting point for other implementers to use. &nbsp;If we knew all our projects would work out, they wouldn’t be ambitious enough to be research worth doing.</p>
	<p><i>If this sort of research experience appeals to you,</i> <a href="https://boards.greenhouse.io/cloudflare/jobs/608495?gh_jid=608495"><i>we’re hiring</i></a>.</p>
</div>