<div class="mb2 gray5">7 min read</div>
<div class="mt4">This post is also available in <a href="https://blog.cloudflare.com/zh-cn/mlops">简体中文</a>, <a href="https://blog.cloudflare.com/ko-kr/mlops">한국어</a> and <a href="https://blog.cloudflare.com/zh-tw/mlops">繁體中文</a>.</div>
<div class="post-content lh-copy gray1">
	<p></p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4GvjtY1dTv1z9QsDBcP5q9/62b26d15bbdf3521ae24bb2fe7e919c9/image1.png" alt="ML Ops Platform at Cloudflare" class="kg-image" width="1999" height="1126" loading="lazy">

	</figure>
	<p>We've been relying on ML and AI for our core services like Web Application Firewall (WAF) since the early days of Cloudflare. Through this journey, we've learned many lessons about running AI deployments at scale, and all the tooling and processes necessary. We recently launched <a href="https://blog.cloudflare.com/workers-ai">Workers AI</a> to help abstract a lot of that away for inference, giving developers an easy way to leverage powerful models with just a few lines of code. In this post, we’re going to explore some of the lessons we’ve learned on the other side of the ML equation: <i>training</i>.</p>
	<p>Cloudflare has extensive experience training models and using them to improve our products. A constantly-evolving ML model drives the <a href="https://blog.cloudflare.com/data-generation-and-sampling-strategies">WAF attack score</a> that helps protect our customers from malicious payloads. Another evolving model powers our <a href="https://blog.cloudflare.com/stop-the-bots-practical-lessons-in-machine-learning">bot management</a> product to catch and <a href="https://blog.cloudflare.com/cloudflare-bot-management-machine-learning-and-more">prevent bot attacks</a> on our <a href="https://blog.cloudflare.com/machine-learning-mobile-traffic-bots">customers</a>. Our customer support is <a href="https://blog.cloudflare.com/using-data-science-and-machine-learning-for-improved-customer-support">augmented by data science</a>. We build machine learning to <a href="https://blog.cloudflare.com/threat-detection-machine-learning-models">identify threats</a> with our global network. To top it all off, Cloudflare is delivering <a href="https://blog.cloudflare.com/scalable-machine-learning-at-cloudflare">machine learning at unprecedented scale</a> across our network.</p>
	<p>Each of these products, along with many others, has elevated ML models — including experimentation, training, and deployment — to a crucial position within Cloudflare. To help our team continue to innovate efficiently, our MLOps effort has collaborated with Cloudflare’s data scientists to implement the following best practices.</p>
	<h3>Notebooks</h3>
	<p>Given a use case and data, the first step for many Data Scientist/AI Scientists is to set up an environment for exploring data, feature engineering, and model experiments. <a href="https://docs.jupyter.org/en/latest/start/index.html">Jupyter Notebooks</a> are a common tool to satisfy these requirements. These environments provide an easy remote Python environment that can be run in the browser or connected to a local code editor. To make notebooks scalable and open to collaboration, we deploy <a href="https://jupyter.org/hub">JupyterHub</a> on Kubernetes. With JupyterHub, we can manage resources for teams of Data Scientists and ensure they get a suitable development environment. Each team can tailor their environment by pre-installing libraries and configuring user environments to meet the specific needs, or even individual projects.</p>
	<p>This notebook space is always evolving as well. Open source projects include further features, such as:</p>
	<ul>
		<li>
			<p><a href="https://nbdev.fast.ai">nbdev</a> - a Python package to improve the notebook experience</p>
		</li>
		<li>
			<p><a href="https://www.kubeflow.org/docs/components/notebooks/overview">Kubeflow</a> - the kubernetes native CNCF project for machine learning</p>
		</li>
		<li>
			<p><a href="https://www.deploykf.org">deployKF</a> - ML Platforms on any Kubernetes cluster, with centralized configs, in-place upgrades, and support for leading ML &amp; Data tools like Kubeflow, Airflow, and MLflow</p>
		</li>
	</ul>
	<h3>GitOps</h3>
	<p>Our goal is to provide an easy-to-use platform for Data Scientists and AI Scientists to develop and test machine learning models quickly. Hence, we are adopting GitOps as our continuous delivery strategy and infrastructure management on MLOps Platform in Cloudflare. GitOps is a software development methodology that leverages Git, a distributed version control system, as the single source of truth for defining and managing infrastructure, application configurations, and deployment processes. It aims to automate and streamline the deployment and management of applications and infrastructure in a declarative and auditable manner. GitOps aligns well with the principles of automation and collaboration, which are crucial for <a href="https://www.cloudflare.com/learning/ai/what-is-machine-learning">machine learning (ML)</a> workflows. GitOps leverages Git repositories as the source of truth for declarative infrastructure and application code.</p>
	<p>A data scientist needs to define the desired state of infrastructure and applications. This usually takes a lot of custom work, but with <a href="https://argo-cd.readthedocs.io/en/stable">ArgoCD</a> and model templates, all it takes is a simple pull request to add new applications. Helm charts and Kustomize are both supported to allow for configuration for different environments and jobs. With ArgoCD, declarative GitOps will then start the Continuous Delivery process. ArgoCD will continuously check the desired state of the infrastructure and applications to ensure that they are synched with the Git repository.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/46I2rJ6bnhsXmVC8f7sK3i/ac3d754e97f936948571ad2578f15339/image2.png" alt="" class="kg-image" width="960" height="464" loading="lazy">

	</figure>
	<p>In the future, we plan to migrate our platform (including Jupyterhub) to <a href="https://www.kubeflow.org">Kubeflow</a>, a machine learning workflow platform on Kubernetes that simplifies the development, deployment, and management of notebooks and end-to-end pipelines. This is best deployed using a new project, <a href="https://www.deploykf.org">deployKF</a>, which allows for distributed configuration management across multiple components available with Kubeflow, and others that extend beyond what is offered within Kubeflow.</p>
	<h3>Templates</h3>
	<p>Starting a project with the right tools and structure can be the difference between success and stagnation. Within Cloudflare, we've curated an array of model templates, which are production ready data science repositories with an example model. These model templates are deployed through production to continually ensure they are a stable foundation for future projects. To start a new project, all it takes is one Makefile command to build a new CICD project in the git project of the users’ choosing. These template utility packages are identical to those used in our Jupyter Notebooks and connections to R2 / S3 / GCS buckets, D1 / Postgres / Bigquery / Clickhouse databases. Data scientists can use these templates to instantly kickstart new projects with confidence. These templates are not yet publicly available, but our team plans to open source them in the future.</p>
	<p><b>1. Training Template</b>Our model training template provides a solid foundation to build any model. This is configured to help extract, transform, and load data (ETL) from any data source. The template includes helper functions for feature engineering, tracking experiments with model metadata, and choose orchestration through a Directed Acyclic Graph (DAG) to productionalize the model pipeline. Each orchestration can be configured to use <a href="https://github.com/airflow-helm/charts">Airflow</a> or <a href="https://argoproj.github.io/argo-workflows">Argo Workflows</a>.</p>
	<p><b>2. Batch Inference Template</b>Batch and micro-batch inference can make a significant impact on processing efficiency. Our batch inference model template to schedule models for consistent results, and can be configured to use <a href="https://github.com/airflow-helm/charts">Airflow</a> or <a href="https://argoproj.github.io/argo-workflows">Argo Workflows</a>.</p>
	<p><b>3. Stream Inference Template</b>This template makes it easy for our team to deploy real-time inference. Tailored for Kubernetes as a microservice using <a href="https://fastapi.tiangolo.com">FastAPI</a>, this template allows our team to run inference using familiar Python in a container. This microservice already has built-in REST interactive documentation with <a href="https://swagger.io">Swagger</a> and integration with Cloudflare Access authentication tokens in <a href="https://developers.cloudflare.com/cloudflare-one/api-terraform/access-with-terraform">terraform</a>.</p>
	<p><b>4. Explainability Template</b>Our model template for explainability spins up dashboards to illuminate the model type and experiments. It is important to be able to understand key values such as a time window F1 score, the drift of features and data over time. Tools like <a href="https://streamlit.io">Streamlit</a> and <a href="https://bokeh.org">Bokeh</a> help to make this possible.</p>
	<h3>Orchestration</h3>
	<p>Organizing data science into a consistent pipeline involves a lot of data and several model versions. Enter Directed Acyclic Graphs (DAGs), a robust flow chart orchestration paradigm that weaves together the steps from data to model, and model to inference. There are many unique approaches to running DAG pipelines, but we have found that data science teams' preference comes first. Each team has different approaches based on their use cases and experience.</p>
	<p><a href="https://github.com/airflow-helm/charts"><b>Apache Airflow</b></a> <b>- The Standard DAG Composer</b>Apache Airflow is the standard as a DAG (Directed Acyclic Graphs)-based orchestration approach. With a vast community and extensive plugin support, <a href="https://blog.cloudflare.com/automating-data-center-expansions-with-airflow">Airflow excels in handling diverse workflows</a>. The flexibility to integrate with a multitude of systems and a web-based UI for task monitoring make it a popular choice for orchestrating complex sequences of tasks. Airflow can be used to run any data or machine learning workflow.</p>
	<p><a href="https://argoproj.github.io/argo-workflows"><b>Argo Workflows</b></a> <b>- Kubernetes-native Brilliance</b>Built for Kubernetes, Argo Workflows embraces the container ecosystem for orchestrating workflows. It boasts an intuitive YAML-based workflow definition and excels in running microservices-based workflows. The integration with Kubernetes enables scalability, reliability, and native container support, making it an excellent fit for organizations deeply rooted in the Kubernetes ecosystem. Argo Workflows can also be used to run any data or machine learning workflow.</p>
	<p><a href="https://www.kubeflow.org/docs/components/pipelines/v2/introduction"><b>Kubeflow Pipelines</b></a> <b>- A Platform for Workflows</b>Kubeflow Pipelines is a more specific approach tailored for orchestrating machine learning workflows. “KFP” aims to address the unique demands of data preparation, model training, and deployment in the ML landscape. As an integrated component of the Kubeflow ecosystem, it streamlines ML workflows with a focus on collaboration, reusability, and versioning. Its compatibility with Kubernetes ensures seamless integration and efficient orchestration.</p>
	<p><a href="https://temporal.io"><b>Temporal</b></a> <b>- The Stateful Workflow Enabler</b>Temporal takes a stance by emphasizing the orchestration of long-running, stateful workflows. This relative newcomer shines in managing resilient, event-driven applications, preserving workflow state and enabling efficient recovery from failures. The unique selling point lies in its ability to manage complex, stateful workflows, providing a durable and fault-tolerant orchestration solution.</p>
	<p>In the orchestration landscape, the choice ultimately boils down to the team and use case. These are all open source projects, so the only limitation is support for different styles of work, which we find is worth the investment.</p>
	<h3>Hardware</h3>
	<p>Achieving optimal performance necessitates an understanding of workloads and the underlying use cases in order to provide teams with <a href="https://blog.cloudflare.com/cloudflares-gen-x-servers-for-an-accelerated-future">effective hardware</a>. The goal is to enable data scientists and strike a balance between enablement and utilization. Each workload is different, and it is important to fine tune each use case for the capabilities of <a href="https://blog.cloudflare.com/bringing-ai-to-the-edge">GPUs</a> and <a href="https://blog.cloudflare.com/debugging-hardware-performance-on-gen-x-servers">CPUs</a> to find the perfect tool for the job. &nbsp;For core datacenter workloads and edge inference, GPUs have leveled up the speed and efficiency that is core to our business. With observability and metrics consumed by <a href="https://prometheus.io">Prometheus</a>, metrics enable us to track orchestration to be optimized for <a href="https://blog.cloudflare.com/getting-to-the-core">performance</a>, maximize hardware utilization, and operate within a Kubernetes-native experience.</p>
	<h3>Adoption</h3>
	<p>Adoption is often one of the most challenging steps in the MLops journey. Before jumping into building, it is important to understand the different teams and their approach to data science. At Cloudflare, this process began years ago, when each of the teams started their own machine learning solutions separately. As these solutions evolved, we ran into the common challenge of working across the company to prevent work from becoming isolated from other teams. In addition, there were other teams that had potential for machine learning but did not have data science expertise within their team. This presented an opportunity for MLops to step in — both to help streamline and standardize the ML processes being employed by each team, and to introduce potential new projects to data science teams to start the ideation and discovery process.</p>
	<p>When able, we have found the most success when we can help get projects started and shape the pipelines for success. Providing components for shared use such as notebooks, orchestration, data versioning (DVC), feature engineering (Feast), and model versioning (MLflow) allow for teams to collaborate directly.</p>
	<h3>Looking forward</h3>
	<p>There is no doubt that data science is <a href="https://blog.cloudflare.com/best-place-region-earth-inference">evolving our business</a> and the <a href="https://blog.cloudflare.com/ai-companies-building-cloudflare">businesses of our customers</a>. We improve our own products with models, and have built <a href="https://blog.cloudflare.com/announcing-ai-gateway">AI infrastructure</a> that can help us <a href="https://www.cloudflare.com/application-services/solutions">secure applications</a> and <a href="https://blog.cloudflare.com/secure-generative-ai-applications">applications built with AI</a>. We can leverage the <a href="https://blog.cloudflare.com/workers-ai">power of our network to deliver AI</a> for us and our customers. We have partnered with <a href="https://blog.cloudflare.com/partnering-with-hugging-face-deploying-ai-easier-affordable">machine</a> <a href="https://www.cloudflare.com/press-releases/2023/cloudflare-partners-with-databricks">learning</a> <a href="https://www.cloudflare.com/press-releases/2023/cloudflare-and-meta-collaborate-to-make-llama-2-available-globally">giants</a> to make it easier for the data science community to deliver real value from data.</p>
	<p>The call to action is this: join the <a href="https://discord.com/invite/cloudflaredev">Cloudflare community</a> in bringing modern software practices and tools to data science. Be on the lookout for more data science from Cloudflare. Help us securely leverage data to help build a better Internet.</p>
</div>