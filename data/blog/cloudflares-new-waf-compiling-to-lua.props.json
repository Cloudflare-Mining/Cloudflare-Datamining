{
	"footerBlurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
	"initialReadingTime": "5",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "John Graham-Cumming",
				"slug": "john-graham-cumming",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5vGNsXzZrtSLn2X30pnpUY/6f350e7dd36058a6422f9199b452bb02/john-graham-cumming.jpg",
				"location": "Lisbon, Portugal",
				"website": null,
				"twitter": null,
				"facebook": null,
				"publiclyIndex": true
			}
		],
		"excerpt": "We use nginx throughout our network for front-line web serving, proxying and traffic filtering. In some cases, we've augmented the core C code of nginx with our own modules, but recently we've made a major move to using Lua in conjunction with nginx.\n\n\nOne project that's now almost entirely written in Lua is the new CloudFlare WAF that we blogged about the other day.\n\n\n\n\n\nThe Lua WAF uses the nginx Lua module to embed Lua code and execute that code as part of the normal nginx handling of phases.",
		"feature_image": "https:undefined",
		"featured": false,
		"html": "<p>We use nginx throughout our network for front-line web serving, proxying and traffic filtering. In some cases, we&#39;ve augmented the core C code of nginx with our own modules, but recently we&#39;ve made a <a href=\"/pushing-nginx-to-its-limit-with-lua\">major move</a> to using Lua in conjunction with nginx.</p><p>One project that&#39;s now almost entirely written in Lua is the new CloudFlare WAF that we <a href=\"/heuristics-and-rules-why-we-built-a-new-old-waf\">blogged about the other day</a>.</p><p>The Lua WAF uses the <a href=\"http://wiki.nginx.org/HttpLuaModule\">nginx Lua module</a> to embed Lua code and execute that code as part of the normal nginx handling of phases. The entire execution of the [WAF](<a href=\"https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf/\">https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf/</a>) is actually handled by the following nginx configuration:</p><p>location / {\nset $backend_waf    &quot;WAF_CORE&quot;;\ndefault_type      &#39;text/plain&#39;;\naccess_by_lua &#39;\nlocal waf = require &quot;waf&quot;\nwaf.execute()\n&#39;;\n}</p><p>The <a href=\"http://wiki.nginx.org/HttpLuaModule#access_by_lua\">access_by_lua</a> directive tells nginx to execute the Lua code shown as an access phase handler. Then the Lua code in the waf module determines whether the request should be blocked or passed to the origin for processing. The waf module terminates by calling <a href=\"http://wiki.nginx.org/HttpLuaModule#ngx.exit\">ngx.exit()</a> with either a 200 (which causes nginx to continue processing the request) or a 403 (to block the request).</p><p>All the real WAF work is done by the waf module which is written in Lua.</p><p>To implement the WAF we wanted to be able to read existing WAF configurations written for the popular <a href=\"http://www.modsecurity.org/\">mod_security</a> open source WAF and support our own simplified WAF language. The mod_security language has to work inside Apache configuration files which leads to it being somewhat hard to read, but there are a large body of rules written using it (such as the popular <a href=\"https://www.owasp.org/index.php/Projects/OWASP_ModSecurity_Core_Rule_Set_Project\">OWASP ruleset</a>) that we wanted to be able to run natively.</p><p>Prior to writing the new WAF we had actually been running Apache alongside nginx just for mod_security, but the combination was slow, cumbersome, and not scalable with CloudFlare&#39;s growing business. We were already working with compromises just to keep it running.</p><p>A rule written in mod_security&#39;s native language might look like the following (this is a slightly obfuscated version of a real custom rule we put in place). The first block of code shows the mod_security version, the second the equivalent in CloudFlare&#39;s own rule language. </p><p>SecRule REQUEST_HEADERS:User-Agent &quot;@beginsWith DataStore/&quot;\n&quot;id:100000,phase:0,t:none,deny,chain,msg:&#39;DataStore Attack&#39;&quot;\nSecRule REQUEST_METHOD &quot;@streq GET&quot; &quot;chain&quot;\nSecRule REQUEST_URI &quot;\\/\\?-?\\d+=-?\\d+&quot; &quot;&quot;</p><p>rule 100000 DataStore AttackREQUEST_HEADERS:User-Agent has-prefix DataStore/ andREQUEST_METHOD is GET andREQUEST_URI matches /?-?\\d+=-?\\d+deny</p><p>We&#39;ll be opening up the ability to write custom rules in either mod_security or CloudFlare style as the WAF rolls out more widely. Most importantly the CloudFlare WAF language is not Lua despite the fact that the WAF is implemented in Lua.</p><p>In fact, the WAF operates by first taking rules written in either mod_security or CloudFlare style and converting them to a common JSON format that encodes the rule and adds additional information used by the WAF UI (such as whether the rule can be disabled or not).</p><p>The JSON format is then compiled into a Lua program that is executed by the WAF. The compilation step allows us to support different input languages (like the two above) and perform optimization so that the WAF executes quickly.</p><p>For example, the compiler performs tasks such as:</p><ul><li><p>Clause reordering so that rules can be quickly skipped if a sub-clause doesn&#39;t match</p></li><li><p>Regular expression optimization and simplification</p></li><li><p>Operator replacement so that fast operators (such as simple string matches) are used where possible</p></li><li><p>Providing hints to the WAF runtime about whether macro expansion is needed.</p></li><li><p>Global optimizations such as recognizing repeated use of the same strings or variables and ensuring that they are computed only once</p></li><li><p>Lua optimizations such as the use of local references to global functions</p></li></ul><p>The rule above ends up as the following Lua code:</p><p>if waf_begins(waf, v3_6, &#39;3_6&#39;, t3_1, &#39;3_1&#39;, &#39;DataStore/&#39;, false) then\nwaf.vars[&#39;RULE&#39;][&#39;ID&#39;] = &#39;100000&#39;\nif waf_eq(waf, v3_7, &#39;3_7&#39;, t3_1, &#39;3_1&#39;, &#39;GET&#39;, false) then\nif waf_regex(waf, v3_4, &#39;3_4&#39;, t3_1, &#39;3_1&#39;, [=[\\/\\?-?\\d+=-?\\d+]=],\nfalse, nil, false) then\nwaf_activate(waf, rulefile)\nwaf_msg(waf, &#39;DataStore Attack&#39;)\nwaf_deny(waf, rulefile)\nend\nend\nend</p><p>The resulting code is hard to read because it&#39;s essentially the WAF&#39;s assembly language and has been automatically generated. The WAF runtime implements functions like waf_begins, waf_eq, and waf_regex that are used to perform rule matching. Those functions themselves are highly optimized.</p><p>The overall goal was to get the median WAF block/allow decision made in &lt;1ms when running in the real world.</p><p>The optimization in the WAF runtime comes from examining the WAF&#39;s performance under a test harness with line-level timing information and from running the WAF in CloudFlare&#39;s network with very detailed <a href=\"http://sourceware.org/systemtap/\">systemtap</a>-based instrumention.</p><p>To get line-level information when running in the test suite we wrote a small line-level code profiler which we use when running the WAF core code against a test set of requests. The profiler, called <a href=\"http://blog.jgc.org/2013/04/lulip-line-level-profiler-for-code.html\">lulip</a>, is an open source project. It outputs information about which lines were called the most frequently and which consumed the most execution time.</p><p>For example, here&#39;s a simplified version of output from a test:</p><p>file:line     count   elapsed (ms)   line\nwr.lua:1129      2         822.455   hash = ngx_sha1_bin(value)\nwr.lua:1172    428         470.849   captures, err = ngx_re_match(v, p)\nwr.lua:1197   3762         207.487   x = string_find(v, f)\nwr.lua:212     157         154.386   string_gsub(v, &quot;//([^/]+)//&quot;, &quot;%1&quot;)\nwr.lua:1196   3788          87.475   for i=1,g() do\nwr.lua:1158   1563          52.906   if not f() then</p><p>It shows that a call to ngx_sha1_bin (which is actually a local Lua reference to the <a href=\"http://wiki.nginx.org/HttpLuaModule#ngx.sha1_bin\">ngx.sha1_bin</a> function in nginx Lua) was called only twice but took 823ms to run. The next most expensive line was line 1172 which took 471ms in total but was called 428 times. Using this detailed information we were able to optimize specific hot spots of code.</p><p>Information from the systemtap or a stack trace is fed into our own pastebin which parses it and automatically produces a <a href=\"http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/\">flame graph</a> showing where the code is running. Hovering over any segment gives information about percentage of time spent in any part of the code.</p><p>Early on in the optimization of the WAF the flame graph quickly showed that extensive used of <a href=\"http://lua-users.org/wiki/MinimisingClosures\">closures</a> was causing slowness because of their cost in <a href=\"http://luajit.org/\">LuaJIT</a>. A change to the compiler removed their use.</p><p>Another view generated from the same information shows the total time spent within a function (ignoring any functions it itself calls). This enables quick identification of hot functions. Here it&#39;s easy to see that regular expression processing and string matching are the most expensive operations (which isn&#39;t surprising given that that&#39;s what the WAF does, mostly).</p><p>Examining these traces we decided that it would be worthwhile <a href=\"http://luajit.org/sponsors.html#sponsorship_perf\">sponsoring improvements</a> to the LuaJIT open source project.</p><p>The key to optimizing the WAF came from two things: repeatable test data and tools for inspecting the code as it ran. The combination of flame graphs and lulip meant that it was possible to make huge leaps in WAF performance by seeing precisely where time was spent. The use of a rule compiler meant that optimizations could be made rapidly to all the rules as needed. There&#39;s no point guessing what&#39;s slow: measure it!</p><p>The resulting code makes extensive use of <a href=\"http://lua-users.org/wiki/OptimisingUsingLocalVariables\">local variables</a> (many of which are automatically generated by the compiler) and memoization. We also use nginx Lua&#39;s cache of loaded Lua code to speed up loading of custom rules and a two stage in-memory cache that uses by <a href=\"http://wiki.nginx.org/HttpLuaModule#ngx.shared.DICT\">lua_shared_dict</a> and memcached for additional loading speed. And our <a href=\"/kyoto_tycoon_with_postgresql\">globally distributed data store</a> means that new rules can be rolled out in seconds.</p><p>And, finally, to measure the operation of the WAF in production we have a global metrics system that gathers metrics about all parts of the CloudFlare network. Here&#39;s a chart showing a few hours of WAF operation; it shows the average time to process a request in microseconds. The WAF is running at between 380us and 480us per request, well within the goal of 1ms.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/66gD4M2c2W91OyMtXNkslf/a3ad0d436ca663704031de25b7f1b4d9/Screen_Shot_2013-08-23_at_4.41.07_PM.png\" alt=\"\" class=\"kg-image\" width=\"787\" height=\"407\" loading=\"lazy\"/>\n            \n            </figure><p>The combination of optimization in the language, the compiler and the WAF core mean that we now have a very fast all Lua WAF that gives us great flexibility and which runs within the core of nginx. This is yet another project that points to Lua being an excellent embedded language in which to write the sorts of scalable logic that CloudFlare needs.</p>",
		"id": "3gZrMOBQqV4feuOtJByVOp",
		"localeList": {
			"name": "CloudFlare's new WAF: compiling to Lua Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"publicly_index": true,
		"published_at": "2013-08-23T06:31:00.000+01:00",
		"slug": "cloudflares-new-waf-compiling-to-lua",
		"tags": [
			{
				"id": "3FBpuRfF7HUFga2Z5jgAFf",
				"name": "NGINX",
				"slug": "nginx"
			},
			{
				"id": "lGCLqAT2SMojMzw5b6aio",
				"name": "WAF",
				"slug": "waf"
			},
			{
				"id": "6QVJOBzgKXUO9xAPEpqxvK",
				"name": "Reliability",
				"slug": "reliability"
			}
		],
		"title": "CloudFlare's new WAF: compiling to Lua",
		"updated_at": "2024-10-10T00:35:40.631Z",
		"url": "https://blog.cloudflare.com/cloudflares-new-waf-compiling-to-lua"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.icon_aria_label": "Search",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"search.result_stat_empty": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong>",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"search.autocomplete_title": "Insert a query. Press enter to send",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}