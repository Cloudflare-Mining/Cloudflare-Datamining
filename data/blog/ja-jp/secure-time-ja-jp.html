<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2019/06/time-service@3x-1.png" class="kg-image"></figure>
	<p>Cloudflareは、セキュリティの不十分なインターネットプロトコルにセキュアなバージョンを展開し、誰でもそれを無料で利用できるようにすることで業界をリードしてきました。2014年には、既存の無料HTTPプランで利用いただける、世界初の無料でセキュアなHTTPSサービス（<a href="https://blog.cloudflare.com/introducing-universal-ssl/">Universal SSL</a>）を立ち上げました。<a href="https://blog.cloudflare.com/announcing-1111/">1.1.1.1 DNS リゾルバー</a>を提供開始したとき、新しいセキュアなバージョンのDNS（<a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/" target="_blank">DNS over HTTPS</a>と<a href="https://developers.cloudflare.com/1.1.1.1/dns-over-tls/" target="_blank">DNS over TLS</a>）もサポートしました。今日は、<a href="https://blog.cloudflare.com/welcome-to-crypto-week-2019/">暗号ウィーク2019</a>の一環として、インターネット上で時刻値を取得するためのプロトコルとして主に利用されているNetwork Time Protocol（NTP）についても同じことを行います。</p>
	<p>この発表は、私にとって意味深いものです。過去 4 年間、私はタイムプロトコルの脆弱性を特定し、修正してきました。今日、2015年から2019年まで非常に苦労して取り組んだサービスの導入のお手伝いできることを誇りに思います。<a href="https://cloudflare.com/time" target="_blank">time.cloudflare.com</a>は、NTP保護のための新しいNetwork Time Security（NTS）プロトコルとNTPの両方をサポートする無料の時刻情報提供サービスです。今では、世界180都市のすべてのデータセンターから安全に時刻を取得することができます。</p>
	<p>NTSのクライアントがまだ開発中ですが、<a href="https://cloudflare.com/time" target="_blank">NTP</a>で今使っているすべてのデバイスの時刻のソースとしてtime.cloudflare.com が使用できます。<a href="https://blog.ntpsec.org/2019/01/02/starting-nts.html" target="_blank">NTPsec</a>にはNTSの実験的なサポートが含まれています。NTSクライアントの開発に関する最新情報を入手するには、<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1e6a77737b336d7b6c68777d7b6d5e7d72716b7a78727f6c7b307d7173">[email&nbsp;protected]</a>まで参加希望のメールを送信してください。NTS を使用して時刻の同期を保護するには、業者に連絡してNTSサポートについて問い合わせてください。</p>
	<h3 id="-"><strong>まずは「時刻」の小さな物語</strong></h3>
	<p>2015年、私はインターネットセキュリティに興味を持つ大学院の新入生として、<a href="https://tools.ietf.org/html/rfc5905" target="_blank">Network Time Protocol</a>（NTP）と呼ばれる、その大部分が難解なインターネットプロトコルに出会いました。NTP は、信頼性が低い可変レイテンシーのネットワークパスを介して通信するコンピュータシステム間で時刻を同期するように設計されていました。本来はインターネットルーティングセキュリティ、特にリソース公開鍵基盤（<a href="https://blog.cloudflare.com/rpki/">RPKI</a>）に対する攻撃を研究していましたが、キャッシュフラッシュングの問題で壁にぶつかり続けていました。最後の手段として、マニュアルでコンピュータ上の時刻をロールバックすることを決め、そうすると攻撃がうまくいきました。</p>
	<p>私はコンピューターセキュリティにとっての時刻の重要性を発見しました。ほとんどの暗号化では、タイムスタンプを使用して証明書と署名の有効期間を制限します。Webサイトに接続する場合、正しい時刻を知ることで、表示される証明書が最新であり、攻撃者によって侵害されていないことが保証されます。ログを確認する時、時刻同期によって、異なるマシン上のイベントを正確に関連付けることができます。証明書とログインフラストラクチャは、数分、数時間、または数か月の時差で破損します。キャッシュやビットコインなどの他のアプリケーションは、きっちりと秒のオーダーでわずかな違いに敏感です。</p>
	<p>ローリング番号を使用した2要素認証も、正確なクロックに依存します。これにより、コンピュータのクロックが、セキュアに配信される充分正確な時刻にアクセスできる必要が生じます。NTPは、インターネット上の時刻同期に最も一般的に使用されるプロトコルです。攻撃者が NTPの脆弱性を利用してコンピュータクロックの時刻が操作できてしまうと、これらのシステムが提供するセキュリティ保証を損なう可能性があります。</p>
	<p>私は、問題の深刻さに突き動かされて、NTPとそのセキュリティを深く調べることにしました。ネットワーク間で時刻を同期する必要性は早い段階で認識されており、NTPは非常に古いプロトコルです。NTPの最初の標準化版は 1985年にさかのぼり、最新のNTP バージョン4は 2010 年に完成しました（<a href="https://tools.ietf.org/html/rfc5905" target="_blank">RFC5905</a>参照）。</p>
	<p>最も一般的なモードでは、NTPがクライアントにNTPサーバーへクエリパケットを送信させて、NTPサーバーにクロック時間で応答させることによって機能します。次に、クライアントは自分のクロックとリモートクロックの差を計算して推定し、この中のネットワーク遅延を補正しようとします。NTPクライアントは複数のサーバーに対してクエリを実行し、アルゴリズムを実装して最適な見積もりを選択し、明らかに間違った回答を拒否します。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2019/06/VGltZSBoYW5kc2hha2UgLnBuZw--.png" class="kg-image"></figure>
	<p>驚くべきことに、NTPとそのセキュリティに関する研究は、当時あまり活発に行われませんでした。この前に、2013年後半から2014年初頭には、NTPサーバーからのトラフィックを増幅する、分散サービス拒否（DDoS）攻撃が注目を集めました。攻撃者は、被害者のIPアドレスを偽装することができ、大量のトラフィックを流入させることで対象ドメインを圧倒させました。そこに注目する研究者もいました。しかし、これらの攻撃は基本的なプロトコル設計の欠陥を悪用したものではありませんでした。攻撃者は単に退屈な帯域幅増幅機能としてのNTPを使用したのです。Cloudflareは、こうした攻撃について広範囲に記述しました。<a href="https://blog.cloudflare.com/understanding-and-mitigating-ntp-based-ddos-attacks/">ここ</a>と<a href="https://blog.cloudflare.com/technical-details-behind-a-400gbps-ntp-amplification-ddos-attack/">ここ</a>、それから<a href="https://blog.cloudflare.com/good-news-vulnerable-ntp-servers-closing-down/">ここ</a>で読むことができます。</p>
	<p>私は、NTPプロトコルの設計と実装にいくつかの弱点を見つけました。こうした弱点を利用して、ネットワーク攻撃者が、時間を書き換えたりNTPクライアントへのサービスを拒否することで、もっと壊滅的な攻撃を展開することが可能です。さらに懸念されるのは、この攻撃者がこうした攻撃を仕掛けるために、クライアントとサーバー間のトラフィックを変更できる<em>中間者（MITM）である必要がない</em>ことです。我々のメンバーが最近執筆した一連の<a href="https://www.cs.bu.edu/~goldbe/papers/NTPattack.pdf" target="_blank">論文</a>で、ネットワーク上のどこかに存在するオフパスの攻撃者が時間を書き換えたり、NTPクライアントへのサービスを拒否することが可能であることが示されました。これを行う方法の1つは、IPフラグメンテーションを悪用することです。</p>
	<p>フラグメンテーションとは、大きなパケットをサポートしないネットワークを通過できるように、大きなパケットを複数の小さなフラグメントに切り分けるIP層の機能です。基本的に、クライアントとサーバーの間のパス上にあるランダムなネットワーク要素は、「<a href="https://en.wikipedia.org/wiki/Path_MTU_Discovery" target="_blank">ICMPフラグメンテーション要</a>」と、何バイトかにパケットを断片化するように指示を出す特別なパケットをサーバーに送信することができます。サーバーはパス上にあるすべてのネットワーク要素のIPアドレスを知っているとは限らないので、このパケットはどの送信元 IPからでも送信できます。</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2019/06/time-fragmentation-attack-@2x.png" class="kg-image">
		<figcaption>NTPに対する断片化攻撃</figcaption>
	</figure>
	<p>我々の攻撃では、攻撃者はこの機能を利用して、NTPサーバーに、被害者のNTPクライアント用のNTP応答パケットを断片化させます。次に、攻撃者は自分のタイムスタンプ値を含むオフパスから、重複する応答フラグメントを慎重に細工して偽装します。重複するフラグメントに対する再構成ポリシーをさらに悪用することで、攻撃者はクライアントを騙して正当なフラグメントと攻撃者の挿入を含むパケットを組み立てさせます。これにより、パケットの元来の部分の値に依存する信憑性チェックが回避されます。</p>
	<h3 id="ntp-"><strong>NTPの過去と未来</strong></h3>
	<p>1985年にNTPが創設された当時、NTPが提供するサービスには主要な設計目標が2つありました。1つ目の目標は、ネットワークエラーや機器の故障に対応できる堅牢性を持たせることでした。そのため、NTPはクライアントが複数の通信パスを介して複数のピアからタイミングサンプルを収集し、それらを平均化してより正確な測定を行うことができるサービスを設計しました。</p>
	<p>2つ目の目標は負荷分散です。どのクライアントも、原子時計、GPSなどの高精度の時刻維持デバイスに直接接続され、より正確な時刻を持つタイムサーバーと通信しようとしますが、デバイスの容量も限られています。そこで、ネットワーク上のプロトコルの負荷を軽減するために、サービスを階層的に設計しました。NTP以外のタイムソースに接続されたサーバーが階層の最上位にあり、他のサーバーに時間を分散し、さらに多くのサーバーに時間を分散します。ほとんどのコンピュータが、これらの第 2レベルまたは第 3 レベルのサーバーに接続します。</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2019/06/time-stratum-@2x.png" class="kg-image">
		<figcaption>NTP のStratumとよばれる階層</figcaption>
	</figure>
	<p>元の仕様（<a href="https://tools.ietf.org/html/rfc958" target="_blank">RFC 958</a>）には、プロトコルの「非目標」、つまりピア認証とデータ整合性も示されています。比較的小規模で信頼できる初期のインターネットでは、セキュリティはそれほど重要視されておらず、セキュリティに時間を費やすプロトコルやアプリケーションは存在しませんでした。NTPのセキュリティ保護は、プロトコルと実装の改善の二の次でした。</p>
	<p>インターネットが成長するにつれて、ますます多くのコアインターネットプロトコルが、不正行為から保護するために、暗号化によって保護されるようになりました。TLS、DNSSEC、RPKI はすべて、インターネット上のすべての通信のセキュリティを確保するための手順です。これらのプロトコルは、セキュリティ保証を提供するために「時間」を使用します。インターネットのセキュリティは NTPのセキュリティにかかっているため、NTPのセキュリティを確保することがさらに重要になります。</p>
	<p>この研究で、NTPをセキュアにする必要性が明確に示されました。その結果、インターネットプロトコルの標準化機関であるインターネット技術特別調査委員会（IETF）において、暗号化認証に向けた動きが進みました。当時、NTPv4は対称暗号方式認証と非対称暗号方式認証の両方をサポートしていましたが、両者ともに限界があり、実際に使用されることはほとんどありませんでした。</p>
	<p>同期をセキュリティで保護する NTPv4 の対称方式は、対称鍵が事前共有鍵で、かつ手動での設定が必要であるため規模拡大ができません。全クライアントがそれぞれ、時刻を取得したいサーバーと特殊な秘密鍵を必要としたとしたら、こうしたサーバーを実行する組織は、鍵の管理に大量の作業をしなければならなくなるのです。そしてこのソリューションは、どのクライアントからのクエリも受け入れる必要があるパブリックサーバーにとって非常に負担が大きくなります。ＮISTの場合、重要な公開タイムサーバーを運営し、年に1回米国郵便またはファクシミリを介して登録するユーザーにのみ対称鍵を配布します。米海軍事務所でも同様のことを行っています。</p>
	<p>鍵配布の問題を解決する最初の試みは、<a href="https://tools.ietf.org/html/rfc5906" target="_blank">RFC 5906</a>で説明されている、Autokeyプロトコルでした。多くの公開NTP サーバーは、Autokeyをサポートしません（例: NISTとUSNOタイムサーバー、pool.ntp.orgの多くのサーバー）。ネットワーク攻撃者がクライアントとサーバーの間で共有される秘密鍵を簡単に取得できるため、プロトコルは完全に<a href="https://www.semanticscholar.org/paper/Analysis-of-the-NTP-Autokey-Procedures-R%C3%B6ttger/a1781712cec129d5c7311a915e4d0076117ee33f" target="_blank">崩壊</a>しています。認証メカニズムは非標準で非常に特異性があります。</p>
	<p>インターネットの未来は、セキュアなインターネットです。つまり、認証されていて暗号化もされているインターネットです。しかしこれまで、プロトコル開発が続いているにもかかわらず、NTPのセキュリティは低いままです。その間に、それに依存するサービスがどんどん増えています。</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2019/06/timeline-@2x.png" class="kg-image">
		<figcaption>NTP開発の経緯</figcaption>
	</figure>
	<h3 id="--1"><strong>問題の修正</strong></h3>
	<p>論文の発表後、NTPコミュニティ内ではインターネットプロトコルの標準化機関、インターネット技術特別調査委員会（IETF）において、またNTPコミュニティ外でも、NTPセキュリティの状態を改善することへの関心が高まりました。短期的な修正として、ntpd リファレンス実装ソフトウェアに、我々が見つけたいくつかの脆弱性に対するパッチが適用されました。また、長期的なソリューションのために、コミュニティは公開鍵暗号に基づく安全で認証された時刻同期プロトコルの必要性を認識しました。これがあれば、事前に鍵材料を共有することなく、暗号化と認証が可能になります。今日、NTPワーキンググループの数十人の熱心な方々の努力のおかげで、IETFにおいて<a href="https://tools.ietf.org/html/draft-ietf-ntp-using-nts-for-ntp-19" target="_blank">Network Time Security </a>（NTS）のドラフトが検証されています。</p>
	<p>簡単に言うと、NTSプロトコルは 2フェーズに分けられます。最初のフェーズは、NTP クライアントとサーバーの間に必要な鍵材料を確立するNTS鍵交換です。このフェーズでは、Transport Layer Security (TLS) ハンドシェイクを使用し、Webと同じ公開鍵基盤に依存します。鍵が交換されると、TLS チャネルが閉じられ、プロトコルは第2フェーズに入ります。このフェーズでは、そのTLSハンドシェイクの結果を使用して、拡張フィールドを介したNTP時刻同期パケットを認証します。ご興味があれば、インターネット版<a href="https://datatracker.ietf.org/doc/draft-ietf-ntp-using-nts-for-ntp/" target="_blank">ドラフト</a>で詳細情報をご確認いただけます。</p>
	<h3 id="cloudflare-"><strong>Cloudflareの新サービス</strong></h3>
	<p>今日、Cloudflareはインターネット上のどなたでも無料で利用できる、時刻情報提供サービスを発表します。特に可用性、堅牢性、セキュリティを向上させることで、既存の公開時刻情報提供サービスの制約を解決する予定です。</p>
	<p>グローバルネットワークを使用して、レイテンシーと精度における優位性を提供します。世界180か所すべてにおいてエニーキャストを利用しており、自動的に最も近いサーバーにパケットをルーティングします。私たちのすべてのサーバーは、他の公開 NTPプロバイダの機能と同様に、Stratum 1 時刻情報提供サービスプロバイダと同期され、一般のユーザーに NTPを提供します。時刻同期プロトコルが不正確になる最大の原因は、ネットワークの非対称性であり、クライアントとサーバー間の移動時間とサーバーからクライアントへの移動時間の違いにつながります。一方で、当社のサーバーはユーザーに近接しているため、ネットワーク上でのレイテンシーの分散の測定値であるジッターと、パケットパスの非対称性の可能性が少なくなります。また、NTPサーバーが不足している地域では、私たちのサービスがNTPエコシステムの容量と品質を大幅に向上させることを期待しています。</p>
	<p>Cloudflareサーバは、Stratum 1 アップストリームサーバーとの共有対称キーを使用して認証された時刻値を取得します。これらのアップストリームサーバーを各地に配置しており、当社のサーバーがデータセンターで保有する時間が正確であることを確認します。しかし、時間を確保するためのこのアプローチは規模拡大ができません。Stratum 1 サーバーを実行する組織と個別にメールを交換し、それらを使用する許可をネゴシエートする必要がありました。当社にとっては解決策ですが、インターネット上の人全員にとっての解決策ではありません。</p>
	<p>セキュアな時刻情報提供サービスプロバイダとして、CloudflareはNetwork Time Securityにおいて無料で安全な公開時刻情報提供サービスを提供する先駆者であることを誇りに思っています。最新の<a href="https://datatracker.ietf.org/doc/draft-ietf-ntp-using-nts-for-ntp/" target="_blank"> NTS IETF ドラフト</a>を実装しました。このドラフトが順次インターネット標準のプロセスを経て仕上げられるのに従い、私たちはサービスを最新の状態に保つことに全力を上げています。</p>
	<p>現在、ほとんどの NTP 実装は NTS サポートに取り組んでおり、今後数か月ほどで広範な導入と現在のドラフトプロトコルのRFCへの進展が見込まれています。現在、NTS の<a href="https://tools.ietf.org/html/draft-ietf-ntp-using-nts-for-ntp-18" target="_blank">ドラフト18</a>を実装している NTPsec と相互運用性があります。当社のサービスがインターネットセキュリティに対する、この重要な改善の採用を加速させるものになることを望んでいます。これは後方互換性の要件を持たない新しいサービスであるため、TLS v1.3 を使用して TLS の最もセキュアなバージョンの採用を促進する必要があります。</p>
	<h3 id="--2"><strong>ぜひご利用ください</strong></h3>
	<p>NTS クライアントをお持ちの場合は、time.cloudflare.com:1234 を指定してください。それ以外の場合は、NTP クライアントをtime.cloudflare.comに指定します。構成の詳細については、<a href="https://developers.cloudflare.com/time-services/" target="_blank">開発者ドキュメント</a>を参照してください。</p>
	<h3 id="--3"><strong>まとめ</strong></h3>
	<p><a href="https://developers.cloudflare.com/roughtime/docs/" target="_blank">Roughtime</a>サービスから<a href="https://blog.cloudflare.com/introducing-universal-ssl/">Universal SSL</a>まで、Cloudflareはセキュアなプロトコルの可用性と利用を拡大する役割を果たしてきました。今、私たちの無料の公開時刻情報提供サービスで、セキュアでないレガシープロトコルに代わる、信頼できて広く利用可能な代替手段を提供します。すべての人にとってより速く、信頼性が高く、より安全なインターネットの構築を支援するという私たちの使命の一部です。<br></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/06/crypto-week-2019-header-circle@2x-3.png" class="kg-image"></figure>
	<p><em>このプロジェクトに参加してくださった</em><a href="https://github.com/wbl/" target="_blank"><em>Watson Ladd</em></a><em>、</em><a href="https://blog.cloudflare.com/author/gabbi/"><em>Gabbi Fisher</em></a><em>、</em><a href="https://blog.cloudflare.com/author/dina/"><em>Dina Kozlov</em></a>を始め、多くのエンジニアのみなさま、ありがとうございました。</p>
	<hr>
	<p><em>本投稿は、ボストン大学の大学院研究助手で、Cloudflareの暗号化チームの元インターンである</em><a href="https://scholar.google.com/citations?user=WVff3wsAAAAJ" target="_blank"><em>Aanchal Malhotra</em></a><em>氏が行いました。</em></p>
</div>