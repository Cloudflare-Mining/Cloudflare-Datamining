<div class="mb2 gray5">5 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/09/image2-48.png" class="kg-image" alt="The future of Page Rules" loading="lazy"></figure>
	<p>ページルールは、最もよく使われている製品の一つです。数百万人のユーザーに採用され、キャッシュからセキュリティレベルまであらゆる設定に使用されています。これはCloudflareの「If This Then That」（IFTTT）です。「If...」はURLで、「Then That」は「ゾーン」の特定の部分へのトラフィックを処理する方法を変更するものです。しかし、限界がないわけではありません。</p>
	<p>ページルールは、URLまたはURLパターンにのみトリガーすることができます。1つのゾーンにつき、最大125のページルールを設定することができます。また、ページルールはデバッグが面倒です。「ページ」という言葉も、今ではかなり古くさく聞こえます。</p>
	<p>私たちはページルールを4つの新しい専用の製品に置き換えることで、ルール枠の拡大、機能性の向上、粒度の向上を実現しました。これらの製品は、すぐにでも試験的に使用することが可能です。ページルールはまだ廃止されていませんが、近々正式に廃止手続きの開始を見込んでいます。</p>
	<h3 id="-">なぜ変えるのか？</h3>
	<p>ページルールは<a href="https://blog.cloudflare.com/introducing-pagerules-fine-grained-feature-co">発売</a>から10年の間にすっかり定着し、広く採用されている製品になりました。ページルールは、過去3ヶ月間だけでも<em>100万</em>もの数が導入されました。</p>
	<p>ページルールは、ファイルのキャッシュ期間を調整するために使用されます。ページルールは、特定のURLのゾーン全体の設定を上書きするために使用されます。ページルールは、単純なURLリダイレクトを作成するために使用されます。ページルールは、HTTPヘッダーを選択的に追加／削除するために使用されます。ページルールは、製品の<em>十徳ナイフ</em>です。</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2022/09/image3-33.png" class="kg-image" alt="" loading="lazy">
		<figcaption>Photo by <a href="https://unsplash.com/@zelebb?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Andrey Matveev</a> on <a href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Unsplash</a></figcaption>
	</figure>
	<p>十徳ナイフやその他の万能製品のように、ページルールは多くのことに「適した」機能性を発揮しますが、何に対してもベスト・オブ・ブリードというわけではありません。これには、一般論で言うトレードオフがあります。私たちは企業として成長するにつれ、お客様からは当然のように、より多くを要求されるようになりました。URLだけのフィルタリングではもはや不十分であり、ユーザーからはより多くの要求があります。そして現在私たちはそれを実現しています。</p>
	<p>この2年間、私たちはページルールの将来について考え、何百ものフィードバックから、次のような共通のテーマを抽出してきました。</p>
	<ol>
		<li>125以上のページルールが欲しい</li>
		<li>URL以外からもページルールをトリガーできるようにして欲しい</li>
		<li>ページルールで正規表現を使用できるようにして欲しい</li>
		<li>異なるページルールが互いにどのように影響し合っているのか理解するのが難しい</li>
		<li>ページルールのデバッグが難しい</li>
		<li>ページルール内のアクションを増やして欲しい</li>
	</ol>
	<p>これらのテーマを分析した結果、ページルールにとって最良のことは、ページルールを分解して、それぞれが関連する分野でベスト・オブ・ブリードとなるような新しい個別製品を作ることであるとの結論に至りました。このように分解することで、相互運用（キャッシュ、コンフィギュレーション、...）がより明確になり、デバッグもより簡単になります。</p>
	<p>本日、これらの新製品を以下に紹介します：</p>
	<p><strong>1.Cache Rules</strong>：「すべてのキャッシュ」を設定および調整するための専用製品。</p>
	<p><strong>2.Configuration Rules</strong>：ゾーン全体の設定を行い、選択的に有効化、無効化、上書きするための専用製品。</p>
	<p><strong>3.Dynamic Redirects</strong>：「転送先URL」のようなものですが、上限が11に変わりました。訪問者の国、好んで使用する言語、デバイスの種類、正規表現の使用（プランレベルによる）などに基づいてリダイレクトします。</p>
	<p><strong>4.Origin Rules</strong>：「Cloudflareを離れた後のトラフィックの向かう先」専用の製品です。この新製品（ENTのみ）は、ホストヘッダを追加してオーバーライドを解決するだけでなく、お客様が宛先ポートを選択的にオーバーライドできるようにすることで、別の一般的なWorkersの使用事例も製品化されました。また、サーバー名表示（SNI）を上書きする機能も追加されました。</p>
	<p>現在、これら4つの製品はすべて、ダッシュボード、API、Terraformを通じて利用可能であり、Transform Rulesと並んで、最終的にページルールの廃止を告知できる代替製品群として提供しています。</p>
	<p>当社ではそれぞれの製品に対する専用ブログを用意しており、提供する機能やどのような問題に対処できるかについてのより詳細な情報を提供しています。</p>
	<h3 id="--1">実行順序</h3>
	<p>この新しい製品群の主な利点のひとつは、そのわかりやすさです。</p>
	<p>ページルールは、トラフィックが入り、「何かが起こり」、トラフィックが出てくる、といったブラックボックスです。キャッシュ、設定、ヘッダーの変更などで行われたやりとりの内容をデバッグするのは難しく、また、完全にユーザー定義であるため、ゾーンごとに異なる可能性があります。</p>
	<p>「機能」ごとに領域が分かれていることで、HTTPリクエストの流れをより簡単に可視化することができます。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/09/image1-58.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>ページルールのように一塊ではなく、最初にオリジンルールが実行され、次にキャッシュルール、コンフィギュレーションルール、最後に動的リダイレクトが実行されるという動きを可視化できるようになりました。 つまり、キャッシュの設定を調整する前に、まずホストヘッダを変更することになります。また、特定のトラフィックに対して有効にする設定を変更する前に、キャッシュのパラメータを調整します。</p>
	<p>また、これらの新製品は、<a href="https://blog.cloudflare.com/traffic-sequence-which-product-runs-first">Traffic Sequence</a>のダッシュボードの要素にも統合されています。</p>
	<p>（ページルールとこの新しい製品群の両方を使用しているゾーンの場合、新しい製品がページルールよりも優先されます。つまり、競合が発生した場合、ページルールは上書きされることになります）。</p>
	<h3 id="125-">125以上のページルールが欲しい</h3>
	<p>ページルールの制約のひとつは、各ページルールのバックエンドアーキテクチャへの保存と実行方法にありました。余分な負荷がかかるため、ゾーンごとに125を超えるページルールを提供することはできません。ページルールとリクエストとの比較評価に時間がかかり、HTTPリクエストの待ち時間が長くなってしまいます。この制限に対処するため、ユーザーは単純なワークロードをWorkersに移動させたり、ゾーンを複数のサブドメインに分割して、それぞれに125のページルールの枠を持たせたりしています。どちらもお客様が理想的とするものではありません。</p>
	<p>この制限に対処するために、私たちは<em>すべての</em>代替製品を、Transform Rules、Custom Rules（WAF）、Bulk Redirect、API Shieldなどの製品を実行する、当社が誇る超高速の<a href="https://developers.cloudflare.com/ruleset-engine/about/rulesets" target="_blank">ルールセットエンジン</a>の上に構築しました。</p>
	<p>このエンジンは、1製品あたり125ルールをはるかに超える拡張性を持つように構築されているため、お客様に、より多くの枠を提供することができます。以下の表は、これらの新製品がもたらす影響の前と後をまとめたもので、プランごとの既定のルールの枠数を示しています。</p><!--kg-card-begin: html-->
	<table>
		<thead>
			<tr>
				<th>Plan</th>
				<th>Page Rules</th>
				<th>Origin Rules</th>
				<th>Cache Rules</th>
				<th>Config Rules</th>
				<th>Dynamic Redirects</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Enterprise</td>
				<td>125</td>
				<td>125+</td>
				<td>125+</td>
				<td>125+</td>
				<td>125+</td>
			</tr>
			<tr>
				<td>Business</td>
				<td>50</td>
				<td>50</td>
				<td>50</td>
				<td>50</td>
				<td>50</td>
			</tr>
			<tr>
				<td>Pro</td>
				<td>20</td>
				<td>25</td>
				<td>25</td>
				<td>25</td>
				<td>25</td>
			</tr>
			<tr>
				<td>Free</td>
				<td>3</td>
				<td>10</td>
				<td>10</td>
				<td>10</td>
				<td>10</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<p><em>これらの新製品は、追加ルールの購入ができません。</em></p>
	<p>そのため、Enterpriseプランのゾーンは、これまで125個のページルールでしたが、最低でも<strong>500</strong>個のルールを使用することができるようにしています。Enterpriseプランで使用できる新製品の枠数は交渉可能です。Proプランのゾーンでは、使用できるページルールは、20～100個になります。これらの変更により、ルールセットエンジンが提供するきめ細かな制御と組み合わせることで、お客様はゾーンのトラフィックを細部までカスタマイズすることができます。</p>
	<p>これらすべての製品をこのルールセットエンジンの上に構築するもう一つのメリットは、拡張性です。現在、このルールセットエンジン上で構築・稼働している製品は30を超えます。これらの製品は、基本的に「フェーズ」と呼ばれる論理的なバケットであり、その製品に対応する単一のルールセットを含んでいます。各フェーズは、特定のアクションとフィールドに制限されます。例えば、http_request_transformでは、URL書き換え時にボットスコアを計算していないため、cf.bot_management.scoreというフィールドは使用できません。また、許可されるアクションは「<code>rewrite</code>」のみです。一方、当社がOrigin Rules（http_request_origin）に許可しているアクションは「<code>route</code>」のみです。</p>
	<p>ルールセットエンジンの上に構築された製品に作成された新しい機能は、後日、他の製品に拡張することが非常に簡単です。</p>
	<p>一例として、私たちは今年の初めにTransform Rulesに新しく<a href="https://developers.cloudflare.com/ruleset-engine/rules-language/fields" target="_blank">「field」</a>、「<code>http.request.accepted_languages</code>」を追加しました。最近まで、これはTransform Rulesでしか使えませんでした。しかし、両製品は<a href="https://developers.cloudflare.com/ruleset-engine/about/rulesets" target="_blank">Rulesets Engine</a>の上に構築されているため、Dynamic Redirectsのような他の製品でこの機能を有効にするのは簡単でした。これは、フィールドが既に実装されているため、お客様が訪問者の言語設定に基づいてURLリダイレクトを実行することを可能にし、エンジニアリングの観点から見た場合の私たちへのコストはごくわずかです。</p>
	<p>また、将来的にお客様のご要望により、Cache Rulesに新しいフィールドが作成された場合、例えば、以下のようになります。http.request.super_cool_fieldを使えば、複数のプラットフォームで重複した作業をすることなく、クリック数回で他の30製品にもこのフィールドを有効にすることが可能です。</p>
	<p>つまり、Rulesets Engineの上に多くの製品を作れば作るほど、より速く、より多くの機能をユーザーに届けることができるのです。</p>
	<h3 id="--2"><strong>シングルユーザーエクスペリエンス</strong></h3>
	<p>最も特筆すべき利点は一貫性です。これらの製品には、一貫性のある予測可能なAPIがあります。一貫性のある予測可能なTerraformの設定と、ダッシュボードでの一貫性のある予測可能なユーザーエクスペリエンス。ルールセットエンジンを使用すると、「アクション」以外はすべて同じ状態に維持することができます。フィルタリングはそのまま、APIもそのまま、UIも（ほぼ）そのままで、ルールのアクション部分である「...then」だけが唯一の変更点です。</p>
	<p>これにより、ユーザーがダッシュボードをクリックして新しいゾーンを設定する際に、個々の製品のページとその操作方法を学ぶ必要がなくなります。学ぶ必要があるのは、その製品の特徴である、<em>アクション</em>だけです。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/09/image4-15.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>最後に、新しい製品を追加するとき、それをサポートするためにTerraformプロバイダを拡張するのは些細なことです。その一貫した経験が、今回のプロジェクトでも、そして将来のプロジェクトでも、私たちの進むべき道を示す羅針盤となるでしょう。</p>
	<h3 id="--3">今すぐ試す</h3>
	<p>ページルールは新しい製品スイートで置き換えられます。新しいスイートの各製品がベスト・オブ・ブリードの一助となり、より多くの機能を提供するよう設計されています。新製品については、それぞれの専用ブログで詳しくご紹介しています。是非ご自身で<a href="https://dash.cloudflare.com/?to=%2F%3Aaccount%2F%3Azone%2Frules%2F" target="_blank">体験</a>してください！</p>
</div>