<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/01/image1-6.png" class="kg-image" alt="Miniflare 2.0: fully-local development and testing for Workers"></figure>
	<!--kg-card-begin: markdown-->
	<p>2021å¹´7æœˆã€ç§ã¯Workerså‘ã‘ã®éŠã³å¿ƒã‚’æŒã¡ãƒ•ãƒ«æ©Ÿèƒ½ã‚’å‚™ãˆãŸå®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ã‚ã‚‹Miniflare 1.0ã‚’ã€<a href="https://discord.gg/cloudflaredev" target="_blank">Cloudflare Workers Discordã‚µãƒ¼ãƒ</a>ä¸Šã«ç«‹ã¡ä¸Šã’ã¾ã—ãŸã€‚<a href="https://github.com/gja/cloudflare-worker-local/pull/57" target="_blank"><code>cloudflare-worker-local</code></a>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦å§‹ã¾ã£ãŸã‚‚ã®ãŒä»Šã§ã¯Cloudflareã®å…¬å¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ãªã‚Šã€Workersã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã¨ãªã£ã¦<a href="https://blog.cloudflare.com/wrangler-v2-beta/">wrangler 2.0</a>ã«çµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬æ—¥ã€æ¬¡ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹ã€ã‚ˆã‚Šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã•ã‚ŒãŸã€è»½é‡ã§æ­£ç¢ºãªMiniflare 2.0ã®ãƒªãƒªãƒ¼ã‚¹ã‚’ç™ºè¡¨ã§ãã‚‹ã“ã¨ã‚’å¬‰ã—ãæ€ã„ã¾ã™ã€‚ğŸ”¥</p>
	<h2 id="miniflare">èƒŒæ™¯ï¼šMiniflareãŒä½œã‚‰ã‚ŒãŸç†ç”±</h2>
	<p><img src="https://blog.cloudflare.com/content/images/2022/01/image3-7.png" alt="image3-7"></p>
	<p>2020å¹´æœ«é ƒã«ã€ç§ã¯åˆã‚ã¦ã¨ãªã‚‹Workersã‚¢ãƒ—ãƒªã®åˆ¶ä½œã‚’å§‹ã‚ã¾ã—ãŸã€‚æœ€åˆã¯ã€å½“æ™‚<a href="https://blog.cloudflare.com/announcing-wrangler-dev-the-edge-on-localhost/">æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã§ã‚ã‚‹ <code>wrangler dev</code></a>ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ã“ã‚Œã¯å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã¾ã§ã«æ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚Workersã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸Šã§å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ååˆ†å‡„ã„ã“ã¨ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ç§ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é–‹ç™ºã«<a href="https://vitejs.dev/" target="_blank">Vite</a>ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã®ã§ã€é–‹ç™ºè€…ä½“é¨“ã®å¤§å¹…ãªé«˜é€ŸåŒ–ãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã¾ã—ãŸã€‚</p>
	<p>ãã®å¾Œã€ãƒ­ãƒ¼ã‚«ãƒ«ã®Workersã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ã‚ã‚‹<a href="https://github.com/gja/cloudflare-worker-local" target="_blank"><code>cloudflare-worker-local</code></a>ã¨<a href="https://github.com/dollarshaveclub/cloudworker" target="_blank"><code>cloudworker</code></a>ã«ç›®ã‚’ä»˜ã‘ã¾ã—ãŸãŒã€Workers Sitesã®ã‚ˆã†ãªæ–°ã—ã„æ©Ÿèƒ½ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ç§ã¯ã€é–‹ç™ºè€…ä½“é¨“ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã€æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§âœ¨ <em>ãŒå‹•ä½œã™</em> ã‚‹é­”æ³•ã®ã‚ˆã†ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’æ±‚ã‚ã¦ã„ã¾ã—ãŸãŒã€Miniflare 1.0ã«ã¤ã„ã¦ã®ä¸–é–“ã®åå¿œã‚’è¦‹ã‚‹ã¨ã€ãã‚Œã¯ç§ã ã‘ã§ã¯ãªã‹ã£ãŸã‚ˆã†ã§ã™ã€‚</p>
	<p>Miniflare 1.0ã¯ã€ç¬æ™‚ã®ãƒªãƒ­ãƒ¼ãƒ‰ã€ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ã®ã‚µãƒãƒ¼ãƒˆï¼ˆã©ã“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ãŒã‚ã‹ã‚‹ï¼‰ã€ã™ã£ãã‚Šã¨ã—ãŸãƒ­ã‚°ï¼ˆ<code>{ unknown object }</code>ã‚„å¤§é‡ã® JSON ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ã‚‚ã¯ã‚„ä¸è¦ï¼‰ã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’å¼·èª¿ã™ã‚‹ç¾ã—ã„ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã€<a href="https://miniflare.dev/developing/debugger" target="_blank">ã‚¹ãƒ†ãƒƒãƒ—ã‚¹ãƒ«ãƒ¼ãƒ‡ãƒãƒƒã‚¬ã®ã‚µãƒãƒ¼ãƒˆ</a>ãªã©ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã—ãŸã€‚</p>
	<p><img src="https://blog.cloudflare.com/content/images/2021/12/image2-81.png" alt="image2-81"></p>
	<center>ã€Œå¹¼å…èªã€ã§å‹•ä½œã™ã‚‹å¯æ„›ã‚‰ã—ã„ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸</center>
	<p><img src="https://blog.cloudflare.com/content/images/2022/01/image5-5.png" alt="image5-5"></p>
	<h2 id="2">æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãƒãƒ¼ã‚¸ãƒ§ãƒ³2ã§ã®æ–°æ©Ÿèƒ½</h2>
	<p>7æœˆã«Miniflare1.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã‹ã‚‰æ¯”è¼ƒçš„çŸ­ã„æœŸé–“ã§ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦ã®Workersã¯åŠ‡çš„ã«å‘ä¸Šã—ã¾ã—ãŸã€‚Durable Objectsã¯æ˜ç¤ºçš„ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§ä¸€è²«æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®<a href="https://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/">å…¥ãƒ»å‡ºåŠ›ã‚²ãƒ¼ãƒˆ</a>ã‚’æŒã¡ã€Workersã¯é–‹ç™ºè€…ãŒå¾Œæ–¹äº’æ›æ€§ã®ãªã„ä¿®æ­£ã‚’é¸æŠã§ãã‚‹<a href="https://blog.cloudflare.com/backwards-compatibility-in-cloudflare-workers/">äº’æ›æ€§ã®ã‚ã‚‹æ—¥ä»˜</a>ã‚’æŒã¡ã€ãŠå®¢æ§˜ã¯<a href="https://blog.cloudflare.com/workers-javascript-modules/">JavaScriptãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</a>ã‚’ä½¿ç”¨ã—ã¦ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’åˆ¶ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
	<p>Miniflare 2ã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ã™ã¹ã¦ã‚µãƒãƒ¼ãƒˆã—ã€3ã¤ã®ä¸»è¦ãªè¨­è¨ˆç›®æ¨™ã«åŸºã¥ã„ã¦å®Œå…¨ã«å†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
	<ol>
		<li><strong>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¼ï¼š</strong> Miniflare 2ã§ã¯ã€Workersã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆKVã€Durable Objectsãªã©ï¼‰ã‚’å€‹åˆ¥ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ<code>@miniflare/kv</code>ã€<code>@miniflare/durable-objects</code>ãªã©ï¼‰ã«åˆ†å‰²ã—ã€ãƒ†ã‚¹ãƒˆç”¨ã«å˜ç‹¬ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€<a href="https://blog.cloudflare.com/introducing-r2-object-storage/">R2 Storage</a>ã®ã‚ˆã†ãªã€ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ãªã„æ–°æ©Ÿèƒ½ã®ã‚µãƒãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚</li>
		<li><strong>è»½é‡ï¼š</strong> Miniflare 1ã«ã¯<a href="http://npm.anvaka.com/#/view/2d/miniflare/1.4.1" target="_blank">122å€‹ã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</a>ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚µã‚¤ã‚ºã¯åˆè¨ˆ<code>88.3MB</code>ã§ã—ãŸã€‚Miniflare 2ã¯ã€Node.js 16ã«å«ã¾ã‚Œã‚‹æ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚’<strong>23å€‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã€<code>6MB</code></strong> ã®ã‚µã‚¤ã‚ºã«ã¾ã§å‰Šæ¸›ã—ã¦ã„ã¾ã™ã€‚</li>
		<li><strong>æ­£ç¢ºã•ï¼š</strong> Miniflare 2ã§ã¯ã€å®Ÿéš›ã®Workerã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ç™–ã‚„ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ç ´æã®äºˆå…†ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“<code>wrangler dev</code>ã¯ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å®Ÿéš›ã®ã‚¨ãƒƒã‚¸ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å¸¸ã«æœ€ã‚‚æ­£ç¢ºãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãªã‚Šã¾ã™ãŒã€Miniflare 2ã¯æœ¬å½“ã«è¿‘ã„ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚</li>
	</ol>
	<p>ã¾ãŸã€æ–°ã—ã„<a href="https://miniflare.dev/developing/live-reload" target="_blank">live-reloadæ©Ÿèƒ½</a>ã¨ã€Jestã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã®first-classã®ã‚µãƒãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã€é–‹ç™ºè€…ä½“é¨“ãŒã•ã‚‰ã«æ¥½ã—ã„ã‚‚ã®ã«ãªã‚Šã¾ã—ãŸã€‚</p>
	<div style="position: relative; padding-top: 45.565217391304344%;"><iframe src="https://iframe.videodelivery.net/3c37cfa72152fef7e44de922f84b0920?preload=true&amp;poster=https%3A%2F%2Fvideodelivery.net%2F3c37cfa72152fef7e44de922f84b0920%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600&amp;primaryColor=%23e97f07" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe></div>
	<p></p>
	<h2 id="">ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚’å§‹ã‚ã‚‹ã«ã‚ãŸã£ã¦</h2>
	<p>å†’é ­ã§è¿°ã¹ãŸã‚ˆã†ã«ã€Miniflare 2.0ã¯ç¾åœ¨<a href="https://blog.cloudflare.com/wrangler-v2-beta/">wrangler 2.0</a>ã«çµ±åˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã®Workeré–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã«ã¯<code>npx [email protected] dev --local</code>ã‚’ã€<a href="https://blog.cloudflare.com/ja-jp/cloudflare-pages-goes-full-stack-ja-jp/">Cloudflare Pages Functions</a>ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã«ã¯<code>npx [email protected] pages dev</code>ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ã€‚<a href="https://nodejs.org/" target="_blank">Node.jsã®æœ€æ–°ãƒªãƒªãƒ¼ã‚¹</a>ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
	<p>ã—ã‹ã—ã€Wrangler 1ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã‚„ã€ãŠä½¿ã„ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„å ´åˆã¯ã€Miniflare ã‚’ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚‚ã—ãŠå®¢æ§˜ãŒ<code>wrangler.toml</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¤æ—¢å­˜ã®Workerã‚’ãŠæŒã¡ã§ã‚ã‚Œã°ã€<code>npx miniflare --live-reload</code>ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ãƒ©ã‚¤ãƒ–ãƒªãƒ­ãƒ¼ãƒ‰å‹ã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Miniflareã¯ã€KVåå‰ç©ºé–“ã‚„Durable Objectãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®ã‚ˆã†ãªè¨­å®šã‚’<code>wrangler.toml</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€ãã—ã¦secretsã‚’<code>.env</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
	<p>Miniflareã¯é«˜åº¦ãªè¨­å®šãŒå¯èƒ½ã§ã™ã€‚ãŸã¨ãˆã°ã€å†èµ·å‹•ã®é–“KVãƒ‡ãƒ¼ã‚¿ã‚’æŒç¶šã•ã›ãŸã„å ´åˆã¯ã€<code>--kv-persist</code>ãƒ•ãƒ©ã‚°ã‚’å«ã‚ã¾ã™ã€‚è¤‡æ•°ã®Workersã®å®Ÿè¡Œã‚„ HTTPS ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãªã©ã€ã•ã‚‰ã«å¤šãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€<a href="https://miniflare.dev/" target="_blank">Miniflare docs</a>ã‚’å‚ç…§ã„ãŸã ãã‹ã€<code>npx miniflare --help</code>ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
	<p><code>scheduled</code>çŠ¶æ…‹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãŒã‚ã‚Œã°ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§<code>http://localhost:8787/cdn-cgi/mf/scheduled</code>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€æ‰‹å‹•ã§ãƒˆãƒªã‚¬ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
	<h2 id="jestworker">Jestã«ã‚ˆã‚‹Workerã®ãƒ†ã‚¹ãƒˆ</h2>
	<p><a href="https://jestjs.io/" target="_blank">Jest</a>ã¯ã€æœ€ã‚‚äººæ°—ã®ã‚ã‚‹JavaScriptãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®1ã¤ã§ã‚ã‚‹ãŸã‚ã€ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯ç†ã«ã‹ãªã£ã¦ã„ã¾ã™ã€‚Miniflare 2.0ã«ã¯ã€<a href="https://developers.cloudflare.com/workers/runtime-apis" target="_blank">Workersã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ API</a>ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹<a href="https://jestjs.io/docs/configuration#testenvironment-string" target="_blank">ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆç’°å¢ƒ</a>ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
	<p>ä¾‹ãˆã°ã€JavaScriptãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦æ›¸ã‹ã‚ŒãŸæ¬¡ã®ã‚ˆã†ãªWorkerãŒã‚ã‚Šã€å„URLã®è¨ªå•å›æ•°ã‚’Workers KVã«æ ¼ç´ã—ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚</p>
	<blockquote>
		<p>ä½™è«‡ã§ã™ãŒã€Workers KVã¯æœ€çµ‚çš„ã«ä¸€è²«æ€§ã‚’ä¿ã¤ä»•çµ„ã¿ã§ã‚ã‚‹ãŸã‚ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç”¨ã«ã¯è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å®Ÿéš›ã®Workersã§ã¯Durable Objectã‚’ä½¿ã†ã¹ãã§ã™ã€‚ã“ã“ã§ã¯ç°¡å˜ãªä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚</p>
	</blockquote>
	<pre><code class="language-js">// src/index.mjs
export async function increment(namespace, key) {
  // Get the current count from KV
  const currentValue = await namespace.get(key);
  // Increment the count, defaulting it to 0
  const newValue = parseInt(currentValue ?? "0") + 1;
  // Store and return the new count
  await namespace.put(key, newValue.toString());
  return newValue;
}

export default {
  async fetch(request, env, ctx) {
    // Use the pathname for a key
    const url = new URL(request.url);
    const key = url.pathname;
    // Increment the key
    const value = await increment(env.COUNTER_NAMESPACE, key);
    // Return the new incremented count
    return new Response(`count for ${key} is now ${value}`);
  },
};
</code></pre>
	<pre><code class="language-toml"># wrangler.toml
kv_namespaces = [
  { binding = "COUNTER_NAMESPACE", id = "..." }
]

[build.upload]
format = "modules"
dist = "src"
main = "./index.mjs"
</code></pre>
	<p>...å˜ä½“ãƒ†ã‚¹ãƒˆã§ã¯ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ï¼š</p>
	<pre><code class="language-js">// test/index.spec.mjs
import worker, { increment } from "../src/index.mjs";

// When using `format = "modules"`, bindings are included in the `env` parameter,
// which we don't have access to in tests. Miniflare therefore provides a custom
// global method to access these.
const { COUNTER_NAMESPACE } = getMiniflareBindings();

test("should increment the count", async () =&gt; {
  // Seed the KV namespace
  await COUNTER_NAMESPACE.put("a", "3");

  // Perform the increment
  const newValue = await increment(COUNTER_NAMESPACE, "a");
  const storedValue = await COUNTER_NAMESPACE.get("a");

  // Check the return value of increment
  expect(newValue).toBe(4);
  // Check increment had the side effect of updating KV
  expect(storedValue).toBe("4");
});

test("should return new count", async () =&gt; {
  // Note we're using Worker APIs in our test, without importing anything extra
  const request = new Request("http://localhost/a");
  const response = await worker.fetch(request, { COUNTER_NAMESPACE });

  // Each test gets its own isolated storage environment, so the changes to "a"
  // are *undone* automatically. This means at the start of this test, "a"
  // wasn't in COUNTER_NAMESPACE, so it defaulted to 0, and the count is now 1.
  expect(await response.text()).toBe("count for /a is now 1");
});
</code></pre>
	<pre><code class="language-js">// jest.config.js
const { defaults } = require("jest-config");

module.exports = {
  testEnvironment: "miniflare", // âœ¨
  // Tell Jest to look for tests in .mjs files too
  testMatch: [
    "**/__tests__/**/*.?(m)[jt]s?(x)",
    "**/?(*.)+(spec|test).?(m)[tj]s?(x)",
  ],
  moduleFileExtensions: ["mjs", ...defaults.moduleFileExtensions],
};
</code></pre>
	<p>...å®Ÿè¡Œã«ã¯ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
	<pre><code class="language-shell"># Install dependencies
$ npm install -D jest jest-environment-miniflare
# Run tests with experimental ES modules support
$ NODE_OPTIONS=--experimental-vm-modules npx jest
</code></pre>
	<p>ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨åˆ†é›¢ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è©³ç´°ã«ã¤ã„ã¦ã¯<a href="https://miniflare.dev/testing/jest" target="_blank">Miniflare docs</a>ã€ã¾ãŸã¯TypeScriptã¨DurableObjectsã‚’ä½¿ç”¨ã—ãŸ<a href="https://github.com/mrbbot/miniflare-typescript-esbuild-jest" target="_blank">ã“ã¡ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
	<p>Jestã‚’ãŠä½¿ã„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼ŸMiniflareã§ã¯ã€vanilla Node.jsã‚„ãã®ä»–ã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ç‹¬è‡ªã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚AVAã‚’ä½¿ç”¨ã—ãŸä¾‹ã«ã¤ã„ã¦ã¯ã€<a href="https://miniflare.dev/testing/ava" target="_blank">Miniflareã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã¾ãŸã¯<a href="https://github.com/mrbbot/miniflare-esbuild-ava" target="_blank">ã“ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒª</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
	<h2 id="miniflare">Miniflareã®ä»•çµ„ã¿</h2>
	<p>ãã‚Œã§ã¯ã€Miniflareã®èˆˆå‘³æ·±ã„æ©Ÿèƒ½ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
	<p>Miniflareã¯ã€Chromeã®V8 JavaScriptã‚¨ãƒ³ã‚¸ãƒ³ä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸJavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚ã‚‹Node.jsã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚V8ã¯Cloudflare Workersãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’å¼·åŒ–ã™ã‚‹ã®ã¨åŒã˜ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ãŒã€Nodeã¨Workersã¯ãã®ä¸Šã«ç•°ãªã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ APIã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚Nodeã®APIã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ã—ã€Workersã®APIã‚’æ³¨å…¥ã™ã‚‹ãŸã‚ã«ã€<a href="https://nodejs.org/api/vm.html" target="_blank">Miniflareã¯Node.jsã®<code>vm</code>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</a>ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚«ã‚¹ã‚¿ãƒ V8ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
	<p>Workersã®ã‚³ã‚¢éƒ¨åˆ†ã¯ã€<code>Request</code>ã¨<code>Response</code>ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚Miniflareã¯ã“ã‚Œã‚‰ã‚’Nodeãƒãƒ¼ãƒ ãŒNodeã«<code>fetch</code>ã‚’å°å…¥ã™ã‚‹ãŸã‚ã«æ›¸ã„ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹<a href="https://github.com/nodejs/undici" target="_blank"><code>undici</code></a>ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€service workersç”¨ã«Node 15 ã§è¿½åŠ ã•ã‚ŒãŸ<code>addEventListener</code>ã¨<code>EventTarget</code> API ã‚’ä½¿ã£ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹æ–¹æ³•ã‚‚å¿…è¦ã§ã™ã€‚</p>
	<p>ãã‚Œã‚‰ãŒã‚ã‚Œã°ã€ç§ãŸã¡ã¯ <em>å°è¦æ¨¡ã®</em>-miniflareã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
	<pre><code class="language-js">import vm from "vm";
import { Request, Response } from "undici";

// An instance of this class will become the global scope of our Worker,
// extending EventTarget for addEventListener and dispatchEvent
class ServiceWorkerGlobalScope extends EventTarget {
  constructor() {
    super();

    // Add Worker runtime APIs
    this.Request = Request;
    this.Response = Response;

    // Make sure this is bound correctly when EventTarget methods are called
    this.addEventListener = this.addEventListener.bind(this);
    this.removeEventListener = this.removeEventListener.bind(this);
    this.dispatchEvent = this.dispatchEvent.bind(this);
  }
}

// An instance of this class will be passed as the event parameter to "fetch"
// event listeners
class FetchEvent extends Event {
  constructor(type, init) {
    super(type);
    this.request = init.request;
  }

  respondWith(response) {
    this.response = response;
  }
}

// Create a V8 context to run user code in
const globalScope = new ServiceWorkerGlobalScope();
const context = vm.createContext(globalScope);

// Example user worker code, this could be loaded from the file system
const workerCode = `
addEventListener("fetch", (event) =&gt; {
  event.respondWith(new Response("Hello mini-miniflare!"));
})
`;
const script = new vm.Script(workerCode);

// Run the user's code, registering the "fetch" event listener
script.runInContext(context);

// Create an example request, this could come from an incoming HTTP request
const request = new Request("http://localhost:8787/");
const event = new FetchEvent("fetch", { request });

// Dispatch the event and log the response
globalScope.dispatchEvent(event);
console.log(await event.response.text()); // Hello mini-miniflare!
</code></pre>
	<h3 id="">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³</h3>
	<p><img src="https://blog.cloudflare.com/content/images/2021/12/image1-108.png" alt="image1-108"></p>
	<center>Miniflare monorepoã®ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã€‚</center>
	<p>Workersã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ APIã¯ãŸãã•ã‚“ã‚ã‚‹ãŸã‚ã€ä¸Šè¨˜ã®ã‚ˆã†ã«ã™ã¹ã¦ã‚’æ‰‹ä½œæ¥­ã§è¿½åŠ ãƒ»è¨­å®šã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚ãã“ã§Miniflare 2ã§ã¯ã€å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚„ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯ã€ãã‚Œã‚‰ã®ã‚¿ã‚¤ãƒ—ã€CLIãƒ•ãƒ©ã‚°ã€ãã‚Œã‚‰ãŒWranglerè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã©ã“ã«ã‚ã‚‹ã‹ã‚’èª¬æ˜ã™ã‚‹æ³¨é‡ˆãŒã‚ã‚Šã¾ã™ã€‚</p>
	<pre><code class="language-ts">@Option({
  // Define type for runtime validation of the CLI flag
  type: OptionType.ARRAY,
  // Use --kv instead of auto-generated --kv-namespace for the CLI flag
  name: "kv",
  // Define -k as an alias
  alias: "k",
  // Displayed in --help
  description: "KV namespace to bind",
  // Where to find this option in wrangler.toml
  fromWrangler: (config) =&gt; config.kv_namespaces?.map(({ binding }) =&gt; binding),
})
kvNamespaces?: string[];
</code></pre>
	<h3 id="durableobjects">Durable Objects</h3>
	<p>å…¥å‡ºåŠ›ã‚²ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹ä»¥å‰ã¯ã€é€šå¸¸<code>transaction()</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ä¸€è²«æ€§ã‚’ç¢ºä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
	<pre><code class="language-js">async function incrementCount() {
  let value;
  await this.storage.transaction(async (txn) =&gt; {
    value = await txn.get("count");
    await txn.put("count", value + 1);
  });
  return value;
}
</code></pre>
	<p>Miniflareã§ã¯ã“ã‚Œã‚’<a href="https://dl.acm.org/doi/10.1145/319566.319567" target="_blank">optimistic-concurrency control (OCC)</a>ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€å…¥å‡ºåŠ›ã‚²ãƒ¼ãƒˆãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€æ–°ã—ãæ›¸ã‹ã‚ŒãŸDurable Objectã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹éš›ã®ç«¶åˆçŠ¶æ…‹ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€Miniflare 2ã§ã¯ãã‚Œã‚‰ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
	<p><a href="https://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/#part1inputgates">ã‚²ãƒ¼ãƒˆç™ºè¡¨æ™‚ã®ãƒ–ãƒ­ã‚°è¨˜äº‹</a>ã®èª¬æ˜ã‚ˆã‚Šï¼š</p>
	<blockquote>
		<p><strong>å…¥åŠ›ã‚²ãƒ¼ãƒˆï¼š</strong> ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œã®å®Ÿè¡Œä¸­ã¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆä»¥å¤–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é…ä¿¡ã—ã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒJavaScriptã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãªããªã‚Šã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œã®å¾…ã¡ãŒãªããªã‚‹ã¾ã§å¾…æ©ŸçŠ¶æ…‹ã«ã•ã‚Œã¾ã™ã€‚ç§ãŸã¡ã¯ã“ã‚Œã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã€Œå…¥åŠ›ã‚²ãƒ¼ãƒˆã€ãŒé–‹ãã®ã‚’å¾…ã£ã¦ã„ã‚‹çŠ¶æ…‹ã¨è¡¨ç¾ã—ã¾ã™ã€‚</p>
	</blockquote>
	<p>...å…¥åŠ›ã‚²ãƒ¼ãƒˆã«ã¯2ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚1ã¤ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å‹•ä½œä¸­ã«ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹ã‚‚ã®ã§ã€1ã¤ã¯å…¥åŠ›ã‚²ãƒ¼ãƒˆãŒé–‹ãã¾ã§å¾…ã¤ã‚‚ã®ã§ã™ï¼š</p>
	<pre><code class="language-ts">class InputGate {
  async runWithClosed&lt;T&gt;(closure: () =&gt; Promise&lt;T&gt;): Promise&lt;T&gt; {
    // 1. Close the input gate
    // 2. Run the closure and store the result
    // 3. Open the input gate
    // 4. Return the result
  }

  async waitForOpen(): Promise&lt;void&gt; {
    // 1. Check if the input gate is open
    // 2. If it is, return
    // 3. Otherwise, wait until it is
  }
}
</code></pre>
	<p>å„Durable Objectã«ã¯ã€ãã‚Œãã‚Œã«å¯¾ã™ã‚‹<code>InputGate</code>ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®Ÿè£…ã§ã¯<code>runWithClosed</code>ã‚’å‘¼ã³å‡ºã—ã¦ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œãŒå®Œäº†ã™ã‚‹ã¾ã§ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿã•ã›ã¾ã™ã€‚</p>
	<pre><code class="language-ts">class DurableObjectStorage {
  async get&lt;Value&gt;(key: string): Promise&lt;Value | undefined&gt; {
    return this.inputGate.runWithClosed(() =&gt; {
      // Get key from storage
    });
  }
}
</code></pre>
	<p>...æ¬¡ã«ã€åˆ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é…ä¿¡ã™ã‚‹æº–å‚™ãŒã§ããŸã‚‰ã€<code>waitForOpen</code>ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š</p>
	<pre><code class="language-js">import { fetch as baseFetch } from "undici";

async function fetch(input, init) {
  const response = await baseFetch(input, init);
  await inputGate.waitForOpen();
  return response;
}
</code></pre>
	<p>ã“ã“ã§å•é¡Œã«æ°—ã¥ã„ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<code>inputGate</code>ã¯<code>fetch</code>å†…ã®ã©ã“ã‹ã‚‰æ¥ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼ŸWorkerå…¨ä½“ã¨ãã®ã™ã¹ã¦ã®Durable Objectã«å¯¾ã—ã¦1ã¤ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã—ã‹ãªã„ãŸã‚ã€Durable Objectã®<code>InputGate</code>ã”ã¨ã«<code>fetch</code>ã‚’è¡Œã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€ãã‚Œã‚’å¿…è¦ã¨ã™ã‚‹ã™ã¹ã¦ã®é–¢æ•°ã«åˆ¥ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦æ¸¡ã™ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ±‚ã‚ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚æ½œåœ¨çš„ã«_<code>async</code>_ é–¢æ•°é–“ã§è‡ªå‹•çš„ã«æ¸¡ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­ã«ãã‚Œã‚’æ ¼ç´ã™ã‚‹ä½•ã‚‰ã‹ã®æ–¹æ³•ãŒå¿…è¦ã§ã™ã€‚ã“ã®ãŸã‚ã«ã€æˆ‘ã€…ã¯ã€ <a href="https://nodejs.org/api/async_context.html#class-asynclocalstorage" target="_blank"><code>AsyncLocalStorage</code> ã‚¯ãƒ©ã‚¹</a>ã‚’å«ã‚€ã€ã‚‚ã†ä¸€ã¤ã®ã‚ã¾ã‚ŠçŸ¥ã‚‰ã‚Œã¦Nodeãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«<a href="https://nodejs.org/api/async_context.html" target="_blank"><code>async_hooks</code></a>ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ ï¼š</p>
	<pre><code class="language-ts">import { AsyncLocalStorage } from "async_hooks";

const inputGateStorage = new AsyncLocalStorage&lt;InputGate&gt;();

const inputGate = new InputGate();
await inputGateStorage.run(inputGate, async () =&gt; {
  // This closure will run in an async context with inputGate
  await fetch("https://example.com");
});

async function fetch(input: RequestInfo, init: RequestInit): Promise&lt;Response&gt; {
  const response = await baseFetch(input, init);
  // Get the input gate in the current async context
  const inputGate = inputGateStorage.getStore();
  await inputGate.waitForOpen();
  return response;
}
</code></pre>
	<p>ã¾ãŸã€Durable Objectsã«ã¯ã€<code>blockConcurrencyWhile(closure)</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€<code>closure</code>ãŒå®Œäº†ã™ã‚‹ã¾ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿã•ã›ã¾ã™ã€‚ã“ã‚Œã¯ã¾ã•ã«<code>runWithClosed()</code>ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚</p>
	<pre><code class="language-ts">class DurableObjectState {
  // ...

  blockConcurrencyWhile&lt;T&gt;(closure: () =&gt; Promise&lt;T&gt;): Promise&lt;T&gt; {
    return this.inputGate.runWithClosed(closure);
  }
}
</code></pre>
	<p>ã—ã‹ã—ã€ä»Šã‚ã‚‹ã‚‚ã®ã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
	<pre><code class="language-js">export class CounterObject {
  constructor(state: DurableObjectState) {
    state.blockConcurrencyWhile(async () =&gt; {
      const res = await fetch("https://example.com");
      this.data = await res.text();
    });
  }
}
</code></pre>
	<p><code>blockConcurrencyWhile</code>ã¯å…¥åŠ›ã‚²ãƒ¼ãƒˆã‚’é–‰ã˜ã¾ã™ãŒã€<code>fetch</code>ã¯å…¥åŠ›ã‚²ãƒ¼ãƒˆãŒé–‹ãã¾ã§æˆ»ã‚‰ãªã„ãŸã‚ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã§ã™ï¼ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã«ã¯<code>InputGate</code>ã‚’å…¥ã‚Œå­ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
	<pre><code class="language-ts">class InputGate {
  constructor(private parent?: InputGate) {}

  async runWithClosed&lt;T&gt;(closure: () =&gt; Promise&lt;T&gt;): Promise&lt;T&gt; {
    // 1. Close the input gate, *and any parents*
    // 2. *Create a new child input gate with this as its parent*
    const childInputGate = new InputGate(this);
    // 3. Run the closure, *under the child input gate's context*
    // 4. Open the input gate, *and any parents*
    // 5. Return the result
  }
}
</code></pre>
	<p>ç¾åœ¨ã€<code>blockConcurrencyWhile</code>ã®å¤–å´ã®å…¥åŠ›ã‚²ãƒ¼ãƒˆãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã®ã§ã€Durable Objectã¸ã®ãƒ•ã‚§ãƒƒãƒã¯å¾…æ©ŸçŠ¶æ…‹ã«ã•ã‚Œã¾ã™ãŒã€closureã®å†…å´ã®å…¥åŠ›ã‚²ãƒ¼ãƒˆã¯é–‹ã‹ã‚Œã‚‹ã®ã§ã€<code>fetch</code>ã¯æˆ»ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
	<p>ã“ã“ã§ã¯ã„ãã¤ã‹ã®è©³ç´°ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ãŒã€<a href="https://github.com/cloudflare/miniflare/blob/v2.0.0/packages/shared/src/sync/gate.ts" target="_blank">ã‚²ãƒ¼ãƒˆã®å®Ÿè£…</a>ã§è¿½åŠ ã®æ§‹æ–‡ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ğŸ™‚</p>
	<h3 id="htmlrewriter">HTMLRewriter</h3>
	<p><code>HTMLRewriter</code>ã¯HTMLã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è§£æãƒ»å¤‰æ›ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã§ã™ã€‚edge Workers ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯ã€Rustãƒ©ã‚¤ãƒ–ãƒ©ãƒª<a href="https://github.com/cloudflare/lol-html" target="_blank">lol-html</a>ã¸ã®Cãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã£ã¦å‹•ä½œã—ã¦ã„ã¾ã™ã€‚å¹¸é‹ãªã“ã¨ã«ã€ <a href="https://blog.cloudflare.com/author/ivan-nikulin/">Ivan Nikulin</a>æ° ãŒã“ã®ãŸã‚ã«<a href="https://github.com/cloudflare/lol-html/issues/38" target="_blank">WebAssembly bindings</a>ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ§‹ç¯‰ã—ãŸã®ã§ã€Node.jsã§åŒã˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
	<p>ã—ã‹ã—ã€ã“ã‚Œã‚‰ã«ã¯æ›¸ãæ›ãˆæ™‚ã«å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹asyncãƒãƒ³ãƒ‰ãƒ©ã®ã‚µãƒãƒ¼ãƒˆãŒæ¬ ã‘ã¦ã„ã¾ã—ãŸã€‚</p>
	<pre><code class="language-js">class UserElementHandler {
  async element(node) {
    const response = await fetch("/user");
    // ...
  }
}
</code></pre>
	<p>The WebAssembly bindings Rust code includes something like:</p>
	<pre><code class="language-rust">macro_rules! make_handler {
  ($handler:ident, $JsArgType:ident, $this:ident) =&gt; {
    move |arg: &amp;mut _| {
      // `js_arg` here is the `node` parameter from above
      let js_arg = JsValue::from(arg);
      // $handler here is the `element` method from above
      match $handler.call1(&amp;$this, &amp;js_arg) {
        Ok(res) =&gt; {
          // Check if this is an async handler
          if let Some(promise) = res.dyn_ref::&lt;JsPromise&gt;() {
            await_promise(promise);
          }
          Ok(())
        }
        Err(e) =&gt; ...,
      }
    }
  };
}
</code></pre>
	<p>ã“ã“ã§é‡è¦ãªã®ã¯ã€Rustã®<code>move |...| { ... }</code>ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¯åŒæœŸçš„ã§ã™ãŒã€ãƒãƒ³ãƒ‰ãƒ©ã¯éåŒæœŸçš„ã«ã§ãã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯é<code>async</code>é–¢æ•°ã§<code>Promise</code>ã‚’<code>await</code>ã—ã‚ˆã†ã¨ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚</p>
	<p>ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ‰±ã†ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã§ã‚ã‚‹ <a href="https://github.com/WebAssembly/binaryen" target="_blank">Binaryen</a>ã®<a href="https://github.com/WebAssembly/binaryen/blob/main/src/passes/Asyncify.cpp" target="_blank">Asyncify</a>æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<code>await_promise</code>ã‚’å‘¼ã³å‡ºã™ãŸã³ã«ã€Asyncify ã¯ç¾åœ¨ã® WebAssembly ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å±•é–‹ã—ã¾ã™ã€‚ãã—ã¦ã€JavaScriptã§ã€<code>Promise</code>ã‚’<code>await</code>ã—ã¾ã™ã€‚æœ€å¾Œã«ã€ä¸€æ™‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰ã®çŠ¶æ…‹ã«å·»ãæˆ»ã—ã€ä¸­æ–­ã—ãŸã¨ã“ã‚ã‹ã‚‰æ›¸ãæ›ãˆã‚’ç¶šã‘ã¾ã™ã€‚</p>
	<p>å®Œå…¨ãªå®Ÿè£…ã¯ã€ <a href="https://github.com/mrbbot/html-rewriter-wasm" target="_blank"><code>html-rewriter-wasm</code> ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</a>ã«ã‚ã‚Šã¾ã™ã€‚</p>
	<p><img src="https://blog.cloudflare.com/content/images/2022/01/image4-4.png" alt="image4-4"></p>
	<h2 id="miniflare">Miniflareã®ä»Šå¾Œã«ã¤ã„ã¦</h2>
	<p>å‰è¿°ã®é€šã‚Šã€Miniflareã¯wrangler 2.0ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãœã²ãŠè©¦ã—ã„ãŸã ãã€ã”æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚</p>
	<p>ã“ã®ã‚ˆã†ãªç´ æ™´ã‚‰ã—ã„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨æ”¯æ´ã—ã¦ãã‚Œã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ§‹ç¯‰ã—ã¦ãã‚ŒãŸCloudflareã®Workersãƒãƒ¼ãƒ ã®çš†ã•ã‚“ã«æ„Ÿè¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚Miniflareã«è²¢çŒ®ã—ã¦ãã ã•ã£ãŸæ–¹ã€å•é¡Œã‚’æèµ·ã—ã¦ãã‚ŒãŸæ–¹ã€ææ¡ˆã‚’ã—ã¦ãã ã•ã£ãŸæ–¹ã€Discordã‚µãƒ¼ãƒãƒ¼ã§è³ªå•ã—ã¦ãã‚ŒãŸæ–¹ã¸ã‚‚æ„Ÿè¬ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚</p>
	<p>ã“ã‚Œã§æœ¬æ¥ã®Workersãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’çµ‚ã‚ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...ğŸ˜…</p>
	<!--kg-card-end: markdown-->
	<p></p>
</div>