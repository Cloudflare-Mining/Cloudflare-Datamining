<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/12/image2-20.png" class="kg-image" alt="Extending Cloudflare’s Zero Trust platform to support UDP and Internal DNS"></figure>
	<p>2020年末、Cloudflareは、当社のネットワークの上に<a href="https://blog.cloudflare.com/build-your-own-private-network-on-cloudflare/">プライベートネットワークの構築を</a>開始する権限を組織に与えました。サーバー側でCloudflareトンネルを、クライアント側でCloudflare WARPを使用することで、従来のVPNの必要性を排除しました。今日に至るまで、何千もの組織が当社と共にこの作業を続け、従来のVPNコンセントレータ、内部ファイアウォール、ロードバランサーの接続を解除してきました。これらの組織は、従来のハードウェアのすべてを維持する必要性を排除し、エンドユーザーの速度を劇的に向上させ、組織全体でZero Trustルールを維持することができるようになりました。</p>
	<p>まずはTCPから始めました。TCPは重要なユースケースを有効にするため強力です。しかし、真にVPNを置き換えるには、UDPもカバーできるようにする必要があります。本日から、CloudflareのZero TrustプラットフォームでUDPへの早期アクセスを提供できることを嬉しく思います。さらに、UDPをサポートすることにより、内部DNSの提供も可能になります。それにより、DNSルールを上書きするために何千ものプライベートホスト名を手作業で移行する必要がなくなりました。Cloudflare for Teamsは、<a href="https://dash.cloudflare.com/sign-up/teams" target="_blank">こちらから</a>サインアップすることにより、本日より無料でご利用いただけます。UDPと内部DNSへの早期アクセスを行うための順番待ちリストに登録したい方は、<a href="https://cloudflare.com/zero-trust/lp/private-dns-waitlist" target="_blank">こちら</a>をご覧ください。</p>
	<h2 id="cloudflare-"><strong>Cloudflare上のプライベートネットワークのトポロジー</strong></h2>
	<p>プライベートネットワークの構築には、インフラストラクチャ側とクライアント側の2つの主要な構成要素があります。</p>
	<p>インフラストラクチャ側はCloudflareトンネルによって強化されており、お客様のインフラストラクチャ（単一のアプリケーション、多数のアプリケーション、ネットワークセグメント全体など）をCloudflareに接続するだけです。これは、お客様の環境でシンプルなコマンドラインデーモンを実行し、Cloudflareへの複数の安全な、送信専用の、負荷分散されたリンクを確立することで可能となります。簡単に言うと、トンネルとはお客様のネットワークとCloudflareを接続するものです。</p>
	<p>この図の反対側では、エンドユーザーがCloudflareに、そしてより重要なことに、お客様のネットワークに簡単に接続できる必要があります。この接続は、当社の堅牢なデバイスクライアントである<a href="https://blog.cloudflare.com/ja-jp/warp-for-desktop-ja-jp/">Cloudflare WARP</a>によって処理されます。このクライアントは、社内のMDMツールを使ってわずか数分で組織全体に展開でき、ユーザーのデバイスからCloudflareネットワークへのWireGuardベースのセキュアな接続を確立することが可能です。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image1-36.png" class="kg-image"></figure>
	<p>お客様のインフラストラクチャとユーザーがCloudflareに接続すると、アプリケーションとレイヤーをZero Trustセキュリティ制御にタグ付けし、ネットワーク上のリクエストごとにIDとデバイス中心のルールの両方を検証することが容易になります。</p>
	<p>ただし、これまではTCPのみがサポートされていました。</p>
	<h2 id="cloudflare-zero-trust-udp-"><strong>Cloudflare Zero Trustの拡張によるUDPのサポート</strong></h2>
	<p>この1年間、CloudflareのZero Trustプラットフォームを採用するユーザーが増える中、VPNを接続し続けるすべてのユースケースに関するデータを集めてきました。その中で、最も一般的なニーズは、UDPベースのトラフィックのブランケットサポートでした。QUICのような最新のプロトコルは、UDPの軽量アーキテクチャを利用しています。Cloudflareでは、より良いインターネットを構築するためにこれらの新しい標準を推進することが我々の使命の一部であると信じてきました。</p>
	<p>本日、UDPをサポートするCloudflare for Teamsの早期アクセスを希望する方のための公式順番待ちリストを開始しました。</p>
	<h3 id="udp-udp-"><strong>UDPについて、およびUDPが重要な理由</strong></h3>
	<p>UDPはインターネットの重要な構成要素です。UDPがなければ、多くのアプリケーションは現代的な用途には到底適さないものになってしまうでしょう。ビデオストリーミングやVoIPサービスなど、ほぼリアルタイムの通信を使用するアプリケーションは、UDPが必要な理由と、インターネットで果たす役割を示す代表的な例です。しかし、TCPとUDPはその中核において同じ結果をもたらしますが、その手段は大きく異なります。それぞれ独自の利点と欠点があり、それらを利用するアプリケーションは常に下流でそれらの影響を受けています。</p>
	<p>ここで、比喩として誰かに質問する形式で、この2つの仕組みを簡単に説明します。TCPはかなり見慣れたもので、一般的な会話のように、挨拶をして、相手が挨拶を返すのを待ち、調子を伺い、相手の応答を待ってから、自分の希望を尋ねます。</p>
	<p>一方、UDPは、相手が聞いているかどうかを確認することなく、ただ歩み寄って自分の希望を尋ねます。この方法では、質問の一部が聞き逃される可能性がありますが、答えが得られればそれでいいのです。</p>
	<p>上記の会話と同様に、UDPの場合、多くのアプリケーションは実際にデータが失われたとしても気にしません。ビデオストリーミングやゲームサーバーがその良い例です。ストリーミング中にパケットが失われた場合、そのパケットを受信するまでストリーム全体を中断させたくはないでしょう。むしろ、パケットを破棄してでも次に進みたいはずです。アプリケーション開発者がUDPを利用するもう1つの理由には、TCPの標準化されたものを使うよりも、接続、転送、品質管理に関する独自の制御を開発することを好むということが挙げられます。</p>
	<p>Cloudflareにとって、UDPベースのトラフィックのエンドツーエンドのサポートは、多くの新しいユースケースを可能にすることになります。ここでは、かなり楽しみにしていただけると思ういくつかのケースを紹介します。</p>
	<h3 id="-dns-"><strong>内部DNSリゾルバ</strong></h3>
	<p>ほとんどの企業ネットワークでは、イントラネットで利用可能なリソースへのアクセスを普及させるために、内部DNSリゾルバが必要です。イントラネットが内部DNSリゾルバを必要とする理由は、インターネットがパブリックDNSリゾルバを必要とする理由と同じです。要するに、人間が得意としていることはたくさんありますが、長い数字の列（この場合はIPアドレス）を覚えることは得意ではありません。パブリックDNSリゾルバも内部DNSリゾルバも、この問題（および<a href="https://www.cloudflare.com/ja-jp/learning/dns/what-is-dns/" target="_blank">もっと多くの問題</a>）を解決するために設計されました。</p>
	<p>企業において、SharepointやOneDriveにアクセスするためだけに、社内のユーザーに例えば192.168.0.1に移動してもらうことは、無駄に骨が折れることだと思います。その代わりに、各リソースに対してDNSエントリーを作成し、内部リゾルバにユーザーのマッピングをすべて処理させる方がはるかに簡単です。なぜなら、これは、人間が実際に得意とすることだからです。</p>
	<p>DNSクエリは、通常、クライアントからの1回のUDPリクエストで構成されています。それを受けると、サーバーはクライアントに1回、応答を返すことができます。DNSリクエストはそれほど大きくないため、多くの場合、1つのパケットで送受信することができます。このため、Zero TrustプラットフォームでUDPをサポートすることが、VPNの使用をやめるための重要な手段となります。</p>
	<h3 id="-"><strong>シッククライアントアプリケーション</strong></h3>
	<p>UDPのもう1つの一般的なユーズケースとして、シッククライアントアプリケーションがあります。これまで述べてきたUDPの利点の1つは、無駄のないプロトコルであることです。これは、TCPの<a href="https://www.cloudflare.com/ja-jp/learning/ddos/glossary/tcp-ip/" target="_blank">スリーウェイハンドシェイク</a>などの信頼性対策が設計上削ぎ落とされているためです。多くの場合、アプリケーション開発者はこれらの信頼性制御を引き続き望んでいますが、自分のアプリケーションを熟知しており、これらの制御を自分のアプリケーションに適合させることで、よりうまく処理できることを知っています。これらのシッククライアントアプリケーションは、重要なビジネス機能を実行することが多く、移行するためにはエンドツーエンドでサポートする必要があります。たとえば、ほとんどの操作がローカルマシンで実行され、Exchangeサーバーとの同期操作のみがUDP経由で行われるシッククライアントを介して、旧バージョンのOutlookを実装している場合があります。</p>
	<p>繰り返しになりますが、Zero TrustプラットフォームではUDPをサポートしているため、この種のアプリケーションで従来のVPNを使用し続ける理由にはなりません。</p>
	<h3 id="--1"><strong>さらに...</strong></h3>
	<p>世界のインターネットトラフィックの大部分は、UDPで転送されています。多くの場合、ユーザーはタイムセンシティブなアプリケーションをUDPと同等と考え、パケットを時々破棄する方が待つよりも良いと考えています。しかし、他にも多くのユースケースがあり、幅広いサポートを提供できることを嬉しく思います。</p>
	<h2 id="--2"><strong>今日から始めるにはどうしたらいいですか？</strong></h2>
	<p>チュートリアルや開発者向けドキュメントにあるガイドを使用して、Cloudflareのプライベートネットワークの構築は、もうすでに開始することができます。クリティカルパスを以下に示します。すでにお客様で、UDPや内部DNSアクセスの順番待ちリストに加わることに興味がある方は、この投稿の最後まで読み飛ばしてください。</p>
	<h3 id="-cloudflare-"><strong>お客様のネットワークとCloudflareの接続</strong></h3>
	<p>まず、お客様のネットワーク上に<a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation" target="_blank">cloudflaredをインストールし</a>、以下のコマンドで認証する必要があります。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>cloudflared tunnel login
</code></pre>
	<!--kg-card-end: markdown-->
	<p>次に、お客様のネットワークや環境を識別するために、使いやすい名前のトンネルを作成します。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>cloudflared tunnel create acme-network
</code></pre>
	<!--kg-card-end: markdown-->
	<p>最後に、プライベートネットワークのIP/CIDRレンジでトンネルを設定することをおすすめします。こうすることで、このIPレンジへのすべてのリクエストが新しいトンネルにルーティングされる必要があることを、Cloudflare WARPエージェントに認識させることができます。</p>
	<!--kg-card-begin: markdown-->
	<pre><code>cloudflared tunnel route ip add 192.168.0.1/32
</code></pre>
	<!--kg-card-end: markdown-->
	<p>あとはトンネルを実行するだけです。</p>
	<h3 id="--3"><strong>ユーザーとネットワークの接続</strong></h3>
	<p>最初のユーザーを接続するには、接続するデバイスにCloudflare WARPエージェントをダウンロードすることから始め、その後インストーラーの手順に従います。</p>
	<p>次に、<a href="https://dash.teams.cloudflare.com/" target="_blank">Teamsのダッシュボード</a>にアクセスし、登録ポリシーを作成することでネットワークへのアクセスを許可するユーザーを定義します。このポリシーは、設定 &gt; デバイス &gt; デバイスの登録で作成することができます。以下の例では、カナダ在住で、@cloudflare.comで終わるメールアドレスを持つユーザーを要求していることがわかります。</p>
	<p>このポリシーを作成したら、マシンのWARPデスクトップアイコンをクリックして、環境設定 &gt; アカウント &gt; Teamsでログインに移動することで、最初のデバイスを登録することができます。</p>
	<p>最後に、設定 &gt; ネットワーク &gt; スプリットトンネルのリストを除外から、トンネルに追加したIPレンジを削除します。これにより、このトラフィックが実際にCloudflareにルーティングされ、意図したとおりにプライベートネットワークトンネルに送信されることが確認できます。</p>
	<p>上記のチュートリアルに加えて、Teamsのダッシュボードにある製品内ガイドでは、各ステップについてより詳しく説明し、途中の検証も記載されています。</p>
	<p>最初のトンネルを作成するには、<a href="https://dash.teams.cloudflare.com/access/tunnels" target="_blank">Access &gt; トンネル</a>に移動します。</p>
	<p>最初のデバイスをWARPに登録するには、<a href="https://dash.teams.cloudflare.com/team/devices" target="_blank">My Team &gt; デバイス</a>に移動します。</p>
	<h2 id="--4"><strong>次は何を？</strong></h2>
	<p>本日、<a href="https://cloudflare.com/zero-trust/lp/private-dns-waitlist" target="_blank">順番待ちリスト</a>をリリースできることを大変嬉しく思っていますし、今後数週間のうちにこの機能を発売できることをさらに楽しみにしています。プライベートネットワークトンネルはまだ始まったばかりで、発売後も各内部DNSホスト名への各リクエストに対するZero Trust Accessルールのサポートをさらに追加していく予定です。また、パフォーマンスを測定し、最速のZero Trustプラットフォームであり続けるために、さまざまな取り組みを行っていきます。これにより、従来のVPNを使用する場合の手間と比較して、ユーザーに喜びを与えることができます。</p>
</div>