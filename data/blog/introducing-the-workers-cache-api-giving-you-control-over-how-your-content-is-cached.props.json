{
	"post": {
		"id": "5d16453b41acde0011a957ab",
		"uuid": "d71a90d9-4f9f-434d-8251-2e7d925db830",
		"title": "Introducing the Workers Cache API: Giving you control over how your content is cached",
		"slug": "introducing-the-workers-cache-api-giving-you-control-over-how-your-content-is-cached",
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2019/01/caching@3x-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>At Cloudflare, we aim to make the Internet faster and safer for everyone. One way we do this is through <em>caching:</em> we keep a copy of our customer content in our 165 data centers around the world. This brings content  closer to users and reduces traffic back to <a href=\"https://www.cloudflare.com/learning/cdn/glossary/origin-server/\">origin servers</a>.</p><p>Today, we’re excited to announce a huge change in our how cache works. <a href=\"https://www.cloudflare.com/products/cloudflare-workers/\">Cloudflare Workers</a> now integrates the <a href=\"https://developers.cloudflare.com/workers/reference/cache-api/\">Cache API</a>, giving you programmatic control over our caches around the world. </p><h3 id=\"why-the-cache-api\">Why the Cache API?</h3><p>Figuring out what to cache and how can get complicated. Consider an e-commerce site with a shopping cart, a Content Management System (CMS) with many templates and hundreds of articles, or a GraphQL API. Each contains a mix of elements that are dynamic for some users, but might stay unchanged for the vast majority of requests. </p><p>Over the last 8 years, we’ve added more features to give our customers flexibility and control over what goes in the cache. However, we’ve learned that we need to offer more than just adding settings in our dashboard. Our customers have told us clearly that they want to be able to express their ideas in <em>code</em>, to build things we could never have imagined.</p><h3 id=\"how-the-cache-api-works\">How the Cache API works</h3><p>Fetching content is one of the most common Worker tasks. <code>fetch()</code> has always leveraged powerful Cloudflare features like Argo and Load Balancing. It also runs through our cache: we check for content locally before connecting to the Internet. Without the Cache API, content requested with <code>fetch()</code> goes in the cache as-is.</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"http://blog.cloudflare.com/content/images/2019/01/workers-cache-api-1@2x.png\" class=\"kg-image\" alt loading=\"lazy\"><figcaption>fetch() will always write back to cache after a miss.</figcaption></figure><p>The Cache API changes all of that. It’s based on the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Cache\">Service Workers Cache API</a>, and at its core <a href=\"https://developers.cloudflare.com/workers/reference/cache-api/\">it offers three methods</a>:</p><ul><li><strong><strong>put(</strong></strong><em>request, response</em><strong><strong>)</strong> </strong>places a Response in the cache, keyed by a Request </li><li><strong>match(</strong><em>request</em><strong>) </strong>returns a given Response that was previously put()</li><li><strong>delete(</strong><em>request</em><strong>)</strong> deletes a Response that was previously put()</li></ul><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"http://blog.cloudflare.com/content/images/2019/01/workers-cache-api-2@2x.png\" class=\"kg-image\" alt loading=\"lazy\"><figcaption>The Cache API enables you to modify content before writing it to cache.</figcaption></figure><p>This API unleashes a huge amount of power. Because Workers give you the ability to <em>modify</em> Request and Response objects, you can control any caching behavior like TTL or cache tags. You can implement customer Vary logic or cache normally-uncacheable objects like POST requests.</p><p>The Cache API expects requests and responses, but they don't have to come from external servers. Your worker can generate arbitrary data that’s stored in our cache. That means you can use the Cache API as a general-purpose, ephemeral key-value store! </p><h3 id=\"case-study-using-the-cache-api-to-cache-post-requests\">Case study: Using the Cache API to cache POST requests</h3><p>Since we <a href=\"http://blog.cloudflare.com/cache-api-for-cloudflare-workers-is-now-in-beta/\">announced the beta</a> in September, usage of the Cache API has grown to serve thousands of requests per second. One common use-case is to cache <a href=\"https://en.wikipedia.org/wiki/POST_(HTTP)\">POST requests</a>.</p><p>Normally, Cloudflare does not consider POST requests to be cacheable because they are designed to be non-idempotent: that is, they change state on the server when a request is made. However, applications can also use POST requests to send large amounts of data to the server, or as a common HTTP method for API calls.</p><p>Here’s what one developer had to say about using the Cache API:</p><blockquote>We needed to migrate some complex server side code to the edge. We have an API endpoint that accepts POST requests with large bodies, but mostly returns the same data without changing anything on our origin server. With Workers and the Cache API, we were able to cache responses to POST requests that we knew were safe, and reduce significant load on our origin.</blockquote><p>— Aaron Dearinger, Edge Architect, Garmin International</p><p>Caching POST requests with the Cache API is simple. Here’s some example code from our <a href=\"https://developers.cloudflare.com/workers/reference/cache-api/\">documentation</a>:</p><p></p><!--kg-card-begin: markdown--><pre><code class=\"language-javascript\">async function handleRequest(event) {\n  let request = event.request\n  let response\n\n  if (request.method == 'POST') {\n    let body = await request.clone().text()\n    let hash = await sha256(body)\n\n    let url = new URL(request.url)\n    url.pathname = &quot;/posts&quot; + url.pathname + hash\n\n    // Convert to a GET to be able to cache\n    let cacheKey = new Request(url, {\n      headers: request.headers,\n      method: 'GET'\n    })\n\n    let cache = caches.default\n    // try to find the cache key in the cache\n    response = await cache.match(cacheKey)\n\n    // otherwise, fetch from origin\n    if (!response) {\n      // makes POST to the origin\n      response = await fetch(request.url, newRequest)\n      event.waitUntil(cache.put(cacheKey, response.clone()))\n    }\n  } else {\n    response = await fetch(request) \n  }\n  return response\n}\n\nasync function sha256(message) {\n  // encode as UTF-8\n  const msgBuffer = new TextEncoder().encode(message)\n\n  // hash the message\n  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer)\n\n  // convert ArrayBuffer to Array\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\n\n  // convert bytes to hex string\n  const hashHex =\n    hashArray.map(b =&gt; ('00' + b.toString(16)).slice(-2)).join('')\n  return hashHex\n}\n</code></pre>\n<!--kg-card-end: markdown--><p></p><h3 id=\"try-it-yourself\">Try it yourself</h3><p>Already in our beta, we’ve seen customers use the Cache API to dynamically cache parts of GraphQL queries and store customer data to improve performance. We’re excited to see what you build! Check out the <a href=\"https://developers.cloudflare.com/workers/\">Cloudflare Workers getting started guide</a> and the <a href=\"https://developers.cloudflare.com/workers/reference/cache-api/\">Cache API docs</a>, and let us know what you’ve built in the <a href=\"https://community.cloudflare.com/c/developers/workers\">Workers Community forum</a>.</p>",
		"comment_id": "5c4a63c3389f2100c0f6c6f0",
		"feature_image": "http://blog.cloudflare.com/content/images/2019/01/caching@3x.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2019-01-25T01:17:55.000+00:00",
		"updated_at": "2024-02-12T20:27:54.000+00:00",
		"published_at": "2019-01-25T15:33:41.000+00:00",
		"custom_excerpt": "At Cloudflare, we aim to make the Internet faster and safer for everyone. One way we do this is through caching: we keep a copy of our customer content in our 165 data centers around the world. This brings content  closer to users and reduces traffic back to origin servers.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94fc6",
				"name": "Jon Levine",
				"slug": "jpl",
				"profile_image": "http://blog.cloudflare.com/content/images/2018/04/prof-crop.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-92.png",
				"bio": null,
				"website": null,
				"location": "San Francisco, CA",
				"facebook": null,
				"twitter": "@jplevine",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/jpl/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "5d16450341acde0011a95252",
				"name": "Serverless",
				"slug": "serverless",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Serverless.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Serverless",
				"meta_description": "Cloudflare blog posts tagged 'serverless'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/serverless/"
			},
			{
				"id": "5d16450341acde0011a95157",
				"name": "Cache",
				"slug": "cache",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/cache/"
			},
			{
				"id": "5d16450341acde0011a95160",
				"name": "Speed & Reliability",
				"slug": "speed-and-reliability",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Speed---Reliability-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Speed & Reliability",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Speed & Reliability'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/speed-and-reliability/"
			},
			{
				"id": "5d16450341acde0011a95165",
				"name": "JavaScript",
				"slug": "javascript",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/javascript/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94fc6",
			"name": "Jon Levine",
			"slug": "jpl",
			"profile_image": "http://blog.cloudflare.com/content/images/2018/04/prof-crop.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-92.png",
			"bio": null,
			"website": null,
			"location": "San Francisco, CA",
			"facebook": null,
			"twitter": "@jplevine",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/jpl/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a95253",
			"name": "Cloudflare Workers",
			"slug": "workers",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/workers/"
		},
		"url": "http://blog.cloudflare.com/introducing-the-workers-cache-api-giving-you-control-over-how-your-content-is-cached/",
		"excerpt": "At Cloudflare, we aim to make the Internet faster and safer for everyone. One way we do this is through caching: we keep a copy of our customer content in our 165 data centers around the world. This brings content  closer to users and reduces traffic back to origin servers.",
		"reading_time": 4,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}