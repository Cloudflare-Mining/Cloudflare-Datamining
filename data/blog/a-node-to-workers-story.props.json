{
	"footerBlurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
	"initialReadingTime": "3",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Victoria Bernard",
				"slug": "victoria",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3ZkxhWDKU0Figr2UZd6SqN/71b1b0d3b145887064b86a93ad05a508/victoria.jpg",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "Node.js allows developers to build web services with JavaScript. However, you're on your own when it comes to registering a domain, setting up DNS, managing the server processes, and setting up builds. ",
		"feature_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4DVsVgzLDZz2pPJTt1nLmW/5bc364089c088cf4779f3f8d20fc678a/a-node-to-workers-story.png",
		"featured": false,
		"html": "<p>Node.js allows developers to build web services with JavaScript. However, you&#39;re on your own when it comes to registering a domain, setting up DNS, managing the server processes, and setting up builds.</p><p>There&#39;s no reason to manage all these layers on separate platforms. For a site on Cloudflare, these layers can be on a single platform. Serverless technology simplifies developers&#39; lives and reframes our current definition of backend.</p><p>In this article I will breeze through a simple example of how converting a former Node server into a Worker untangled a part of my teams’ code base. The conversion to Workers for this example can be found at this <a href=\"https://github.com/cloudflare-apps/spotify-oauth-express/pull/1/files\">PR on Github</a>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"background\">Background</h3>\n            <a href=\"#background\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>Cloudflare Marketplace hosts a variety of apps, most of which are produced by third party developers, but some are produced by Cloudflare employees.</p><p>The Spotify app is one of those apps that was written by the Cloudflare apps team. This app requires an OAuth flow with Spotify to retrieve the user’s token and gather the playlist, artists, other Spotify profile specific information. While Cloudflare manages the OAuth authentication portion, the app owner - in this case Cloudflare Apps - manages the small integration service that uses the token to call Spotify and formats an appropriate response. Mysteriously, this Spotify OAuth integration broke.</p><p>Teams at Cloudflare are keen to remain  agile, adaptive, and constantly learning. The current Cloudflare Apps team no longer comprises the original team that developed the Spotify OAuth integration. As such, this current team had no idea why the app broke. Although we had various alerting and logging systems, the Spotify OAuth server was lost in the cloud.</p><p>Our first step to tackling the issue was tracking down, <i>where</i> exactly did the OAuth flow <i>live</i>. After shuffling through several of the potential platforms - GCloud, AWS, Digital Ocean.. - we discovered the service was on Heroku.  The more platforms introduced, the more complexity in deploys and access management.</p><p>I decided to reduce the number of layers in our service by simply creating a serverless Cloudflare Worker with no maintenance, no new logins, and no unique backend configuration.</p><p>Here’s how I did it.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"goodbye-node\">Goodbye Node</h3>\n            <a href=\"#goodbye-node\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The old service used the Node.js and Express.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">app.post(&#039;/blah&#039;, function(request, response) {</pre></code>\n            <p>This states that for every POST to an endpoint <code>/blah</code>, execute the callback function with a request and response object as arguments.</p><p>Cloudflare Workers are built on top of the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API\">Service Workers</a> spec. Instead of mutating the response and calling methods on the response object like in Express, we need to respond to ‘fetch’ events. The code below adds an event listener for fetch events (incoming requests to the worker), receiving a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent\">FetchEvent</a> as the first parameter. The FetchEvent has a special method called <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith\">respondWith</a> that accepts an instance of <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Response\">Response</a> or a Promise which resolves to a Response.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">addEventListener(&quot;fetch&quot;, event =&gt; {\n         event.respondWith(new Response(‘Hello world!’));\n});\n</pre></code>\n            <p>To avoid reimplementation of the routing logic in my worker, I made my own <code>app</code> .</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const app = {\n   get: (endpoint, fn) =&gt; {\n     url = new URL(request.url);\n     if (url.pathname === endpoint &amp;&amp; request.method === &quot;GET&quot;)\n       return fn(request);\n     return null;\n   },\n   post: (endpoint, fn) =&gt; {\n     url = new URL(request.url);\n     if (url.pathname === endpoint &amp;&amp; request.method === &quot;POST&quot;)\n       return fn(request);\n     return null;\n   }\n };</pre></code>\n            <p>Now with app set, I call <code>app.get(..)</code> similar to how I did in Node in my handler. I just need to make sure the handler returns at the correct app.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">async function handleRequest(request) {\n  lastResponse = app.post(&quot;/&quot;, async function (request) {..}\n  if (lastResponse) {\n      return lastResponse;\n    }\n lastResponse =  app.get(&quot;/&quot;, async function (request) {\n if (lastResponse) {\n      return lastResponse;\n    }</pre></code>\n            <p><code>lastResponse</code> ensures that we keep listening for all the endpoint methods.</p><p>The other thing that needs to change is the return of the response. Before that return used <code>response.json()</code>, so the final response would be of JSON type.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">response.json({\n         proceed: false,\n         errors: [{type: &#039;400&#039;, message: error.toString()}]</pre></code>\n            <p>In workers, I need to return a type <code>Response</code> to the <code>respondWith</code> function. I replaced every instance of <code>response.json</code> or <code>response.sendStatus</code> with a new Response object.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">return new Response(\n         JSON.stringify({\n         proceed: false,\n         errors: [{ type: &quot;400&quot;, message: res.error }]\n         }, { headers: { ‘Content-Type’: ‘application/json’ } })</pre></code>\n            <p>Now for the most beautiful part of the transition: delete useless config.</p><p>Our Express server was set to export app as a module insert credentials so that Heroku or whatever non-serverless server could pick up, run, and build.</p><p>Though I <i>can</i> import libraries for workers via <a href=\"/using-webpack-to-bundle-workers/\">webpack</a>, for this application, it’s unreasoned. Also, I have access to fetch and other native service worker functions.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const {getJson} = require(&#039;simple-fetch&#039;)\nmodule.exports = function setRoutes (app) {</pre></code>\n            <p>Getting rid of modules and deployment config, I removed the files: <code>Procfile</code>, <code>credentials.json</code>, <code>package.json</code>, <code>development.js</code>, <code>heroku.js</code>, and <code>create-app.js</code>.<code>Routes.js</code> simply becomes <code>worker.js</code>.</p><p>This was a demo of how workers made my life as a programmer easier. Future developers working with my code can read this code without ever looking at any configuration. Even a purely vanilla bean Javascript developer can come in since there is no managing builds and pulling hair out.</p><p>With serverless I can now spend time on doing what I love - development.</p>",
		"id": "57JO6uOsVn7zF28ZV4HjHo",
		"localeList": {
			"name": "A Node to Workers Story Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2019-03-08T23:04:45.000+00:00",
		"slug": "a-node-to-workers-story",
		"tags": [
			{
				"id": "78aSAeMjGNmCuetQ7B4OgU",
				"name": "JavaScript",
				"slug": "javascript"
			},
			{
				"id": "6hbkItfupogJP3aRDAq6v8",
				"name": "Cloudflare Workers",
				"slug": "workers"
			},
			{
				"id": "5cye1Bh5KxFh3pKSnX8Dsy",
				"name": "Serverless",
				"slug": "serverless"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "3JAY3z7p7An94s6ScuSQPf",
				"name": "Developer Platform",
				"slug": "developer-platform"
			}
		],
		"title": "A Node to Workers Story",
		"updated_at": "2024-10-10T00:32:19.195Z",
		"url": "https://blog.cloudflare.com/a-node-to-workers-story"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}