{
	"locale": "en-us",
	"localesAvailable": [
		"fr-fr",
		"de-de",
		"es-es"
	],
	"post": {
		"authors": [
			{
				"name": "Nick Downie",
				"slug": "nick-downie",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/4XW9mkOc4u06ya7Vxdr5ga/c7ec6a6ff63106bd54a3dbc66f551ec3/nick-downie.jpg",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "Firewall Analytics is the first product in the Cloudflare dashboard to utilize the new GraphQL API. All Cloudflare dashboard products are built using the same public APIs that we provide to our customers, allowing us to understand the challenges they face when interfacing with our APIs.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/5QivoS1cSb6wu822m7ewSZ/90f776b1e096582c43666168595b44aa/how-we-used-our-new-graphql-api-to-build-firewall-analytics.png",
		"featured": false,
		"html": "\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/1Ms5v0G8uX9xVyDYaL3z47/fbab266034006964315fcdeaa9a870f5/analytics-API--copy_2x.png\" alt=\"\" class=\"kg-image\" width=\"1600\" height=\"995\" loading=\"lazy\"/>\n            \n            </figure><p>Firewall Analytics is the first product in the Cloudflare dashboard to utilize the new GraphQL Analytics API. All Cloudflare dashboard products are built using the same public APIs that we provide to our customers, allowing us to understand the challenges they face when interfacing with our APIs. This parity helps us build and shape our products, most recently the new GraphQL Analytics API that we’re thrilled to release today.</p><p>By defining the data we want, along with the response format, our GraphQL Analytics API has enabled us to prototype new functionality and iterate quickly from our beta user feedback. It is helping us deliver more insightful analytics tools within the Cloudflare dashboard to our customers.</p><p>Our user research and testing for <a href=\"/new-firewall-tab-and-analytics/#new-firewall-analytics-for-analysing-events-and-maintaining-optimal-configurations\">Firewall Analytics</a> surfaced common use cases in our customers&#39; workflow:</p><ul><li><p>Identifying spikes in firewall activity over time</p></li><li><p>Understanding the common attributes of threats</p></li><li><p>Drilling down into granular details of an individual event to identify potential false positives</p></li></ul><p>We can address all of these use cases using our new GraphQL Analytics API.</p><h3>GraphQL Basics</h3><p>Before we look into how to address each of these use cases, let&#39;s take a look at the format of a GraphQL query and how our schema is structured.</p><p>A GraphQL query is comprised of a structured set of fields, for which the server provides corresponding values in its response. The schema defines which fields are available and their type. You can find more information about the GraphQL query syntax and format in the <a href=\"https://graphql.org/learn/queries/\">official GraphQL documentation</a>.</p><p>To run some GraphQL queries, we recommend downloading a GraphQL client, such as <a href=\"https://electronjs.org/apps/graphiql\">GraphiQL</a>, to explore our schema and run some queries. You can find documentation on getting started with this in our <a href=\"https://developers.cloudflare.com/analytics/graphql-api/getting-started/\">developer docs</a>.</p><p>At the top level of the schema is the <code>viewer</code> field. This represents the top level node of the user running the query. Within this, we can query the <code>zones</code> field to find zones the current user has access to, providing a <code>filter</code> argument, with a <code>zoneTag</code> of the identifier of the zone we&#39;d like narrow down to.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">{\n  viewer {\n    zones(filter: { zoneTag: &quot;YOUR_ZONE_ID&quot; }) {\n      # Here is where we&#039;ll query our firewall events\n    }\n  }\n}</pre></code>\n            <p>Now that we have a query that finds our zone, we can start querying the firewall events which have occurred in that zone, to help solve some of the use cases we’ve identified.</p><h3>Visualising spikes in firewall activity</h3><p>It&#39;s important for customers to be able to visualise and understand anomalies and spikes in their firewall activity, as these could indicate an attack or be the result of a misconfiguration.</p><p>Plotting events in a timeseries chart, by their respective action, provides users with a visual overview of the trend of their firewall events.</p><p>Within the <code>zones</code> field in the query we’ve created earlier, we can query our firewall event aggregates using the <code>firewallEventsAdaptiveGroups</code> field, providing arguments to limit the count of groups, a filter for the date range we&#39;re looking for (combined with any user-entered filters), and a list of fields to order by; in this case, just the <code>datetimeHour</code> field that we&#39;re grouping by.</p><p>Within the <code>zones</code> field in the query we created earlier, we can further query our firewall event aggregates using the <code>firewallEventsAdaptiveGroups</code> field and providing arguments for:</p><ul><li><p>A <code>limit</code> for the count of groups</p></li><li><p>A <code>filter</code> for the date range we&#39;re looking for (combined with any user-entered filters)</p></li><li><p>A list of fields to <code>orderBy</code> (in this case, just the <code>datetimeHour</code> field that we&#39;re grouping by).</p></li></ul><p>By adding the <code>dimensions</code> field, we&#39;re querying for groups of firewall events, aggregated by the fields nested within <code>dimensions</code>. In this case, our query includes the <code>action</code> and <code>datetimeHour</code> fields, meaning the response will be groups of firewall events which share the same action, and fall within the same hour. We also add a <code>count</code> field, to get a numeric count of how many events fall within each group.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">query FirewallEventsByTime($zoneTag: string, $filter: FirewallEventsAdaptiveGroupsFilter_InputObject) {\n  viewer {\n    zones(filter: { zoneTag: $zoneTag }) {\n      firewallEventsAdaptiveGroups(\n        limit: 576\n        filter: $filter\n        orderBy: [datetimeHour_DESC]\n      ) {\n        count\n        dimensions {\n          action\n          datetimeHour\n        }\n      }\n    }\n  }\n}</pre></code>\n            <p><i>Note - Each of our groups queries require a limit to be set. A firewall event can have one of 8 possible actions, and we are querying over a 72 hour period. At most, we’ll end up with 567 groups, so we can set that as the limit for our query.</i></p><p>This query would return a response in the following format:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">{\n  &quot;viewer&quot;: {\n    &quot;zones&quot;: [\n      {\n        &quot;firewallEventsAdaptiveGroups&quot;: [\n          {\n            &quot;count&quot;: 5,\n            &quot;dimensions&quot;: {\n              &quot;action&quot;: &quot;jschallenge&quot;,\n              &quot;datetimeHour&quot;: &quot;2019-09-12T18:00:00Z&quot;\n            }\n          }\n          ...\n        ]\n      }\n    ]\n  }\n}</pre></code>\n            <p>We can then take these groups and plot each as a point on a time series chart. Mapping over the <code>firewallEventsAdaptiveGroups</code> array, we can use the group’s <code>count</code> property on the y-axis for our chart, then use the nested fields within the <code>dimensions</code> object, using <code>action</code> as unique series and the <code>datetimeHour</code> as the time stamp on the x-axis.</p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/4RH0u6Cc6dIk9ztyZ3E0Ag/dfdfc88b6e5fad91a374f4af4fd2762e/pasted-image-0--1--3.png\" alt=\"\" class=\"kg-image\" width=\"998\" height=\"505\" loading=\"lazy\"/>\n            \n            </figure><h3>Top Ns</h3><p>After identifying a spike in activity, our next step is to highlight events with commonality in their attributes. For example, if a certain IP address or individual user agent is causing many firewall events, this could be a sign of an individual attacker, or could be surfacing a false positive.</p><p>Similarly to before, we can query aggregate groups of firewall events using the <code>firewallEventsAdaptiveGroups</code> field. However, in this case, instead of supplying <code>action</code> and <code>datetimeHour</code> to the group’s <code>dimensions</code>, we can add individual fields that we want to find common groups of.</p><p>By ordering by descending count, we’ll retrieve groups with the highest commonality first, limiting to the top 5 of each. We can add a single field nested within <code>dimensions</code> to group by it. For example, adding <code>clientIP</code> will give five groups with the IP addresses causing the most events.</p><p>We can also add a <code>firewallEventsAdaptiveGroups</code> field with no nested <code>dimensions</code>. This will create a single group which allows us to find the total count of events matching our filter.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">query FirewallEventsTopNs($zoneTag: string, $filter: FirewallEventsAdaptiveGroupsFilter_InputObject) {\n  viewer {\n    zones(filter: { zoneTag: $zoneTag }) {\n      topIPs: firewallEventsAdaptiveGroups(\n        limit: 5\n        filter: $filter\n        orderBy: [count_DESC]\n      ) {\n        count\n        dimensions {\n          clientIP\n        }\n      }\n      topUserAgents: firewallEventsAdaptiveGroups(\n        limit: 5\n        filter: $filter\n        orderBy: [count_DESC]\n      ) {\n        count\n        dimensions {\n          userAgent\n        }\n      }\n      total: firewallEventsAdaptiveGroups(\n        limit: 1\n        filter: $filter\n      ) {\n        count\n      }\n    }\n  }\n}</pre></code>\n            <p><i>Note - we can add the </i><code><i>firewallEventsAdaptiveGroups</i></code><i> field multiple times within a single query, each aliased differently. This allows us to fetch multiple different groupings by different fields, or with no groupings at all. In this case, getting a list of top IP addresses, top user agents, and the total events.</i></p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/48ybDlyb9qiOXRcqbxYMBT/d4d00cef7835e84131c644a94d746bc7/pasted-image-0--2--1.png\" alt=\"\" class=\"kg-image\" width=\"1025\" height=\"813\" loading=\"lazy\"/>\n            \n            </figure><p>We can then reference each of these aliases in the UI, mapping over their respective groups to render each row with its count, and a bar which represents the proportion of total events, showing the proportion of all events each row equates to.</p><h3>Are these firewall events false positives?</h3><p>After users have identified spikes, anomalies and common attributes, we wanted to surface more information as to whether these have been caused by malicious traffic, or are false positives.</p><p>To do this, we wanted to provide additional context on the events themselves, rather than just counts. We can do this by querying the <code>firewallEventsAdaptive</code> field for these events.</p><p>Our GraphQL schema uses the same filter format for both the aggregate <code>firewallEventsAdaptiveGroups</code> field and the raw <code>firewallEventsAdaptive</code> field. This allows us to use the same filters to fetch the individual events which summate to the counts and aggregates in the visualisations above.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">query FirewallEventsList($zoneTag: string, $filter: FirewallEventsAdaptiveFilter_InputObject) {\n  viewer {\n    zones(filter: { zoneTag: $zoneTag }) {\n      firewallEventsAdaptive(\n        filter: $filter\n        limit: 10\n        orderBy: [datetime_DESC]\n      ) {\n        action\n        clientAsn\n        clientCountryName\n        clientIP\n        clientRequestPath\n        clientRequestQuery\n        datetime\n        rayName\n        source\n        userAgent\n      }\n    }\n  }\n}</pre></code>\n            \n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/5BmadcWdFvLxALf8fO3MbW/f67acc01a77edf0eec2a0e462e1e6579/pasted-image-0--3--1.png\" alt=\"\" class=\"kg-image\" width=\"1150\" height=\"580\" loading=\"lazy\"/>\n            \n            </figure><p>Once we have our individual events, we can render all of the individual fields we’ve requested, providing users the additional context on event they need to determine whether this is a false positive or not.</p><p>That’s how we used our new GraphQL Analytics API to build Firewall Analytics, helping solve some of our customers most common security workflow use cases. We’re excited to see what you build with it, and the problems you can help tackle.</p><p>You can find out how to get started querying our GraphQL Analytics API using GraphiQL in our <a href=\"https://developers.cloudflare.com/analytics/graphql-api/getting-started/\">developer documentation</a>, or learn more about writing GraphQL queries on the official GraphQL Foundation <a href=\"https://graphql.org/learn/queries/\">documentation</a>.</p>",
		"id": "3I5BKE6KqU328LA4QoiQQX",
		"localeList": {
			"name": "How we used our new GraphQL Analytics API to build Firewall Analytics Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "Translated for Locale",
			"deDE": "Translated for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "Translated for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2019-12-12T15:41:20.000+00:00",
		"reading_time": 6,
		"slug": "how-we-used-our-new-graphql-api-to-build-firewall-analytics",
		"tags": [
			{
				"id": "6QktrXeEFcl4e2dZUTZVGl",
				"name": "Product News",
				"slug": "product-news"
			},
			{
				"id": "2OotqBxtRdi5MuC90AlyxE",
				"name": "Analytics",
				"slug": "analytics"
			},
			{
				"id": "5x72ei67SoD11VQ0uqFtpF",
				"name": "API",
				"slug": "api"
			},
			{
				"id": "6GfYtlrIy3UkkZHclLS3LX",
				"name": "GraphQL",
				"slug": "graphql"
			}
		],
		"title": "How we used our new GraphQL Analytics API to build Firewall Analytics",
		"updated_at": "2024-08-27T02:06:57.522Z",
		"url": "https://blog.cloudflare.com/how-we-used-our-new-graphql-api-to-build-firewall-analytics"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}