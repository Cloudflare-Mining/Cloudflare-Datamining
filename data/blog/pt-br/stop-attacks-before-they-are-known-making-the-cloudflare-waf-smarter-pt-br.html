<div class="mb2 gray5">7 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image5-2.png" class="kg-image" alt="Stop attacks before they are known: making the Cloudflare WAF smarter" loading="lazy"></figure>
	<p>O <a href="https://www.cloudflare.com/waf" target="_blank">Cloudflare WAF</a> ajuda os proprietários de sites a manter seus aplicativos protegidos contra invasores. Ele faz isso analisando o tráfego com as <a href="https://developers.cloudflare.com/waf/managed-rulesets/reference/cloudflare-managed-ruleset" target="_blank">regras gerenciadas da Cloudflare</a>: regras escritas à mão altamente especializadas que detectam e interrompem cargas maliciosas. Mas há um problema: se uma regra não for escrita para um ataque específico, ela não o detectará.</p>
	<p>Hoje, resolvemos esse problema tornando nosso WAF mais inteligente e anunciamos nosso sistema de pontuação de ataques WAF em disponibilidade geral.</p>
	<p>Os clientes em nossos pacotes Enterprise Core e Advanced Security terão acesso gradual a esse novo recurso. Todos os outros clientes Enterprise terão acesso nos próximos meses.</p>
	<p>Nosso sistema de pontuação de ataques WAF, totalmente compatível com as regras gerenciadas da Cloudflare, classifica todas as solicitações usando um modelo treinado em verdadeiros positivos observados em toda a rede da Cloudflare, permitindo que você detecte (e bloqueie) evasão, desvio e novas técnicas de ataque antes que sejam conhecidas publicamente.</p>
	<h2 id="o-problema-com-wafs-baseados-em-assinatura">O problema com WAFs baseados em assinatura</h2>
	<p>Os invasores que tentam se infiltrar em aplicativos web geralmente usam cargas conhecidas ou divulgadas recentemente. O Cloudflare WAF foi desenvolvido para lidar muito bem com esses ataques. O conjunto de regras gerenciadas da Cloudflare e o conjunto de regras gerenciadas do <a href="https://en.wikipedia.org/wiki/OWASP" target="_blank">OWASP</a> da Cloudflare são, de fato, continuamente atualizados e visam proteger aplicativos web contra ameaças conhecidas, minimizando falsos positivos.</p>
	<p>As coisas ficam mais difíceis com ataques não conhecidos publicamente, geralmente chamados de ataques de <a href="https://en.wikipedia.org/wiki/Zero-day_(computing)" target="_blank">dia zero</a>. Enquanto nossas equipes fazem o possível para pesquisar novos vetores de ameaças e manter as regras gerenciadas da Cloudflare atualizadas, a velocidade humana se torna um fator limitante. Sempre que um novo vetor é encontrado, uma janela de oportunidade fica disponível para os invasores escaparem das mitigações.</p>
	<p>Um exemplo bem conhecido foi o ataque <a href="https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation">Log4j RCE</a>, no qual tivemos que implantar atualizações de regras frequentes à medida que novos desvios eram descobertos, alterando os <a href="https://blog.cloudflare.com/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">padrões de ataque</a> conhecidos.</p>
	<h2 id="a-solu-o-complementar-as-assinaturas-com-um-modelo-de-pontua-o-de-aprendizado-de-m-quina">A solução: complementar as assinaturas com um modelo de pontuação de aprendizado de máquina</h2>
	<p>Nosso sistema de pontuação de ataques WAF é um aprimoramento baseado em aprendizado de máquina para o Cloudflare WAF. Ele pontua cada solicitação com a probabilidade de ser maliciosa. Você pode usar essa pontuação ao implementar as regras personalizadas do WAF para manter seu aplicativo seguro junto com as regras gerenciadas da Cloudflare existentes.</p>
	<h3 id="como-usamos-o-aprendizado-de-m-quina-no-cloudflare-waf">Como usamos o aprendizado de máquina no Cloudflare WAF?</h3>
	<p>Em qualquer problema de classificação, a qualidade do conjunto de treinamento está diretamente relacionada à qualidade da saída da classificação; portanto, muito esforço foi colocado na preparação dos dados de treinamento.</p>
	<p>E foi aqui que usamos um superpoder da Cloudflare: aproveitamos a visibilidade da rede da Cloudflare reunindo milhões de amostras verdadeiramente positivas geradas por nosso WAF baseado em assinatura existente e o aprimoramos ainda mais usando técnicas abordadas em “<a href="https://blog.cloudflare.com/data-generation-and-sampling-strategies">Improving the accuracy of our machine learning WAF</a>” .</p>
	<p>Isso nos permitiu treinar um modelo capaz de classificar, uma determinada solicitação HTTP, com a probabilidade de que ela contenha uma carga maliciosa, mas, mais importante, classificar quando uma solicitação é muito semelhante a um verdadeiro positivo conhecido, mas suficientemente diferente para evitar uma correspondência de regra gerenciada.</p>
	<p>O modelo é executado em linha com o tráfego HTTP e, a partir de hoje, está otimizado para três categorias de ataque: Injeção de SQL (SQLi), Cross Site Scripting (XSS) e uma ampla variedade de ataques de Execução Remota de Código (RCE), como injeção de shell, injeção PHP, comprometimentos do tipo Apache Struts, Apache log4j e ataques semelhantes que resultam em RCE. Planejamos adicionar outros tipos de ataque no futuro.</p>
	<p>As pontuações de saída são semelhantes às pontuações do <a href="https://blog.cloudflare.com/introducing-bot-analytics">Gerenciamento de bots</a>; elas variam entre 1 e 99, onde pontuações baixas indicam malicioso ou provavelmente malicioso e pontuações altas indicam solicitação HTTP limpa ou provavelmente limpa.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image4-5.png" class="kg-image" alt="Scale showing distribution of the WAF Attack Score between 1 and 99" loading="lazy"></figure>
	<h3 id="provando-o-valor-imediato">Provando o valor imediato</h3>
	<p>Como exemplo da eficácia deste novo sistema, em 13 de outubro de 2022, o <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-42889" target="_blank">CVE-2022-42889</a> foi identificado como uma “gravidade crítica” no <a href="https://github.com/apache/commons-text" target="_blank">Apache Commons Text</a> afetando as versões 1.5 a 1.9.</p>
	<p>A carga usada no ataque, embora não tenha sido imediatamente bloqueada pelas regras gerenciadas da Cloudflare, foi identificada corretamente (por pontuação muito baixa) por nosso sistema de pontuação de ataques. Isso nos permitiu proteger os endpoints, identificar o ataque e implantar em tempo zero. Claro, também atualizamos as regras gerenciadas da Cloudflare para cobrir o novo vetor de ataque, pois isso nos permite melhorar nossos dados de treinamento completando ainda mais nosso ciclo de feedback.</p>
	<h2 id="saiba-o-que-voc-n-o-sabe-com-o-novo-security-analytics">Saiba o que você não sabe com o novo Security Analytics</h2>
	<p>Além do sistema de pontuação de ataques, temos outro grande anúncio: nosso novo Security Analytics. Você pode ler mais sobre ele no <a href="https://blog.cloudflare.com/security-analytics">comunicado oficial</a>.</p>
	<p>Usando o Security Analytics, você pode visualizar a distribuição da pontuação do ataque, independentemente de as solicitações terem sido bloqueadas ou não, permitindo que você explore ataques possivelmente maliciosos antes de implantar quaisquer regras.</p>
	<p>A exibição não mostra apenas o WAF Attack Score, mas também o Gerenciamento de bots e o Content Scanning com a capacidade de misturar e combinar filtros conforme desejado.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image1-10.png" class="kg-image" alt="Snapshot from the dashboard showing the Analytics default view" loading="lazy"></figure>
	<h2 id="como-usar-o-waf-attack-score-e-o-security-analytics">Como usar o WAF Attack Score e o Security Analytics</h2>
	<p>Vamos fazer um tour para detectar ataques usando o novo Security Analytics e, em seguida, usar o WAF Attack Score para mitigá-los.</p>
	<h3 id="vamos-come-ar-com-o-security-analytics">Vamos começar com o Security Analytics</h3>
	<p>Essa nova visualização tem o poder de mostrar tudo sobre o seu tráfego em um só lugar. Você tem dezenas de filtros para misturar e combinar, principais estatísticas, várias distribuições de gráficos interativos, bem como amostras de logs para verificar seus insights. Em essência, isso oferece a capacidade de visualizar vários filtros sem a necessidade de criar regras personalizadas de WAF em primeiro lugar.</p>
	<p><strong>Etapa 1</strong> – acessar o novo Security Analytics: para acessar o novo Security Analytics no painel, vá até a guia “Segurança” (<strong>Segurança &gt; Analytics</strong>), a guia anterior (<strong>Segurança &gt; Visão geral</strong>) ainda existe em (<strong>Segurança &gt; Eventos</strong>). Você deve ter acesso, pelo menos, ao WAF Attack Score para poder visualizar o novo Security Analytics por enquanto.</p>
	<p><strong>Etapa 2</strong> – explorar insights: na nova página do Analytics, você verá a distribuição de tempo de todo o tráfego, juntamente com muitos filtros no lado direito, mostrando distribuições para vários recursos, incluindo o WAF Attack Score e a pontuação do Gerenciamento de bots, para que fique super fácil aplicar filtros interessantes, adicionamos a seção “Insights”.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image7.png" class="kg-image" alt="Graph displayed in the dashboard showing HTTP requests distribution" loading="lazy"></figure>
	<p>Ao escolher a opção “Attack Analysis”, você tem uma visão geral do gráfico de barras de como seu tráfego fica na perspectiva do WAF Attack Score.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image6.png" class="kg-image" alt="Snapshot from the dashboard showing Attack analysis stacked chart distribution" loading="lazy"></figure>
	<p><strong>Etapa 3</strong> – filtrar o tráfego de ataque: um bom lugar para começar é procurar por solicitações HTTP não mitigadas, classificadas como ataques. Você pode fazer isso usando os controles deslizantes de pontuação de ataques no lado direito ou selecionando qualquer um dos filtros de insights com atalhos de um clique fáceis de usar. Todos os gráficos serão atualizados automaticamente de acordo com os filtros selecionados.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image8.png" class="kg-image" alt="Snapshot shows insights usage to propagate multiple filters at once" loading="lazy"></figure>
	<p><strong>Etapa 4</strong> – verificar o tráfego de ataque: isso pode ser feito expandindo os logs de amostra abaixo do gráfico de distribuição de tráfego, por exemplo, no log expandido abaixo, você pode ver uma pontuação RCE muito baixa indicando um "Ataque", juntamente com a pontuação do Bot indicando que a solicitação era “Likely Automated” (provavelmente automatizada). Observando o campo “Path” (caminho), podemos confirmar que realmente se trata de uma solicitação maliciosa. Observe que nem todos os campos estão registrados/mostrados no momento. Por exemplo, uma solicitação pode receber uma pontuação baixa devido a uma carga maliciosa no corpo do HTTP que não pode ser facilmente verificada nas amostra de logs hoje.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image3-2.png" class="kg-image" alt="Expanded log of an attack from the new analytics view" loading="lazy"></figure>
	<p><strong>Etapa 5</strong> – criar uma regra para mitigar o tráfego de ataque: depois de verificar que seu filtro não está correspondendo a falsos positivos, com um único clique no botão “Criar regra personalizada”, você será direcionado ao construtor de regras personalizadas do WAF com todos os seus filtros pré-preenchidos e prontos para “Implantar”.</p>
	<h3 id="pontua-es-de-ataque-em-logs-de-eventos-de-seguran-a">Pontuações de ataque em logs de eventos de segurança</h3>
	<p>As pontuações de ataque WAF também estão disponíveis em <a href="https://developers.cloudflare.com/logs/reference/log-fields/zone/http_requests" target="_blank">logs de HTTP</a> e navegando para <strong>(Segurança &gt; Eventos)</strong> ao expandir qualquer uma das amostras de logs de eventos:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image2-7.png" class="kg-image" alt="Expanded log in the security events tab highlighting WAF attack scores" loading="lazy"></figure>
	<p>Observe que todos os novos campos estão disponíveis em regras personalizadas do WAF e regras de Rate Limiting do WAF. Eles estão documentados em nossa <a href="https://developers.cloudflare.com/waf/about/waf-ml" target="_blank">documentação para desenvolvedores</a>: <code>cf.waf.score</code>, <code>cf.waf.score.xss</code>, <code>cf.waf.score.sqli</code> e <code>cf.waf.score.rce</code>.</p>
	<p>Embora a maneira mais fácil de usar esses campos seja iniciar no novo painel do Security Analytics, conforme descrito acima, você pode usá-los como estão ao criar regras e, claro, combinar com qualquer outro campo disponível. O exemplo a seguir implanta uma regra de ação "Log" para qualquer solicitação com WAF Attack Score agregado (<code>cf.waf.score</code>) inferior a 40.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image9.png" class="kg-image" alt="Dashboard view of a custom rule with action log for WAF Attack Score less than 40" loading="lazy"></figure>
	<h2 id="o-que-vem-a-seguir">O que vem a seguir?</h2>
	<p>Este é apenas o primeiro passo de muitos para tornar nosso Cloudflare WAF verdadeiramente “inteligente”. Além de lançar essa nova tecnologia para mais clientes, já estamos trabalhando para fornecer visibilidade ainda melhor e cobrir vetores de ataque adicionais. Por tudo isso e muito mais, fique ligado.</p>
</div>