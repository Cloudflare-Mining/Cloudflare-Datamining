{
	"footerBlurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
	"initialReadingTime": "4",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "James M Snell",
				"slug": "jasnell",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5dR6CJtYedvLrkAZ6rxv9I/0db3d5a763a8b0a350ac04ac6410da6b/jasnell.jpg",
				"location": "California",
				"website": "https://bsky.app/profile/jasnell.me",
				"facebook": null
			}
		],
		"excerpt": "Over the coming months, Cloudflare Workers will start to roll out built-in compatibility with Node.js core APIs as part of an effort to support increased compatibility across JavaScript runtimes",
		"feature_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1k2cY3yKZIuzqd1wRuvwoQ/e90c731127209536cd983f5e8fdf0b91/workers-node-js-asynclocalstorage.png",
		"featured": false,
		"html": "\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6YKC6jhVmTt96NeN3UNtQ4/b43fd153bbd2d8f3251a804c7368d96e/image1-43.png\" alt=\"Node.js compatibility for Cloudflare Workers – starting with Async Context Tracking, EventEmitter, Buffer, assert, and util\" class=\"kg-image\" width=\"1810\" height=\"1022\" loading=\"lazy\"/>\n            \n            </figure><p>Over the coming months, Cloudflare Workers will start to roll out built-in compatibility with Node.js core APIs as part of an effort to support increased compatibility across JavaScript runtimes.</p><p>We are happy to announce today that the first of these Node.js APIs – <code>AsyncLocalStorage</code>, <code>EventEmitter</code>, <code>Buffer</code>, <code>assert</code>, and parts of <code>util</code> – are now available for use. These APIs are provided directly by the <a href=\"https://github.com/cloudflare/workerd\">open-source Cloudflare Workers runtime</a>, with no need to bundle polyfill implementations into your own code.</p><p>These new APIs are available today — start using them by enabling the <code>nodejs_compat</code> <a href=\"https://developers.cloudflare.com/workers/platform/compatibility-dates/\">compatibility flag</a> in your Workers.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"async-context-tracking-with-the-asynclocalstorage-api\">Async Context Tracking with the AsyncLocalStorage API</h3>\n            <a href=\"#async-context-tracking-with-the-asynclocalstorage-api\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The <code>AsyncLocalStorage</code> API provides a way to track context across asynchronous operations. It allows you to pass a value through your program, even across multiple layers of asynchronous code, without having to pass a context value between operations.</p><p>Consider an example where we want to add debug logging that works through multiple layers of an application, where each log contains the ID of the current request. Without AsyncLocalStorage, it would be necessary to explicitly pass the request ID down through every function call that might invoke the logging function:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">function logWithId(id, state) {\n  console.log(`${id} - ${state}`);\n}\n\nfunction doSomething(id) {\n  // We don&#039;t actually use id for anything in this function!\n  // It&#039;s only here because logWithId needs it.\n  logWithId(id, &quot;doing something&quot;);\n  setTimeout(() =&gt; doSomethingElse(id), 10);\n}\n\nfunction doSomethingElse(id) {\n  logWithId(id, &quot;doing something else&quot;);\n}\n\nlet idSeq = 0;\n\nexport default {\n  async fetch(req) {\n    const id = idSeq++;\n    doSomething(id);\n    logWithId(id, &#039;complete&#039;);\n    return new Response(&quot;ok&quot;);\n  }\n}</pre></code>\n            <p>While this approach works, it can be cumbersome to coordinate correctly, especially as the complexity of an application grows. Using <code>AsyncLocalStorage</code> this becomes significantly easier by eliminating the need to explicitly pass the context around. Our application functions (<code>doSomething</code> and <code>doSomethingElse</code> in this case) never need to know about the request ID at all while the <code>logWithId</code> function does exactly what we need it to:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { AsyncLocalStorage } from &#039;node:async_hooks&#039;;\n\nconst requestId = new AsyncLocalStorage();\n\nfunction logWithId(state) {\n  console.log(`${requestId.getStore()} - ${state}`);\n}\n\nfunction doSomething() {\n  logWithId(&quot;doing something&quot;);\n  setTimeout(() =&gt; doSomethingElse(), 10);\n}\n\nfunction doSomethingElse() {\n  logWithId(&quot;doing something else&quot;);\n}\n\nlet idSeq = 0;\n\nexport default {\n  async fetch(req) {\n    return requestId.run(idSeq++, () =&gt; {\n      doSomething();\n      logWithId(&#039;complete&#039;);\n      return new Response(&quot;ok&quot;);\n    });\n  }\n}</pre></code>\n            <p>With the <code>nodejs_compat</code> <a href=\"https://developers.cloudflare.com/workers/platform/compatibility-dates/\">compatibility flag</a> enabled, import statements are used to access specific APIs. The Workers implementation of these APIs requires the use of the node: specifier prefix that was introduced recently in Node.js (e.g. <code>node:async_hooks</code>, <code>node:events</code>, etc)</p><p>We implement <a href=\"https://github.com/wintercg/proposal-common-minimum-api/blob/main/asynclocalstorage.md\">a subset</a> of the <code>AsyncLocalStorage</code> API in order to keep things as simple as possible. Specifically, we&#39;ve chosen not to support the <code>enterWith()</code> and <code>disable()</code> APIs that are found in Node.js implementation simply because they make async context tracking more brittle and error prone.</p><p>Conceptually, at any given moment within a worker, there is a current &quot;Asynchronous Context Frame&quot;, which consists of a map of storage cells, each holding a store value for a specific <code>AsyncLocalStorage</code> instance. Calling <code>asyncLocalStorage.run(...)</code> causes a new frame to be created, inheriting the storage cells of the current frame, but using the newly provided store value for the cell associated with <code>asyncLocalStorage</code>.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const als1 = new AsyncLocalStorage();\nconst als2 = new AsyncLocalStorage();\n\n// Code here runs in the root frame. There are two storage cells,\n// one for als1, and one for als2. The store value for each is\n// undefined.\n\nals1.run(123, () =&gt; {\n  // als1.run(...) creates a new frame (1). The store value for als1\n  // is set to 123, the store value for als2 is still undefined.\n  // This new frame is set to &quot;current&quot;.\n\n  als2.run(321, () =&gt; {\n    // als2.run(...) creates another new frame (2). The store value\n    // for als1 is still 123, the store value for als2 is set to 321.\n    // This new frame is set to &quot;current&quot;.\n    console.log(als1.getStore(), als2.getStore());\n  });\n\n  // Frame (1) is restored as the current. The store value for als1\n  // is still 123, but the store value for als2 is undefined again.\n});\n\n// The root frame is restored as the current. The store values for\n// both als1 and als2 are both undefined again.</pre></code>\n            <p>Whenever an asynchronous operation is initiated in JavaScript, for example, creating a new JavaScript promise, scheduling a timer, etc, the current frame is captured and associated with that operation, allowing the store values at the moment the operation was initialized to be propagated and restored as needed.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">const als = new AsyncLocalStorage();\nconst p1 = als.run(123, () =&gt; {\n  return promise.resolve(1).then(() =&gt; console.log(als.getStore());\n});\n\nconst p2 = promise.resolve(1); \nconst p3 = als.run(321, () =&gt; {\n  return p2.then(() =&gt; console.log(als.getStore()); // prints 321\n});\n\nals.run(&#039;ABC&#039;, () =&gt; setInterval(() =&gt; {\n  // prints &quot;ABC&quot; to the console once a second…\n  setInterval(() =&gt; console.log(als.getStore(), 1000);\n});\n\nals.run(&#039;XYZ&#039;, () =&gt; queueMicrotask(() =&gt; {\n  console.log(als.getStore());  // prints &quot;XYZ&quot;\n}));</pre></code>\n            <p>Note that for unhandled promise rejections, the &quot;<code>unhandledrejection</code>&quot; event will automatically propagate the context that is associated with the promise that was rejected. This behavior is different from other types of events emitted by <code>EventTarget</code> implementations, which will propagate whichever frame is current when the event is emitted.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const asyncLocalStorage = new AsyncLocalStorage();\n\nasyncLocalStorage.run(123, () =&gt; Promise.reject(&#039;boom&#039;));\nasyncLocalStorage.run(321, () =&gt; Promise.reject(&#039;boom2&#039;));\n\naddEventListener(&#039;unhandledrejection&#039;, (event) =&gt; {\n  // prints 123 for the first unhandled rejection (&#039;boom&#039;), and\n  // 321 for the second unhandled rejection (&#039;boom2&#039;)\n  console.log(asyncLocalStorage.getStore());\n});</pre></code>\n            <p>Workers can use the <code>AsyncLocalStorage.snapshot()</code> method to create their own objects that capture and propagate the context:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const asyncLocalStorage = new AsyncLocalStorage();\n\nclass MyResource {\n  #runInAsyncFrame = AsyncLocalStorage.snapshot();\n\n  doSomething(...args) {\n    return this.#runInAsyncFrame((...args) =&gt; {\n      console.log(asyncLocalStorage.getStore());\n    }, ...args);\n  }\n}\n\nconst resource1 = asyncLocalStorage.run(123, () =&gt; new MyResource());\nconst resource2 = asyncLocalStorage.run(321, () =&gt; new MyResource());\n\nresource1.doSomething();  // prints 123\nresource2.doSomething();  // prints 321</pre></code>\n            <p>For more, refer to the <a href=\"https://nodejs.org/dist/latest-v18.x/docs/api/async_context.html#class-asynclocalstorage\">Node.js documentation</a> about the <code>AsyncLocalStorage</code> API.</p><p>There is currently an effort underway to add a new <a href=\"https://github.com/tc39/proposal-async-context\">AsyncContext</a> mechanism (inspired by <code>AsyncLocalStorage</code>) to the JavaScript language itself. While it is still early days for the TC-39 proposal, there is good reason to expect it to progress through the committee. Once it does, we look forward to being able to make it available in the Cloudflare Workers platform. We expect our implementation of <code>AsyncLocalStorage</code> to be compatible with this new API.</p><p>The proposal for AsyncContext provides an excellent set of examples and <a href=\"https://github.com/tc39/proposal-async-context#motivation\">description of the motivation</a> of why async context tracking is useful.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"events-with-eventemitter\">Events with EventEmitter</h3>\n            <a href=\"#events-with-eventemitter\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The EventEmitter API is one of the most fundamental Node.js APIs and is critical to supporting many other higher level APIs, including streams, crypto, net, and more. An EventEmitter is an object that emits named events that cause listeners to be called.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { EventEmitter } from &#039;node:events&#039;;\n\nconst emitter = new EventEmitter();\nemitter.on(&#039;hello&#039;, (...args) =&gt; {\n  console.log(...args);\n});\n\nemitter.emit(&#039;hello&#039;, 1, 2, 3);</pre></code>\n            <p>The <a href=\"https://github.com/cloudflare/workerd/blob/main/src/node/internal/events.ts\">implementation</a> in the Workers runtime fully supports the entire Node.js EventEmitter API including the captureRejections option that allows improved handling of async functions as event handlers:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const emitter = new EventEmitter({ captureRejections: true });\nemitter.on(&#039;hello&#039;, async (...args) =&gt; {\n  throw new Error(&#039;boom&#039;);\n});\nemitter.on(&#039;error&#039;, (err) =&gt; {\n  // the async promise rejection is emitted here!\n});</pre></code>\n            <p>Please refer to the Node.js documentation for more details on the use of the <code>EventEmitter</code> API: <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/events.html#events\">https://nodejs.org/dist/latest-v19.x/docs/api/events.html#events</a>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"buffer\">Buffer</h3>\n            <a href=\"#buffer\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The <code>Buffer</code> API in Node.js predates the introduction of the standard TypedArray and DataView APIs in JavaScript by many years and has persisted as one of the most commonly used Node.js APIs for manipulating binary data. Today, every Buffer instance extends from the standard Uint8Array class but adds a range of unique capabilities such as built-in base64 and hex encoding/decoding, byte-order manipulation, and encoding-aware substring searching.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { Buffer } from &#039;node:buffer&#039;;\n\nconst buf = Buffer.from(&#039;hello world&#039;, &#039;utf8&#039;);\n\nconsole.log(buf.toString(&#039;hex&#039;));\n// Prints: 68656c6c6f20776f726c64\nconsole.log(buf.toString(&#039;base64&#039;));\n// Prints: aGVsbG8gd29ybGQ=</pre></code>\n            <p>Because a Buffer extends from Uint8Array, it can be used in any workers API that currently accepts Uint8Array, such as creating a new Response:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const response = new Response(Buffer.from(&quot;hello world&quot;));</pre></code>\n            <p>Or interacting with streams:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">const writable = getWritableStreamSomehow();\nconst writer = writable.getWriter();\nwriter.write(Buffer.from(&quot;hello world&quot;));</pre></code>\n            <p>Please refer to the Node.js documentation for more details on the use of the Buffer API: <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/buffer.html\">https://nodejs.org/dist/latest-v19.x/docs/api/buffer.html</a>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"assertions\">Assertions</h3>\n            <a href=\"#assertions\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The assert module in Node.js provides a number of useful assertions that are useful when building tests.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import {\n  strictEqual,\n  deepStrictEqual,\n  ok,\n  doesNotReject,\n} from &#039;node:assert&#039;;\n\nstrictEqual(1, 1); // ok!\nstrictEqual(1, &quot;1&quot;); // fails! throws AssertionError\n\ndeepStrictEqual({ a: { b: 1 }}, { a: { b: 1 }});// ok!\ndeepStrictEqual({ a: { b: 1 }}, { a: { b: 2 }});// fails! throws AssertionError\n\nok(true); // ok!\nok(false); // fails! throws AssertionError\n\nawait doesNotReject(async () =&gt; {}); // ok!\nawait doesNotReject(async () =&gt; { throw new Error(&#039;boom&#039;) }); // fails! throws AssertionError</pre></code>\n            <p>In the Workers implementation of assert, all assertions run in what Node.js calls the &quot;<a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/assert.html#strict-assertion-mode\">strict assertion mode</a>&quot;, which means that non-strict methods behave like their corresponding strict methods. For instance, <code>deepEqual()</code> will behave like <code>deepStrictEqual()</code>.</p><p>Please refer to the Node.js documentation for more details on the use of the assertion API: <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/assert.html\">https://nodejs.org/dist/latest-v19.x/docs/api/assert.html</a>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"promisify-callbackify\">Promisify/Callbackify</h3>\n            <a href=\"#promisify-callbackify\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The <code>promisify</code> and callbackify APIs in Node.js provide a means of bridging between a Promise-based programming model and a callback-based model.</p><p>The <code>promisify</code> method allows taking a Node.js-style callback function and converting it into a Promise-returning async function:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { promisify } from &#039;node:util&#039;;\n\nfunction foo(args, callback) {\n  try {\n    callback(null, 1);\n  } catch (err) {\n    // Errors are emitted to the callback via the first argument.\n    callback(err);\n  }\n}\n\nconst promisifiedFoo = promisify(foo);\nawait promisifiedFoo(args);</pre></code>\n            <p>Similarly, callbackify converts a Promise-returning async function into a Node.js-style callback function:</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { callbackify } from &#039;node:util&#039;;\n\nasync function foo(args) {\n  throw new Error(&#039;boom&#039;);\n}\n\nconst callbackifiedFoo = callbackify(foo);\n\ncallbackifiedFoo(args, (err, value) =&gt; {\n  if (err) throw err;\n});</pre></code>\n            <p>Together these utilities make it easy to properly handle all of the generally tricky nuances involved with properly bridging between callbacks and promises.</p><p>Please refer to the Node.js documentation for more information on how to use these APIs: <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utilcallbackifyoriginal\">https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utilcallbackifyoriginal</a>, <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utilpromisifyoriginal\">https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utilpromisifyoriginal</a>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"type-brand-checking-with-util-types\">Type brand-checking with util.types</h3>\n            <a href=\"#type-brand-checking-with-util-types\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The util.types API provides a reliable and generally more efficient way of checking that values are instances of various built-in types.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">import { types } from &#039;node:util&#039;;\n\ntypes.isAnyArrayBuffer(new ArrayBuffer());  // Returns true\ntypes.isAnyArrayBuffer(new SharedArrayBuffer());  // Returns true\ntypes.isArrayBufferView(new Int8Array());  // true\ntypes.isArrayBufferView(Buffer.from(&#039;hello world&#039;)); // true\ntypes.isArrayBufferView(new DataView(new ArrayBuffer(16)));  // true\ntypes.isArrayBufferView(new ArrayBuffer());  // false\nfunction foo() {\n  types.isArgumentsObject(arguments);  // Returns true\n}\ntypes.isAsyncFunction(function foo() {});  // Returns false\ntypes.isAsyncFunction(async function foo() {});  // Returns true\n// .. and so on</pre></code>\n            <p>Please refer to the Node.js documentation for more information on how to use the type check APIs: <a href=\"https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utiltypes\">https://nodejs.org/dist/latest-v19.x/docs/api/util.html#utiltypes</a>. The workers implementation currently does not provide implementations of the <code>util.types.isExternal()</code>, <code>util.types.isProxy()</code>, <code>util.types.isKeyObject()</code>, or <code>util.type.isWebAssemblyCompiledModule()</code> APIs.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"whats-next\">What's next</h3>\n            <a href=\"#whats-next\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>Keep your eyes open for more Node.js core APIs coming to Cloudflare Workers soon! We currently have implementations of the string decoder, streams and crypto APIs in active development. These will be introduced into the workers runtime incrementally over time and any worker using the <code>nodejs_compat</code> compatibility flag will automatically pick up the new modules as they are added.</p>",
		"id": "3sNrfiJGZc4oDIOguVYgq9",
		"localeList": {
			"name": "Node.js compatibility for Cloudflare Workers – starting with Async Context Tracking, EventEmitter, Buffer, assert, and util Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": "Over the coming months, Cloudflare Workers will start to roll out built-in compatibility with Node.js core APIs as part of an effort to support increased compatibility across JavaScript runtimes.",
		"metadata": {
			"title": "Node.js compatibility for Cloudflare Workers – starting with Async Context Tracking, EventEmitter, Buffer, assert, and util",
			"description": "Over the coming months, Cloudflare Workers will start to roll out built-in compatibility with Node.js core APIs as part of an effort to support increased compatibility across JavaScript runtimes.",
			"imgPreview": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/61Ykz9S3MgLQpFI9DGPagV/591a02117e1c60bbcd9175b6e98d4133/workers-node-js-asynclocalstorage-CiVT0I.png"
		},
		"primary_author": {},
		"published_at": "2023-03-23T13:05:00.000+00:00",
		"slug": "workers-node-js-asynclocalstorage",
		"tags": [
			{
				"id": "3XzVULQKajbCuWudT6JD0p",
				"name": "Node.js",
				"slug": "node-js"
			},
			{
				"id": "6hbkItfupogJP3aRDAq6v8",
				"name": "Cloudflare Workers",
				"slug": "workers"
			},
			{
				"id": "78aSAeMjGNmCuetQ7B4OgU",
				"name": "JavaScript",
				"slug": "javascript"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "3JAY3z7p7An94s6ScuSQPf",
				"name": "Developer Platform",
				"slug": "developer-platform"
			}
		],
		"title": "Node.js compatibility for Cloudflare Workers – starting with Async Context Tracking, EventEmitter, Buffer, assert, and util",
		"updated_at": "2024-10-09T23:23:33.623Z",
		"url": "https://blog.cloudflare.com/workers-node-js-asynclocalstorage"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.icon_aria_label": "Search",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"search.result_stat_empty": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong>",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"search.autocomplete_title": "Insert a query. Press enter to send",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}