<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/07/1-1.png" class="kg-image"></figure>
	<p><a href="https://developers.cloudflare.com/workers/learning/using-durable-objects" target="_blank">Durable Objects</a> æ˜¯ Workers å¼€å‘è€…ç”Ÿæ€ç³»ç»Ÿçš„ä¸€ä¸ªå¾ˆæ£’çš„è¡¥å……ï¼Œå®ƒå…è®¸æ‚¨åœ¨ç‰¹å®šçš„ Worker ä¸­å¯»å€å’Œå·¥ä½œï¼Œä»¥æä¾›åº”ç”¨ç¨‹åºçš„ä¸€è‡´æ€§ã€‚è¿™å¬èµ·æ¥å¾ˆä»¤äººå…´å¥‹ï¼Œä½†å¦‚æœä½ åƒæˆ‘ä¸€æ ·ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“â€œå¥½å§ï¼Œæˆ‘å¯ä»¥ç”¨å®ƒåšä»€ä¹ˆï¼Ÿâ€</p>
	<p>æ²¡æœ‰ä»€ä¹ˆæ¯”ç”¨æŠ€æœ¯æ„å»ºçœŸå®çš„ä¸œè¥¿æ›´èƒ½çœŸæ­£ç†è§£å®ƒäº†ã€‚</p>
	<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ä¸ºä»€ä¹ˆ Durable Objects å¾ˆé‡è¦ï¼Œä»¥åŠ<a href="https://blog.cloudflare.com/introducing-websockets-in-workers/">åƒ WebSockets è¿™æ ·çš„ Workers ç”Ÿæ€ç³»ç»Ÿä¸­çš„æ–°å…¬å‘Š</a>å¦‚ä½•ä¸ Durable Objects ä¸€èµ·ç©ï¼Œæˆ‘è½¬å‘äº†æˆ‘å‡ ä¸ªæœˆæ¥ä¸€ç›´åœ¨ä¸šä½™æ—¶é—´æ„å»ºçš„ä¸€ç±»è½¯ä»¶ï¼šè§†é¢‘æ¸¸æˆã€‚</p>
	<p>åœ¨è¿‡å»åå¹´ä¸­ï¼Œæ¸¸æˆçš„æŠ€æœ¯æ–¹é¢å‘ç”Ÿäº†å·¨å¤§å˜åŒ–ã€‚è®¸å¤šæ¸¸æˆéƒ½æ˜¯é»˜è®¤åœ¨çº¿çš„ï¼Œè€Œåƒ <a href="https://unity.com/" target="_blank">Unity</a> è¿™æ ·æ— å¤„ä¸åœ¨çš„å·¥å…·ä½¿ä»»ä½•äººéƒ½å¯ä»¥å¼€å§‹å°è¯•å¼€å‘æ¸¸æˆã€‚</p>
	<p>æˆ‘å¬è¯´äº†å¾ˆå¤šå…³äº Durable Objects å’Œ WebSockets åœ¨åº”ç”¨ç¨‹åºä¸­æä¾›å®æ—¶ä¸€è‡´æ€§çš„èƒ½åŠ›ï¼Œä¸ºäº†æµ‹è¯•è¿™ä¸ªç”¨ä¾‹ï¼Œæˆ‘æ„å»ºäº† <a href="https://durable-world.pages.dev/" target="_blank">Durable World</a>ï¼šä¸€ä¸ªç®€å•çš„ 3D å¤šäººæ¸¸æˆä¸–ç•Œï¼Œå®Œå…¨éƒ¨ç½²åœ¨æˆ‘ä»¬çš„ Cloudflare ä¸Šå †æ ˆï¼šä¸ºå®¢æˆ·ç«¯æ¸¸æˆæä¾›æœåŠ¡çš„é¡µé¢ï¼Œåœ¨ Unity å’Œ WebGL ä¸­è¿è¡Œï¼ŒWorker ä½œä¸ºåè°ƒå±‚ï¼Œä½¿ç”¨ Durable Objects å’Œ WebSockets åŒæ­¥ç©å®¶ä½ç½®å’Œå…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚éšæœºç”Ÿæˆçš„ç”¨æˆ·åã€‚</p>
	<figure class="kg-card kg-embed-card">
		<blockquote class="twitter-tweet">
			<p lang="en" dir="ltr">playing multiplayer on the edge with some of my friends from the <a href="https://twitter.com/CloudflareDev?ref_src=twsrc%5Etfw" target="_blank">@cloudflaredev</a> discordğŸ˜<br><br>client-side:<br>- <a href="https://twitter.com/unity?ref_src=twsrc%5Etfw" target="_blank">@unity</a> webgl + websockets client<br>- hosted on cf pages<br><br>serverless:<br>- cloudflare workers<br>- durable objects<br>- websockets <a href="https://t.co/Ef3nr76D2e" target="_blank">pic.twitter.com/Ef3nr76D2e</a></p>â€” Kristian Freeman (@signalnerve) <a href="https://twitter.com/signalnerve/status/1384274000986005511?ref_src=twsrc%5Etfw" target="_blank">April 19, 2021</a>
		</blockquote>
		<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
	</figure>
	<p>3D æ¸¸æˆå¾€å¾€çœ‹èµ·æ¥éå¸¸ä»¤äººå°è±¡æ·±åˆ»â€”å®ƒä»¬æ˜¯ä¼Ÿå¤§çš„æŠ€æœ¯æ¼”ç¤ºã€‚å³ä½¿çœ‹åˆ°æ¥è‡ªä¸–ç•Œå„åœ°çš„äººå‘˜ä¸æ‚¨è”ç³»å¹¶ä¸æ‚¨ä¸€èµ·åœ¨åœ°å›¾ä¸Šç§»åŠ¨è¿™ä¸€â€œä»¤äººæƒŠå¹çš„å› ç´ â€ï¼Œæ‚¨ä¹Ÿå¯èƒ½ä¼šæƒŠè®¶äºè¯¥é¡¹ç›®çš„ç›¸åº”ä»£ç æ˜¯å¤šä¹ˆç®€å•ã€‚è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨ Durable World çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ–¹é¢ï¼Œç„¶åæˆ‘å°†å°±è¿™æ ·çš„é¡¹ç›®åœ¨æœªæ¥å¦‚ä½•å‘å±•ä»¥åŠæ¥ä¸‹æ¥æˆ‘æƒ³æ¢ç´¢çš„å†…å®¹æå‡ºä¸€äº›æƒ³æ³•ã€‚</p>
	<p>é™¤äº†è¿™ç¯‡åšæ–‡ä¹‹å¤–ï¼Œæˆ‘ä»¬æœ€è¿‘è¿˜<a href="https://blog.cloudflare.com/doom-multiplayer-workers/">åœ¨ Cloudflare çš„åšå®¢ä¸Šå‘è¡¨äº†ä¸€ç¯‡å…³äºä½¿ç”¨ WebAssembly å’Œ Durable Objects çš„ Workers çš„æ–‡ç« ï¼Œå±•ç¤ºäº†å¤šäºº Doom ç«¯å£ã€‚</a>éšç€ Durable Objectsã€WebSockets å’Œ WebAssembly ç­‰å·¥å…·çš„æ·»åŠ ï¼Œæ— è®ºæ‚¨æ˜¯ç§»æ¤ç°æœ‰æ¸¸æˆè¿˜æ˜¯æ„å»ºå…¨æ–°æ¸¸æˆï¼ŒWorkers ä¸Šçš„æ¸¸æˆç”¨ä¾‹æ•°é‡éƒ½éå¸¸å¤šã€‚</p>
	<p>Durable World æ˜¯ä½¿ç”¨<em>æƒå¨çš„å®¢æˆ·ç«¯</em>æ¨¡å‹æ„å»ºçš„ã€‚å®¢æˆ·ç«¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œå·²ç¼–è¯‘çš„æ¸¸æˆï¼Œå†…ç½®åœ¨ WebAssembly ä¸­ï¼Œå› æ­¤æ— éœ€å°†ç‰¹å®šäºå¹³å°çš„å®¢æˆ·ç«¯ä¸‹è½½åˆ°æœ¬åœ°æœºå™¨å³å¯è¿è¡Œã€‚è¯¥æœåŠ¡å™¨å®Œå…¨è¿è¡Œåœ¨ Cloudflare Workers ä¸Šï¼Œå¯ä»¥é€šè¿‡ WebSockets è¿›è¡Œäº¤äº’ï¼Œå¹¶ä½¿ç”¨ Durable Objects æ¥ç®¡ç†æ¸¸æˆçŠ¶æ€ã€‚</p>
	<p>ä¸æˆ‘ä»¬åœ¨åšå®¢ä¸­å±•ç¤ºçš„ Doom ç¤ºä¾‹éå¸¸ç›¸ä¼¼ï¼Œç”± Workers åº”ç”¨ç¨‹åºç®¡ç†çš„ Durable Object å……å½“æ¶ˆæ¯è·¯ç”±å™¨ï¼Œæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„æ¸¸æˆçŠ¶æ€æ›´æ”¹ï¼Œå¹¶ä¿ç•™é€šè¿‡ Worker æ¥æ”¶è¿™äº›æ›´æ–°çš„æ´»åŠ¨å®¢æˆ·ç«¯åˆ—è¡¨ã€‚</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/07/2-1.png" class="kg-image"></figure>
	<h3 id="-character-durable-object">ç®¡ç†è¿æ¥ï¼šCharacter Durable Object</h3>
	<p>åœ¨å¼€å§‹è¿™ä¸ªé¡¹ç›®ä¹‹å‰ï¼Œæˆ‘æœ€å¤§çš„ææƒ§æ˜¯ä½¿ç”¨ Durable Objectsã€‚å°½ç®¡æˆ‘ä»æœªç”¨ Unity åˆ¶ä½œè¿‡ä»»ä½•ä¸¥è‚ƒçš„æ¸¸æˆï¼Œè€Œä¸”æˆ‘ç”šè‡³æ— æ³•åœ¨æ²¡æœ‰å¯¹åŸºæœ¬è¯­æ³•è¿›è¡Œ Google æœç´¢çš„æƒ…å†µä¸‹å®šä¹‰ C# å˜é‡ï¼Œä½†æœ‰å…³ Durable Objects çš„æ¦‚å¿µéƒ¨åˆ†çš„æŸäº›å†…å®¹ä»ç„¶è®©æˆ‘æ„Ÿåˆ°å®³æ€•ï¼Œç›´åˆ°æˆ‘å¼€å§‹ç¼–å†™å®é™…ä»£ç çš„é‚£ä¸€åˆ»ã€‚</p>
	<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå½“ç¼–å†™ Durable Objects å’Œä½¿ç”¨ API å˜å¾—éå¸¸ç®€å•æ—¶ï¼Œæˆ‘çš„æƒŠè®¶ã€‚</p>
	<p>Character æ¨¡å—æ˜¯ä¸€ä¸ªä½¿ç”¨æˆ‘ä»¬åœ¨ Workers ä¸­çš„æ–°æ¨¡å—æ”¯æŒçš„ Durable Objectï¼Œå®ƒæ„å»ºåœ¨æˆ‘ä»¬çš„ <a href="https://github.com/cloudflare/modules-rollup-esm" target="_blank">modules-rollup-esm</a> æ¨¡æ¿ä¹‹ä¸Šã€‚è¯¥æ¨¡å—å¤„ç†ä¼ å…¥çš„è¯·æ±‚ï¼Œå¹¶å……å½“å®¢æˆ·ç«¯çš„ WebSocket æä¾›å•†ç¨‹åºï¼š</p>
	<!--kg-card-begin: markdown-->
	<pre><code class="language-js">export class Character {
  constructor(state, env) {
    this.state = state;
    this.env = env
  }

  async initialize() {
    let stored = await this.state.storage.get("state");
    this.value = stored || { users: [], websockets: [] }
  }

  async handleSession(websocket, ip) {
    websocket.accept()
    // Game state code
  }

  // Handle HTTP requests from clients.
  async fetch(request) {
    if (!this.initializePromise) {
      this.initializePromise = this.initialize().catch((err) =&gt; {
        this.initializePromise = undefined;
        throw err
      });
    }
    await this.initializePromise;

    // Apply requested action.
    let url = new URL(request.url);

    switch (url.pathname) {
      case "/websocket":
        if (request.headers.get("Upgrade") != "websocket") {
          return new Response("Expected websocket", { status: 406 })
        }
        let ip = request.headers.get("CF-Connecting-IP");
        let pair = new WebSocketPair();
        await this.handleSession(pair[1], ip);
        return new Response(null, { status: 101, webSocket: pair[0] });
      case "/":
        break;
      default:
        return new Response("Not found", { status: 404 });
    }

    return new Response(this.value);
  }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>å…¶ä¸­å¤§éƒ¨åˆ†åœ¨æ¦‚å¿µä¸Šä¸æˆ‘ä»¬çš„ <a href="https://github.com/cloudflare/websocket-template" target="_blank">websocket æ¨¡æ¿</a>ç›¸åŒâ€”æˆ‘ä»¬åœ¨ä¼ å…¥è¯·æ±‚ä¸­æŸ¥æ‰¾ Upgrade æ ‡å¤´ï¼Œå¹¶è®¾ç½®ä¸€ä¸ª WebSocketPairï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª<em>æœåŠ¡å™¨</em>å’Œä¸€ä¸ª<em>å®¢æˆ·ç«¯ </em>WebSocketã€‚</p>
	<p>handleSession å‡½æ•°æ˜¯æˆ‘ä»¬å¤§éƒ¨åˆ†æ¸¸æˆç‰¹å®šé€»è¾‘å‘ç”Ÿçš„åœ°æ–¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ Durable Objects + WebSocket ä»£ç æœ‰ä¸¤ä¸ªä»»åŠ¡éœ€è¦ç®¡ç†ï¼šç¬¬ä¸€ï¼Œå¤„ç†æ–°ç©å®¶â€”ç»™ä»–ä»¬ä¸€ä¸ªéšæœºç”Ÿæˆçš„ç”¨æˆ·åï¼Œå¹¶ä½¿ç”¨æœ‰æ•ˆçš„ WebSocket è®¾ç½®ä»–ä»¬ï¼Œç¬¬äºŒï¼Œæ¥å—æ–°çš„ç©å®¶ä½ç½®ï¼Œå¹¶å¹¿æ’­è¿™äº›ä½ç½®ç»™ç›®å‰åœ¨æ¸¸æˆä¸­çš„æ¯ä¸ªäººã€‚â€˜tickâ€™ å‡½æ•°ç”¨äºå‘æˆ‘ä»¬çš„å®¢æˆ·ç«¯å¹¿æ’­æ¸¸æˆçŠ¶æ€ï¼Œå…¶ä½™ä»£ç è§£æä¼ å…¥çš„æ•°æ®ï¼Œå¹¶ç¡®å®šå“ªäº› WebSocket å®¢æˆ·ç«¯åº”è¯¥æ¥æ”¶æ–°æ•°æ®ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
	<!--kg-card-begin: markdown-->
	<pre><code class="language-js">async tick(skipKey) {
  const users = this.value.users.filter(user =&gt; user.id !== skipKey)
  this.value.websockets
    .forEach(
      ({ id, name, websocket }) =&gt; {
        websocket.send(
          JSON.stringify({
            id,
            name,
            users
          })
        )
      }
    )
}

async key(ip) {
  const text = new TextEncoder().encode(`${this.env.SECRET}-${ip}`)
  const digest = await crypto.subtle.digest({ name: "SHA-256", }, text)
  const digestArray = new Uint8Array(digest)
  return btoa(String.fromCharCode.apply(null, digestArray))
}

constructName() {
  function titleCase(str) {
    return str.toLowerCase().split(' ').map(function (word) {
      return word.replace(word[0], word[0].toUpperCase());
    }).join(' ');
  }

  return titleCase(faker.fake("{{commerce.color}} {{hacker.adjective}} {{hacker.abbreviation}}"))
}

async handleSession(websocket, ip) {
  websocket.accept()

  try {
    let currentState = this.value;
    const key = await this.key(ip)

    const name = this.constructName()
    let newUser = { id: key, name, position: '0.0,0.0,0.0', rotation: '0.0,0.0,0.0' }
    if (!currentState.users.find(user =&gt; user.id === key)) {
      currentState.users.push(newUser)
      currentState.websockets.push({ id: key, name, websocket })
    }

    this.value = currentState
    this.tick(key)

    websocket.addEventListener("message", async msg =&gt; {
      try {
        let { type, position, rotation } = JSON.parse(msg.data)
        switch (type) {
          case 'POSITION_UPDATED':
            let user = currentState.users.find(user =&gt; user.id === key)
            if (user) {
              user.position = position
              user.rotation = rotation
            }

            this.value = currentState
            this.tick(key)

            break;
          default:
            console.log(`Unknown type of message ${type}`)
            websocket.send(JSON.stringify({ message: "UNKNOWN" }))
            break;
        }
      } catch (err) {
        websocket.send(JSON.stringify({ error: err.toString() }))
      }
    })

    const closeOrError = async evt =&gt; {
      currentState.users = currentState.users.filter(user =&gt; user.id !== key)
      currentState.websockets = currentState.websockets.filter(user =&gt; user.id !== key)
      this.value = currentState
      this.tick(key)
    }

    websocket.addEventListener("close", closeOrError)
    websocket.addEventListener("error", closeOrError)
  } catch (err) {
    websocket.send(JSON.stringify({ message: err.toString() }))
  }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>åœ¨è®¾ç½®æ–°çš„ WebSocketPair æ—¶ï¼ŒWorkers å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªä»ç”¨æˆ· IP åœ°å€æ´¾ç”Ÿçš„å”¯ä¸€ IDï¼ˆå°½ç®¡æ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ UUID æˆ–å…¶ä»–ä»»ä½•å†…å®¹ï¼‰ï¼Œç„¶åå¼€å§‹å°† WebSocket æ•°æ®å‘é€åˆ°æ–°å®¢æˆ·ç«¯ã€‚å½“æ•°æ®ä¼ å…¥æ—¶ï¼ˆä¾‹å¦‚ä¸€ä¸ªæ–°çš„ç©å®¶ä½ç½®ï¼‰ï¼Œè¯¥å‡½æ•°ä¼šæŸ¥çœ‹æ˜¯<em>è°</em>åœ¨å‘é€æ•°æ®ï¼Œå¹¶å°†æ–°ä¿¡æ¯å‘é€åˆ°å½“å‰æ¸¸æˆä¸­çš„æ‰€æœ‰<em>å…¶ä»–çš„ </em>WebSocketã€‚</p>
	<h3 id="-unity-durable-objects-">å¤„ç†ç©å®¶ä½ç½®å’Œç§»åŠ¨ï¼šåœ¨ Unity ä¸­ä½¿ç”¨ Durable Objects æ„å»º</h3>
	<p>å¯¹äºåƒæˆ‘è¿™æ ·çš„äººæ¥è¯´ï¼ŒUnity æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„æ¸¸æˆå¼•æ“ï¼šä¸€ä¸ª<em>æ²¡æœ‰</em>åˆ¶ä½œæ¸¸æˆç»éªŒçš„ç›¸å½“æœ‰ç»éªŒçš„ç¨‹åºå‘˜ã€‚å¤šå¹´æ¥ï¼Œæˆ‘ä¸€ç›´æ–­æ–­ç»­ç»­åœ°ä½¿ç”¨ Unityï¼Œä½†åœ¨è¿‡å»çš„å‡ ä¸ªæœˆé‡Œï¼Œæˆ‘ä¸€ç›´åœ¨æ·±å…¥ç ”ç©¶å®ƒå¹¶æ‰©å±•æˆ‘å¯¹å¦‚ä½•å®é™…æ„å»ºçœŸå®æ¸¸æˆçš„ç†è§£ã€‚</p>
	<p>ä»¥ä¸‹æ˜¯æ‚¨åœ¨æ„å»º Durable World çš„ä¸Šä¸‹æ–‡ä¸­éœ€è¦äº†è§£çš„æœ‰å…³ Unity çš„å†…å®¹ï¼šæ¸¸æˆå¯¹è±¡<em>æ˜¯ </em>Unity ä¸­æ‰€æœ‰äº‹ç‰©çš„é¦–é€‰ï¼Œå¹¶ä¸”ä½¿ç”¨ C# è„šæœ¬ï¼Œæ‚¨å¯ä»¥ä¸ºæ¸¸æˆå¯¹è±¡ç¼–ç¨‹ä¸åŒçš„è¡Œä¸ºï¼Œæ— è®ºæ˜¯è”ç½‘çš„è¿˜æ˜¯ç©å®¶æœ¬åœ°çš„ã€‚</p>
	<p>åœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œå­˜åœ¨ä¸‰ç§ä¸åŒç±»å‹çš„æ¸¸æˆå¯¹è±¡ã€‚é¦–å…ˆï¼Œæ˜¯ä¸–ç•Œæœ¬èº«â€”é™æ€ç½‘æ ¼çš„é›†åˆï¼Œä¸»è¦æ˜¯ç«‹æ–¹ä½“ã€‚è¿™äº›ç½‘æ ¼åœ¨æ¸¸æˆçš„ç½‘ç»œæ–¹é¢æ ¹æœ¬æ²¡æœ‰è¡¨ç°å‡ºæ¥ã€‚é€šè¿‡ä¸€ç³»åˆ—<em>å¯¹æ’æœº</em>ï¼Œå¯ä»¥åœæ­¢åœ¨è¿™äº›ç½‘æ ¼ä¹‹ä¸Šæˆ–å‘¨å›´å¯¼èˆªçš„ä»»ä½•å…¶ä»–æ¸¸æˆå¯¹è±¡ä»åœ°æ¿ä¸Šæ‰ä¸‹æ¥å’Œç©¿è¿‡å¢™å£ç§»åŠ¨ã€‚è¿‡å» 20 å¹´æ¥ï¼Œæ‚¨åœ¨æ¯æ¬¾ 3D æ¸¸æˆä¸­éƒ½çœ‹åˆ°äº†è¿™ç§è®¾è®¡ï¼ŒåŒ…æ‹¬åƒã€Šè¶…çº§é©¬é‡Œå¥¥ 64ã€‹è¿™æ ·çš„ç»å…¸æ¸¸æˆã€‚</p>
	<!--kg-card-begin: html-->
	<div style="width:100%;height:0;padding-bottom:70%;position:relative;"><iframe src="https://giphy.com/embed/fTmOPDE3jH9qP9HVuL" width="100%" height="100%" style="position:absolute" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe></div>
	<p><a href="https://giphy.com/gifs/glitch-cheat-mario-64-fTmOPDE3jH9qP9HVuL" target="_blank">via GIPHY</a></p>
	<!--kg-card-end: html-->
	<p>åœ¨ Durable World ä¸­ï¼Œæ‚¨çš„ç©å®¶æ¸¸æˆå¯¹è±¡æ˜¯ä¸€ä¸ªç®€å•çš„èƒ¶å›Šã€‚æ­¤å½¢çŠ¶å†…ç½®äº Unity ä¸­ï¼Œé€šè¿‡é™„åŠ  C# è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é”®ç›˜æ§ä»¶è¿›è¡ŒåŸºæœ¬ç§»åŠ¨ï¼ˆåœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä½¿ç”¨äº†<a href="https://www.youtube.com/watch?v=4HpC--2iowE" target="_blank">Brackey çš„æœ¬æ•™ç¨‹</a>ï¼‰ã€‚</p>
	<p>å¤šäººæ¸¸æˆè§’è‰²è¢«è¡¨ç¤ºä¸ºåŒä¸€ç©å®¶èƒ¶å›Šçš„ç®€åŒ–ç‰ˆæœ¬ã€‚ä¸å°†ä»»ä½•ç±»å‹çš„è¾“å…¥é€»è¾‘ï¼ˆé”®ç›˜ã€é¼ æ ‡ç­‰ï¼‰é™„åŠ åˆ°è¿™äº›æ¸¸æˆå¯¹è±¡ä¸åŒï¼Œå®ƒä»¬åœ¨ 3D ç©ºé—´ä¸­çš„ä½ç½®çš„å…³é”®æ–¹é¢â€”å³ä½ç½®å’Œæ—‹è½¬â€”ç”± WebSocket å®¢æˆ·ç«¯ç®¡ç†ã€‚</p>
	<p>æ¸¸æˆå¼€å§‹æ—¶ï¼Œæ‚¨è¢«ç½®äºå•äººæ¸¸æˆç¯å¢ƒä¸­ï¼šæ‚¨çš„è§’è‰²å¯ä»¥åœ¨é™æ€ 3D ä¸–ç•Œä¸­ç§»åŠ¨ã€‚ä¸€æ—¦æ¸¸æˆè¿æ¥åˆ° Workers å¹¶æ¥æ”¶åˆ°ä¸€ä¸ª WebSocketï¼Œå®ƒå°±å¯ä»¥å¼€å§‹åœ¨å¤šäººæ¸¸æˆç¯å¢ƒä¸­è¿è¡Œäº†ã€‚è¿™æ˜¯åœ¨ä¸–ç•Œå¯åŠ¨ä¹‹å‰çš„çº¿æ¡†å›¾ï¼š</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/07/3.png" class="kg-image"></figure>
	<p>å½“è°ˆåˆ°é¡¹ç›®çš„å®é™…ä»£ç æ—¶ï¼Œè¿æ¥æ–¹é¢éå¸¸ç®€å•ï¼šåœ¨æ¸¸æˆå¼€å§‹æ—¶åˆ›å»ºä¸€ä¸ªè¿æ¥å•ä¾‹ï¼Œå®ƒä½¿ç”¨ WebSocket ç±»è¿æ¥åˆ° Workerï¼Œå¹¶åœ¨æ–°çš„ WebSocket æ›´æ–°ä¸Šè°ƒç”¨å„ç§å‡½æ•°ã€‚æ‚¨å¯ä»¥åœ¨<a href="https://github.com/signalnerve/durable-world/blob/main/packages/unity/Assets/Connection.cs" target="_blank">æ­¤å¤„</a>æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼Œä½†æˆ‘å°†åœ¨ä¸‹é¢æ€»ç»“é‡è¦éƒ¨åˆ†ã€‚</p>
	<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†ç©å®¶çš„ä½ç½®å‘é€å› Workersã€‚è¿™å‘ç”Ÿåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œæ¯ 0.2 ç§’è°ƒç”¨ä¸€æ¬¡ã€‚UpdatePosition å‡½æ•°è·å–ç©å®¶ä½ç½®å’Œæ—‹è½¬ï¼Œå°†å®ƒä»¬ç¼–ç ä¸º JSONï¼Œå¹¶å°†æ•°æ®å‘é€åˆ° WebSocketã€‚è¯·æ³¨æ„ï¼Œé€šè¿‡æ¯ 0.2 ç§’å‘é€ä¸€æ¬¡ä½ç½®ï¼Œæˆ‘ä»¬æœ‰æ•ˆåœ°æ„å»ºäº†ä¸€ä¸ªä»¥æ¯ç§’ 5 å¸§æ›´æ–°çš„æ’­æ”¾å™¨ã€‚è€ƒè™‘åˆ°å¤§å¤šæ•°æ¸¸æˆ<em>è‡³å°‘</em>æ¯ç§’è¿è¡Œ 30 å¸§ï¼Œå¦‚æœä¸æ˜¯æ›´é«˜ï¼Œè¿™å°†æ˜¯æˆ‘ä»¬ç¨åå°†ä½¿ç”¨æ’å€¼è§£å†³çš„é—®é¢˜ã€‚</p>
	<!--kg-card-begin: markdown-->
	<pre><code class="language-cs">using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

using NativeWebSocket;

public class Connection : MonoBehaviour
{
  WebSocket websocket;

  // Start is called before the first frame update
  void Start()
  {
    Connect();
  }

  async void Connect()
  {
    retries += 1;

    if (maxRetries &lt; retries)
    {
      return;
    }

    websocket = new WebSocket("wss://durable-world.signalnerve.workers.dev/websocket");

    websocket.OnOpen += () =&gt;
    {
      Debug.Log("Connection open!");
    };

    websocket.OnError += (e) =&gt;
    {
      Debug.Log("Error! " + e);
      Connect();
    };

    websocket.OnClose += (e) =&gt;
    {
      Debug.Log("Connection closed!" + e);
      Connect();
    };

    websocket.OnMessage += (bytes) =&gt;
    {
      // Do things with new messages
    };

    // Keep sending messages at every 0.2 seconds
    InvokeRepeating("UpdatePosition", 0.0f, 0.2f);

    // waiting for messages
    await websocket.Connect();
  }

  void Update()
  {
#if !UNITY_WEBGL || UNITY_EDITOR
    websocket.DispatchMessageQueue();
#endif
  }

  async void UpdatePosition()
  {
    if (websocket.State == WebSocketState.Open)
    {
      var currentPos = player.transform.position;
      if (currentPos == lastPosition)
      {
        return;
      }

      PlayerPosition playerPosition = new PlayerPosition();
      playerPosition.position = $"{currentPos.x},{currentPos.y},{currentPos.z}";
      var currentRot = player.transform.rotation;
      playerPosition.rotation = $"{currentRot.eulerAngles.x},{currentRot.eulerAngles.y},{currentRot.eulerAngles.z}";
      playerPosition.type = "POSITION_UPDATED";
      await websocket.SendText(JsonUtility.ToJson(playerPosition));
      lastPosition = currentPos;
    }
  }

  private async void OnApplicationQuit()
  {
    await websocket.Close();
  }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬å½“å‰åœ¨æ¸¸æˆä¸­çš„å…¶ä»–ç©å®¶ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç›‘å¬æ¥è‡ª Workers çš„ä¼ å…¥ WebSocket æ¶ˆæ¯ã€‚æ¯æ¡æ¶ˆæ¯éƒ½å°†åŒ…å«æˆ‘ä»¬çš„æ•´ä¸ªæ¸¸æˆçŠ¶æ€ï¼ˆæˆ‘ä»¬å°†æ¥è‚¯å®šå¯ä»¥ä¼˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è§£æå¹¶ä½¿ç”¨å®ƒä»¬æ¥å†³å®šæˆ‘ä»¬çš„æœ¬åœ°æ¸¸æˆç‰ˆæœ¬åº”è¯¥å¦‚ä½•æ›´æ–°ã€‚å¯¹äºæˆ‘ä»¬çš„ gameState è´Ÿè½½ä¸­çš„æ¯ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç©å®¶çš„æ–°å®ä¾‹ï¼Œå¹¶å¼€å§‹åœ¨æœ¬åœ°è·Ÿè¸ªå®ƒã€‚æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ CreateClient ä¸­æ›´æ–°ä½ç½®ã€æ—‹è½¬å¹¶è®¾ç½®ä¸€ä¸ªæŒ‡ç¤ºç©å®¶å§“åçš„ç®€å• UI å…ƒç´ ï¼š</p>
	<!--kg-card-begin: markdown-->
	<pre><code class="language-cs">using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

using NativeWebSocket;

public class Connection : MonoBehaviour
{
  async void Connect()
  {
    // Truncated code

    websocket.OnMessage += (bytes) =&gt;
    {
      var payload = System.Text.Encoding.UTF8.GetString(bytes);
      GameState gameState = JsonUtility.FromJson&lt;GameState&gt;(payload);

      foreach (var user in gameState.users)
      {
        try
        {
          if (user.id == gameState.id)
          {
            continue;
          }

          Client client;
          if (!Clients.TryGetValue(user.id, out client))
          {
            client = CreateClient(user);
          }

          var rt = user.rotation.Split(","[0]); // gets 3 parts of the vector into separate strings
          var rtx = float.Parse(rt[0]);
          var rty = float.Parse(rt[1]);
          var rtz = float.Parse(rt[2]);
          var newRot = Quaternion.Euler(rtx, rty, rtz);
          client.interpolateMovement.endRotation = newRot;

          var pt = user.position.Split(","[0]); // gets 3 parts of the vector into separate strings
          var ptx = float.Parse(pt[0]);
          var pty = float.Parse(pt[1]);
          var ptz = float.Parse(pt[2]);
          var newPos = new Vector3(ptx, pty, ptz);
          client.interpolateMovement.endPosition = newPos;
        }
        catch (Exception e)
        {
          Debug.Log(e);
        }
      }

      TMPro.TextMeshProUGUI text = onlineText.GetComponent&lt;TMPro.TextMeshProUGUI&gt;();
      text.text = $"Online: {gameState.users.Length + 1}\\nPlaying as {gameState.name}";
    };

    // Keep sending messages at every 0.2 seconds
    InvokeRepeating("UpdatePosition", 0.0f, 0.2f);

    // waiting for messages
    await websocket.Connect();
  }

  Client CreateClient(User user)
  {
    var newClient = new Client();
    newClient.id = user.id;
    var otherPlayer = Instantiate(otherPlayerPrefab, new Vector3(0, 0, 0), Quaternion.identity);
    otherPlayer.name = user.id;

    TMPro.TextMeshPro text = otherPlayer.GetComponentInChildren&lt;TMPro.TextMeshPro&gt;();
    text.text = user.name;

    newClient.playerObject = otherPlayer;
    newClient.interpolateMovement = otherPlayer.GetComponent&lt;InterpolateMovement&gt;();
    Clients.Add(user.id, newClient);
    return newClient;
  }

  // Truncated code
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>è®¾ç½®æ‰€æœ‰è¿™äº›ä»£ç åï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªç®€å•çš„ç³»ç»Ÿï¼Œç”¨äºå°†æˆ‘ä»¬çš„æœ¬åœ°ç©å®¶ä½ç½®å‘é€ç»™ Workersã€‚å½“æˆ‘çš„ç©å®¶ä½ç½®æ›´æ–°æ—¶ï¼Œæ¸¸æˆä¸­çš„å…¶ä»–æ‰€æœ‰äººéƒ½ä¼šæ”¶åˆ°è¯¥ä½ç½®ä½œä¸ºæ›´å¤§æ¸¸æˆçŠ¶æ€è´Ÿè½½çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç›¸åº”åœ°æ›´æ–°æ¯ä¸ªç©å®¶çš„æœ¬åœ°å‰¯æœ¬ã€‚</p>
	<p>æˆ‘æåˆ°è¿™äº›æ›´æ–°<em>æ¯ 0.2 ç§’å‘ç”Ÿä¸€æ¬¡ã€‚</em>æ¸¸æˆé¢„è®¡æ¯ç§’<em>è‡³å°‘</em>æ›´æ–° 30 æ¬¡ï¼Œç”šè‡³æ›´å¤šï¼šç°ä»£æ¸¸æˆé€šå¸¸é¢„è®¡ä»¥æ¯ç§’ 60 å¸§çš„é€Ÿåº¦è¿è¡Œï¼Œå¹¶ä¸”æ›´æ–°é€Ÿåº¦æå¿«ã€‚</p>
	<p>æ­£æ˜¯å› ä¸ºè¿™ç§æœŸæœ›ï¼Œæˆ‘ä»¬éœ€è¦<em>ä¸ºæˆ‘ä»¬çš„ç©å®¶æ’å…¥</em>è¿åŠ¨ã€‚è€Œä¸æ˜¯æ¯ç§’å‘é€ç©å®¶æ›´æ–°å…­åæ¬¡ï¼Œè¿™å°†æ˜¯å¯¹æˆ‘ä»¬çš„æŒä¹…å¯¹è±¡ä¸€ä¸ªå·¨å¤§çš„è´Ÿè·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ä¼ å…¥çš„æ–°ä½ç½®æˆ–æ—‹è½¬çš„å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä¸€äº›æ•°å­¦è¿ç®—æ¥å¹³æ»‘ç§»åŠ¨ï¼Œä»ç©å®¶æ‰€åœ¨çš„ä½ç½®åˆ°ä»–ä»¬è¦<em>å»çš„åœ°æ–¹ </em>Unityï¼ˆä»¥åŠè®¸å¤šå…¶ä»–æ¸¸æˆå¼•æ“ï¼‰é€šè¿‡è¯¸å¦‚ SmoothDamp ä¹‹ç±»çš„ API æä¾›è¿™ç§è¡Œä¸ºâ€”ä¸€ç§ç”¨äºéšç€æ—¶é—´çš„æ¨ç§»å¹³æ»‘å¿«é€Ÿã€ä¸å’Œè°çš„è¿åŠ¨â€”å¦‚ä¸‹é¢çš„ InterpolateMovement è„šæœ¬æ‰€ç¤ºï¼Œè¯¥è„šæœ¬ç”¨äºç®¡ç†ç©å®¶ä½ç½®å’Œæ—‹è½¬ï¼š</p>
	<!--kg-card-begin: markdown-->
	<pre><code class="language-cs">using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class InterpolateMovement : MonoBehaviour
{
  public Vector3 endPosition;
  public Quaternion endRotation;

  public float rotationSmoothTime = 0.3f;
  public float positionSmoothTime = 0.6f;
  private Vector3 posVelocity = Vector3.zero;
  private float rotVelocity = 0.0f;

  void Update()
  {
    transform.position = Vector3.SmoothDamp(transform.position, endPosition, ref posVelocity, positionSmoothTime);

    float delta = Quaternion.Angle(transform.rotation, endRotation);
    if (delta &gt; 0f)
    {
      float t = Mathf.SmoothDampAngle(delta, 0.0f, ref rotVelocity, rotationSmoothTime);
      t = 1.0f - (t / delta);
      transform.rotation = Quaternion.Slerp(transform.rotation, endRotation, t);
    }
  }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="-">ä¸‹ä¸€æ­¥</h3>
	<p>è¾¹ç¼˜çš„ Durable Objects å’Œ WebSockets ç­‰å·¥å…·çš„å¯ç”¨æ€§å¼€å¯äº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Cloudflare Workers æ„å»ºçš„ä¸€ç±»æ–°åº”ç”¨ç¨‹åºã€‚æ¸¸æˆåªæ˜¯ä¸€ä¸ªç”¨ä¾‹ï¼Œæˆ‘ä»¬æ‰åˆšåˆšå¼€å§‹æ¢ç´¢è¾¹ç¼˜å®æ—¶ã€é«˜åº¦äº¤äº’æ¸¸æˆçš„å¯èƒ½æ€§ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£æŸ¥çœ‹ Durable World çš„æºä»£ç ï¼Œå¯ä»¥<a href="https://github.com/signalnerve/durable-world" target="_blank">åœ¨ GitHub ä¸Š</a>æŸ¥çœ‹ã€‚å¦‚æœæ‚¨æƒ³èŠèŠ Workersã€Durable Objects æˆ–å…¶ä»–ä»»ä½•æ¢ç´¢æˆ‘ä»¬å¯ä»¥åœ¨åˆ†å¸ƒå¼æ— æœåŠ¡å™¨ç¯å¢ƒä¸­æ„å»ºçš„æ–°çš„ã€æœ‰è¶£çš„ä¸œè¥¿ï¼Œ<a href="https://discord.com/invite/cloudflaredev" target="_blank">è¯·åŠ å…¥æˆ‘ä»¬çš„ Cloudflare Workers Discord</a>ã€‚</p>
</div>