<div class="mb2 gray5">11 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/image4-4.png" class="kg-image" alt="Network flow monitoring is GA, providing end-to-end traffic visibility" loading="lazy" width="1999" height="1125"></figure>
	<p>网络工程师在分析 DDoS 攻击或排查其他流量异常时，常常发现他们需要加强监测网络流量和运行情况。这些工程师通常会制定一些关于网络流量的高级别指标，但他们却难以收集到能够阐明问题的特定流量的基本信息。为了解决这个问题，Cloudflare 一直在试点应用一款名为 <a href="https://www.cloudflare.com/network-services/products/magic-network-monitoring" target="_blank">Magic Network Monitoring</a> 的云网络流量监控产品 &nbsp;，为客户提供整个网络所有流量的端到端监测。</p>
	<p>今天，Cloudflare 很高兴地宣布，Magic Network Monitoring（以前称为 <a href="https://blog.cloudflare.com/flow-based-monitoring-for-magic-transit">Flow Based Monitoring</a>）现已正式发布，可供所有企业客户使用。在过去的一年里，Cloudflare 工程团队对 Magic Network Monitoring 进行了重大改进；我们很高兴能够推出一款网络服务产品，帮助客户更快速地识别威胁、减少安全漏洞，并提高网络安全性。<br><br>我们会对所有 Magic Transit 和 Magic WAN 的企业客户自动启用 Magic Network Monitoring。此产品位于 Cloudflare 仪表板的帐户级别，并且可以通过导航至“分析与日志 &gt; Magic Monitoring”将其打开。Magic Network Monitoring 的载入流程属于自助式服务，拥有访问权限的所有企业客户都可以立即开始配置此产品。 </p>
	<p>如果尚未购买 Magic Transit 或 Magic WAN 的企业客户有兴趣参与 Magic Network Monitoring 测试，可以通过向 Cloudflare 客户团队提交申请或填写此表<a href="http://network-services/products/magic-network-monitoring" target="_blank">向专家咨询</a>，来体验免费版（对流量数量有一些限制）。</p>
	<h3 id="%E4%BB%80%E4%B9%88%E6%98%AF-magic-network-monitoring%EF%BC%9F">什么是 Magic Network Monitoring？</h3>
	<p>Magic Network Monitoring 是一款云网络流量监控产品。<a href="https://en.wikipedia.org/wiki/Traffic_flow_(computer_networking)" target="_blank">网络流量</a>是指使用相同互联网协议和端口集，在源与目标 IP 之间传输的数据包流。客户可以将网络流量报告从他们的路由器（或任何其他网络流量生成器）发送到 <a href="https://www.cloudflare.com/learning/cdn/glossary/anycast-network" target="_blank">Cloudflare Anycast 网络</a>上公开可用的端点，即使这些流量最初不是通过 Cloudflare 网络传输。Cloudflare 会分析网络流量数据，然后让客户可以通过分析仪表板监测各项关键网络流量指标。具体包括：一段时间内的流量数量（以比特或数据包为单位）、源 IP、目标 IP、端口、流量协议和路由器 IP。客户还可以配置警报，以识别 <a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack" target="_blank">DDoS 攻击</a>和其他异常流量活动。</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/1-1.png" class="kg-image" alt="" loading="lazy" width="1435" height="802">
		<figcaption>将网络中的流量数据发送到 Cloudflare 进行分析</figcaption>
	</figure>
	<h3 id="%E4%BC%81%E4%B8%9A-ddos-%E6%94%BB%E5%87%BB%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%B5%8B">企业 DDoS 攻击类型检测</h3>
	<p><a href="https://developers.cloudflare.com/magic-transit/on-demand" target="_blank">Magic Transit 按需使用</a> (MTOD) 客户在使用 Magic Network Monitoring 时会体验到显著的流量监测优势。<a href="https://www.cloudflare.com/network-services/products/magic-transit" target="_blank">Magic Transit</a> 是一套网络安全解决方案，为本地网络、云托管网络和混合网络中的每个 Cloudflare 数据中心提供 DDoS 防护和流量加速。如果检测到 DDoS 攻击，Magic Transit 按需使用客户可以激活 Magic Transit 来提供保护。</p>
	<p>总的来说，我们注意到一些 MTOD 客户缺乏网络监测工具，无法快速识别 DDoS 攻击并采取适当的缓解措施。现在，MTOD 客户则可以使用 Magic Network Monitoring 来分析其网络数据，并在检测到 DDoS 攻击时收到警报。</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/2-1.png" class="kg-image" alt="" loading="lazy" width="1436" height="761">
		<figcaption>Cloudflare 会从客户的网络流数据中检测到 DDoS 攻击</figcaption>
	</figure>
	<p>一旦检测到 DDoS 攻击，Magic Network Monitoring 客户可以选择手动或自动启用 Magic Transit 来缓解 DDoS 攻击。</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/3-1.png" class="kg-image" alt="" loading="lazy" width="1436" height="761">
		<figcaption>激活 Magic Transit 以实施 DDoS 防护</figcaption>
	</figure>
	<h3 id="%E4%BC%81%E4%B8%9A%E7%BD%91%E7%BB%9C%E7%9B%91%E6%B5%8B">企业网络监测</h3>
	<p>Cloudflare Magic WAN 和 Cloudflare One 客户也可以从使用 Magic Network Monitoring 中受益。如今，这些客户可以很好地监测通过 Cloudflare 网络发送的流量，但是有时候却无法检测那些未通过 Cloudflare 发送的流量。这可能包括保留在本地网络上的流量，或者在云环境之间发送的网络流量。Magic WAN 和 Cloudflare One 客户可以将 Magic Network Monitoring 添加到他们的产品解决方案套件中，以实现对其网络上所有流量的端到端网络检测。</p>
	<h3 id="%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E6%B5%81%E9%87%8F%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%B5%81%E9%87%8F%E9%87%87%E6%A0%B7">深入了解网络流量与网络流量采样</h3>
	<p>Magic Network Monitoring 通过采集和分析网络流量数据，让客户能够加强对其网络流量的监测。<br><br>这个流程的开端就是路由器（或其他网络流生成设备）收集入站和/或出站数据包数据的<a href="https://en.wikipedia.org/wiki/Sampling_(statistics)" target="_blank">统计样本</a>。这些样本是通过检查每 X 个数据包中的 1 个数据包收集而来，其中 X 是指路由器上配置的采样率。常见的采样率范围从每 1,000 个数据包中采样 1 个到每 4,000 个数据包中采样 1 个都有，不一而足。理想的采样率取决于流量数量、流量多样性以及路由器硬件的计算/内存能力。有关更多信息，请阅读 Cloudflare MNM 开发人员文档中<a href="https://developers.cloudflare.com/magic-network-monitoring/routers/recommended-sampling-rate" target="_blank">推荐的网络流采样率</a>。<br><br>然后，将采样的数据打包成两种行业标准格式之一（NetFlow 或 sFlow）的网络流量数据。如果是 NetFlow 格式，采样的数据包数据会按照不同的数据包特征（例如，源/目标 IP、端口和协议）分组。每组采样的数据包数据还包括流量数量的估算值。如果是 sFlow 格式，则整个数据包标头被选作代表性样本，且不包含任何数据汇总。因此，与 NetFlow 数据相比，sFlow 数据的格式更加丰富，包含的网络流量详细信息也更多。在收集到 NetFlow 或 sFlow 格式的数据样本之后，将其发送到 Magic Network Monitoring 进行分析和发送警报。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/4-1.png" class="kg-image" alt="" loading="lazy" width="1600" height="400"></figure>
	<h3 id="%E4%B8%BA%E4%BB%80%E4%B9%88-magic-network-monitoring-%E4%B8%8D%E9%87%87%E7%94%A8%E7%AE%80%E5%8D%95%E7%9A%84%E9%9A%8F%E6%9C%BA%E5%8F%96%E6%A0%B7">为什么 Magic Network Monitoring 不采用简单的随机取样</h3>
	<p>与一年前发布的提前体验版相比，如今的 Magic Network Monitoring 已经取得了显著的进步。特别是，Cloudflare 工程团队投入了大量时间来提高 MNM 中流量估算的准确性。在 Magic Network Monitoring 提前体验版中，客户出乎意料地报告称，他们的网络流量数量的估算值过高，与预期值不符。<br><br>Magic Network Monitoring 会对接收的 NetFlow 或 sFlow 格式的数据进行自主采样，以便有效地扩展和管理 Cloudflare 在全局网络中提取的数据。由于 MNM 解析的 NetFlow 或 sFlow 格式的数据均建立在采样的数据包数据基础之上，因此，提高流量估算值的准确性比预期的要更加困难。为了解决这个问题，我们在产品分析中引入了多个不同的数据采样层。</p>
	<p>Magic Network Monitoring 第一版使用了<a href="https://en.wikipedia.org/wiki/Simple_random_sample" target="_blank">随机取样</a> ，也就是从具有相同时间戳的网络流量数据中随机抽取一个子集，来代表特定时间点的流量。网络流量数据的一个特点是，有些样本比其他样本更重要，并且代表着更大数量的网络流量。考虑到这种重要性，我们可以根据每个样本所代表的流量数量为其设定一个<a href="https://en.wikipedia.org/wiki/Weighting" target="_blank">权重</a>。网络流量数据权重始终为正数，并且呈<a href="https://en.wikipedia.org/wiki/Long_tail" target="_blank">长尾分布</a>。这些数据特征导致 MNM 的随机取样无法正确估算客户的网络流量数量。当从长尾分布中随机选择一个离群数据样本作为该时间点所有流量的代表时，客户就会在流量分析中看到不真实的峰值。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/5-1.png" class="kg-image" alt="" loading="lazy" width="1600" height="400"></figure>
	<h3 id="%E4%BD%BF%E7%94%A8-varopt-%E8%93%84%E6%B0%B4%E6%B1%A0%E5%8F%96%E6%A0%B7%EF%BC%8C%E6%8F%90%E9%AB%98%E5%87%86%E7%A1%AE%E6%80%A7">使用 VarOpt 蓄水池取样，提高准确性</h3>
	<p>为了解决这个问题，Cloudflare 工程团队采用了一种称之为<a href="https://arxiv.org/pdf/0803.0473.pdf" target="_blank"> VarOpt</a> 的<a href="https://en.wikipedia.org/wiki/Reservoir_sampling" target="_blank">蓄水池取样</a>方法。VarOpt 设计用于在数据流长度未知的情况下，从数据流中收集样本（用于分析入站网络流量数据的理想应用）。在 MNM 中采用 VarOpt 方法，我们首先新建一个固定尺寸的空蓄水池，在其中注入网络流量数据样本。在蓄水池已满但仍有新的入站网络流量数据输入的情况下，我们会从蓄水池随机丢弃一个旧样本，并使用一个新样本取而代之。在观察一定数量的样本之后，我们会计算蓄水池中所有加权样本的流量，此时就是估算客户网络流量数量的时间点。最后，清空蓄水池，然后使用下一组最新网络流量样本填充蓄水池，并重新启动 VarOpt 循环。</p>
	<p>新的 VarOpt 取样方法显著提高了 Magic Network Monitoring 估算流量数量的准确性，解决了客户的难题。改进这些取样方法为正式发布 Magic Network Monitoring 创造了条件且铺平了道路，我们很高兴能够向所有客户提供准确的网络流量分析。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/6-1.png" class="kg-image" alt="" loading="lazy" width="1600" height="320"></figure>
	<h3 id="%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E6%96%87%E6%A1%A3%E4%B8%8E-discord-%E7%A4%BE%E5%8C%BA">开发人员文档与 Discord 社区</h3>
	<p>详细的 <a href="https://developers.cloudflare.com/magic-network-monitoring" target="_blank">Magic Network Monitoring 开发人员文档</a>阐述了产品功能，并为新客户概述了分步配置指南。在您阅读 Magic Network Monitoring 文档时，可以随时单击开发人员文档右上角的“提供反馈”按钮来提供反馈。</p>
	<p>我们还在 Cloudflare Discord 社区创建了一个频道，主要用于讨论调试配置问题、测试新功能和提供产品反馈。您可以通过此链接，选择加入 <a href="https://discord.gg/cloudflaredev" target="_blank">Cloudflare Discord 服务器</a>。</p>
	<h3 id="%E5%85%8D%E8%B4%B9%E7%89%88">免费版</h3>
	<p>所有 Enterprise 客户均可向其 Cloudflare 客户团队提出请求，试用 <a href="https://developers.cloudflare.com/magic-network-monitoring/magic-network-monitoring-free" target="_blank">Magic Network Monitoring 免费版</a>。免费版有助于企业客户在购买 Magic Transit、Magic WAN 或 Cloudflare One 之前，快速测试和评估 Magic Network Monitoring。Enterprise 客户可以按照产品文档中的<a href="https://developers.cloudflare.com/magic-network-monitoring/get-started" target="_blank">分步入门指南</a>来自行完整配置 Magic Network Monitoring。免费版对可以处理的流量数量有一些<a href="https://developers.cloudflare.com/magic-network-monitoring/magic-network-monitoring-free" target="_blank">限制</a>，产品文档对此有进一步概述。</p>
	<p>还可以通过封闭测试向所有 Cloudflare Free、Cloudflare Pro 和 Cloudflare Business 计划客户提供 Magic Network Monitoring 免费版。这些客户都可以通过<a href="https://developers.cloudflare.com/magic-network-monitoring/magic-network-monitoring-free" target="_blank">阅读免费版文档</a>并<a href="https://forms.gle/z93ghpydpKdAFZ7P9" target="_blank">填写此表单</a>来请求访问免费版。那些加入 <a href="https://discord.com/invite/cloudflaredev" target="_blank">Cloudflare Discord 服务器</a>并发送消息至 Magic Network Monitoring Discord 频道的用户，都会获得优先访问权限。</p>
	<h3 id="%E7%AB%8B%E5%8D%B3%E5%8F%AF%E4%BB%A5%E9%87%87%E5%8F%96%E7%9A%84%E4%B8%8B%E4%B8%80%E6%AD%A5%E6%8E%AA%E6%96%BD">立即可以采取的下一步措施</h3>
	<p>Magic Network Monitoring 现已正式发布，并且所有 Magic Transit 和 Magic WAN 客户均可立即自动体验此产品。您可以进入 Cloudflare 仪表板的帐户级别，然后选择“分析与日志 &gt; Magic Monitoring”，来浏览此产品。<br><br>如果您是没有购买 Magic Transit 或 Magic WAN 的企业客户，但却希望使用 Magic Network Monitoring 来加强流量监测，则可以<a href="http://network-services/products/magic-network-monitoring" target="_blank">立即咨询 MNM 专家</a>。<br><br>如果您有兴趣了解如何使用 Magic Transit 和 Magic Network Monitoring 来进行 DDoS 防护，则可以<a href="https://www.cloudflare.com/network-services/products/magic-transit" target="_blank">申请 Magic Transit 演示</a>。如果您想搭配使用 Magic WAN 和 Magic Network Monitoring 来实现端到端网络流量监测，则可以<a href="https://www.cloudflare.com/network-services/products/magic-wan" target="_blank">咨询 Magic WAN 专家</a>。</p>
</div>