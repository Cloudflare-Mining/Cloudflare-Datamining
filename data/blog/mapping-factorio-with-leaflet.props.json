{
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Guest Author",
				"slug": "guest-author",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/YJzTr2p8aLvtEX5J7CysP/8be54016d68bd43aa5b327f0382f5827/guest-author.png",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "Factorio is a game about building and maintaining factories. Players mine resources, research new technology and automate production. Resources move along the production line through multiple means of transportation such as belts and trains. ",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/1PJDqmx90z4PIOIyHZT9PC/db5927da10957ab49f9271351fc01d82/mapping-factorio-with-leaflet.png",
		"featured": false,
		"html": "<p><i>The following is a guest post by </i><a href=\"https://twitter.com/jachands\"><i>Jacob Hands</i></a><i>, Creator of </i><a href=\"https://factoriomaps.com/browse.html\"><i>FactorioMaps.com</i></a><i>. He is building a community site for the game </i><a href=\"https://www.factorio.com/\"><i>Factorio</i></a><i> centered around sharing user creations.</i></p><p>Factorio is a game about building and maintaining factories. Players mine resources, research new technology and automate production. Resources move along the production line through multiple means of transportation such as belts and trains. Once production starts getting up to speed, alien bugs start to attack the factory requiring strong defenses.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/1TNrprtIuvw1mO132IQAJO/cc743c79db49c5268d1a05f2652066fe/Screen-Shot-2018-10-03-at-5.25.28-PM.png\" alt=\"\" class=\"kg-image\" width=\"1248\" height=\"704\" loading=\"lazy\"/>\n            \n            </figure><p>A Factorio factory producing many different items.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/5UhpJmn4V4ssl4Z0xYL9F4/cfe728692fb59eac6e684d5ebba5e828/Screen-Shot-2018-10-03-at-5.26.28-PM.png\" alt=\"\" class=\"kg-image\" width=\"1248\" height=\"702\" loading=\"lazy\"/>\n            \n            </figure><p>A Factorio military outpost fighting the alien bugs.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/31bhk36TBVSqbovlQfCOEt/2aeef39aa93db25f44a8e5ad024d7632/Screen-Shot-2018-10-03-at-5.27.24-PM.png\" alt=\"\" class=\"kg-image\" width=\"1248\" height=\"1248\" loading=\"lazy\"/>\n            \n            </figure><p>A Factorio map view of a small factory, that’s still too big to easily share fully with screenshots.</p><p>At FactorioMaps.com, I am building a place for the community of Factorio players to share their factories as interactive Leaflet maps. Due to the size and detail of the game, it can be difficult to share an entire factory through a few screenshots. A Leaflet map provides a Google Maps-like experience allowing viewers to pan and zoom throughout the map almost as if they are playing the game.</p><h3>Hosting</h3><p>Leaflet maps contain thousands of small images for X/Y/Z coordinates. Amazon S3 and Google Cloud Storage are the obvious choices for low-latency object storage. However, after 3.5  months in operation, FactorioMaps.com contains 17 million map images (&gt;1TB). For this use-case, $0.05 per 10,000 upload API calls and $0.08 to 0.12/GB for egress would add up quickly. Backblaze B2 is a better fit because upload API calls are free, <a href=\"/bandwidth-alliance/\">egress bandwidth is $0.00/GB to Cloudflare</a>, and storage is 1/4th the price of the competition.</p><p>Backblaze B2 requires a prefix of /file/bucketName on all public files, which I don’t want. To remove it, I added a VPS proxy to rewrite paths and add a few 301 redirects. Unfortunately, the latency from the user -&gt; VPS -&gt; B2 was sub-par averaging 800-1200ms in the US.</p><h3>A Closer Look At Leaflet</h3><p>Leaflet maps work by loading images at the user&#39;s X/Y/Z coordinates to render the current view. As a map is zoomed in, it requires 4x as many images to show the same area. That means 75% of a map&#39;s images are in the max rendered zoom level.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/2I3CK2L5HsxRJlY41MAl8j/92e8d16a8da3d3cff6550a321134d127/Screen-Shot-2018-10-03-at-5.29.14-PM.png\" alt=\"\" class=\"kg-image\" width=\"1262\" height=\"550\" loading=\"lazy\"/>\n            \n            </figure><p>A diagram of how each zoom level is 4x larger than the previous</p><h3>Reducing Latency</h3><p>With hosting working, it&#39;s time to start making the site faster. The majority of image requests come from the first few zoom levels, representing less than 25% of a given map&#39;s images. Adding a local SSD cache on the VPS containing all except the last 1-3 zoom levels for each map reduces latency for 66% of requests. The problem with SSD storage is it&#39;s difficult to scale with ever-increasing data and is still limited to the network and CPU performance of the server it occupies.</p><h3>Going Serverless with Cloudflare Workers</h3><p>Cloudflare Workers can run JavaScript using the Service Workers API which means the path rewrites and redirects the VPS was accomplishing could run on Cloudflare&#39;s edge.</p><p>While Google Cloud Storage is more expensive than B2, it has much lower latency to the US and worldwide destinations because of their network and multi-regional object storage. However, it&#39;s not time to move the whole site over to GCS just yet; the upload API calls alone would cost $85 for 17 million files.</p><h3>Multi-Tier Object Storage</h3><p>The first few zoom levels are stored in GCS, while the rest are in B2. Cloudflare Workers figure out where files are located by checking both sources simultaneously. By doing this, 66% of requested files come from GCS with a mean latency of &lt;350ms, while only storing 24% of files on GCS. Another benefit to using B2 as the primary storage is if GCS becomes too expensive in the future, I can move all requests to B2.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">// Race GCS and B2\nlet gcsReq = new Request(&#039;https://storage.googleapis.com/bucketName&#039; + url.pathname, event.request)\nlet b2Req = new Request(getB2Url(request) + &#039;/bucketName&#039; + url.pathname, event.request);\n\n// Fetch from GCS and B2 with Cloudflare caching enabled\nlet gcsPromise = fetch(gcsReq, cfSettings);\nlet b2Promise = fetch(b2Req, cfSettings);\n\nlet response = await Promise.race([gcsPromise, b2Promise]);\nif (response.ok) {\n    return response;\n}\n\n// If the winner was bad, find the one that is good (if any)\nresponse = await gcsPromise;\nif (response.ok) {\n    return response;\n}\n\nresponse = await b2Promise;\nif (response.ok) {\n    return response;\n}\n\n// The request failed/doesn&#039;t exist\nreturn response;</pre></code>\n            <h3>Tracking Subrequests</h3><p>The Cloudflare Workers dashboard contains a few analytics for subrequests, but there is no way to see what responses came from B2 vs. GCS. Fortunately, it’s easy to send request stats to a 3rd party service like StatHat with a few lines of JavaScript.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\"> // Fetch from GCS and B2 with caching\nlet reqStartTime = Date.now();\nlet gcsPromise = fetch(gcsReq, cfSettings);\nlet b2Promise = fetch(b2Req, cfSettings);\n\nlet response = await Promise.race([gcsPromise, b2Promise]);\nif (response.ok) {\n    event.waitUntil(logResponse(event, response, (Date.now() - reqStartTime)));\n    return response;\n}</pre></code>\n            <p>The resulting stats prove that GCS is serving the majority of requests, and Cloudflare caches over 50% of those requests. The code for the logResponse function can be found <a href=\"https://gist.github.com/jahands/636e89a125f0352a3d50fff155bfa50f#file-stat-logging-to-stathat-js\"><b>here</b></a>.  </p><h3>Making B2 Faster with Argo</h3><p>Tracking request time surfaced another issue. Requests to B2 from countries outside of North America are still quite slow. Cloudflare&#39;s Argo can reduce latency by over 50%, but is too expensive to enable for the whole site. Additionally, it would be redundant to smart-route content from GCS that Google already does an excellent job of keeping latency down. Cloudflare request headers include the country of origin, making it trivial to route this subset of requests through an Argo-enabled domain.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">// Use CF Argo for non-US/CA users\nfunction getB2Url(request) {\n    let b2BackendUrl = &#039;https://b2.my-argo-enabled-domain.com/file&#039;;\n    let country = request.headers.get(&#039;CF-IPCountry&#039;)\n    if (country === &#039;US&#039; || country === &#039;CA&#039;) {\n        b2BackendUrl = &#039;https://f001.backblazeb2.com/file&#039;;\n    }\n    return b2BackendUrl;\n}</pre></code>\n            <h3>Conclusion</h3><p>Cloudflare Workers are an excellent fit for my project; they enabled me to make a cost-effective solution to hosting Leaflet maps at scale. Check out <a href=\"https://factoriomaps.com\">https://factoriomaps.com</a> for performant Leaflet maps, and if you play Factorio, <a href=\"https://factoriomaps.com/submit\">submit</a> your <a href=\"https://www.factorio.com/\">Factorio</a> world to share with others!</p>",
		"id": "2879ChUuA8e7m19nzVicLX",
		"localeList": {
			"name": "Mapping Factorio with Leaflet Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2018-10-10T15:09:31.000+01:00",
		"reading_time": 4,
		"slug": "mapping-factorio-with-leaflet",
		"tags": [
			{
				"id": "6hbkItfupogJP3aRDAq6v8",
				"name": "Cloudflare Workers",
				"slug": "workers"
			},
			{
				"id": "5cye1Bh5KxFh3pKSnX8Dsy",
				"name": "Serverless",
				"slug": "serverless"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "78aSAeMjGNmCuetQ7B4OgU",
				"name": "JavaScript",
				"slug": "javascript"
			},
			{
				"id": "3JAY3z7p7An94s6ScuSQPf",
				"name": "Developer Platform",
				"slug": "developer-platform"
			}
		],
		"title": "Mapping Factorio with Leaflet",
		"updated_at": "2024-08-27T02:17:59.144Z",
		"url": "https://blog.cloudflare.com/mapping-factorio-with-leaflet"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}