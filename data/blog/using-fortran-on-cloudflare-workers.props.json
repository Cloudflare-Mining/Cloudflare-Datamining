{
	"locale": "en-us",
	"post": {
		"access": true,
		"authors": [
			{
				"id": "5d1644b141acde0011a94f2c",
				"name": "John Graham-Cumming",
				"slug": "john-graham-cumming",
				"profile_image": "http://blog.cloudflare.com/content/images/2017/03/url-2.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2023/05/Twitter-Header-@cloudflare-US.png",
				"bio": null,
				"website": null,
				"location": "Lisbon, Portugal",
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/john-graham-cumming/"
			},
			{
				"id": "5f7305b4c9353501baf0c723",
				"name": "Sven Sauleau",
				"slug": "sven",
				"profile_image": "https://blog-cloudflare-com-assets.storage.googleapis.com/2020/09/7cBY6-H7_400x400--1-.jpg",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@svensauleau",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/sven/"
			}
		],
		"canonical_url": null,
		"codeinjection_foot": null,
		"codeinjection_head": null,
		"comment_id": "66200f7327e210000ab29b11",
		"comments": false,
		"created_at": "2024-04-17T19:05:39.000+01:00",
		"custom_excerpt": "Work on LLVM has enabled Fortran to compile to WebAssembly. So, today, we’re writing about running Fortran code on Cloudflare Workers",
		"custom_template": null,
		"email_subject": null,
		"excerpt": "Work on LLVM has enabled Fortran to compile to WebAssembly. So, today, we’re writing about running Fortran code on Cloudflare Workers",
		"feature_image": "http://blog.cloudflare.com/content/images/2024/05/image2-1.png",
		"feature_image_alt": "Using Fortran on Cloudflare Workers.",
		"feature_image_caption": null,
		"featured": false,
		"frontmatter": null,
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2024/05/image2.png\" class=\"kg-image\" alt=\"Using Fortran on Cloudflare Workers\" loading=\"lazy\" width=\"1800\" height=\"1014\"></figure><p>In April 2020, we blogged about how to get <a href=\"http://blog.cloudflare.com/cloudflare-workers-now-support-cobol\">COBOL running on Cloudflare Workers</a> by compiling to WebAssembly. The ecosystem around WebAssembly has grown significantly since then, and it has become a solid foundation for all types of projects, be they client-side or server-side.</p><p>As WebAssembly support has grown, more and more languages are able to compile to WebAssembly for execution on servers and in browsers. As Cloudflare Workers uses the V8 engine and supports WebAssembly natively, we’re able to support languages that compile to WebAssembly on the platform. </p><p>Recently, work on LLVM has enabled Fortran to compile to WebAssembly. So, today, we’re writing about running Fortran code on Cloudflare Workers.</p><p>Before we dive into how to do this, here’s a little demonstration of number recognition in Fortran. Draw a number from 0 to 9 and Fortran code running somewhere on Cloudflare’s network will predict the number you drew.</p><!--kg-card-begin: html--><iframe src=\"https://handwritten-digit-classifier.fortran.demos.cloudflare.com/\" style=\"height: 300px\"></iframe><!--kg-card-end: html--><p>This is taken from the wonderful <a href=\"https://gws.phd/posts/fortran_wasm/\">Fortran on WebAssembly</a> post but instead of running client-side, the Fortran code is running on Cloudflare Workers. Read on to find out how you can use Fortran on Cloudflare Workers and how that demonstration works.</p><h3 id=\"wait-fortran-no-one-uses-that\">Wait, Fortran? No one uses that!</h3><p>Not so fast! Or rather, actually pretty darn fast if you’re doing a lot of numerical programming or have scientific data to work with. Fortran <a href=\"https://en.wikipedia.org/wiki/Fortran#Naming\">(originally FORmula TRANslator)</a> is very well suited for scientific workloads because of its native functionality for things like arithmetic and handling large arrays and matrices.</p><p>If you look at the <a href=\"https://en.wikipedia.org/wiki/TOP500\">ranking</a> of the fastest supercomputers in the world you’ll discover that the measurement of “fast” is based on these supercomputers running a piece of software called <a href=\"https://en.wikipedia.org/wiki/LINPACK\">LINPACK</a> that was originally written in Fortran. LINPACK is designed to help with problems solvable using linear algebra.</p><p>The <a href=\"https://en.wikipedia.org/wiki/LINPACK_benchmarks\">LINPACK benchmarks</a> use LINPACK to solve an n x n system of linear equations using matrix operations and, in doing so, determine how fast supercomputers are. The code is available in <a href=\"https://www.netlib.org/benchmark/linpackd\">Fortran</a>, <a href=\"https://www.netlib.org/benchmark/linpackc\">C</a> and <a href=\"https://www.netlib.org/benchmark/linpackjava/\">Java</a>.</p><p>A related Fortran package, <a href=\"https://www.netlib.org/blas/\">BLAS</a>, also does linear algebra and forms the basis of the number identifying code above. But other Fortran packages are still relevant. Back in 2017, NASA ran a <a href=\"https://www.bbc.com/news/technology-39803425\">competition</a> to make FUN3D (used to perform calculations of airflow over simulated aircraft). <a href=\"https://fun3d.larc.nasa.gov/\">FUN3D</a> is written in Fortran. </p><p>So, although Fortran (or at the time FORTRAN) first came to life in 1957, it’s alive and well and being used widely for scientific applications (there’s even <a href=\"https://developer.nvidia.com/cuda-fortran\">Fortran for CUDA</a>). One particular application left Earth 20 years after Fortran was born: Voyager. The Voyager probes use a combination of <a href=\"https://www.popularmechanics.com/space/a17991/voyager-1-voyager-2-retiring-engineer/\">assembly language and Fortran</a> to keep chugging along.</p><p>But back in our solar system, and back on Region: Earth, you can now use Fortran on Cloudflare Workers. Here’s how.</p><h3 id=\"how-to-get-your-fortran-code-running-on-cloudflare-workers\">How to get your Fortran code running on Cloudflare Workers</h3><p>To make it easy to run your Fortran code on Cloudflare Workers, we created a tool called <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a> (translates to smart in French). It uses <a href=\"https://flang.llvm.org/docs/\">Flang</a> and <a href=\"https://emscripten.org\">Emscripten</a> under the hood.</p><p><a href=\"https://flang.llvm.org/docs/\">Flang</a> is a frontend in <a href=\"https://en.wikipedia.org/wiki/LLVM\">LLVM</a> and, if you read the <a href=\"https://gws.phd/posts/fortran_wasm/\">Fortran on WebAssembly</a> blog post, we currently have to patch <a href=\"https://en.wikipedia.org/wiki/LLVM\">LLVM</a> to work around a few issues.</p><p><a href=\"https://emscripten.org\">Emscripten</a> is used to compile <a href=\"https://en.wikipedia.org/wiki/LLVM\">LLVM</a> output and produce code that is compatible with Cloudflare Workers.</p><p>This is all packaged in the <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a> Docker image. Let’s see a simple example.</p><p>add.f90:</p><pre><code>SUBROUTINE add(a, b, res)\n    INTEGER, INTENT(IN) :: a, b\n    INTEGER, INTENT(OUT) :: res\n\n    res = a + b\nEND\n</code></pre><p>Here we defined a subroutine called add that takes <code>a</code> and <code>b</code>, sums them together and places the result in <code>res</code>. </p><p>Compile with <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a>:</p><pre><code>docker run -v $PWD:/input -v $PWD/output:/output xtuc/fortiche --export-func=add add.f90\n</code></pre><p>Passing <code>--export-func=add</code> to <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a> makes the Fortran <code>add</code> subroutine available to JavaScript.</p><p>The output folder contains the compiled WebAssembly module and JavaScript from <a href=\"https://emscripten.org\">Emscripten</a>, and a JavaScript endpoint generated by <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a>:</p><pre><code>$ ls -lh ./output\ntotal 84K\n-rw-r--r-- 1 root root 392 avril 22 12:00 index.mjs\n-rw-r--r-- 1 root root 27K avril 22 12:00 out.mjs\n-rwxr-xr-x 1 root root 49K avril 22 12:00 out.wasm</code></pre><p>And finally the Cloudflare Worker:</p><pre><code class=\"language-js\">// Import what Fortiche generated\nimport {load} from \"../output/index.mjs\"\n\nexport default {\n    async fetch(request: Request): Promise&lt;Response&gt; {\n        // Load the Fortran program\n        const program = await load();\n\n        // Allocate space in memory for the arguments and result\n        const aPtr = program.malloc(4);\n        const bPtr = program.malloc(4);\n        const outPtr = program.malloc(4);\n\n        // Set argument values\n        program.HEAP32[aPtr / 4] = 123;\n        program.HEAP32[bPtr / 4] = 321;\n\n        // Run the Fortran add subroutine\n        program.add(aPtr, bPtr, outPtr);\n\n        // Read the result\n        const res = program.HEAP32[outPtr / 4];\n\n        // Free everything\n        program.free(aPtr);\n        program.free(bPtr);\n        program.free(outPtr);\n\n        return Response.json({ res });\n    },\n};\n</code></pre><p>Interestingly, the values we pass to Fortran are all pointers, therefore we have to allocate space for each argument and result (the Fortran integer type is four bytes wide), and pass the pointers to the <code>add</code> subroutine. </p><p>Running the Worker gives us the right answer:</p><pre><code>$ curl https://fortran-add.cfdemos.workers.dev\n\n{\"res\":444}\n</code></pre><p>You can find the <a href=\"https://github.com/cloudflare/fortiche/tree/main/examples/add\">full example here</a>.</p><h3 id=\"handwritten-digit-classifier\">Handwritten digit classifier</h3><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2024/05/image1-2.png\" class=\"kg-image\" alt loading=\"lazy\" width=\"1688\" height=\"858\"></figure><p>This example is taken from <a href=\"https://gws.phd/posts/fortran_wasm/#mnist\">https://gws.phd/posts/fortran_wasm/#mnist</a>. It relies on the <a href=\"https://www.netlib.org/blas/\">BLAS</a> library, which is available in Fortiche with the flag: <code>--with-BLAS-3-12-0</code>.</p><p>Note that the <a href=\"https://en.wikipedia.org/wiki/LAPACK\">LAPACK</a> library is also available in <a href=\"https://github.com/cloudflare/fortiche\">Fortiche</a> with the flag: <code>--with-LAPACK-3-12-0</code>.</p><p>You can try it below:</p><!--kg-card-begin: html--><iframe src=\"https://handwritten-digit-classifier.fortran.demos.cloudflare.com/\" style=\"height: 300px\"></iframe><!--kg-card-end: html--><p>And you can access the <a href=\"https://github.com/cloudflare/fortiche/tree/main/examples/handwritten-digit-classifier\">source code here</a>.</p><p>Let us know what you write using Fortran and Cloudflare Workers!</p><p><code>END</code></p>",
		"id": "66200f7327e210000ab29b11",
		"meta_description": "Work on LLVM has enabled Fortran to compile to WebAssembly. So, today, we’re writing about running Fortran code on Cloudflare Workers",
		"meta_title": null,
		"og_description": null,
		"og_image": "http://blog.cloudflare.com/content/images/2024/05/Cloudflare-Workers-now-supports-Fortran-OG-3.png",
		"og_title": null,
		"primary_author": {
			"id": "5d1644b141acde0011a94f2c",
			"name": "John Graham-Cumming",
			"slug": "john-graham-cumming",
			"profile_image": "http://blog.cloudflare.com/content/images/2017/03/url-2.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2023/05/Twitter-Header-@cloudflare-US.png",
			"bio": null,
			"website": null,
			"location": "Lisbon, Portugal",
			"facebook": null,
			"twitter": null,
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/john-graham-cumming/"
		},
		"primary_tag": null,
		"published_at": "2024-05-07T14:00:00.000+01:00",
		"reading_time": 4,
		"slug": "using-fortran-on-cloudflare-workers",
		"tags": [
			{
				"id": "66200fb327e210000ab29b15",
				"name": "#BLOG-2405",
				"slug": "hash-blog-2405",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "66200fb327e210000ab29b16",
				"name": "Fortran",
				"slug": "fortran",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/fortran/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "65c0d31851a92e000adeae66",
				"name": "#front-page",
				"slug": "hash-front-page",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			}
		],
		"title": "Using Fortran on Cloudflare Workers",
		"twitter_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2024/05/Cloudflare-Workers-now-supports-Fortran-OG-2.png",
		"twitter_title": null,
		"updated_at": "2024-05-07T14:40:15.000+01:00",
		"url": "http://blog.cloudflare.com/using-fortran-on-cloudflare-workers/",
		"uuid": "07dbcd26-4ecc-40d4-b9c4-d5e9632ddaa8",
		"visibility": "public"
	}
}