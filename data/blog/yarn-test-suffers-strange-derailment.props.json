{
	"footerBlurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
	"initialReadingTime": "7",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Yew Leong",
				"slug": "yew-leong",
				"profile_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/658l52gIu4kyDjwnJCelUt/d0a7c86def68692d50d9b4a0d6fc2f18/_tmp_mini_magick20221116-43-2dcplr.jpg",
				"publiclyIndex": true
			}
		],
		"excerpt": "Yarn tests fail consistently at the 27-second mark. The usual suspects are swiftly eliminated. A deep dive is taken to comb through traces, only to be derailed into an unexpected crash investigation.",
		"feature_image": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1yA1TgNlIUZwtZ4bIL39EJ/0bfc765dae00213eca7e48a337c8178e/image1.png",
		"featured": false,
		"html": "<p>So the story begins with a pair programming session I had with my colleague, which I desperately needed because my node skill tree is still at level 1, and I needed to get started with React because I&#39;ll be working on our internal <a href=\"https://github.com/backstage/backstage\"><u>backstage</u></a> instance.</p><p>We worked together on a small feature, tested it locally, and it worked. Great. Now it&#39;s time to make My Very First React Commit. So I ran the usual <code>git add</code> and <code>git commit</code>, which hooked into <code>yarn test</code>, to automatically run unit tests for backstage, and that&#39;s when <i>everything got derailed</i>. For all the React tutorials I have followed, I have never actually run a <code>yarn test</code> on <i>my machine</i>. And the first time I tried yarn test, it hung, and after a long time, the command eventually failed:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">Determining test suites to run...\n\n  ‚óè Test suite failed to run\n\nthrown: [Error]\n\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nüåà  backstage  ‚ö°</pre></code>\n            <p>I could tell it was obviously unhappy about something, and then it threw some [Error]. I have very little actual JavaScript experience, but this looks suspiciously like someone had neglected to write a proper toString() or whatever, and thus we&#39;re stuck with the monumentally unhelpful [Error]. Searching the web yielded an entire ocean of false positives due to how vague the error message is. <i>What a train wreck!</i></p><p>Fine, let&#39;s put on our troubleshooting hats. My memory is not perfect, but thankfully shell history is. Let&#39;s see all the (ultimately useless) things that were tried (with commentary):</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">2025-03-19 14:18  yarn test --help                                                                                                  \n2025-03-19 14:20  yarn test --verbose                    \n2025-03-19 14:21  git diff --staged                                                                                                 \n2025-03-19 14:25  vim README.md                    # Did I miss some setup?\n2025-03-19 14:28  i3lock -c 336699                 # &quot;I need a drink&quot;            \n2025-03-19 14:34  yarn test --debug                # Debug, verbose, what&#039;s the diff\n2025-03-19 14:35  yarn backstage-cli repo test     # Maybe if I invoke it directly ...\n2025-03-19 14:36  yarn backstage-cli --version     # Nope, same as mengnan&#039;s\n2025-03-19 14:36  yarn backstage-cli repo --help\n2025-03-19 14:36  yarn backstage-cli repo test --since HEAD~1   # Minimal changes?\n2025-03-19 14:36  yarn backstage-cli repo test --since HEAD     # Uhh idk no changes???\n2025-03-19 14:38  yarn backstage-cli repo test plugins          # The first breakthrough. More on this later\n2025-03-19 14:39  n all tests.\\n ‚Ä∫ Press f to run only failed tests.\\n ‚Ä∫ Press o to only run tests related to changed files.\\n ‚Ä∫ Pres\nfilter by a filename regex pattern.\\n ‚Ä∫ Press t to filter by a test name regex pattern.\\n ‚Ä∫ Press q to quit watch mode.\\n ‚Ä∫ Press Ent\nrigger a test run all tests.\\n ‚Ä∫ Press f to run only failed tests.\\n ‚Ä∫ Press o to only run tests related to changed files.\\n ‚Ä∫ Press\nlter by a filename regex pattern.\\n ‚Ä∫ Press t to filter by a test name regex pattern.\\n ‚Ä∫ Press q to quit watch mode.\\n ‚Ä∫ Press Enter\ngger a test ru                                     # Got too excited and pasted rubbish\n2025-03-19 14:44  ls -a | fgrep log\n2025-03-19 14:44  find | fgrep log                 # Maybe it leaves a log file?\n2025-03-19 14:46  yarn backstage-cli repo test --verbose --debug --no-cache plugins    # &quot;clear cache&quot;\n2025-03-19 14:52  yarn backstage-cli repo test --no-cache --runInBand .                # No parallel\n2025-03-19 15:00  yarn backstage-cli repo test --jest-help\n2025-03-19 15:03  yarn backstage-cli repo test --resetMocks --resetModules plugins     # I have no idea what I&#039;m resetting</pre></code>\n            <p>The first real breakthrough was <code>test plugins</code>,¬†which runs only tests matching &quot;plugins&quot;. This effectively bypassed the &quot;determining suites to run...&quot; logic, which was the thing that was hanging. So, I am now able to get tests to run. However, these too eventually crash with the same cryptic <code>[Error]</code>:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">PASS   @cloudflare/backstage-components  plugins/backstage-components/src/components/Cards/TeamMembersListCard/TeamMembersListCard.test.tsx (6.787 s)\nPASS   @cloudflare/backstage-components  plugins/backstage-components/src/components/Cards/ClusterDependencyCard/ClusterDependencyCard.test.tsx\nPASS   @internal/plugin-software-excellence-dashboard  plugins/software-excellence-dashboard/src/components/AppDetail/AppDetail.test.tsx\nPASS   @cloudflare/backstage-entities  plugins/backstage-entities/src/AccessLinkPolicy.test.ts\n\n\n  ‚óè Test suite failed to run\n\nthrown: [Error]</pre></code>\n            <p>Re-running it or matching different tests will give slightly different run logs, but they always end with the same error.</p><p>By now, I&#39;ve figured out that yarn test is actually backed by <a href=\"https://jestjs.io/\"><u>Jest, a JavaScript testing framework</u></a>, so my next strategy is simply trying different Jest flags to see what sticks, but invariably, none do:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">2025-03-19 15:16  time yarn test --detectOpenHandles plugins\n2025-03-19 15:18  time yarn test --runInBand .\n2025-03-19 15:19  time yarn test --detectLeaks .\n2025-03-19 15:20  yarn test --debug aetsnuheosnuhoe\n2025-03-19 15:21  yarn test --debug --no-watchman nonexisis\n2025-03-19 15:21  yarn test --jest-help\n2025-03-19 15:22  yarn test --debug --no-watch ooooooo &gt; ~/jest.config\n</pre></code>\n            \n    <div class=\"flex anchor relative\">\n      <h2 id=\"a-pattern-finally-emerges\">A pattern finally emerges</h2>\n      <a href=\"#a-pattern-finally-emerges\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>Eventually, after re-running it so many times, I started to notice a pattern. So by default after a test run, Jest drops you into an interactive menu where you can¬† (Q)uit, Run (A)ll tests, etc. and I realized that Jest would eventually crash, even if it&#39;s idling in the menu. I started timing the runs, which led me to the second breakthrough:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">‚Ä∫ Press q to quit watch mode.\n ‚Ä∫ Press Enter to trigger a test run.\n\n\n  ‚óè Test suite failed to run\n\nthrown: [Error]\n\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nyarn test .  109.96s user 14.21s system 459% cpu 27.030 total</pre></code>\n            \n            <pre class=\"language-Rust\"><code class=\"language-Rust\">RUNS   @cloudflare/backstage-components  plugins/backstage-components/src/components/Cards/TeamRoles/CustomerSuccessCard.test.tsx\n RUNS   @cloudflare/backstage-app  packages/app/src/components/catalog/EntityFipsPicker/EntityFipsPicker.test.tsx\n\nTest Suites: 2 failed, 23 passed, 25 of 65 total\nTests:       217 passed, 217 total\nSnapshots:   0 total\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nyarn test .  110.85s user 14.04s system 463% cpu 26.974 total</pre></code>\n            <p>No matter what Jest was doing, it always crashes after almost exactly 27 wallclock seconds. It literally didn&#39;t matter what tests I selected or re-ran. Even the original problem, a bare yarn test (no tests selected, just hangs), will crash after 27 seconds:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">Determining test suites to run...\n\n  ‚óè Test suite failed to run\n\nthrown: [Error]\n\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nyarn test  2.05s user 0.71s system 10% cpu 27.094 total\n</pre></code>\n            <p>Obviously, some sort of timeout. 27 seconds is kind of a weird number (unlike, say, 5 seconds or 60 seconds) but let&#39;s try:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">2025-03-19 15:09  find | fgrep 27\n2025-03-19 15:09  git grep &#039;\\b27\\b&#039;\n</pre></code>\n            <p>No decent hits.</p><p>How about something like 20+7 or even 20+5+2? <i>Nope.</i></p><p>Googling/GPT-4oing¬† for &quot;jest timeout 27 seconds&quot; again yielded nothing useful. Far more people were having problems with testing asynchronously, or getting their tests to timeout, than with Jest proper.¬†</p><p>At this time, my colleague came back from his call, and with his help we determined some other things:</p><ul><li><p>his system (MacOS) is not affected at all versus mine (Linux)</p></li><li><p><a href=\"https://github.com/nvm-sh/nvm?tab=readme-ov-file#intro\"><u>nvm use v20</u></a> didn&#39;t fix it</p></li><li><p>I can reproduce it on a clean clone of <a href=\"https://github.com/backstage/backstage\"><u>github.com/backstage/backstage</u></a>. The tests seem to progress further, about 50+ seconds. This lends credence to a running theory that the filesystem crawler/watcher is the one crashing, and backstage/backstage is a bigger repo than the internal Cloudflare instance, so it takes longer.</p></li></ul><p>I next went <i>on a little detour</i> to grab another colleague who I know has been working on a <a href=\"https://nextjs.org/\"><u>Next.js</u></a> project. He&#39;s one of the few other people nearby who knows anything about <a href=\"https://nodejs.org/en\"><u>Node.js</u></a>. In my experience with troubleshooting it‚Äôs helpful to get multiple perspectives, so we can cover each other‚Äôs blind spots and avoid tunnel vision.</p><p>I then tried invoking many yarn tests in parallel, and I did manage to get the crash time to stretch out to 28 or 29 seconds if the system was under heavy load. So this tells me that it might not be a hard timeout but rather processing driven. A series of sleeps <i>chugging along</i> perhaps?</p><p>By now, there is a veritable crowd of curious onlookers gathered in front of my terminal marveling at the consistent 27 seconds crash and trading theories. At some point, someone asked if I had tried rebooting yet, and I had to sheepishly reply that I haven&#39;t but &quot;I&#39;m absolutely sure it wouldn&#39;t help whatsoever&quot;.</p><p>And the astute reader can already guess that rebooting did nothing at all, or else this wouldn&#39;t even be a story worth telling. Besides, haven&#39;t I teased in the clickbaity title about some crazy Steam Locomotive from 1993?</p>\n    <div class=\"flex anchor relative\">\n      <h2 id=\"strace-to-the-rescue\">Strace to the rescue</h2>\n      <a href=\"#strace-to-the-rescue\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>My colleague then put us <i>back on track</i> and suggested <a href=\"https://strace.io/\"><u>strace</u></a>, and I decided to trace the simpler case of the idling menu (rather than trace running tests, which generated far more syscalls).</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">Watch Usage\n ‚Ä∫ Press a to run all tests.\n ‚Ä∫ Press f to run only failed tests.\n ‚Ä∫ Press o to only run tests related to changed files.\n ‚Ä∫ Press p to filter by a filename regex pattern.\n ‚Ä∫ Press t to filter by a test name regex pattern.\n ‚Ä∫ Press q to quit watch mode.\n ‚Ä∫ Press Enter to trigger a test run.\n[], 1024, 1000)          = 0\nopenat(AT_FDCWD, &quot;/proc/self/stat&quot;, O_RDONLY) = 21\nread(21, &quot;42375 (node) R 42372 42372 11692&quot;..., 1023) = 301\nclose(21)                               = 0\nepoll_wait(13, [], 1024, 0)             = 0\nepoll_wait(13, [], 1024, 999)           = 0\nopenat(AT_FDCWD, &quot;/proc/self/stat&quot;, O_RDONLY) = 21\nread(21, &quot;42375 (node) R 42372 42372 11692&quot;..., 1023) = 301\nclose(21)                               = 0\nepoll_wait(13, [], 1024, 0)             = 0\nepoll_wait(13,</pre></code>\n            <p>It basically <code>epoll_waits</code> until 27 seconds are up and then, right when the crash happens:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\"> ‚óè Test suite failed to run                                                                                                                \n                                                                                                                                            \nthrown: [Error]                                                                                                                             \n                                                                                                                                            \n0x7ffd7137d5e0, 1024, 1000) = -1 EINTR (Interrupted system call)\n--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=42578, si_uid=1000, si_status=1, si_utime=0, si_stime=0} ---\nread(4, &quot;*&quot;, 1)                     \t= 1\nwrite(15, &quot;\\210\\352!\\5\\0\\0\\0\\0\\21\\0\\0\\0\\0\\0\\0\\0&quot;, 16) = 16\nwrite(5, &quot;*&quot;, 1)                    \t= 1\nrt_sigreturn({mask=[]})             \t= -1 EINTR (Interrupted system call)\nepoll_wait(13, [{events=EPOLLIN, data={u32=14, u64=14}}], 1024, 101) = 1\nread(14, &quot;\\210\\352!\\5\\0\\0\\0\\0\\21\\0\\0\\0\\0\\0\\0\\0&quot;, 512) = 16\nwait4(42578, [{WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 1}], WNOHANG, NULL) = 42578\nrt_sigprocmask(SIG_SETMASK, ~[RTMIN RT_1], [], 8) = 0\nread(4, &quot;*&quot;, 1)                     \t= 1\nrt_sigaction(SIGCHLD, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x79e91e045330}, NULL, 8) = 0\nwrite(5, &quot;*&quot;, 1)                    \t= 1\nrt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0\nmmap(0x34ecad880000, 1495040, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x34ecad880000\nmadvise(0x34ecad880000, 1495040, MADV_DONTFORK) = 0\nmunmap(0x34ecad9ae000, 258048)      \t= 0\nmprotect(0x34ecad880000, 1236992, PROT_READ|PROT_WRITE) = 0</pre></code>\n            <p>I don&#39;t know about you, but sometimes I look at straces and wonder ‚ÄúDo people actually read this gibberish?‚Äù Fortunately, in the modern generative AI era, we can count on GPT-4o to gently chide: the process was interrupted <code>EINTR</code> by its child <code>SIGCHLD</code>, which means you forgot about the children, silly human. Is the problem with <i>one of the cars rather than the engine</i>?</p><p>Following this <i>train of thought</i>, I now re-ran with <code>strace --follow-forks</code>, which revealed a giant flurry of activity that promptly overflowed my terminal buffer. The investigation is really <i>gaining steam</i> now. The original trace weighs in at a hefty 500,000 lines, but here is a smaller equivalent version derived from a clean instance of backstage: <a href=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3IX3GEpe1WPllLf4tJBw5l/9a6c00a3eb06693d545ca49834ded987/trace.log.gz\"><u>trace.log.gz</u></a>. I have uploaded this trace here because the by-now overhyped Steam Locomotive is finally making its grand appearance<b> </b>and I know there&#39;ll be people who&#39;d love nothing more than to crawl through a haystack of system calls looking for a train-sized needle. Consider yourself lucky, I had to do it without even knowing what I was looking for, much less that it was a whole Steam Locomotive.</p><hr/><p>This section is left intentionally blank to allow locomotive enthusiasts who want to find the train on their own to do so first.</p><hr/><p>Remember my comment about straces being gibberish? Actually, I was kidding. So there are a few ways to make it more manageable, and with experience you&#39;ll learn which system calls to pay attention to, such as <code>execve</code>,<code> chdir</code>,<code> open</code>,<code> read</code>,<code> fork</code>,<code> and signals</code>, and which ones to skim over, such as <code>mprotect,</code> <code>mmap</code>, and <code>futex</code>.</p><p>Since I&#39;m writing this account after the fact, let&#39;s cheat a little and assume I was super smart and zeroed in on execve correctly on the first try:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">üåà  ~  zgrep execve trace.log.gz | head\nexecve(&quot;/home/yew/.nvm/versions/node/v18.20.6/bin/yarn&quot;, [&quot;yarn&quot;, &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffdff573148 /* 72 vars */) = 0\nexecve(&quot;/home/yew/.pyenv/shims/node&quot;, [&quot;node&quot;, &quot;/home/yew/.nvm/versions/node/v18&quot;..., &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffd64f878c8 /* 72 vars */) = -1 ENOENT (No such file or directory)\nexecve(&quot;/home/yew/.pyenv/bin/node&quot;, [&quot;node&quot;, &quot;/home/yew/.nvm/versions/node/v18&quot;..., &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffd64f878c8 /* 72 vars */) = -1 ENOENT (No such file or directory)\nexecve(&quot;/home/yew/repos/secrets/bin/node&quot;, [&quot;node&quot;, &quot;/home/yew/.nvm/versions/node/v18&quot;..., &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffd64f878c8 /* 72 vars */) = -1 ENOENT (No such file or directory)\nexecve(&quot;/home/yew/.nvm/versions/node/v18.20.6/bin/node&quot;, [&quot;node&quot;, &quot;/home/yew/.nvm/versions/node/v18&quot;..., &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffd64f878c8 /* 72 vars */) = 0\n[pid 49307] execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;backstage-cli repo test resource&quot;...], 0x3d17d6d0 /* 156 vars */ &lt;unfinished ...&gt;\n[pid 49307] &lt;... execve resumed&gt;)   \t= 0\n[pid 49308] execve(&quot;/home/yew/cloudflare/repos/backstage/node_modules/.bin/backstage-cli&quot;, [&quot;backstage-cli&quot;, &quot;repo&quot;, &quot;test&quot;, &quot;steam-regulator&quot;], 0x5e7ef80051d8 /* 156 vars */ &lt;unfinished ...&gt;\n[pid 49308] &lt;... execve resumed&gt;)   \t= 0\n[pid 49308] execve(&quot;/tmp/yarn--1742459197616-0.9027914591640542/node&quot;, [&quot;node&quot;, &quot;/home/yew/cloudflare/repos/backs&quot;..., &quot;repo&quot;, &quot;test&quot;, &quot;steam-regulator&quot;], 0x7ffcc18af270 /* 156 vars */) = 0\nüåà  ~  zgrep execve trace.log.gz | wc -l\n2254\n</pre></code>\n            <p>Phew, 2,000 is a lot of <code>execves</code> . Let&#39;s get the unique ones, plus their counts:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">üåà  ~  zgrep -oP &#039;(?&lt;=execve\\(&quot;)[^&quot;]+&#039; trace.log.gz | xargs -L1 basename | sort | uniq -c | sort -nr\n    576 watchman\n    576 hg\n    368 sl\n    358 git\n     16 sl.actual\n     14 node\n      2 sh\n      1 yarn\n      1 backstage-cli</pre></code>\n            <p>Have you spotted the <b>S</b>team <b>L</b>ocomotive yet? I spotted it immediately because this is My Own System and Surely This Means I Am Perfectly Aware Of Everything That Is Installed Unlike, er, <code>node_modules</code>.</p><p><code>sl</code>¬† is actually a<a href=\"https://github.com/mtoyoda/sl\"> <u>fun little joke program from 1993</u></a> that plays on users&#39; tendencies to make a typo on <a href=\"https://man7.org/linux/man-pages/man1/ls.1.html\"><code><u>ls</u></code></a>. When <code>sl</code>¬† runs, it clears your terminal to make way for an animated steam locomotive to come chugging through.</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">                        (  ) (@@) ( )  (@)  ()\t@@\tO \t@ \tO \t@  \tO\n                   (@@@)\n               (\t)\n            (@@@@)\n \n          (   )\n      ====    \t________            \t___________\n  _D _|  |_______/    \t\\__I_I_____===__|_________|\n   |(_)---  |   H\\________/ |   |    \t=|___ ___|  \t_________________\n   / \t|  |   H  |  | \t|   |     \t||_| |_|| \t_|            \t\\_____A\n  |  \t|  |   H  |__--------------------| [___] |   =|                    \t|\n  | ________|___H__/__|_____/[][]~\\_______|   \t|   -|                    \t|\n  |/ |   |-----------I_____I [][] []  D   |=======|____|________________________|_\n__/ =| o |=-~~\\  /~~\\  /~~\\  /~~\\ ____Y___________|__|__________________________|_\n |/-=|___|=O=====O=====O=====O   |_____/~\\___/      \t|_D__D__D_|  |_D__D__D_|\n  \\_/  \t\\__/  \\__/  \\__/  \\__/  \t\\_/           \t\\_/   \\_/\t\\_/   \\_/</pre></code>\n            <div style=\"position: relative; padding-top: 68.6046511627907%;\">\n  <iframe\n    src=\"https://customer-eq7kiuol0tk9chox.cloudflarestream.com/4d5cf36262674071cbb0c7520d569666/iframe?preload=true&loop=true&autoplay=true&poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2F4d5cf36262674071cbb0c7520d569666%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600\"\n    loading=\"lazy\"\n    style=\"border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;\"\n    allow=\"accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;\"\n    allowfullscreen=\"true\"\n  ></iframe>\n</div><p>When I first saw that Jest was running <code>sl</code> so many times, my first thought was to ask my colleague if <code>sl</code> is a valid command on his Mac, and of course it is not. After all, which serious engineer would stuff their machine full of silly commands like <code>sl</code>, <a href=\"https://r-wos.org/hacks/gti\"><code><u>gti</u></code></a>, <a href=\"https://en.wikipedia.org/wiki/Cowsay\"><code><u>cowsay</u></code></a>, or <a href=\"https://linuxcommandlibrary.com/man/toilet\"><code><u>toilet</u></code></a> ? The next thing I tried was to rename <code>sl</code> to something else, and sure enough all my problems disappeared: <code>yarn test</code> started working perfectly.</p>\n    <div class=\"flex anchor relative\">\n      <h2 id=\"so-what-does-jest-have-to-do-with-steam-locomotives\">So what does Jest have to do with Steam Locomotives?</h2>\n      <a href=\"#so-what-does-jest-have-to-do-with-steam-locomotives\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p><a href=\"https://github.com/jestjs/jest/issues/14046\"><u>Nothing, that&#39;s what</u></a>. The whole affair is an unfortunate naming clash between <code>sl</code> the Steam Locomotive and <code>sl</code> the<a href=\"https://github.com/facebook/sapling?tab=readme-ov-file#sapling-cli\"> <u>Sapling CLI</u></a>. Jest wanted <code>sl</code> the source control system, but ended up getting steam-rolled by <code>sl </code>the Steam Locomotive.</p>\n          <figure class=\"kg-card kg-image-card\">\n          <Image src=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6BDDm4dEbvMuVyn1J5reqf/ac7f914b3b23608941c84a6cd7aadbb1/image3.png\" alt=\"\" class=\"kg-image\" width=\"877\" height=\"1028\" loading=\"lazy\"/>\n          </figure><p>Fortunately the devs took it in good humor, and<a href=\"https://github.com/jestjs/jest/pull/15053\"> <u>made a (still unreleased) fix</u></a>. Check out the train memes!</p>\n          <figure class=\"kg-card kg-image-card\">\n          <Image src=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/n8MrPDXuVMuze7UEkxCie/5d187401c8bb12d8e3e0ef89d03b87f3/image4.png\" alt=\"\" class=\"kg-image\" width=\"962\" height=\"523\" loading=\"lazy\"/>\n          </figure>\n          <figure class=\"kg-card kg-image-card\">\n          <Image src=\"https://cf-assets.www.cloudflare.com/zkvhlag99gkb/Fot6dhfCsL0zvxYkVEh6a/440436342f93d1f7aca7dd70a9059436/image2.png\" alt=\"\" class=\"kg-image\" width=\"544\" height=\"237\" loading=\"lazy\"/>\n          </figure><p>At this point the main story has ended. However, there are still some unresolved nagging questions, like...</p>\n    <div class=\"flex anchor relative\">\n      <h2 id=\"how-did-the-crash-arrive-at-the-magic-number-of-a-relatively-even-27-seconds\">How did the crash arrive at the magic number of a relatively even 27 seconds?</h2>\n      <a href=\"#how-did-the-crash-arrive-at-the-magic-number-of-a-relatively-even-27-seconds\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>I don&#39;t know. Actually I&#39;m not sure if a forked child executing <code>sl</code> still has a terminal anymore, but the travel time of the train does depend on the terminal width. The wider it is, the longer it takes:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">üåà  ~  tput cols\n425\nüåà  ~  time sl\nsl  0.19s user 0.06s system 1% cpu 20.629 total\nüåà  ~  tput cols\n58\nüåà  ~  time sl  \nsl  0.03s user 0.01s system 0% cpu 5.695 total</pre></code>\n            <p>So the first thing I tried was to run yarn test in a ridiculously narrow terminal and see what happens:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">Determin\ning test\n suites \nto run..\n.       \n        \n  ‚óè Test\n suite f\nailed to\n run    \n        \nthrown: \n[Error] \n        \nerror Co\nmmand fa\niled wit\nh exit c\node 1.  \ninfo Vis\nit https\n://yarnp\nkg.com/e\nn/docs/c\nli/run f\nor docum\nentation\n about t\nhis comm\nand.    \nyarn tes\nt  1.92s\n user 0.\n67s syst\nem 9% cp\nu 27.088\n total  \nüåà  back\nstage [m\naster] t\nput cols\n        \n8</pre></code>\n            <p>Alas, the terminal width doesn&#39;t affect jest at all. Jest calls<a href=\"https://github.com/jestjs/jest/pull/13941/files#diff-4c649a2515ae8d1dc1ed6ebccbe3b43e54e5d7217cb011df616dcf471a80319cR59\"> <code><u>sl via execa</u></code></a> so let&#39;s mock that up locally:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">üåà  choochoo  cat runSl.mjs \nimport {execa} from &#039;execa&#039;;\nconst { stdout } = await execa(&#039;tput&#039;, [&#039;cols&#039;]);\nconsole.log(&#039;terminal colwidth:&#039;, stdout);\nawait execa(&#039;sl&#039;, [&#039;root&#039;]);\nüåà  choochoo  time node runSl.mjs\nterminal colwidth: 80\nnode runSl.mjs  0.21s user 0.06s system 4% cpu 6.730 total</pre></code>\n            <p>So <code>execa</code> uses the default terminal width of 80, which takes the train 6.7 seconds to cross. And 27 seconds divided by 6.7 is awfully close to 4. So is Jest running <code>sl</code> 4 times? Let&#39;s do a poor man&#39;s <a href=\"https://github.com/bpftrace/bpftrace\"><u>bpftrace</u></a> by hooking into <code>sl</code> like so:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">#!/bin/bash\n\nuniqid=$RANDOM\necho &quot;$(date --utc +&quot;%Y-%m-%d %H:%M:%S.%N&quot;) $uniqid started&quot; &gt;&gt; /home/yew/executed.log\n/usr/games/sl.actual &quot;$@&quot;\necho &quot;$(date --utc +&quot;%Y-%m-%d %H:%M:%S.%N&quot;) $uniqid ended&quot; &gt;&gt; /home/yew/executed.log</pre></code>\n            <p>And if we check <code>executed.log</code>, <code>sl</code> is indeed executed in 4 waves, albeit by 5 workers simultaneously in each wave:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">#wave1\n2025-03-20 13:23:57.125482563 21049 started\n2025-03-20 13:23:57.127526987 21666 started\n2025-03-20 13:23:57.131099388 4897 started\n2025-03-20 13:23:57.134237754 102 started\n2025-03-20 13:23:57.137091737 15733 started\n#wave1 ends, wave2 starts\n2025-03-20 13:24:03.704588580 21666 ended\n2025-03-20 13:24:03.704621737 21049 ended\n2025-03-20 13:24:03.707780748 4897 ended\n2025-03-20 13:24:03.712086346 15733 ended\n2025-03-20 13:24:03.711953000 102 ended\n2025-03-20 13:24:03.714831149 18018 started\n2025-03-20 13:24:03.721293279 23293 started\n2025-03-20 13:24:03.724600164 27918 started\n2025-03-20 13:24:03.729763900 15091 started\n2025-03-20 13:24:03.733176122 18473 started\n#wave2 ends, wave3 starts\n2025-03-20 13:24:10.294286746 18018 ended\n2025-03-20 13:24:10.297261754 23293 ended\n2025-03-20 13:24:10.300925031 27918 ended\n2025-03-20 13:24:10.300950334 15091 ended\n2025-03-20 13:24:10.303498710 24873 started\n2025-03-20 13:24:10.303980494 18473 ended\n2025-03-20 13:24:10.308560194 31825 started\n2025-03-20 13:24:10.310595182 18452 started\n2025-03-20 13:24:10.314222848 16121 started\n2025-03-20 13:24:10.317875812 30892 started\n#wave3 ends, wave4 starts\n2025-03-20 13:24:16.883609316 24873 ended\n2025-03-20 13:24:16.886708598 18452 ended\n2025-03-20 13:24:16.886867725 31825 ended\n2025-03-20 13:24:16.890735338 16121 ended\n2025-03-20 13:24:16.893661911 21975 started\n2025-03-20 13:24:16.898525968 30892 ended\n#crash imminent! wave4 ending, wave5 starting...\n2025-03-20 13:24:23.474925807 21975 ended</pre></code>\n            <p>The logs were emitted for about 26.35 seconds, which is close to 27. It probably crashed just as wave4 was reporting back. And each wave lasts about 6.7 seconds, right on the money with manual measurement.¬†</p>\n    <div class=\"flex anchor relative\">\n      <h2 id=\"so-why-is-jest-running-sl-in-4-waves-why-did-it-crash-at-the-start-of-the-5th-wave\">So why is Jest running sl in 4 waves? Why did it crash at the start of the 5th wave?</h2>\n      <a href=\"#so-why-is-jest-running-sl-in-4-waves-why-did-it-crash-at-the-start-of-the-5th-wave\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>Let&#39;s again modify the poor man&#39;s bpftrace to also log the args and working directory:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">echo &quot;$(date --utc +&quot;%Y-%m-%d %H:%M:%S.%N&quot;) $uniqid started: $@ at $PWD&quot; &gt;&gt; /home/yew/executed.log</pre></code>\n            <p>From the results we can see that the 5 workers are busy executing <code>sl root</code>, which corresponds to the <code>getRoot()</code>¬† function in <code>jest-change-files/sl.ts</code> </p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">2025-03-21 05:50:22.663263304  started: root at /home/yew/cloudflare/repos/backstage/packages/app/src\n2025-03-21 05:50:22.665550470  started: root at /home/yew/cloudflare/repos/backstage/packages/backend/src\n2025-03-21 05:50:22.667988509  started: root at /home/yew/cloudflare/repos/backstage/plugins/access/src\n2025-03-21 05:50:22.671781519  started: root at /home/yew/cloudflare/repos/backstage/plugins/backstage-components/src\n2025-03-21 05:50:22.673690514  started: root at /home/yew/cloudflare/repos/backstage/plugins/backstage-entities/src\n2025-03-21 05:50:29.247573899  started: root at /home/yew/cloudflare/repos/backstage/plugins/catalog-types-common/src\n2025-03-21 05:50:29.251173536  started: root at /home/yew/cloudflare/repos/backstage/plugins/cross-connects/src\n2025-03-21 05:50:29.255263605  started: root at /home/yew/cloudflare/repos/backstage/plugins/cross-connects-backend/src\n2025-03-21 05:50:29.257293780  started: root at /home/yew/cloudflare/repos/backstage/plugins/pingboard-backend/src\n2025-03-21 05:50:29.260285783  started: root at /home/yew/cloudflare/repos/backstage/plugins/resource-insights/src\n2025-03-21 05:50:35.823374079  started: root at /home/yew/cloudflare/repos/backstage/plugins/scaffolder-backend-module-gaia/src\n2025-03-21 05:50:35.825418386  started: root at /home/yew/cloudflare/repos/backstage/plugins/scaffolder-backend-module-r2/src\n2025-03-21 05:50:35.829963172  started: root at /home/yew/cloudflare/repos/backstage/plugins/security-scorecard-dash/src\n2025-03-21 05:50:35.832597778  started: root at /home/yew/cloudflare/repos/backstage/plugins/slo-directory/src\n2025-03-21 05:50:35.834631869  started: root at /home/yew/cloudflare/repos/backstage/plugins/software-excellence-dashboard/src\n2025-03-21 05:50:42.404063080  started: root at /home/yew/cloudflare/repos/backstage/plugins/teamcity/src</pre></code>\n            <p>The 16 entries here correspond neatly to the 16 <code>rootDirs</code> configured in Jest for Cloudflare&#39;s backstage. We have 5 trains, and we want to visit 16 stations so let&#39;s do some simple math. 16/5.0 = 3.2 which means our trains need to go back and forth 4 times at a minimum to cover them all.</p>\n    <div class=\"flex anchor relative\">\n      <h2 id=\"final-mystery-why-did-it-crash\">Final mystery: Why did it crash?</h2>\n      <a href=\"#final-mystery-why-did-it-crash\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>Let&#39;s go back to the very start of our journey. The original <code>[Error]</code> thrown was actually<a href=\"https://github.com/jestjs/jest/pull/13941/files#diff-4c649a2515ae8d1dc1ed6ebccbe3b43e54e5d7217cb011df616dcf471a80319cR48\"> <u>from here</u></a> and after modifying <code>node_modules/jest-changed-files/index.js</code>, I found that the error is <code>shortMessage: &#39;Command failed with ENAMETOOLONG: sl status...</code>&#39;¬† and the reason why became clear when I interrogated Jest about what it thinks the repos are.</p><p>While the git repo is what you&#39;d expect, the sl &quot;repo&quot; looks amazingly like a <i>train wreck in motion</i>:</p>\n            <pre class=\"language-Rust\"><code class=\"language-Rust\">got repos.git as Set(1) { &#039;/home/yew/cloudflare/repos/backstage&#039; }\ngot repos.sl as Set(1) {\n  &#039;\\x1B[?1049h\\x1B[1;24r\\x1B[m\\x1B(B\\x1B[4l\\x1B[?7h\\x1B[?25l\\x1B[H\\x1B[2J\\x1B[15;80H_\\x1B[15;79H_\\x1B[16d|\\x1B[9;80H_\\x1B[12;80H|\\x1B[13;80H|\\x1B[14;80H|\\x1B[15;78H__/\\x1B[16;79H|/\\x1B[17;80H\\\\\\x1B[9;\n  79H_D\\x1B[10;80H|\\x1B[11;80H/\\x1B[12;79H|\\x1B[K\\x1B[13d\\b|\\x1B[K\\x1B[14d\\b|/\\x1B[15;1H\\x1B[1P\\x1B[16;78H|/-\\x1B[17;79H\\\\_\\x1B[9;1H\\x1B[1P\\x1B[10;79H|(\\x1B[11;79H/\\x1B[K\\x1B[12d\\b\\b|\\x1B[K\\x1B[13d\\b|\n  _\\x1B[14;1H\\x1B[1P\\x1B[15;76H__/ =\\x1B[16;77H|/-=\\x1B[17;78H\\\\_/\\x1B[9;77H_D _\\x1B[10;78H|(_\\x1B[11;78H/\\x1B[K\\x1B[12d\\b\\b|\\x1B[K\\x1B[13d\\b| _\\x1B[14;77H|/ |\\x1B[15;75H__/\n  =|\\x1B[16;76H|/-=|\\x1B[17;1H\\x1B[1P\\x1B[8;80H=\\x1B[9;76H_D _|\\x1B[10;77H|(_)\\x1B[11;77H/\\x1B[K\\x1B[12d\\b\\b|\\x1B[K\\x1B[13d\\b|\n  _\\r\\x1B[14d\\x1B[1P\\x1B[15d\\x1B[1P\\x1B[16;75H|/-=|_\\x1B[17;1H\\x1B[1P\\x1B[8;79H=\\r\\x1B[9d\\x1B[1P\\x1B[10;76H|(_)-\\x1B[11;76H/\\x1B[K\\x1B[12d\\b\\b|\\x1B[K\\x1B[13d\\b| _\\r\\x1B[14d\\x1B[1P\\x1B[15;73H__/ =|\n  o\\x1B[16;74H|/-=|_\\r\\x1B[17d\\x1B[1P\\x1B[8;78H=\\r\\x1B[9d\\x1B[1P\\x1B[10;75H|(_)-\\x1B[11;75H/\\x1B[K\\x1B[12d\\b\\b|\\x1B[K\\x1B[13d\\b|\n  _\\r\\x1B[14d\\x1B[1P\\x1B[15d\\x1B[1P\\x1B[16;73H|/-=|_\\r\\x1B[17d\\x1B[1P\\x1B[8;77H=\\x1B[9;73H_D _|  |\\x1B[10;74H|(_)-\\x1B[11;74H/     |\\x1B[12;73H|      |\\x1B[13;73H| _\\x1B[14;73H|/ |   |\\x1B[15;71H__/\n  =| o |\\x1B[16;72H|/-=|___|\\x1B[17;1H\\x1B[1P\\x 1B[5;79H(@\\x1B[7;77H(\\r\\x1B[8d\\x1B[1P\\x1B[9;72H_D _|  |_\\x1B[10;1H\\x1B[1P\\x1B[11d\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;72H| _\\x1B[14;72H|/ |   |-\\x1B[15;70H__/\n  =| o |=\\x1B[16;71H|/-=|___|=\\x1B[17;1H\\x1B[1P\\x1B[8d\\x1B[1P\\x1B[9;71H_D _|  |_\\r\\x1B[10d\\x1B[1P\\x1B[11d\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;71H| _\\x1B[14;71H|/ |   |-\\x1B[15;69H__/ =| o\n  |=-\\x1B[16;70H|/-=|___|=O\\x1B[17;71H\\\\_/      \\\\\\x1B[8;1H\\x1B[1P\\x1B[9;70H_D _|  |_\\x1B[10;71H|(_)---  |\\x1B[11;71H/     |  |\\x1B[12;70H|      |  |\\x1B[13;70H| _\\x1B[80G|\\x1B[14;70H|/ |\n  |-\\x1B[15;68H__/ =| o |=-~\\x1B[16;69H|/-=|___|=\\x1B[K\\x1B[17;70H\\\\_/      \\\\O\\x1B[8;1H\\x1B[1P\\x1B[9;69H_D _|  |_\\r\\x1B[10d\\x1B[1P\\x1B[11d\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;69H| _\\x1B[79G|_\\x1B[14;69H|/ |\n  |-\\x1B[15;67H__/ =| o |=-~\\r\\x1B[16d\\x1B[1P\\x1B[17;69H\\\\_/      \\\\_\\x1B[4d\\b\\b(@@\\x1B[5;75H(    )\\x1B[7;73H(@@@)\\r\\x1B[8d\\x1B[1P\\x1B[9;68H_D _|\n  |_\\r\\x1B[10d\\x1B[1P\\x1B[11d\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;68H| _\\x1B[78G|_\\x1B[14;68H|/ |   |-\\x1B[15;66H__/ =| o |=-~~\\\\\\x1B[16;67H|/-=|___|=   O\\x1B[17;68H\\\\_/ \\\\__/\\x1B[8;1H\\x1B[1P\\x1B[9;67H_D _|\n  |_\\r\\x1B[10d\\x1B[1P\\x1B[11d\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;67H| _\\x1B[77G|_\\x1B[14;67H|/ |   |-\\x1B[15;65H__/ =| o |=-~O==\\x1B[16;66H|/-=|___|= |\\x1B[17;1H\\x1B[1P\\x1B[8d\\x1B[1P\\x1B[9;66H_D _|\n  |_\\x1B[10;67H|(_)---  |   H\\x1B[11;67H/     |  |   H\\x1B[12;66H|      |  |   H\\x1B[13;66H| _\\x1B[76G|___H\\x1B[14;66H|/ |   |-\\x1B[15;64H__/ =| o |=-O==\\x1B[16;65H|/-=|___|=\n  |\\r\\x1B[17d\\x1B[1P\\x1B[8d\\x1B[1P\\x1B[9;65H_D _|  |_\\x1B[80G/\\x1B[10;66H|(_)---  |   H\\\\\\x1B[11;1H\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;65H| _\\x1B[75G|___H_\\x1B[14;65H|/ | |-\\x1B[15;63H__/ =| o |=-~~\\\\\n  /\\x1B[16;64H|/-=|___|=O=====O\\x1B[17;65H\\\\_/      \\\\__/  \\\\\\x1B[1;4r\\x1B[4;1H\\n&#039; + &#039;\\x1B[1;24r\\x1B[4;74H(    )\\x1B[5;71H(@@@@)\\x1B[K\\x1B[7;69H(   )\\x1B[K\\x1B[8;68H====\n  \\x1B[80G_\\x1B[9;1H\\x1B[1P\\x1B[10;65H|(_)---  |   H\\\\_\\x1B[11;1H\\x1B[1P\\x1B[12d\\x1B[1P\\x1B[13;64H| _\\x1B[74G|___H_\\x1B[14;64H|/ |   |-\\x1B[15;62H__/ =| o |=-~~\\\\  /~\\x1B[16;63H|/-=|___|=\n  ||\\x1B[K\\x1B[17;64H\\\\_/      \\\\O=====O\\x1B[8;67H==== \\x1B[79G_\\r\\x1B[9d\\x1B[1P\\x1B[10;64H|(_)---  |   H\\\\_\\x1B[11;64H/     |  |   H  |\\x1B[12;63H|      |  |   H  |\\x1B[13;63H|\n  _\\x1B[73G|___H__/\\x1B[14;63H|/ |   |-\\x1B[15;61H__/ =| o |=-~~\\\\  /~\\r\\x1B[16d\\x1B[1P\\x1B[17;63H\\\\_/      \\\\_\\x1B[8;66H==== \\x1B[78G_\\r\\x1B[9d\\x1B[1P\\x1B[10;63H|(_)---  |\n  H\\\\_\\r\\x1B[11d\\x1B[1P\\x1B[12;62H|      |  |   H  |_\\x1B[13;62H| _\\x1B[72G|___H__/_\\x1B[14;62H|/ |   |-\\x1B[15;60H__/ =| o |=-~~\\\\  /~~\\\\\\x1B[16;61H|/-=|___|=   O=====O\\x1B[17;62H\\\\_/      \\\\__/\n  \\\\__/\\x1B[8;65H==== \\x1B[77G_\\r\\x1B[9d\\x1B[1P\\x1B[10;62H|(_)---  |   H\\\\_\\r\\x1B[11d\\x1B[1P\\x1B[12;61H|      |  |   H  |_\\x1B[13;61H| _\\x1B[71G|___H__/_\\x1B[14;61H|/ |   |-\\x1B[80GI\\x1B[15;59H__/ =|\n  o |=-~O=====O==\\x1B[16;60H|/-=|___|=    ||    |\\x1B[17;1H\\x1B[1P\\x1B[2;79H(@\\x1B[3;74H(   )\\x1B[K\\x1B[4;70H(@@@@)\\x1B[K\\x1B[5;67H(    )\\x1B[K\\x1B[7;65H(@@@)\\x1B[K\\x1B[8;64H====\n  \\x1B[76G_\\r\\x1B[9d\\x1B[1P\\x1B[10;61H|(_)---  |   H\\\\_\\x1B[11;61H/     |  |   H  |  |\\x1B[12;60H|      |  |   H  |__-\\x1B[13;60H| _\\x1B[70G|___H__/__|\\x1B[14;60H|/ |   |-\\x1B[79GI_\\x1B[15;58H__/ =| o\n  |=-O=====O==\\x1B[16;59H|/-=|___|=    ||    |\\r\\x1B[17d\\x1B[1P\\x1B[8;63H==== \\x1B[75G_\\r\\x1B[9d\\x1B[1P\\x1B[10;60H|(_)---  |   H\\\\_\\r\\x1B[11d\\x1B[1P\\x1B[12;59H|      |  |   H  |__-\\x1B[13;59H|\n  _\\x1B[69G|___H__/__|_\\x1B[14;59H|/ |   |-\\x1B[78GI_\\x1B[15;57H__/ =| o |=-~~\\\\  /~~\\\\  /\\x1B[16;58H|/-=|___|=O=====O=====O\\x1B[17;59H\\\\_/      \\\\__/  \\\\__/  \\\\\\x1B[8;62H====\n  \\x1B[74G_\\r\\x1B[9d\\x1B[1P\\x1B[10;59H|(_)---  |   H\\\\_\\r\\x1B  |  |   H  |__-\\x1B[13;58H| _\\x1B[68G|___H__/__|_\\x1B[14;58H|/ |   |-\\x1B[77GI_\\x1B[15;56H__/ =| o |=-~~\\\\ /~~\\\\  /~\\x1B[16;57H|/-=|___|=\n  ||    ||\\x1B[K\\x1B[17;58H\\\\_/      \\\\O=====O=====O\\x1B[8;61H==== \\x1B[73G_\\r\\x1B[9d\\x1B[1P\\x1B[10;58H|(_)---    _\\x1B[67G|___H__/__|_\\x1B[14;57H|/ |   |-\\x1B[76GI_\\x1B[15;55H__/ =| o |=-~~\\\\  /~~\\\\\n  /~\\r\\x1B[16d\\x1B[1P\\x1B[17;57H\\\\_/      \\\\_\\x1B[2;75H(  ) (\\x1B[3;70H(@@@)\\x1B[K\\x1B[4;66H()\\x1B[K\\x1B[5;63H(@@@@)\\x1B[</pre></code>\n            \n    <div class=\"flex anchor relative\">\n      <h2 id=\"acknowledgements\">Acknowledgements</h2>\n      <a href=\"#acknowledgements\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n      </a>\n    </div>\n    <p>Thank you to my colleagues Mengnan Gong and Shuhao Zhang, whose ideas and perspectives helped narrow down the root causes of this mystery.</p><p>If you enjoy troubleshooting weird and tricky production issues, <a href=\"https://www.cloudflare.com/en-gb/careers/jobs/?department=Engineering\"><i><u>our engineering teams are hiring</u></i></a><i>.</i></p>",
		"id": "4X0QnKvMC0yi0eRv5YqC7g",
		"localeList": {
			"name": "blog-english-only",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": "Yarn tests fail consistently at the 27-second mark. The usual suspects are swiftly eliminated to no avail. A deep dive is taken to comb through traces, only to be derailed into an unexpected crash investigation.",
		"metadata": {
			"title": "A steam locomotive from 1993 broke my yarn test",
			"description": "Yarn tests fail consistently at the 27-second mark. The usual suspects are swiftly eliminated to no avail. A deep dive is taken to comb through traces, only to be derailed into an unexpected crash investigation.",
			"imgPreview": "https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4y36mkMs8GlYflk6MMmLnh/42840cf34748ac9b6619c5d47704db10/A_steam_locomotive_from_1993_broke_my_yarn_test-OG.png"
		},
		"primary_author": {},
		"publicly_index": true,
		"published_at": "2025-04-02T14:00+01:00",
		"slug": "yarn-test-suffers-strange-derailment",
		"tags": [
			{
				"id": "2UVIYusJwlvsmPYl2AvSuR",
				"name": "Deep Dive",
				"slug": "deep-dive"
			},
			{
				"id": "383iv0UQ6Lp0GZwOAxGq2p",
				"name": "Linux",
				"slug": "linux"
			},
			{
				"id": "3JAY3z7p7An94s6ScuSQPf",
				"name": "Developer Platform",
				"slug": "developer-platform"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			}
		],
		"title": "A steam locomotive from 1993 broke my yarn test",
		"updated_at": "2025-04-02T13:00:03.425Z",
		"url": "https://blog.cloudflare.com/yarn-test-suffers-strange-derailment"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.icon_aria_label": "Search",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"search.result_stat_empty": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong>",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"search.autocomplete_title": "Insert a query. Press enter to send",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}