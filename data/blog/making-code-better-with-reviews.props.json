{
	"initialReadingTime": "2",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "John Graham-Cumming",
				"slug": "john-graham-cumming",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/5vGNsXzZrtSLn2X30pnpUY/a43660c54db33a4289ab5a7d99d3d414/john-graham-cumming.jpg",
				"location": "Lisbon, Portugal",
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "In the past we've written about how CloudFlare isn't afraid to rip out and replace chunks of code that have proved to be hard to maintain or have simply reach end of life. ",
		"feature_image": "https:undefined",
		"featured": false,
		"html": "<p>In the past we&#39;ve written about how CloudFlare isn&#39;t afraid to rip out and replace chunks of code that have proved to be hard to maintain or have simply reach end of life. For example, we wrote a brand new <a href=\"/what-weve-been-doing-with-go\">DNS server</a> and replaced our old DNS infrastructure with it. Doing so was greatly helped by two things: a large test suite (that keeps growing) and code reviews.</p><p>Recently, I was working on that same DNS server when I needed to understand and change the following code:</p><p>if raw[2]&amp;0x86 != 0 || raw[3]&amp;0x4f != 0 {\nreturn false\n}</p><p><code>raw</code> is a <code>[]byte</code> containing a DNS packet and this code is part of a filter that throws away packets that contain invalid flags. In this case the code is throwing away query packets that contain flags that are only used in responses.</p><p>It took me a while to grok which flags <code>0x86</code> and <code>0x4f</code> were masking and having understood them I decided to update the code with the following comment:</p><p>// DNS Header looks like this:\n//\n//                                 1  1  1  1  1  1\n//   0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n// |                     ID                        |\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n// |QR|   OPCODE  |AA|TC|RD|RA| Z|AD|CD|   RCODE   |\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n//\n// So ID is in raw[0:1], raw[2] contains QR, OPCODE, AA TC and RD. raw[3]\n// contains RA, Z, AD, CD and RCODE.\n//\n// 0x86 in raw[2] corresponds to masking on the QR, AA and TC\n// 0x4f in raw[3] corresponds to masking on the Z and RCODE</p><p>if raw[2]&amp;0x86 != 0 || raw[3]&amp;0x4f != 0 {\nreturn false\n}</p><p>I figured that I&#39;d save the next person time in dissecting those values since the actual time consuming item was figuring out what they meant; writing a comment dumping my current memory state was quick. And it meant leaving code in better shape than when I first looked at it.</p><p>I sent that code (and bunch of other change) off for review and my colleague <a href=\"https://idea.popcount.org/\">Marek</a> came back with:</p><p>&gt; 0x86 in raw[2] corresponds to masking on the QR, AA and TC</p><p>Nah, how about making it: flags := raw[2] &lt;&lt;8 | raw[3]\nand then checking it against or-ed flags, like (flags &amp; (0x1 | 0x2 | 0x4 ....)\nand letting the compiler to come up with magic 0x86 :)</p><p>That made sense to me and I changed the code to:</p><p>// DNS Header looks like this:\n//\n//                                 1  1  1  1  1  1\n//   0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n// |                     ID                        |\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n// |QR|   OPCODE  |AA|TC|RD|RA| Z|AD|CD|   RCODE   |\n// +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n//\n// So ID is in raw[0:1], raw[2] contains QR, OPCODE, AA TC and RD. raw[3]\n// contains RA, Z, AD, CD and RCODE.</p><p>const QR byte = 0x80const AA byte = 0x04const TC byte = 0x02</p><p>const Z byte = 0x40const RCODE byte = 0x0f</p><p>if raw[2]&amp;(QR|AA|TC) != 0 || raw[3]&amp;(Z|RCODE) != 0 {return false}</p><p>That&#39;s much clearer and requires no thinking on the part of the next person who reads or maintains the code. Along the way Marek had also pointed me to some information about the AD and CD bits which meant that I&#39;d improved the code and learnt something new.</p><p>At that point the Approve button was hit on the pull request and the code was available to be merged into the mainline. All our code goes through this type of process to improve its quality and security, and it&#39;s an essential part of our <a href=\"/cloudflare-is-pci-certified\">PCI certification</a>. Our SRE team follows a similar process for configuration changes.</p><p>Even this blog post got peer review.</p><p>If you&#39;re interested in working on CloudFlare-scale code, and making things better in any of the languages we work with Lua, Go, C, PHP, Python, JavaScript, ... then we&#39;re <a href=\"https://www.cloudflare.com/join-our-team\">hiring in London and San Francisco</a>.</p>",
		"id": "2E3BwuiLuBsa143aZb94gz",
		"localeList": {
			"name": "Making code better with reviews Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2014-07-02T01:14:00.000+01:00",
		"slug": "making-code-better-with-reviews",
		"tags": [
			{
				"id": "6lhzEBz2B56RKa4nUEAGYJ",
				"name": "Programming",
				"slug": "programming"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "5fZHv2k9HnJ7phOPmYexHw",
				"name": "DNS",
				"slug": "dns"
			},
			{
				"id": "6QVJOBzgKXUO9xAPEpqxvK",
				"name": "Reliability",
				"slug": "reliability"
			}
		],
		"title": "Making code better with reviews",
		"updated_at": "2024-08-27T02:42:25.548Z",
		"url": "https://blog.cloudflare.com/making-code-better-with-reviews"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}