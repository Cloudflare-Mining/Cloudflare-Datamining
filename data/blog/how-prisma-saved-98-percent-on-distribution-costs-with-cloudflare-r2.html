<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/IuHdtPrHS6VVomwYLYA9Z/1487a95fc08d5307ca25e47a897da29d/Prisma-Partnership-1.png" alt="How Prisma saved 98% on distribution costs with Cloudflare R2" class="kg-image" width="2400" height="1350" loading="lazy">

	</figure>
	<p><i>The following is a guest post written by Pierre-Antoine Mills, Miguel Fernández, and Petra Donka of Prisma. Prisma provides a server-side library that helps developers read and write data to the database in an intuitive, efficient and safe way.</i></p>
	<p>Prisma’s mission is to redefine how developers build data-driven applications. At its core, Prisma provides an open-source, next-generation TypeScript Object-Relational Mapping (ORM) library that unlocks a new level of developer experience thanks to its intuitive data model, migrations, type-safety, and auto-completion.</p>
	<p>Prisma ORM has experienced remarkable growth, engaging a vibrant community of developers. And while it was a great problem to have, this growth was causing an explosion in our AWS infrastructure costs. After investigating a wide range of alternatives, we went with Cloudflare’s <a href="https://www.cloudflare.com/developer-platform/r2">R2 storage</a> — and as a result are thrilled that our engine distribution costs have decreased by <i>98%,</i> while delivering top-notch performance.</p>
	<p>It was a natural fit: Prisma is already a proud <a href="https://www.cloudflare.com/partners/technology-partners/prisma">technology partner of Cloudflare’s</a>, offering deep database integration with Cloudflare Workers. And Cloudflare products provide much of the underlying infrastructure for <a href="https://www.prisma.io/accelerate">Prisma Accelerate</a> and <a href="http://prisma.io/pulse">Prisma Pulse</a>, empowering user-focused product development. In this post, we’ll dig into how we decided to extend our ongoing collaboration with Cloudflare to the Prisma ORM, and how we migrated from AWS S3 + CloudFront to Cloudflare R2, with zero downtime.</p>
	<h2>Distributing the Prisma ORM and its engines</h2>
	<p>Prisma ORM simplifies data access thanks to its type-safe <a href="https://www.prisma.io/docs/concepts/components/prisma-client">Prisma Client</a>, and enables efficient database management via the <a href="https://www.prisma.io/docs/concepts/components/prisma-cli">Prisma CLI</a>, so that developers can focus on product development.</p>
	<p>Both the Prisma Client and the Prisma CLI rely on the <a href="https://www.prisma.io/docs/concepts/components/prisma-engines#prisma-engines">Prisma Engines</a>, which are implemented in Rust and distributed as platform-specific compiled binaries. The Prisma Engines perform a variety of tasks ranging from providing information about the schema for type generation, or migrating the database, to transforming Prisma queries into SQL, and executing those queries against the database. Think of the engines as the layer in the Prisma ORM that talks to the database.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/75H4s6HbCbgdXyq8Am9t4z/3b8efa137c0d9075f799534d1d6a3849/1-.png" alt="" class="kg-image" width="1600" height="806" loading="lazy">

	</figure>
	<p>As a developer, one of the first steps to <a href="https://www.prisma.io/docs/getting-started/quickstart">get started</a> with Prisma is to install <a href="https://www.prisma.io/docs/concepts/components/prisma-client">Prisma Client</a> and the <a href="https://www.prisma.io/docs/concepts/components/prisma-cli">Prisma CLI</a> from npm. Once installed, these packages need the Prisma Engines to be able to function. These engines have complex target-platform rules and were originally envisioned to be distributed separately from the npm package, so they can be used outside of the Node.js ecosystem. As a result, they are downloaded on demand by the Prisma CLI, only downloading what is strictly required for a given project.</p>
	<p>As of mid-2023, the engines account for <b>100 million downloads a month and 250 terabytes of egress data transfer</b>, with a continuous month-over-month increase as our user base grows. This highlights the importance of a highly available, global, and scalable infrastructure that provides low latency engine downloads to Prisma users all around the world.</p>
	<h2>Our original solution: AWS S3 &amp; CloudFront</h2>
	<p>During the early development of the Prisma ORM, our engineering team looked for tools to build the CDN for engine distribution. With extensive AWS experience, we went with the obvious: S3 blob storage for the engine files and CloudFront to cache contents closer to the user.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/7b5cB00Ar3wfYEfe00TcEQ/1ddb2f2b42da05464331e6c0bb7e5dd8/2-.png" alt="" class="kg-image" width="1600" height="806" loading="lazy">

	</figure>
	<p><i>A simplified representation of how the Prisma Engines flow from our CI where they are built and uploaded, to the Prisma CLI downloading the correct engine for a given environment when installing Prisma, all the way to the user being able to use it.</i></p>
	<p>We were happy with AWS for the most part, and it was able to scale with our demands. However, as our user base continued to grow, so did the costs. At our scale of traffic, data transfer became a considerable cost item that we knew would only continue to grow.</p>
	<p>The continuously increasing cost of these services prompted us to explore alternative options that could better accommodate our needs while at least maintaining the same level of performance and reliability. Prisma is committed to providing the best products and solutions to our users, and an essential part of that commitment is being intentional about the allocation of our resources, including sensible spending to enable us to serve our growing user base in the best way possible.</p>
	<h2>Exploring distribution options</h2>
	<p>We extensively explored different technologies and services that provided both reliable and fast engine distribution, while being cost-effective.</p>
	<h3>Free solutions: GitHub &amp; npm</h3>
	<p>Because Prisma ORM is an open-source solution, we have explored various ways to distribute the engines through our existing distribution channels, at no cost. In this area, we had both GitHub Releases and npm as candidates to host and distribute our engine files. We dismissed GitHub Releases early on as the quality of service was not guaranteed, which was a requirement for us towards our users, so we can be sure to provide a good developer experience under all circumstances.</p>
	<p>We also looked at npm, and confirmed that hosting the engine files would be in agreement with their Terms of Service. This made npm a viable option, but also meant we would have to change our engine download and upload logic to accommodate a different system. Additionally, this implied that we would have to update many past Prisma CLI versions, requiring our users to upgrade to take advantage of the new solution.</p>
	<h3>Paid solutions: CDNs &amp; Cloudflare</h3>
	<p>We then considered only <a href="https://www.cloudflare.com/cloudflare-vs-cloudfront">replacing CloudFront</a>, which accounted for 97% of our distribution costs, while retaining S3 as the origin. When we evaluated different CDNs, we found that alternatives could lead to an estimated 70% cost reduction.</p>
	<p>We also explored Cloudflare’s offerings and were impressed by <a href="https://www.cloudflare.com/developer-platform/r2"><b>Cloudflare R2</b></a>, an alternative to AWS S3 + CloudFront. It offers robust blob storage compatible with S3 and leverages Cloudflare’s network for global low-latency distribution. Additionally, it has no egress costs, and is solely priced based on the total volume of data stored and operations on that data. Given our reliance on Cloudflare’s <a href="https://www.cloudflare.com/cloudflare-product-portfolio"><b>product portfolio</b></a> for our <a href="https://console.prisma.io"><b>Data Platform</b></a>, and extensive experience with their Workers platform, we already had high trust in the quality of Cloudflare’s products.</p>
	<p>To finalize our decision, we implemented a test to confirm our intuitions about Cloudflare’s quality of service. We deployed a script to 50 cities across the globe, representative of our incoming traffic, to measure download latencies for our engine files (~15MB). The test was run multiple times, with latencies for the different <a href="https://developers.cloudflare.com/cache/concepts/default-cache-behavior/#cloudflare-cache-responses">cache statuses</a> recorded and compared against our previous AWS-based solution. The results confirmed that Cloudflare R2's reliability and performance were at least on par with AWS S3 + CloudFront. And because R2 is compatible with S3, we wouldn’t need to make substantial changes to our software in order to move over to Cloudflare. These were great results, and we couldn’t wait to switch!</p>
	<h2>Our solution: moving to Cloudflare’s R2</h2>
	<p>In order to move our engine file distribution to Cloudflare, we needed to ensure we could make the switch without any disruption or impact to our users.</p>
	<p>While R2 URLs match S3's format, Prisma CLI uses a fixed domain to point to the engine file distribution. This fixed domain enabled us to transition without making any changes to the code of older Prisma versions, and simply point the existing URLs to R2. However, to make the transition, we needed to change our DNS configuration to point to Cloudflare. While this seems trivial, potential issues like unexpected DNS propagation challenges, or certificate validation problems when connecting via TLS, required us to plan ahead in order to proceed confidently and safely.</p>
	<p>We modified the Prisma ORM release pipeline to upload assets to both S3 and R2, and used the <a href="https://blog.cloudflare.com/r2-super-slurper-ga">R2 Super Slurper</a> for migrating past engine versions to R2. This ensured all Prisma releases, past and future, existed in both places. We also established Grafana monitoring checks to pull engine files from R2, using a DNS and TLS configuration similar to our desired production setup, but via an experimental domain. Those monitoring checks were later reused during the final traffic cutover to ensure that there was no service disruption.</p>
	<p>As ensuring no impact or disruption to our users was of utmost importance, we proceeded with a gradual rollout of the DNS changes using DNS load balancing, a method where a group of alias records assigned to a domain are weighted differently. This meant that the DNS resolver directed more traffic to heavier-weighted records. We began with a load balancing configuration simulating our old setup, with one record (the <i>control</i>) pointing to AWS CloudFront, and the other (the <i>candidate</i>) pointing to R2. Initially, all weight was on the <i>control</i>, effectively preserving the old routing to CloudFront. We also set the lowest TTL possible, so changes in the record weights took effect as soon as possible, creating more control over DNS propagation. Additionally, we implemented a health check that would redirect all traffic to the <i>control</i> if download latencies were significantly higher, or if errors were detected, ensuring a stable fallback.</p>
	<p>At this point, everything was in place and we could start the rollout.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2O4inKFtr4vG45Z9I85MhS/e10b15ed4f160b3472a8d55bf08cf7f0/3-.png" alt="" class="kg-image" width="1600" height="607" loading="lazy">

	</figure>
	<p><b>Our DNS load balancing setup during the rollout. We assigned increasing weights to route traffic to Cloudflare R2. The health check that would fail over to AWS CloudFront never fired.</b></p>
	<p>The rollout began with a gradual increase in R2's DNS weight, and our monitoring dashboards showed that Cloudflare downloads were proportional to the weight assigned to R2. With as little as 5% traffic routed to Cloudflare, cache hit ratios neared 100%, as expected. Latencies matched the <i>control</i>, so the health checks were all good, and our fallback never activated. Over the duration of an hour, we gradually increased R2's DNS weight to manage 25%, 50%, and finally 100% of traffic, without any issues. The cutover could not have gone any smoother.</p>
	<p>After monitoring for an additional two days, we simplified the DNS topology and routed to Cloudflare exclusively. We were extremely satisfied with the change, and started seeing our infrastructure costs drop considerably, as expected, not to mention the zero downtime and zero reported issues from users.</p>
	<h2>A success</h2>
	<p>Transitioning to Cloudflare R2 was easy thanks to their great product and tooling, intuitive platform and supportive team. We've had an excellent experience with their service, with consistently great uptime, performance and latency. Cloudflare proved once again to be a valuable partner to help us scale.</p>
	<p>We are thrilled that our engine distribution costs have decreased by 98%. Cloudflare's cost-effective solution has not only delivered top-notch performance but has also brought significant savings to our operations. An all around success!</p>
	<p>To learn more about how Prisma is building <a href="https://datadx.io">Data DX</a> solutions with Cloudflare, take a look at <a href="https://www.prisma.io/blog/cloudflare-partnership-qerefgvwirjq"><b>Developer Experience Redefined: Prisma &amp; Cloudflare Lead the Way to Data DX</b></a>.</p>
	<p>And if you want to see Prisma in action, get started with the <a href="https://www.prisma.io/docs/getting-started/quickstart">Quickstart guide</a>.</p>
</div>