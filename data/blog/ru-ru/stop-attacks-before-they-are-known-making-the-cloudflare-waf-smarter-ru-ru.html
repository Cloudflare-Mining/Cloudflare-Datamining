<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image5-2.png" class="kg-image" alt="Stop attacks before they are known: making the Cloudflare WAF smarter" loading="lazy"></figure>
	<p><a href="https://www.cloudflare.com/waf" target="_blank">Cloudflare WAF</a> помогает владельцам сайтов защищать свои приложения от злоумышленников. Это реализуется WAF с помощью <a href="https://developers.cloudflare.com/waf/managed-rulesets/reference/cloudflare-managed-ruleset" target="_blank">управляемых правил Cloudflare</a> — составленных вручную узкоспециализированных правил, которые обнаруживают и блокируют вредоносные коды. Но с ними связана проблема: если правило не написано специально для конкретной атаки, то оно не позволит ее обнаружить.</p>
	<p>Сегодня мы решаем эту проблему за счет расширения интеллектуального потенциала WAF и анонсируя общую доступность нашей системы оценки атак на основе WAF.</p>
	<p>Клиентам, использующим наши пакеты Enterprise Core и Advanced Security, будет предоставляться постепенный доступ к этой новой функции. Все остальные клиенты Enterprise получат доступ в ближайшие месяцы.</p>
	<p>Наша система оценки атак WAF, полностью дополняющая наши управляемые правила Cloudflare, классифицирует все запросы с использованием модели, обученной на наблюдаемых истинно-положительных результатах в сети Cloudflare, что позволяет обнаруживать (и блокировать) уклонение, обход проверки и новые методы атак до того, как они станут общеизвестными.</p>
	<h2 id="-waf-">Проблема с WAF на основе сигнатур</h2>
	<p>Злоумышленники, пытающиеся проникнуть в веб-приложения, часто используют известные или недавно раскрытые коды. Cloudflare WAF был создан для максимально эффективной борьбы с этими атаками. Управляемый набор правил Cloudflare и управляемый набор правил Cloudflare <a href="https://en.wikipedia.org/wiki/OWASP" target="_blank">OWASP</a> в действительности постоянно обновляются и направлены на защиту веб-приложений от известных угроз при сведении к минимуму ложных срабатываний.</p>
	<p>Ситуацию усложняют атаки, которые не являются широко известными. Часто их называют <a href="https://en.wikipedia.org/wiki/Zero-day_(computing)" target="_blank">уязвимости нулевого дня</a>. Несмотря на то, что наши команды делают все возможное, чтобы исследовать новые векторы угроз и обновлять управляемые правила Cloudflare, ограничивающим фактором здесь является производительность человека. Каждый раз, когда обнаруживается новый вектор, у злоумышленников появляется возможность обойти меры по нейтрализации атаки.</p>
	<p>Одним из хорошо известных примеров стала <a href="https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation">атака Log4j RCE</a>, когда нам пришлось часто обновлять правила в рамках развертывания частых обновлений правил по мере обнаружения новых обходов проверок путем изменения известных <a href="https://blog.cloudflare.com/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">типов атак</a>.</p>
	<h2 id="-">Решение: дополнить сигнатуры моделью оценки на основе машинного обучения</h2>
	<p>Наша система оценки атак WAF — это усовершенствование WAF от Cloudflare, основанное на машинном обучении. Система оценивает каждый запрос с точки зрения вероятности того, что он является вредоносным. Затем вы можете использовать эту оценку при реализации пользовательских правил WAF, чтобы обеспечить безопасность вашего приложения наряду с существующими управляемыми правилами Cloudflare.</p>
	<h3 id="-waf-cloudflare">Как мы используем машинное обучение в WAF Cloudflare?</h3>
	<p>В любой задаче по классификации качество обучающей выборки непосредственно связано с качеством результатов классификации, поэтому были приложены значительные усилия к подготовке набора данных для обучения.</p>
	<p>И именно здесь мы использовали сверхмощность Cloudflare: мы воспользовались возможностями мониторинга сети Cloudflare, собрав миллионы истинно-положительных образцов, сгенерированных нашим существующим WAF на основе сигнатур, и дополнительно улучшили его, используя методы, описанные в разделе «<a href="https://blog.cloudflare.com/data-generation-and-sampling-strategies">Повышение точности нашего WAF на основе машинного обучения</a>».</p>
	<p>Это позволило нам обучить модель, которая способна классифицировать c учетом HTTP-запроса вероятность того, что запрос содержит вредоносный код, но, что еще более важно, классифицировать, когда запрос очень похож на известный истинно-положительный, но при этом в достаточной степени отличается, чтобы избежать совпадения с управляемым правилом.</p>
	<p>Модель встраивается в поток HTTP-трафика и на сегодняшний день оптимизирована для трех категорий атак: SQL-инъекция (SQLi), межсайтовый скриптинг (XSS) и широкий спектр атак на основе удаленного выполнения кода (RCE), таких как внедрение оболочки, PHP-инъекции, компрометации типа Apache Struts, Apache log4j и аналогичные атаки, которые приводят к удаленному выполнению кода. В будущем мы планируем добавить дополнительные типы атак.</p>
	<p>Выводимые оценки аналогичны оценкам <a href="https://blog.cloudflare.com/introducing-bot-analytics">управления ботами</a>; они варьируются от 1 до 99, где низкие баллы указывают на вредоносный или вероятно вредоносный, а высокие баллы указывают на чистый или вероятный чистый HTTP-запрос.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image4-5.png" class="kg-image" alt="Scale showing distribution of the WAF Attack Score between 1 and 99" loading="lazy"></figure>
	<h3 id="--1">Доказательство непосредственной ценности</h3>
	<p>Одним из примеров эффективности этой новой системы является то, что 13 октября 2022 г. атака <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-42889" target="_blank">CVE-2022-42889</a> была определена как "критическая серьезность” в <a href="https://github.com/apache/commons-text" target="_blank">Apache Commons Text</a>, затрагивающая версии с 1.5 по 1.9.</p>
	<p>Вредоносный код, использованный в атаке, хотя и не был немедленно заблокирован нашими управляемыми правилами Cloudflare, но был правильно идентифицирован (получив очень низкую оценку) нашей системой оценки атак. Это позволило нам защитить конечные точки и идентифицировать атаку с нулевым временем развертывания. Разумеется, мы также по-прежнему обновляли управляемые правила Cloudflare, чтобы охватить новый вектор атаки, поскольку это позволяет нам улучшать наши обучающие данные, дополнительно завершая наш цикл обратной связи.</p>
	<h2 id="-security-analytics">Узнайте то, чего вы не знаете, с помощью новой системы аналитики безопасности — Security Analytics</h2>
	<p>В дополнение к системе оценки атак у нас есть еще одно важное объявление: наша новая система аналитики безопасности — Security Analytics! Вы можете прочитать больше об этом в <a href="https://blog.cloudflare.com/security-analytics">официальном объявлении</a>.</p>
	<p>Используя новую систему аналитики безопасности, вы можете просматривать распределение оценок атак независимо от того, были ли запросы заблокированы или нет, что позволяет вам исследовать потенциально вредоносные атаки до развертывания каких-либо правил.</p>
	<p>В представлении будет отображаться не только WAF Attack Score, но и управление ботами и сканирование содержимого с возможностью комбинировать и сочетать фильтры по своему усмотрению.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image1-10.png" class="kg-image" alt="Snapshot from the dashboard showing the Analytics default view" loading="lazy"></figure>
	<h2 id="-waf-attack-score-security-analytics">Как использовать WAF Attack Score и Security Analytics</h2>
	<p>Давайте отправимся в путь, чтобы выявить атаки с помощью новой системы Security Analytics, а затем использовать оценки атак WAF для их нейтрализации.</p>
	<h3 id="-security-analytics-1">Начало работы с Security Analytics</h3>
	<p>Этот новый вид позволяет отобразить все детали вашего трафика в одном месте. В вашем распоряжении десятки фильтров, которые можно комбинировать и сопоставлять, лучшие статистические данные, несколько распределений интерактивных графиков, а также образцы журналов для проверки ваших идей. По сути, это дает вам возможность предварительно просматривать ряд фильтров без необходимости предварительно создавать настраиваемые правила WAF.</p>
	<p><strong>Шаг 1</strong> — доступ к новой Security Analytics. Чтобы получить доступ к новой Security Analytics на панели управления, перейдите на вкладку “Security” (<strong>Security &gt; Analytics</strong>) (Безопасность &gt; Аналитика). Предыдущая вкладка (<strong>Security &gt; Overview</strong>) (Безопасность &gt; Обзор) по-прежнему существует в разделе (<strong>Security &gt; Events</strong>) (Безопасность &gt; Аналитика). Вы должны иметь доступ как минимум к WAF Attack Score, чтобы иметь возможность увидеть новую Security Analytics на данный момент.</p>
	<p><strong>Шаг 2</strong> — изучение аналитических данных. На новой странице аналитики вы увидите распределение всего вашего трафика по времени, а также множество фильтров справа, показывающих распределение по нескольким функциям, включая WAF Attack Score и оценку управления ботами. Чтобы максимально упростить применение интересных фильтров, мы добавили раздел “Аналитика”.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image7.png" class="kg-image" alt="Graph displayed in the dashboard showing HTTP requests distribution" loading="lazy"></figure>
	<p>Выбрав параметр "Attack Analysis" (Анализ атак), вы увидите сводную диаграмму, показывающую, как выглядит ваш трафик с точки зрения WAF Attack Score.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image6.png" class="kg-image" alt="Snapshot from the dashboard showing Attack analysis stacked chart distribution" loading="lazy"></figure>
	<p><strong>Шаг 3</strong> — фильтрация вредоносного трафика. Можно начать с поиска не нейтрализованных HTTP-запросов, классифицированных как атаки. Вы можете сделать это, используя ползунки оценки атаки с правой стороны или выбрав любой из фильтров информации, которые легко использовать в один щелчок мыши. Все графики будут обновляться автоматически в соответствии с выбранными фильтрами.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image8.png" class="kg-image" alt="Snapshot shows insights usage to propagate multiple filters at once" loading="lazy"></figure>
	<p><strong>Шаг 4</strong> — проверка вредоносного трафика. Это можно выполнить, развернув выбранные журналы под графиком распределения трафика. Например, в приведенном ниже расширенном журнале вы можете увидеть очень низкий показатель RCE, указывающий на “Атаку”, наряду с оценкой бота, указывающей на то, что запрос был “Вероятно автоматизирован”. Ознакомившись с полем “Путь”, мы можем подтвердить, что это действительно вредоносный запрос. Обратите внимание, что не все поля в данный момент регистрируются / отображаются. Например, запрос может получить низкую оценку из-за вредоносного кода в теле HTTP, которое сегодня непросто проверить в журналах выборки.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image3-2.png" class="kg-image" alt="Expanded log of an attack from the new analytics view" loading="lazy"></figure>
	<p><strong>Шаг 5</strong> — создание правила для нейтрализации вредоносного трафика. Как только вы убедитесь, что ваш фильтр не соответствует ложным срабатываниям, одним нажатием кнопки “Create custom rule” (Создать пользовательское правило) вы будете перенаправлены в конструктор пользовательских правил WAF со всеми вашими фильтрами, предварительно заполненными и готовыми к развертыванию (“Deploy”).</p>
	<h3 id="--2">Оценки атак в журналах событий безопасности</h3>
	<p>Оценки атак WAF также доступны в <a href="https://developers.cloudflare.com/logs/reference/log-fields/zone/http_requests" target="_blank">журналах HTTP</a> и при переходе к пункту Security &gt; Events [Безопасность &gt; События]) при развертывании любого из образцов журнала событий:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image2-7.png" class="kg-image" alt="Expanded log in the security events tab highlighting WAF attack scores" loading="lazy"></figure>
	<p>Обратите внимание, что все новые поля доступны в Пользовательских правилах WAF и Правилах ограничения числа запросов WAF. Они задокументированы в наших <a href="https://developers.cloudflare.com/waf/about/waf-ml" target="_blank">документах</a> для разработчиков: <code>cf.waf.score</code>, <code>cf.waf.score.xss</code>, <code>cf.waf.score.sqli</code>, и <code>cf.waf.score.rce</code>.</p>
	<p>Хотя проще всего использовать эти поля, начав с нашей новой информационной панели Security Analytics, как описано выше, вы можете использовать их «как есть» при создании правил и, разумеется, в комбинации с любым другим доступным полем. В следующем примере развертывается правило действия «Журнал» для любого запроса с агрегированной оценкой WAF Attack Score (<code>cf.waf.score</code>) менее 40.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/12/image9.png" class="kg-image" alt="Dashboard view of a custom rule with action log for WAF Attack Score less than 40" loading="lazy"></figure>
	<h2 id="--3">Что дальше?</h2>
	<p>Это всего лишь один из многих шагов на пути к тому, чтобы сделать наш Cloudflare WAF подлинно «интеллектуальным». Помимо развертывания этой новой технологии для большего числа клиентов, мы уже работаем над обеспечением еще более высокой прозрачности и охватом дополнительных векторов атак. Чтобы узнать больше об этом и многом другом, следите за обновлениями!</p>
</div>