{
	"initialReadingTime": "2",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Matthew C",
				"slug": "matthew-c",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/4YQ3dgBlqWk4mD0Je5IvhU/afd8b8ab5bee82ac59d971192264f906/matthew-c.jpg",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "It's well known that we're heavy users of the Go programming language at CloudFlare. Our work often involves delving into the standard library source code to understand internal code paths, error handling and performance characteristics.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/7ceeKMriHJbSSjjpDd2UMk/bc8a056fd720bfb88d051b826f9fad5d/whats-inside-net-http-socket-late-binding-in-the-go-standard-library.jpg",
		"featured": false,
		"html": "<p>It&#39;s well known that we&#39;re heavy users of the Go programming language at CloudFlare. Our work often involves delving into the standard library source code to understand internal code paths, error handling and performance characteristics.</p><p>Recently, I looked at how the standard library&#39;s built-in HTTP client handles connections to remote servers in order to provide minimal roundtrip latency.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/Bjh7RemFgAymGt06VoKi6/0594bf7c360ba885ef4733fc725627b3/11940908695_cea0865524_o-1.jpg\" alt=\"Athletics track\" class=\"kg-image\" width=\"1024\" height=\"708\" loading=\"lazy\"/>\n            \n            </figure><p><a href=\"https://creativecommons.org/licenses/by/2.0/\">CC By 2.0</a> <a href=\"https://www.flickr.com/photos/deanhochman/11940908695/\">Image</a> by <a href=\"https://www.flickr.com/photos/deanhochman/\">Dean Hochman</a></p><h3>Connection pooling</h3><p>A common pattern that aims to avoid connection setup costs (such as the TCP handshake and TLS setup) and confer control over the number of concurrently established connections is to pool them. <code>net/http</code> maintains a pool of connections to each remote host which supports <code>Connection: keep-alive</code>. The <a href=\"https://golang.org/src/net/http/transport.go#L42\">default size</a> of the pool is two idle connections per <a href=\"https://golang.org/src/net/http/transport.go#L743\">remote host</a>.</p><p>More interestingly, when you make a request with <code>net/http</code>, a race happens. Races in code are often an unwanted side effect, but in this case it&#39;s intentional. Two goroutines operate in parallel: one that tries to dial a connection to the remote host, and another which tries to retrieve an idle connection from the connection pool. The fastest goroutine wins.</p><p>To illustrate, let&#39;s look at the <a href=\"https://golang.org/src/net/http/transport.go#L187\">code executed</a> when <code>transport.RoundTrip(req)</code> is called:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">go func() {\n    pc, err := t.dialConn(cm)\n    dialc &lt;- dialRes{pc, err}\n}()\n\nidleConnCh := t.getIdleConnCh(cm)\n\nselect {\ncase v := &lt;-dialc:\n    // Our dial finished.\n    return v.pc, v.err\ncase pc := &lt;-idleConnCh:\n    // Another request finished first and its net.Conn\n    // became available before our dial. Or somebody\n    // else&#039;s dial that they didn&#039;t use.\n    // But our dial is still going, so give it away\n    // when it finishes:\n    handlePendingDial()\n    return pc, nil\ncase &lt;-req.Cancel:  \n    handlePendingDial()\n    return nil, errors.New(&quot;net/http: request canceled while waiting for connection&quot;)\ncase &lt;-cancelc:  \n    handlePendingDial()\n    return nil, errors.New(&quot;net/http: request canceled while waiting for connection&quot;)\n}</pre></code>\n            <p>First a connection is dialed, then we select over <code>idleConnCh</code> (down which idle connections are passed) or <code>dialc</code>, which gives us the result of the dial. Cancellation of the request is also possible if the caller decides <code>RoundTrip</code> has taken too long.</p><h3>Late binding</h3><p>So if an idle connection is available, retrieving it from the pool should win against dialing a new one. A similar approach (alongside other optimizations) has been used in Chromium, where it&#39;s referred to as <a href=\"https://insouciant.org/tech/connection-management-in-chromium/\">late binding</a>.</p><p>This echoes a mechanism we use in <a href=\"https://www.cloudflare.com/railgun/\">Railgun</a>, CloudFlare&#39;s dynamic content optimizer, to ensure that an incoming request is serviced as quickly as possible. Idle connections to the Railgun component running at an origin server are periodically pruned after a timeout or may be closed because of errors, so an established connection from CloudFlare&#39;s edge is not always available. In this case, a direct request is made without Railgun whilst, in parallel, a persistent connection is initiated for use by subsequent requests.</p><p>As long as you have confidence that your connection manager is capable of cleaning up bad connections and cancelled requests properly, connection pooling and late binding can be important in reducing roundtrip latency. <a href=\"https://golang.org/pkg/sync/#Pool\">sync.Pool</a> in the standard library may be a useful starting point if you need to pool something other than HTTP connections.</p><p>If you found this exploration interesting, we&#39;re <a href=\"https://www.cloudflare.com/join-our-team/\">hiring engineers in London, San Francisco and Singapore</a>.</p>",
		"id": "5YTek3m8V13gVgNGSFTbYI",
		"localeList": {
			"name": "What's inside net/http? Late binding in the Go standard library Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2015-12-21T14:30:48.000+00:00",
		"slug": "whats-inside-net-http-socket-late-binding-in-the-go-standard-library",
		"tags": [
			{
				"id": "KDI5hQcs301H8vxpGKXO0",
				"name": "Go",
				"slug": "go"
			},
			{
				"id": "6lhzEBz2B56RKa4nUEAGYJ",
				"name": "Programming",
				"slug": "programming"
			},
			{
				"id": "01lawpu7M1MKsoK2cbP1vg",
				"name": "Railgun",
				"slug": "railgun"
			},
			{
				"id": "48r7QV00gLMWOIcM1CSDRy",
				"name": "Speed & Reliability",
				"slug": "speed-and-reliability"
			}
		],
		"title": "What's inside net/http? Late binding in the Go standard library",
		"updated_at": "2024-08-27T02:36:36.993Z",
		"url": "https://blog.cloudflare.com/whats-inside-net-http-socket-late-binding-in-the-go-standard-library"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}