{
	"post": {
		"id": "5d16453b41acde0011a95523",
		"uuid": "c3827780-71e3-41ca-a79a-d0f80bb9c527",
		"title": "Logjam: the latest TLS vulnerability explained",
		"slug": "logjam-the-latest-tls-vulnerability-explained",
		"html": "<!--kg-card-begin: markdown--><p><img src=\"http://blog.cloudflare.com/content/images/2015/05/CFa8ap_WIAAAQHE-3.jpg\" alt=\"log-jam\" loading=\"lazy\"><br>\n<small><em>Image: &quot;Logjam&quot; <a href=\"https://twitter.com/0xabad1dea/status/600874766527012865\">as interpreted by @0xabad1dea</a></em></small></p>\n<p>Yesterday, a group from INRIA, Microsoft Research, Johns Hopkins, the University of Michigan, and the University of Pennsylvania <a href=\"https://weakdh.org/imperfect-forward-secrecy.pdf\">published</a> a deep analysis of the Diffie-Hellman algorithm as used in TLS and other protocols. This analysis included a novel downgrade attack against the TLS protocol itself called <a href=\"https://weakdh.org/\"><strong>Logjam</strong></a>, which exploits EXPORT cryptography (just like <a href=\"http://blog.cloudflare.com/cloudflare-sites-are-protected-from-freak/\">FREAK</a>).</p>\n<p>First, let me start by saying that <strong>CloudFlare customers are not and were never affected</strong>. We don’t support non-EC Diffie-Hellman ciphersuites on either the client or origin side. We also won't touch EXPORT-grade cryptography with a 20ft stick.</p>\n<p>But why are CloudFlare customers safe, and how does Logjam work anyway?</p>\n<h3 id=\"diffiehellmanandtls\">Diffie-Hellman and TLS</h3>\n<p><em>This is a detailed technical introduction to how DH works and how it’s used in TLS—if you already know this and want to read about the attack, skip to “Enter export crypto, enter Logjam” below. If, instead, you are not interested in the nuts and bolts and want to know who’s at risk, skip to “So, what’s affected?”</em></p>\n<p>To start a TLS connection, the two sides—client (the browser) and server (CloudFlare)—need to agree securely on a secret key. This process is called <strong>Key Exchange</strong> and it happens during the TLS Handshake: the exchange of messages that take place before encrypted data can be transmitted.</p>\n<p>There is a detailed description of the TLS handshake in the first part of <a href=\"http://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/\">this previous blog post by Nick Sullivan</a>. In the following, I’ll only discuss the ideas you’ll need to understand the attack at hand.</p>\n<p>There are many types of Key Exchanges: static RSA, Diffie-Hellman (DHE cipher suites), Elliptic Curve Diffie-Hellman (ECDHE cipher suites), and some less used methods.</p>\n<p>An important property of DHE and ECDHE key exchanges is that they provide <a href=\"http://blog.cloudflare.com/staying-on-top-of-tls-attacks/#forwardsecrecy\">Forward Secrecy</a>. That is, even if the server key is compromised at some point, it can’t be used to decrypt past connections. It’s important to protect the information exchanged from future breakthroughs, and we’re proud to say that 94% of CloudFlare connections provide it.</p>\n<p>This research—and this attack—applies to the normal non-EC <strong>Diffie-Hellman key exchange (DHE)</strong>. This is how it works at a high level (don’t worry, I’ll explain each part in more detail below):</p>\n<ol>\n<li>The client advertises support for DHE cipher suites when opening a connection (in what is called a Client Hello message)</li>\n<li>The server picks the parameters and performs its half of the DH computation using those parameters</li>\n<li>The server signs parameters and its DH share with its long-term certificate and sends the whole thing to the client</li>\n<li>The client checks the signature, uses the parameters to perform its half of the computation and sends the result to the server</li>\n<li>Both parts put everything together and derive a shared secret, which they will use as the key to secure the connection</li>\n</ol>\n<p>(For a more in depth analysis of each step see the link to Nick Sullivan’s blog post above, <a href=\"http://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/#ephemeraldiffiehellmanhandshake\">“Ephemeral Diffie-Hellman Handshake” section</a>.)</p>\n<p><a href=\"http://blog.cloudflare.com/content/images/2015/05/ssl_handshake_diffie_hellman.jpg\"><img src=\"http://blog.cloudflare.com/content/images/2015/05/ssl_handshake_diffie_hellman.jpg\" alt=\"Diffie-Hellman Handshake diagram\" loading=\"lazy\"></a></p>\n<p>Let’s explain some of the terms that just passed by your screen. “The client” is the browser and “the server” is the website (or CloudFlare’s edge serving the website).</p>\n<p>“The parameters” (or <em>group</em>) are some big numbers that are used as base for the DH computations. <strong>They can be, and often are, fixed. The security of the final secret depends on the size of these parameters.</strong> This research deemed 512 and 768 bits to be weak, 1024 bits to be breakable by really powerful attackers like governments, and 2048 bits to be a safe size.</p>\n<p>The certificate contains a public key and is what you (or CloudFlare for you) get issued from a CA for your website. The client makes sure it’s issued by a CA it trusts and that it’s valid for the visited website. The server uses the corresponding private key to cryptographically sign its share of the DH key exchange so that the client can be sure it’s agreeing on a connection key with the real owner of the website, not a MitM.</p>\n<p>Finally, the DH computation: there’s a <a href=\"https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange#Description\">beautiful explanation of this on Wikipedia which uses <em>paint</em></a>. The tl;dr is:</p>\n<ol>\n<li>The server picks a secret ‘a’</li>\n<li>Then it computes—using some parameters as a base—a value ‘A’ from it and sends that to the client (not ‘a’!)</li>\n<li>The client picks a secret ‘b’, takes the parameters from the server and likewise it computes a value ‘B’ that sends to the server</li>\n<li>Both parts put together ‘a’ + ‘B’ or ‘b’ + ‘A’ to derive a shared, identical secret - which is impossible to compute from ‘A’ + ‘B’ which are the only things that travelled on the wire</li>\n</ol>\n<p>The security of all this depends on the strength/size of the parameters.</p>\n<h3 id=\"enterexportcryptoenterlogjam\">Enter export crypto, enter Logjam</h3>\n<p>So far, so good. Diffie-Hellman is nice, it provides Forward Secrecy, it’s secure if the parameters are big enough, and the parameters are picked and signed by the server. So what’s the problem?</p>\n<p>Enter “export cryptography”! <strong>Export cryptography</strong> is a relic of the 90’s US restrictions on cryptography export. In order to support SSL in countries to where the U.S. had disallowed exporting &quot;strong cryptography&quot;, many implementations support weakened modes called EXPORT modes.</p>\n<p>We’ve already seen an attack that succeeded because connections could be forced to use these modes even if they wouldn’t want to, this is what happened with the FREAK vulnerability. It’s telling that 20 years after these modes became useless we are still dealing with the outcome of the added complexity.</p>\n<p>How it works with Diffie-Hellman is that the client requests a <code>DHE_EXPORT</code> ciphersuite instead of the corresponding <code>DHE</code> one. Seeing that, the server (if it supports DHE_EXPORT) <em>picks small, breakable 512-bits parameters</em> for the exchange, and carries on with a regular DHE key exchange. <strong>The server doesn’t signal back securely to the client that it picked such small DH parameters because of the EXPORT ciphersuite</strong>.</p>\n<p>This is the protocol flaw at the heart of Logjam “downgrade attack”:</p>\n<ul>\n<li>A MitM attacker intercepts a client connection and replaces all the accepted ciphersuites with only the DHE_EXPORT ones</li>\n<li>The server picks weak 512-bits parameters, does its half of the computation, and signs the parameters with the certificate’s private key. <strong>Neither the Client Hello, the client ciphersuites, nor the chosen ciphersuite are signed by the server!</strong></li>\n<li>The client is led to believe that the server picked a DHE Key Exchange and just willingly decided for small parameters. From its point of view, it has have no way to know that the server was tricked by the MitM into doing so!</li>\n<li>The attacker would then break one of the two weak DH shares, recover the connection key, and proceed with the TLS connection with the client</li>\n</ul>\n<p><img src=\"http://blog.cloudflare.com/content/images/2015/05/https-weakdh-org-imperfect-forward-secrecy-pdf-2015-05-21-01-19-48.png\" alt=\"Imperfect Forward Secrecy: How Diffie-Hellman Fails in Practice - Figure 2\" loading=\"lazy\"></p>\n<p><em><a href=\"https://weakdh.org/imperfect-forward-secrecy.pdf\">Imperfect Forward Secrecy: How Diffie-Hellman Fails in Practice</a> - Figure 2</em></p>\n<p>The client has no other way to protect itself besides drawing a line in the sand about how weak the DHE parameters can be (e.g. at least 1024 bits) and refuse to connect to servers that want to pick smaller ones. This is what all modern browsers are now doing, but it wasn’t done before because it causes breakage, and it was believed that there was no way to trick a server into choosing such weak parameters if it wouldn’t normally.</p>\n<p>The servers can protect themselves by refusing EXPORT ciphersuites and never signing small parameters.</p>\n<h3 id=\"aboutparameterssizeandreuse\">About parameters size and reuse</h3>\n<p>But how small is too small for DH parameters? The Logjam paper analyzes this in depth also. The first thing to understand is that <strong>parameters can be and often are reused</strong>. 17.9% of the Top 1 Million Alexa Domains used the same 1024-bit parameters.</p>\n<p><strong>An attacker can perform the bulk of the computation having only the parameters</strong>, and then break any DH exchange that uses them in minutes. So when many sites (or VPN servers, etc.) share the same parameters, the investment of time needed to “break” the parameters makes much more sense since it would then allow the attacker to break many connections with little extra effort.</p>\n<p>The research team performed the precomputation on the most common 512-bit (EXPORT) parameters to demonstrate the impact of Logjam, but they express concerns that real, more powerful attackers might do the same with the common normal-DHE 1024-bit parameters.</p>\n<p>Finally, in their Internet-wide scan they discovered that many servers will <strong>provide vulnerable 512-bit parameters even for non-EXPORT DHE</strong>, in order to support older TLS implementations (for example, old Java versions).</p>\n<h3 id=\"sowhatsaffected\">So, what’s affected?</h3>\n<p><strong>A client/browser is affected if it accepts small DHE parameters as part of any connection</strong>, since it has no way to know that it’s being tricked into a weak EXPORT-level connection. Most major browsers at the time of this writing are vulnerable but <a href=\"https://groups.google.com/a/chromium.org/forum/#!msg/security-dev/WyGIpevBV1s\">are moving to restrict the size of DH parameters to 1024 bit</a>. You can check yours visiting <a href=\"https://weakdh.org\">weakdh.org</a>.</p>\n<p><strong>A server/website is vulnerable if it supports the DHE_EXPORT ciphersuites or if it uses small parameters for DHE.</strong> You can find a test and instructions on how to fix this at <a href=\"https://weakdh.org/sysadmin.html\">https://weakdh.org/sysadmin.html</a>. 8.4% of Alexa Top Million HTTPS websites were initially vulnerable (with 82% and 10% of them using the same two parameters sets, making precomputation more viable). CloudFlare servers don’t accept either DHE_EXPORT or DHE. We offer ECDHE instead.</p>\n<p>Some interesting related statistics: <strong>94% of the TLS connections to CloudFlare customer sites uses ECDHE</strong> (more precisely 90% of them being <code>ECDHE-RSA-AES</code> of some sort and 10% <a href=\"http://blog.cloudflare.com/do-the-chacha-better-mobile-performance-with-cryptography/\"><code>ECDHE-RSA-CHACHA20-POLY1305</code></a>) and provides Forward Secrecy. The rest use static RSA (5.5% with AES, 0.6% with 3DES).</p>\n<p><em>Both the client and the server need to be vulnerable</em> in order for the attack to succeed because the server must accept to sign small DHE_EXPORT parameters, and the client must accept them as valid DHE parameters.</p>\n<p>A closing note: <strong>events like this are ultimately a good thing for the security industry and the web at large</strong> since they mean that skilled people are looking at what we rely on to secure our connections and fix its flaws. They also put a spotlight on how the added complexity of supporting reduced-strength crypto and older devices endangers and adds difficulty to all of our security efforts.</p>\n<p>If you’ve read to here, found it interesting, and would like to work on things like this, remember that we’re <a href=\"https://www.cloudflare.com/join-our-team\">hiring in London and San Francisco</a>!</p>\n<!--kg-card-end: markdown-->",
		"comment_id": "4664",
		"feature_image": "http://blog.cloudflare.com/content/images/2018/08/CFa8ap_WIAAAQHE-3.jpg",
		"featured": false,
		"visibility": "public",
		"created_at": "2015-05-21T00:11:32.000+01:00",
		"updated_at": "2018-08-27T22:12:33.000+01:00",
		"published_at": "2015-05-21T00:52:53.000+01:00",
		"custom_excerpt": "Yesterday, a group from INRIA, Microsoft Research, Johns Hopkins, the University of Michigan, and the University of Pennsylvania published a deep analysis of the Diffie-Hellman algorithm as used in TLS and other protocols. ",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94f51",
				"name": "Filippo Valsorda",
				"slug": "filippo",
				"profile_image": "http://blog.cloudflare.com/content/images/2018/02/K6rX3ZSn_400x400.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-26.png",
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@filosottile",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/filippo/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a95147",
				"name": "TLS",
				"slug": "tls",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/tls/"
			},
			{
				"id": "5d16450341acde0011a951aa",
				"name": "Vulnerabilities",
				"slug": "vulnerabilities",
				"description": "Vulnerabilities (EN)",
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/vulnerabilities/"
			},
			{
				"id": "5d16450341acde0011a95265",
				"name": "Security",
				"slug": "security",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Security.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Security",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Security'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/security/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94f51",
			"name": "Filippo Valsorda",
			"slug": "filippo",
			"profile_image": "http://blog.cloudflare.com/content/images/2018/02/K6rX3ZSn_400x400.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-26.png",
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": "@filosottile",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/filippo/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a95147",
			"name": "TLS",
			"slug": "tls",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/tls/"
		},
		"url": "http://blog.cloudflare.com/logjam-the-latest-tls-vulnerability-explained/",
		"excerpt": "Yesterday, a group from INRIA, Microsoft Research, Johns Hopkins, the University of Michigan, and the University of Pennsylvania published a deep analysis of the Diffie-Hellman algorithm as used in TLS and other protocols. ",
		"reading_time": 7,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}