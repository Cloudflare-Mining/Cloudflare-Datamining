{
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Ashcon Partovi",
				"slug": "ashcon",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/6mLS6e7vpfh6V98eiR9MQH/51123b559c38a05e6f26f802259f5604/ashcon.jpeg",
				"location": null,
				"website": null,
				"twitter": "@ashconpartovi",
				"facebook": null
			}
		],
		"excerpt": "HTMLRewriter for Cloudflare Workers now supports asynchronous handlers, allowing developers to prefetch assets or user-specific content from a remote service.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/6VgwNb7oBX4zQexBTYrwdG/d8fb8169a60e39889b1efa52d4b52538/asynchronous-htmlrewriter-for-cloudflare-workers.png",
		"featured": false,
		"html": "\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/5sO28SZW0LdI6s1xJfkL1c/12ef00b38c6c2d4011a3c7ded7fac01c/image3-10.png\" alt=\"\" class=\"kg-image\" width=\"1600\" height=\"820\" loading=\"lazy\"/>\n            \n            </figure><p>Last year, we launched <a href=\"/introducing-htmlrewriter/\">HTMLRewriter</a> for Cloudflare Workers, which enables developers to make streaming changes to HTML on the edge. Unlike a traditional DOM parser that loads the entire HTML document into memory, we developed a <a href=\"https://github.com/cloudflare/lol-html\">streaming parser</a> written in Rust. Today, we’re announcing support for asynchronous handlers in HTMLRewriter. Now you can perform asynchronous tasks based on the content of the HTML document: from prefetching fonts and image assets to fetching user-specific content from a CMS.</p><h3>How can I use HTMLRewriter?</h3><p>We designed HTMLRewriter to have a jQuery-like experience. First, you define a handler, then you assign it to a CSS selector; Workers does the rest for you. You can look at our new and improved <a href=\"https://developers.cloudflare.com/workers/runtime-apis/html-rewriter#selectors\">documentation</a> to see our supported list of selectors, which now include <code>nth-child</code> selectors. The example below changes the alternative text for every second image in a document.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">async function editHtml(request) {\n  return new HTMLRewriter()\n     .on(\"img:nth-child(2)\", new ElementHandler())\n     .transform(await fetch(request))\n}\n\nclass ElementHandler {\n   element(e) {\n      e.setAttribute(\"alt\", \"A very interesting image\")\n   }\n}</pre></code>\n            <p>Since these changes are applied using streams, we maintain a low TTFB (time to first byte) and users never know the HTML was transformed. If you’re interested in how we’re able to accomplish this technically, you can read our blog post about <a href=\"/html-parsing-2/\">HTML parsing.</a></p><h3>What’s new with HTMLRewriter?</h3><p>Now you can define an <code>async</code> handler which allows any code that uses <code>await</code>. This means you can make dynamic HTML injection, based on the contents of the document, without having prior knowledge of what it contains. This allows you to customize HTML based on a particular user, feature flag, or even an integration with a CMS.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">class UserCustomizer {\n   // Remember to add the `async` keyword to the handler method\n   async element(e) {\n      const user = await fetch(`https://my.api.com/user/${e.getAttribute(\"user-id\")}/online`)\n      if (user.ok) {\n         // Add the user’s name to the element\n         e.setAttribute(\"user-name\", await user.text())\n      } else {\n         // Remove the element, since this user not online\n         e.remove()\n      }\n   }\n}\n</pre></code>\n            <h3>What can I build with HTMLRewriter?</h3><p>To illustrate the flexibility of HTMLRewriter, I wrote an example that you can deploy on your own website. If you manage a website, you know that old links and images can expire with time. Here’s an excerpt from a years’ old post I wrote on the Cloudflare Blog:</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/7Mxl8SXuSpH1wvXxf0hMkv/05881bb92a901975d1667c7320618600/image1-18.png\" alt=\"\" class=\"kg-image\" width=\"1586\" height=\"348\" loading=\"lazy\"/>\n            \n            </figure><p>As you might see, that missing image is not the prettiest sight. However, we can easily fix this using async handlers in HTMLRewriter. Using a service like the <a href=\"https://archive.org/help/wayback_api.php\">Internet Archive</a> API, we can check if an image no longer exists and rewrite the URL to use the latest archive. That means users don’t see an ugly placeholder and won’t even know the image was replaced.</p>\n            <pre class=\"language-javascript\"><code class=\"language-javascript\">async function fetchAndFixImages(request) {\n   return new HTMLRewriter()\n      .on(\"img\", new ImageFixer())\n      .transform(await fetch(request))\n}\n\nclass ImageFixer {\n   async element(e) {\n    var url = e.getAttribute(\"src\")\n    var response = await fetch(url)\n    if (!response.ok) {\n       var archive = await fetch(`https://archive.org/wayback/available?url=${url}`)\n       if (archive.ok) {\n          var snapshot = await archive.json()\n          e.setAttribute(\"src\", snapshot.archived_snapshots.closest.url)\n       } else {\n          e.remove()\n       }\n    }\n  }\n}</pre></code>\n            <p>Using the Workers Playground, you can view a <a href=\"https://cloudflareworkers.com/#42b5ec636af37ae988c3041e61da1870:https://blog.cloudflare.com/minecraft-api-with-workers-coffeescript/\">working sample</a> of the above code. A more complex example could even alert a service like Sentry when a missing image is detected. Using the previous missing image, now you can see the image is restored and users are none of the wiser.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/4kRP0BDTrkjfY5m9NiCZn1/759f7de5ae44de63e8d198c962dbfd7f/image2-9.png\" alt=\"\" class=\"kg-image\" width=\"1982\" height=\"684\" loading=\"lazy\"/>\n            \n            </figure><p>If you’re interested in deploying this to your own website, click on the button below:</p>\n            <figure class=\"kg-card kg-image-card \">\n            <a href=https://deploy.workers.cloudflare.com/?url=https://github.com/Electroid/wayback-worker>\n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/5emZJNvGrSvi1OJFweWSka/40ba08edfb038870f2c72c79c80f4a09/button.svg_xml\" alt=\"Deploy to Cloudflare Workers\" class=\"kg-image\" width=\"184\" height=\"39\" loading=\"lazy\"/>\n            </a>\n            </figure><h3>What else can I build with HTMLRewriter?</h3><p>We’ve been blown away by developer projects using HTMLRewriter. Here are a few projects that caught our eye and are great examples of the power of Cloudflare Workers and HTMLRewriter:</p><ul><li><p><a href=\"https://web.scraper.workers.dev/\">An elegant web scraper</a></p></li><li><p><a href=\"https://stanislas.blog/2020/05/native-image-lazy-loading-ghost-cloudflare-worker/\">Optimizing images with lazy loading</a></p></li><li><p><a href=\"https://dev.to/cloudflareworkers/localizing-applications-with-cloudflare-worker-s-new-streaming-html-rewriter-1k41\">Localizing a website</a></p></li><li><p><a href=\"https://jross.me/using-cloudflare-workers-htmlrewriter-to-extend-ghost-pro/\">Extending a Ghost blog</a></p></li><li><p><a href=\"https://community.cloudflare.com/t/2020-6-18-workers-runtime-release-notes/183460/2\">Prefetching and embedding Google fonts</a></p></li></ul><p>If you’re interested in using HTMLRewriter, check out our <a href=\"https://developers.cloudflare.com/workers/runtime-apis/html-rewriter\">documentation</a>. Also be sure to share any creations you’ve made with <a href=\"https://twitter.com/CloudflareDev\">@CloudflareDev</a>, we love looking at the awesome projects you build.</p>",
		"id": "76Vtl6ZnNzBh69aIwtPl0M",
		"localeList": {
			"name": "Asynchronous HTMLRewriter for Cloudflare Workers Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": "HTMLRewriter for Cloudflare Workers now supports asynchronous handlers, allowing developers to prefetch assets or user-specific content from a remote service.",
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2020-08-28T12:00:00.000+01:00",
		"reading_time": 3,
		"slug": "asynchronous-htmlrewriter-for-cloudflare-workers",
		"tags": [
			{
				"id": "6hbkItfupogJP3aRDAq6v8",
				"name": "Cloudflare Workers",
				"slug": "workers"
			},
			{
				"id": "5cye1Bh5KxFh3pKSnX8Dsy",
				"name": "Serverless",
				"slug": "serverless"
			},
			{
				"id": "4HIPcb68qM0e26fIxyfzwQ",
				"name": "Developers",
				"slug": "developers"
			},
			{
				"id": "6QktrXeEFcl4e2dZUTZVGl",
				"name": "Product News",
				"slug": "product-news"
			}
		],
		"title": "Asynchronous HTMLRewriter for Cloudflare Workers",
		"updated_at": "2024-08-27T01:59:12.117Z",
		"url": "https://blog.cloudflare.com/asynchronous-htmlrewriter-for-cloudflare-workers"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}