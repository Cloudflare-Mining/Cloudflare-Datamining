<div class="mb2 gray5">7 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/09/image1-6.png" class="kg-image" alt="New! Rate Limiting analytics and throttling" loading="lazy" width="1999" height="1136"></figure>
	<p>Rate Limiting rules are essential in the toolbox of security professionals as they are very effective in managing targeted volumetric attacks, takeover attempts, scraping bots, or API abuse. Over the years we have received a lot of feature requests from users, but two stand out: suggesting rate limiting thresholds and implementing a throttle behavior. Today we released both to Enterprise customers!</p>
	<p>When creating a rate limit rule, one of the common questions is “what rate should I put in to block malicious traffic without affecting legitimate users?”. If your traffic is authenticated, <a href="https://www.cloudflare.com/application-services/products/api-gateway" target="_blank">API Gateway</a> will suggest thresholds based on auth IDs (such a session-id, cookie, or API key). However, when you don’t have authentication headers, you will need to create IP-based rules (like for a ‘/login’ endpoint) and you are left guessing the threshold. From today, we provide analytics tools to determine what rate of requests can be used for your rule.</p>
	<p>So far, a rate limit rule could be created with log, challenge, or block action. When ‘block’ is selected, all requests from the same source (for example, IP) were blocked for the timeout period. Sometimes this is not ideal, as you would rather selectively block/allow requests to enforce a maximum rate of requests without an outright temporary ban. When using throttle, a rule lets through enough requests to keep the request rate from individual clients below a customer-defined threshold.</p>
	<p>Continue reading to learn more about each feature.</p>
	<h2 id="introducing-rate-limit-analysis-in-security-analytics">Introducing Rate Limit Analysis in Security Analytics</h2>
	<p>The <a href="https://developers.cloudflare.com/waf/security-analytics" target="_blank">Security Analytics</a> view was designed with the intention of offering complete visibility on HTTP traffic while adding an extra layer of security on top. It's proven a great value when it comes to crafting custom rules. Nevertheless, when it comes to creating rate limiting rules, relying solely on Security Analytics can be somewhat challenging.</p>
	<p>To create a rate limiting rule you can leverage Security Analytics to determine the filter — what requests are evaluated by the rule (for example, by filtering on mitigated traffic, or selecting other security signals like Bot scores). However, you’ll also need to determine what’s the maximum rate you want to enforce and that depends on the specific application, traffic pattern, time of day, endpoint, etc. What’s the typical rate of legitimate users trying to access the login page at peak time? What’s the rate of requests generated by a botnet with the same JA3 fingerprint scraping prices from an ecommerce site? Until today, you couldn’t answer these questions from the analytics view.<br><br>That’s why we made the decision to integrate a rate limit helper into Security Analytics as a new tab called "Rate Limit Analysis," which concentrates on providing a tool to answer rate-related questions.</p>
	<h3 id="high-level-top-statistics-vs-granular-rate-limit-analysis">High level top statistics vs. granular Rate Limit Analysis</h3>
	<p>In Security Analytics, users can analyze traffic data by creating filters combining what we call <em>top statistics. </em>These statistics reveal the total volume of requests associated with a specific attribute of the HTTP requests. For example, you can filter the traffic from the ASNs that generated more requests in the last 24 hours, or you slice the data to look only at traffic reaching the most popular paths of your application. This tool is handy when creating rules based on traffic analysis.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/image3-5.png" class="kg-image" alt="Screenshot of expandable top N statistics" loading="lazy" width="1999" height="260"></figure>
	<p>However, for rate limits, a more detailed approach is required.</p>
	<p>The new <em>Rate limit analysis</em> tab now displays data on request rate for traffic matching the selected filter and time period. You can select a rate defined on different time intervals, like one or five minutes, and the attribute of the request used to identify the rate, such as IP address, JA3 fingerprint, or a combination of both as this often improves accuracy. Once the attributes are selected, the chart displays the distribution of request rates for the top 50 unique clients (identified as unique IPs or JA3s) observed during the chosen time interval in descending order.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/image2-1.png" class="kg-image" alt="Screenshot of the dashboard highlighting Rate limit analysis tab within Security Analytics view" loading="lazy" width="1999" height="1571"></figure>
	<p>You can use the slider to determine the impact of a rule with different thresholds. How many clients would have been caught by the rule and rate limited? Can I visually identify abusers with above-average rate vs. the long tail of average users? This information will guide you in assessing what’s the most appropriate rate for the selected filter.</p>
	<h3 id="using-rate-limit-analysis-to-define-rate-thresholds">Using Rate Limit Analysis to define rate thresholds</h3>
	<p>It takes a few minutes to build your rate limit rule now. Let’s apply this to one of the common use cases where we identify /login endpoint and create a rate limit rule based on the IP with a logging action.</p>
	<p><strong>Define a scope and rate.</strong></p>
	<ul>
		<li>In the <em>HTTP requests</em> tab (the default view), start by selecting a specific time period. If you’re looking for the normal rate distribution you can specify a period with non-peak traffic. Alternatively, you can analyze the rate of offending users by selecting a period when an attack was carried out.</li>
	</ul><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 43.96186440677966%;">
		<iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/308f4dd277f77573a0f91beade09707c/iframe?preload=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2F308f4dd277f77573a0f91beade09707c%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
	</div>
	<p></p><!--kg-card-end: html-->
	<ul>
		<li>Using the filters in the top statistics, select a specific endpoint (e.g., <em>/login</em>). We can also focus on non-automated/human traffic using the bot score quick filter on the right sidebar or the filter button on top of the chart. In the <em>Rate limiting Analysis</em> tab, you can choose the characteristic (JA3, IP, or both) and duration (1 min, 5 mins, or 1 hour) for your rate limit rule. At this point, moving the dotted line up and down can help you choose an appropriate rate for the rule. JA3 is only available to customers using Bot Management.</li>
	</ul>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/image5-2.png" class="kg-image" alt="Top IP addresses distribution from the new rate limit analysis tab for previous 12 hours, grouping by top IP Address over a 1 min interval, using Bot score greater than 40 and /login API endpoint as filters" loading="lazy" width="1421" height="554"></figure>
	<ul>
		<li>Looking at the distribution, we can exclude any IPs or ASNs that might be known to us, to have a better visual on end user traffic. One way to do this is to filter out the outliers right before the long tail begins. A rule with this setting will block the IPs/JA3 with a higher rate of requests.</li>
	</ul>
	<p><strong>Validate your rate.</strong> You can validate the rate by repeating this process but selecting a portion of traffic where you know there was an attack or traffic peak. The rate you've chosen should block the outliers during the attack and allow traffic during normal times. In addition to that, looking at the sampled logs can be helpful in verifying the fingerprints and filters chosen.</p>
	<p><strong>Create a rule.</strong> Selecting “Create rate limit rule” will take you to the rate limiting tab in the WAF with your filters pre-populated.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/09/image7-2.png" class="kg-image" alt="screenshot from Rate Limiting WAF rule with values distributed from the chosen filters" loading="lazy" width="1398" height="1999"></figure>
	<p><strong>Choose your action and behavior in the rule.</strong> Depending on your needs you can choose to log, challenge, or block requests exceeding the selected threshold. It’s often a good idea to first deploy the rule with a log action to validate the threshold and then change the action to block or challenge when you are confident with the result. With every action, you can also choose between two behaviors: fixed action or throttle. Learn more about the difference in the next section.</p>
	<h2 id="introducing-the-new-throttle-behavior">Introducing the new throttle behavior</h2>
	<p>Until today, the only available behavior for Rate Limiting has been <em>fixed action, </em>where an action is triggered for a selected time period (also known as timeout). For example, did the IP 192.0.2.23 exceed the rate of 20 requests per minute? Then block (or log) all requests from this IP for, let’s say, 10 minutes.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/Screenshot-2023-09-19-at-11.16.42.png" class="kg-image" alt="Fixed action: once a threshold is reached, the action is performed for a customer-defined time duration." loading="lazy" width="1392" height="230"></figure>
	<p>In some situations, this type of penalty is too severe and risks affecting legitimate traffic. For example, if a device in a corporate network (think about NAT) exceeds the threshold, all devices sharing the same IP will be blocked outright.</p>
	<p>With <em>throttling</em>, rate limiting selectively drops requests to maintain the rate within the specified threshold. It’s like a leaky bucket behavior (with the only difference that we do not implement a queuing system). For example, throttling a client to 20 requests per minute means that when a request comes from this client, we look at the last 60 seconds and see if (on average) we have received less than 20 requests. If this is true, the rule won’t perform any action. If the average is already at 20 requests then we will take action on that request. When another request comes in, we will check again. Since some time has passed the average rate might have dropped, making room for more requests.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/Screenshot-2023-09-19-at-11.17.18.png" class="kg-image" alt="Throttle behavior: for every request we assess whether the average rate is within the defined limit; if it is then we allow the request." loading="lazy" width="1404" height="216"></figure>
	<p>Throttling can be used with all actions: block, log, or challenge. When creating a rule, you can select the behavior after choosing the action.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/Screenshot-2023-09-19-at-11.17.42.png" class="kg-image" alt="The Rate Limit rule user interface allows users to select what behavior should be used." loading="lazy" width="1416" height="492"></figure>
	<p>When using any challenge action, we recommend using the <em>fixed</em> <em>action </em>behavior. As a result, when a client exceeds the threshold we will challenge all requests until a challenge is passed. The client will then be able to reach the origin again until the threshold is breached again.</p>
	<p>Throttle behavior is available to Enterprise rate limiting <a href="https://developers.cloudflare.com/waf/rate-limiting-rules/#availability" target="_blank">plans</a>.</p>
	<h2 id="try-it-out">Try it out!</h2>
	<p>Today we are introducing a new Rate Limiting analytics experience along with the throttle behavior for all Rate Limiting users on Enterprise plans. We will continue to work actively on providing a better experience to save our customers' time. Log in to the dashboard, try out the new experience, and let us know your feedback using the feedback button located on the top right side of the Analytics page or by reaching out to your account team directly.</p>
</div>