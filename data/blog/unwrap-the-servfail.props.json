{
	"initialReadingTime": "3",
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Anbang Wen",
				"slug": "anbang",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/1UnHNut5bS2QrDbBCSJKjI/80e56b7fe7223a71bdb55d47528852c1/anbang.jpg",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "We recently released a new version of Cloudflare Resolver, which adds a piece of information called “Extended DNS Errors” (EDE) along with the response code under certain circumstances. This will be helpful in tracing DNS resolution errors and figure out what went wrong behind the scenes.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/5gRltbrLmeUguopTnCxPLH/24661be50b99104a3dc42d65732dc92c/unwrap-the-servfail.jpg",
		"featured": false,
		"html": "<p>We recently released a new version of <a href=\"https://1.1.1.1/dns/\">Cloudflare Resolver</a> which adds a piece of information called “<a href=\"https://datatracker.ietf.org/doc/draft-ietf-dnsop-extended-error/\">Extended DNS Errors</a>” (EDE) along with the response code under certain circumstances. This will be helpful in tracing DNS resolution errors and figuring out what went wrong behind the scenes.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/6pI28dXSUFpxeVT9fbOtXN/0d7ad9ea38afa396101a6a1bf1e97663/image1-1.jpg\" alt=\"\" class=\"kg-image\" width=\"910\" height=\"513\" loading=\"lazy\"/>\n            \n            </figure><p>(image from: <a href=\"https://www.pxfuel.com/en/free-photo-expka\">https://www.pxfuel.com/en/free-photo-expka</a>)</p><h3>A tight-lipped agent</h3><p>The DNS protocol was designed to map domain names to IP addresses. To inform the client about the result of the lookup, the protocol has a 4 bit field, called response code/RCODE. The logic to serve a response might look something like this:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">function lookup(domain) {\n    ...\n    switch result {\n    case &quot;No error condition&quot;:\n        return NOERROR with client expected answer\n    case &quot;No record for the request type&quot;:\n        return NOERROR\n    case &quot;The request domain does not exist&quot;:\n        return NXDOMAIN\n    case &quot;Refuse to perform the specified operation for policy reasons&quot;:\n        return REFUSE\n    default(&quot;Server failure: unable to process this query due to a problem with the name server&quot;):\n        return SERVFAIL\n    }\n}\n\ntry {\n    lookup(domain)\n} catch {\n    return SERVFAIL\n}</pre></code>\n            <p>Although the context hasn&#39;t changed much, protocol extensions such as DNSSEC have been added, which makes the RCODE run out of space to express the server&#39;s internal status. To keep backward compatibility, DNS servers have to squeeze various statuses into existing ones. This behavior could confuse the client, especially with the &quot;catch-all&quot; SERVFAIL: something went wrong but what exactly?</p><p>Most often, end users don&#39;t talk to authoritative name servers directly, but use a <a href=\"https://tools.ietf.org/html/rfc8499#section-6\">stub</a> and/or a recursive resolver as an agent to acquire the information it needs. When a user receives  SERVFAIL, the failure can be one of the following:</p><ul><li><p>The stub resolver fails to send the request.</p></li><li><p>The stub resolver doesn’t get a response.</p></li><li><p>The recursive resolver, which the stub resolver sends its query to, is overloaded.</p></li><li><p>The recursive resolver is unable to communicate with upstream authoritative servers.</p></li><li><p>The recursive resolver fails to verify the DNSSEC chain.</p></li><li><p>The authoritative server takes too long to respond.</p></li><li><p>...</p></li></ul><p>In such cases, it is nearly impossible for the user to know exactly what’s wrong. The resolver is usually the one to be blamed, because, as an agent, it fails to get back the answer, and doesn’t return a clear reason for the failure in the response.</p><h3>Keep backward compatibility</h3><p>It seems we need to return more information, but (there&#39;s always a but) we also need to keep the behavior of existing clients unchanged.</p><p>One way is to extend the RCODE space, which came out with the <a href=\"https://www.ietf.org/rfc/rfc6891.txt\">Extension mechanisms for DNS</a> or EDNS. It defines a 8 bit EXTENDED-RCODE, as high-order bits to current 4 bit RCODE. Together they make up a 12 bit integer. This changes the processing of RCODE, requires both client and server to fully support the logic unfortunately.</p><p>Another approach is to provide out-of-band data without touching the current RCODE. This is how Extended DNS Errors is defined. It introduces a <a href=\"https://www.iana.org/assignments/dns-parameters/dns-parameters.xhtml#dns-parameters-11\">new option</a> to EDNS, containing an INFO-CODE to describe error details with an EXTRA-TEXT as an optional supplement. The option can be repeated as many times as needed, so it&#39;s possible for the client to get a full error chain with detailed messages. The INFO-CODE is just something like RCODE, but is 16 bits wide, while the EXTRA-TEXT is an utf-8 encoded string. For example, let’s say a client sends a request to a resolver, and the requested domain has two name servers. The client may receive a SERVFAIL response with an OPT record (see below) which contains two extended errors, one from one of the authoritative servers that shows it&#39;s not ready to serve, and the other from the resolver, showing it cannot connect to the other name server.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">;; OPT PSEUDOSECTION:\n; ...\n; EDE: 14 (Not Ready)\n; EDE: 23 (Network Error): (cannot reach upstream 192.0.2.1)\n; ...</pre></code>\n            <p>Google has something similar in their <a href=\"https://developers.google.com/speed/public-dns/docs/doh/json\">DoH JSON API</a>, which provides diagnostic information in the &quot;Comment&quot; field.</p><h3>Let&#39;s dig into it</h3><p>Our 1.1.1.1 service has an initial support of the draft version of Extended DNS Errors, while we are still trying to find the best practice. As we mentioned above, this is not a breaking change, and existing clients will not be affected. The additional options can be safely ignored without any problem, since the RCODE stays the same.</p><p>If you have a <a href=\"https://downloads.isc.org/isc/bind9/9.16.4/doc/arm/html/notes.html#new-features\">newer version of dig</a>, you can simply check it out with a known problematic domain. As you can see, due to DNSSEC verification failing, the RCODE is still SERVFAIL, but the extended error shows the failure is &quot;DNSSEC Bogus&quot;.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ dig @1.1.1.1 dnssec-failed.org\n\n; &lt;&lt;&gt;&gt; DiG 9.16.4-Debian &lt;&lt;&gt;&gt; @1.1.1.1 dnssec-failed.org\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 1111\n;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; EDE: 6 (DNSSEC Bogus)\n;; QUESTION SECTION:\n;dnssec-failed.org.\t\tIN\tA\n\n;; Query time: 111 msec\n;; SERVER: 1.1.1.1#53(1.1.1.1)\n;; WHEN: Wed Sep 01 00:00:00 PDT 2020\n;; MSG SIZE  rcvd: 52</pre></code>\n            <p>Note that Extended DNS Error relies on EDNS. So to be able to get one, the client needs to support EDNS, and needs to enable it in the request. At the time of writing this blog post, we see about 17% of queries that 1.1.1.1 received had EDNS enabled within a short time range. We hope this information will help you uncover the root cause of a SERVFAIL in the future.</p>",
		"id": "5CQiO0YvIBrAfgTCkEB3ru",
		"localeList": {
			"name": "Unwrap the SERVFAIL Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": "We recently released a new version of Cloudflare Resolver, which adds a piece of information called “Extended DNS Errors” (EDE) along with the response code under certain circumstances.",
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2020-10-30T12:00:00.000+00:00",
		"slug": "unwrap-the-servfail",
		"tags": [
			{
				"id": "5fZHv2k9HnJ7phOPmYexHw",
				"name": "DNS",
				"slug": "dns"
			},
			{
				"id": "2erOhyZHpwsORouNTuWZfJ",
				"name": "Resolver",
				"slug": "resolver"
			}
		],
		"title": "Unwrap the SERVFAIL",
		"updated_at": "2024-08-27T01:56:41.773Z",
		"url": "https://blog.cloudflare.com/unwrap-the-servfail"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}