{
	"initialReadingTime": "4",
	"locale": "en-us",
	"localesAvailable": [
		"zh-cn",
		"fr-fr",
		"de-de",
		"ja-jp",
		"ko-kr",
		"es-es"
	],
	"post": {
		"authors": [
			{
				"name": "Marek Majkowski",
				"slug": "marek-majkowski",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/1JuU5qavgwVeqR8BAUrd6U/bd09672287e7cf04d4347d9a47607eb5/marek-majkowski.jpeg",
				"location": null,
				"website": null,
				"twitter": "@majek04",
				"facebook": null
			}
		],
		"excerpt": "Introducing Spectrum: a new Cloudflare feature that brings DDoS protection, load balancing, and content acceleration to any TCP-based protocol.Today we are releasing Spectrum. ",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/2fBc1UfFU6JKIdXFfqTLE1/7009b4bb5310431f5398b8873704b239/how-we-built-spectrum.jpg",
		"featured": false,
		"html": "<p>Today we are <a href=\"/spectrum/\">introducing Spectrum</a>: a new Cloudflare feature that brings <a href=\"https://www.cloudflare.com/ddos/\">DDoS protection</a>, load balancing, and content acceleration to any TCP-based protocol.</p>\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/1Gm96owfEOWttanNpmKl0l/02a16b37b62499c6132a5389c3001e9b/13334109713_0b32435032_z.jpg\" alt=\"13334109713_0b32435032_z\" class=\"kg-image\" width=\"640\" height=\"425\" loading=\"lazy\"/>\n            \n            </figure><p><a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC BY-SA 2.0</a> <a href=\"https://www.flickr.com/photos/liftarn/13334109713\">image</a> by <a href=\"https://www.flickr.com/photos/liftarn\">Staffan Vilcans</a></p><p>Soon after we started building Spectrum, we hit a major technical obstacle: Spectrum requires us to accept connections on any valid TCP port, from 1 to 65535. On our Linux edge servers it&#39;s impossible to &quot;accept inbound connections on <i>any</i> port number&quot;. This is not a Linux-specific limitation: it&#39;s a characteristic of the BSD sockets API, the basis for network applications on most operating systems. Under the hood there are two overlapping problems that we needed to solve in order to deliver Spectrum:</p><ul><li><p>how to accept TCP connections on all port numbers from 1 to 65535</p></li><li><p>how to configure a single Linux server to accept connections on a very large number of IP addresses (we have many thousands of IP addresses in our anycast ranges)</p></li></ul>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"assigning-millions-of-ips-to-a-server\">Assigning millions of IPs to a server</h3>\n            <a href=\"#assigning-millions-of-ips-to-a-server\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>Cloudflare’s edge servers have an almost identical configuration. In our early days, we used to assign specific /32 (and /128) IP addresses to the loopback network interface<a href=\"#fn1\">[1]</a>. This worked well when we had dozens of IP addresses, but failed to scale as we grew.</p><p>Along came the <a href=\"https://blog.widodh.nl/2016/04/anyip-bind-a-whole-subnet-to-your-linux-machine/\">&quot;AnyIP&quot; trick</a>. AnyIP allows us to assign whole IP prefixes (subnets) to the loopback interface, expanding from specific IP addresses. There is already common use of AnyIP: your computer has 127.0.0.0/8 assigned to the loopback interface. From the point of view of your computer, all IP addresses from 127.0.0.1 to 127.255.255.254 belong to the local machine.</p><p>This trick is applicable to more than the 127.0.0.1/8 block. To treat the whole range of 192.0.2.0/24 as assigned locally, run:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">ip route add local 192.0.2.0/24 dev lo</pre></code>\n            <p>Following this, you can bind to port 8080 on one of these IP addresses just fine:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">nc -l 192.0.2.1 8080</pre></code>\n            <p>Getting IPv6 to work is a bit harder:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">ip route add local 2001:db8::/64 dev lo</pre></code>\n            <p>Sadly, you can&#39;t just bind to these attached v6 IP addresses like in the v4 example. To get this working you must use the <code>IP_FREEBIND</code> socket option, which requires elevated privileges. For completeness, there is also a sysctl <code>net.ipv6.ip_nonlocal_bind</code>, but we don&#39;t recommend touching it.</p><p>This AnyIP trick allows us to have millions of IP addresses assigned locally to each server:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ ip addr show\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536\n    inet 1.1.1.0/24 scope global lo\n       valid_lft forever preferred_lft forever\n    inet 104.16.0.0/16 scope global lo\n       valid_lft forever preferred_lft forever\n...</pre></code>\n            \n          <div class=\"flex anchor relative\">\n            <h3 id=\"binding-to-all-ports\">Binding to ALL ports</h3>\n            <a href=\"#binding-to-all-ports\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The second major issue is the ability to open TCP sockets for any port number. In Linux, and generally in any system supporting the BSD sockets API, you can only bind to a specific TCP port number with a single <code>bind</code> system call. It’s not possible to bind to multiple ports in a single operation.</p><p>A naive solution would be to <code>bind</code> 65535 times, once for each of the 65535 possible ports. Indeed, this could have been an option, but with terrible consequences:</p><ul><li><p><a href=\"/revenge-listening-sockets/\">The revenge of the listening sockets</a></p></li></ul><p>Internally, the Linux kernel stores listening sockets in a hash table indexed by port numbers, <a href=\"https://elixir.bootlin.com/linux/latest/source/include/net/inet_hashtables.h#L118\">LHTABLE</a>, using exactly 32 buckets:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">/* Yes, really, this is all you need. */\n#define INET_LHTABLE_SIZE       32</pre></code>\n            <p>Had we opened 65k ports, lookups to this table would slow drastically: each hash table bucket would contain two thousand items.</p><p>Another way to solve our problem would be to use iptables’ rich NAT features: we could rewrite the destination of inbound packets to some specific address/port, and our application would bind to that.</p><p>We didn&#39;t want to do this though, since it requires enabling the iptables <code>conntrack</code> module. Historically we found some <a href=\"http://patchwork.ozlabs.org/cover/810566/\">performance edge cases</a>, and conntrack cannot cope with some of the large DDoS attacks that we encounter.</p><p>Additionally, with the NAT approach we would lose destination IP address information. To remediate this, there exists a poorly known <code>SO_ORIGINAL_DST</code> socket option, but <a href=\"https://github.com/torvalds/linux/blob/b5dbc28762fd3fd40ba76303be0c7f707826f982/net/ipv4/netfilter/nf_conntrack_l3proto_ipv4.c\">the code doesn&#39;t look encouraging</a>.</p><p>Fortunately, there is a way to achieve our goals that does not involve binding to all 65k ports, or use <code>conntrack</code>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"firewall-to-the-rescue\">Firewall to the rescue</h3>\n            <a href=\"#firewall-to-the-rescue\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>Before we go any further, let’s revisit the general flow of network packets in an operating system.</p><p>Commonly, there are two distinct layers in the inbound packet path:</p><ul><li><p>IP firewall</p></li><li><p>network stack</p></li></ul><p>These are conceptually distinct. The IP firewall is usually a stateless piece of software (let&#39;s ignore <code>conntrack</code> and IP fragment reassembly for now). The firewall analyzes IP packets and decides whether to ACCEPT or DROP them. Please note: at this layer we are talking about <i>packets</i> and <i>port numbers</i> - not <i>applications</i> or <i>sockets</i>.</p><p>Then there is the network stack. This beast maintains plenty of state. Its main task is to dispatch inbound IP packets into <i>sockets</i>, which are then handled by userspace <i>applications</i>. The network stack manages abstractions which are shared with userspace. It reassembles TCP flows, deals with routing, and knows which IP addresses are local.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"the-magic-dust\">The magic dust</h3>\n            <a href=\"#the-magic-dust\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        \n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/3AmbKOGpP2SLYGI4dCFTvG/c71c24b17764a8299cf957b0e478399e/upload-1.jpg\" alt=\"upload-1\" class=\"kg-image\" width=\"640\" height=\"360\" loading=\"lazy\"/>\n            \n            </figure><p>Source: <a href=\"https://www.youtube.com/watch?v=9CS7j5I6aOc\">still from YouTube</a></p><p>At some point we stumbled upon the <code>TPROXY</code> iptables module. The <a href=\"http://ipset.netfilter.org/iptables-extensions.man.html\">official documentation</a> is easy to overlook:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">TPROXY\nThis target is only valid in the mangle table, in the \nPREROUTING chain and user-defined chains which are only \ncalled from this chain.  It redirects the packet to a local \nsocket without changing the packet header in any way. It can\nalso change the mark value which can then be used in \nadvanced routing rules. </pre></code>\n            <p>Another piece of documentation can be found in the kernel:</p><ul><li><p><a href=\"https://www.kernel.org/doc/Documentation/networking/tproxy.txt\">docs/networking/tproxy.txt</a></p></li></ul><p>The more we thought about it, the more curious we became...</p><p>So... What does TPROXY actually <i>do</i>?</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"revealing-the-magic-trick\">Revealing the magic trick</h3>\n            <a href=\"#revealing-the-magic-trick\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>The <code>TPROXY</code> code is <a href=\"https://elixir.bootlin.com/linux/v4.16.1/source/net/netfilter/xt_TPROXY.c#L119\">surprisingly trivial</a>:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">case NFT_LOOKUP_LISTENER:\n  sk = inet_lookup_listener(net, &amp;tcp_hashinfo, skb,\n\t\t\t\t    ip_hdrlen(skb) +\n\t\t\t\t      __tcp_hdrlen(tcph),\n\t\t\t\t    saddr, sport,\n\t\t\t\t    daddr, dport,\n\t\t\t\t    in-&gt;ifindex, 0);</pre></code>\n            <p>Let me read this out loud for you: in an <code>iptables</code> module, which is part of the firewall, we call <code>inet_lookup_listener</code>. This function takes a src/dst port/IP 4-tuple, and returns the listening socket that is able to accept that connection. This is a core functionality of the network stack’s socket dispatch.</p><p>Once again: firewall code calls a socket dispatch routine.</p><p>Later on <a href=\"https://elixir.bootlin.com/linux/v4.16.1/source/net/netfilter/xt_TPROXY.c#L299\"><code>TPROXY</code> actually <i>does</i> the socket dispatch</a>:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">skb-&gt;sk = sk;</pre></code>\n            <p>This line assigns a socket <code>struct sock</code> to an inbound packet - completing the dispatch.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"pulling-the-rabbit-from-the-hat\">Pulling the rabbit from the hat</h3>\n            <a href=\"#pulling-the-rabbit-from-the-hat\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        \n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/51PUlTDqve3FXm5AhGdfZt/705af25c02942ee285330038c52a626d/3649474619_3b800400e9_z-1.jpg\" alt=\"3649474619_3b800400e9_z-1\" class=\"kg-image\" width=\"640\" height=\"424\" loading=\"lazy\"/>\n            \n            </figure><p><a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC BY-SA 2.0</a> <a href=\"https://www.flickr.com/photos/angelaboothroyd/3649474619\">image</a> by <a href=\"https://www.flickr.com/photos/angelaboothroyd\">Angela Boothroyd</a></p><p>Armed with <code>TPROXY</code>, we can perform the bind-to-all-ports trick very easily. Here&#39;s the configuration:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\"># Set 192.0.2.0/24 to be routed locally with AnyIP.\n# Make it explicit that the source IP used for this network\n# when connecting locally should be in 127.0.0.0/8 range.\n# This is needed since otherwise the TPROXY rule would match\n# both forward and backward traffic. We want it to catch \n# forward traffic only.\nsudo ip route add local 192.0.2.0/24 dev lo src 127.0.0.1\n\n# Set the magical TPROXY routing\nsudo iptables -t mangle -I PREROUTING \\\n        -d 192.0.2.0/24 -p tcp \\\n        -j TPROXY --on-port=1234 --on-ip=127.0.0.1</pre></code>\n            <p>In addition to setting this in place, you need to start a TCP server with the magical <code>IP_TRANSPARENT</code> socket option. Our example below needs to listen on tcp://127.0.0.1:1234. The <a href=\"http://man7.org/linux/man-pages/man7/ip.7.html\">man page for <code>IP_TRANSPARENT</code></a> shows:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">IP_TRANSPARENT (since Linux 2.6.24)\nSetting this boolean option enables transparent proxying on\nthis socket.  This socket option allows the calling applica‐\ntion to bind to a nonlocal IP address and operate both as a\nclient and a server with the foreign address as the local\nend‐point.  NOTE: this requires that routing be set up in\na way that packets going to the foreign address are routed \nthrough the TProxy box (i.e., the system hosting the \napplication that employs the IP_TRANSPARENT socket option).\nEnabling this socket option requires superuser privileges\n(the CAP_NET_ADMIN capability).\n\nTProxy redirection with the iptables TPROXY target also\nrequires that this option be set on the redirected socket.</pre></code>\n            <p>Here&#39;s a simple Python server:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">import socket\n\nIP_TRANSPARENT = 19\n\ns = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\ns.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)\ns.setsockopt(socket.IPPROTO_IP, IP_TRANSPARENT, 1)\n\ns.bind((&#039;127.0.0.1&#039;, 1234))\ns.listen(32)\nprint(&quot;[+] Bound to tcp://127.0.0.1:1234&quot;)\nwhile True:\n    c, (r_ip, r_port) = s.accept()\n    l_ip, l_port = c.getsockname()\n    print(&quot;[ ] Connection from tcp://%s:%d to tcp://%s:%d&quot; % (r_ip, r_port, l_ip, l_port))\n    c.send(b&quot;hello world\\n&quot;)\n    c.close()</pre></code>\n            <p>After running the server you can connect to it from arbitrary IP addresses:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ nc -v 192.0.2.1 9999\nConnection to 192.0.2.1 9999 port [tcp/*] succeeded!\nhello world</pre></code>\n            <p>Most importantly, the server will report the connection indeed was directed to 192.0.2.1 port 9999, <i>even though nobody actually listens on that IP address and port</i>:</p>\n            <pre class=\"language-bash\"><code class=\"language-bash\">$ sudo python3 transparent2.py\n[+] Bound to tcp://127.0.0.1:1234\n[ ] Connection from tcp://127.0.0.1:60036 to tcp://192.0.2.1:9999</pre></code>\n            <p>Tada! This is how to <i>bind to any port</i> on Linux, without using <code>conntrack</code>.</p>\n          <div class=\"flex anchor relative\">\n            <h3 id=\"thats-all-folks\">That's all folks</h3>\n            <a href=\"#thats-all-folks\" aria-hidden=\"true\" class=\"relative sm:absolute sm:-left-5\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\"><path fill=\"currentcolor\" d=\"m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\"></path></svg>\n            </a>\n          </div>\n        <p>In this post we described how to use an obscure iptables module, originally designed to help transparent proxying, for something slightly different. With its help we can perform things we thought impossible using the standard BSD sockets API, avoiding the need for any custom kernel patches.</p><p>The <code>TPROXY</code> module is very unusual - in the context of the Linux firewall it performs things typically done by the Linux network stack. The official documentation is rather lacking, and I don&#39;t believe many Linux users understand the full power of this module.</p><p>It&#39;s fair to say that <code>TPROXY</code> allows our Spectrum product to run smoothly on the vanilla kernel. It’s yet another reminder of how important it is to try to understand iptables and the network stack!</p><hr/><p><i>Doing low level socket work sound interesting? Join our </i><a href=\"https://boards.greenhouse.io/cloudflare/jobs/589572\"><i>world famous team</i></a><i> in London, Austin, San Francisco, Champaign and our elite office in Warsaw, Poland</i>.</p><hr/><ol><li><p>Assigning IP addresses to loopback interface, together with appropriate <code>rp_filter</code> and BGP configuration allows us to handle arbitrary IP ranges on our edge servers. <a href=\"#fnref1\">↩︎</a></p></li></ol>",
		"id": "3pYMOvHdXDQsYLmwubg5fj",
		"localeList": {
			"name": "Abusing Linux's firewall: the hack that allowed us to build Spectrum Config",
			"enUS": "English for Locale",
			"zhCN": "Translated for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "Translated for Locale",
			"deDE": "Translated for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "Translated for Locale",
			"koKR": "Translated for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "Translated for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": null,
		"metadata": {
			"imgPreview": ""
		},
		"primary_author": {},
		"published_at": "2018-04-12T14:00:00.000+01:00",
		"slug": "how-we-built-spectrum",
		"tags": [
			{
				"id": "6QktrXeEFcl4e2dZUTZVGl",
				"name": "Product News",
				"slug": "product-news"
			},
			{
				"id": "7GsUXAEWttzfewhzSJXA6W",
				"name": "Spectrum",
				"slug": "spectrum"
			},
			{
				"id": "64g1G2mvZyb6PjJsisO09T",
				"name": "DDoS",
				"slug": "ddos"
			},
			{
				"id": "6Mp7ouACN2rT3YjL1xaXJx",
				"name": "Security",
				"slug": "security"
			},
			{
				"id": "383iv0UQ6Lp0GZwOAxGq2p",
				"name": "Linux",
				"slug": "linux"
			},
			{
				"id": "48r7QV00gLMWOIcM1CSDRy",
				"name": "Speed & Reliability",
				"slug": "speed-and-reliability"
			}
		],
		"title": "Abusing Linux's firewall: the hack that allowed us to build Spectrum",
		"updated_at": "2024-08-27T02:22:55.397Z",
		"url": "https://blog.cloudflare.com/how-we-built-spectrum"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"search.clear": "Clear",
		"search.filter": "Filter",
		"search.source": "Source",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"search.filters": "Filters",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"search.language": "Language",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"search.result_stat": "Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"search.source_location": "Source/Location",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}