<div class="mb2 gray5">15 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5Ttqj8CGxgUA8NKQSSW5Jk/3bb782fb6ae10816a032d84493750223/adopting-a-new-approach-to-http-prioritization.png" alt="">
<div class="post-content lh-copy gray1">
	<p></p>
	<p>Friday the 13th is a lucky day for Cloudflare for <a href="https://twitter.com/eastdakota/status/566276309433602048">many reasons</a>. On December 13, 2019 Tommy Pauly, co-chair of the IETF HTTP Working Group, <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019OctDec/0181.html">announced</a> the adoption of the "Extensible Prioritization Scheme for HTTP" - a new approach to HTTP prioritization.</p>
	<p>Web pages are made up of many resources that must be downloaded before they can be presented to the user. The role of HTTP prioritization is to load the right bytes at the right time in order to achieve the best performance. This is a collaborative process between client and server, a client sends priority signals that the server can use to schedule the delivery of response data. In HTTP/1.1 the signal is basic, clients order requests smartly across a pool of about 6 connections. In HTTP/2 a single connection is used and clients send a signal per request, as a frame, which describes the <i>relative dependency and weighting</i> of the response. HTTP/3 tried to use the same approach but dependencies don't work well when signals can be delivered out of order.</p>
	<p><a href="https://www.cloudflare.com/learning/performance/what-is-http3">HTTP/3</a> is being standardised as part of the <a href="https://blog.cloudflare.com/the-road-to-quic">QUIC</a> effort. As a Working Group (WG) we've been trying to fix the problems that non-deterministic ordering poses for HTTP priorities. However, in parallel some of us have been working on an alternative solution, the Extensible Prioritization Scheme, which fixes problems by dropping dependencies and using an <i>absolute weighting</i>. This is signalled in an HTTP header field meaning it can be backported to work with HTTP/2 or carried over HTTP/1.1 hops. The alternative proposal is documented in the Individual-Draft <a href="https://tools.ietf.org/html/draft-kazuho-httpbis-priority-04">draft-kazuho-httpbis-priority-04</a>, co-authored by Kazuho Oku (Fastly) and myself. This has now been adopted by the IETF HTTP WG as the basis of further work; It's adopted name will be draft-ietf-httpbis-priority-00.</p>
	<p>To some extent document adoption is the end of one journey and the start of the next; sometimes the authors of the original work are not the best people to oversee the next phase. However, I'm pleased to say that Kazuho and I have been selected as co-editors of this new document. In this role we will reflect the consensus of the WG and help steward the next chapter of HTTP prioritization standardisation. Before the next journey begins in earnest, I wanted to take the opportunity to share my thoughts on the story of developing the alternative prioritization scheme through 2019.</p>
	<p>I'd love to explain all the details of this new approach to HTTP prioritization but the truth is I expect the standardization process to refine the design and for things to go stale quickly. However, it doesn't hurt to give a taste of what's in store, just be aware that it is all subject to change.</p>
	<div class="flex anchor relative">
		<h2 id="a-recap-on-priorities">A recap on priorities</h2>
		<a href="https://blog.cloudflare.com/#a-recap-on-priorities" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The essence of HTTP prioritization comes down to trying to download many things over constrained connectivity. To borrow some text from Pat Meenan: <i>Web pages are made up of</i> <a href="https://discuss.httparchive.org/t/whats-the-distribution-of-requests-per-page/21/10?u=patmeenan"><i>dozens (sometimes hundreds)</i></a> <i>of separate resources that are loaded and assembled by a browser into the final displayed content.</i> Since it is not possible to download everything immediately, we prefer to fetch more important things before less important ones. The challenge comes in signalling the importance from client to server.</p>
	<p>In HTTP/2, every connection has a priority tree that expresses the relative importance between requests. Servers use this to determine how to schedule sending response data. The tree starts with a single root node and as requests are made they either depend on the root or each other. Servers may use the tree to decide how to schedule sending resources but clients cannot force a server to behave in any particular way.</p>
	<p>To illustrate, imagine a client that makes three simple GET requests that all depend on root. As the server receives each request it grows its view of the priority tree:</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2eAdxmuUQxOJLbtqnmP0BS/2379ea92642242d027465218bc39d0bc/treebuilding1.png" alt="" class="kg-image" width="1498" height="345" loading="lazy">

	</figure>
	<p>The server starts with only the root node of the priority tree. As requests arrive, the tree grows. In this case all requests depend on the root, so the requests are priority siblings.</p>
	<p>Once all requests are received, the server determines all requests have equal priority and that it should send response data using <a href="https://en.wikipedia.org/wiki/Round-robin_scheduling">round-robin scheduling</a>: send some fraction of response 1, then a fraction of response 2, then a fraction of response 3, and repeat until all responses are complete.</p>
	<p>A single HTTP/2 request-response exchange is made up of frames that are sent on a stream. A simple GET request would be sent using a single <a href="https://tools.ietf.org/html/rfc7540#section-6.2">HEADERS</a> frame:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/76uj7WpKKMF0lczd3FfkSY/b49c96761908edf66d482859b3cfa62f/H2_HEADERS_frame.png" alt="" class="kg-image" width="1378" height="483" loading="lazy">

	</figure>
	<p>HTTP/2 HEADERS frame, Each region of a frame is a named field</p>
	<p>Each region of a frame is a named field, a '?' indicates the field is optional and the value in parenthesis is the length in bytes with '*' meaning variable length. The <i>Header Block Fragment</i> field holds compressed HTTP header fields (using <a href="https://blog.cloudflare.com/hpack-the-silent-killer-feature-of-http-2">HPACK</a>), <i>Pad Length</i> and <i>Padding</i> relate to optional padding, and <i>E</i>, <i>Stream Dependency</i> and <i>Weight</i> combined are the priority signal that controls the priority tree.</p>
	<p>The <i>Stream Dependency</i> and <i>Weight</i> fields are optional but their absence is interpreted as a signal to use the default values; dependency on the root with a weight of 16 meaning that the default priority scheduling strategy is round-robin . However, this is often a bad choice because important resources like HTML, CSS and JavaScript are tied up with things like large images. The following animation demonstrates this in the Edge browser, causing the page to be blank for 19 seconds. Our <a href="https://blog.cloudflare.com/better-http-2-prioritization-for-a-faster-web">deep dive blog post</a> explains the problem further.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/WHsjjksenLoE7ocl8SgRI/d2f8dab33a3688f4357b12b6646cb593/Edge_loading-1.gif" alt="" class="kg-image" width="800" height="600" loading="lazy">

	</figure>
	<p>The HEADERS frame <i>E</i> field is the interesting bit (pun intended). A request with the field set to 1 (true) means that the dependency is exclusive and nothing else can depend on the indicated node. To illustrate, imagine a client that sends three requests which set the <i>E</i> field to 1. As the server receives each request, it interprets this as an exclusive dependency on the root node. Because all requests have the same dependency on root, the tree has to be shuffled around to satisfy the exclusivity rules.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/i6NA77FtHzckq638a42kh/25013c743bff2c0279d4324f69ee9a64/treebuilding2.png" alt="" class="kg-image" width="824" height="586" loading="lazy">

	</figure>
	<p>Each request has an exclusive dependency on the root node. The tree is shuffled as each request is received by the server.</p>
	<p>The final version of the tree looks very different from our previous example. The server would schedule all of response 3, then all of response 2, then all of response 1. This could help load all of an HTML file before an image and thus improve the visual load behaviour.</p>
	<p>In reality, clients load a lot more than three resources and use a mix of priority signals. To understand the priority of any single request, we need to understand all requests. That presents some technological challenges, especially for servers that act like proxies such as the Cloudflare edge network. Some servers have <a href="https://github.com/andydavies/http2-prioritization-issues">problems</a> applying prioritization effectively.</p>
	<p>Because not all clients send the most optimal priority signals we were motivated to develop <a href="https://blog.cloudflare.com/better-http-2-prioritization-for-a-faster-web">Cloudflare's Enhanced HTTP/2 Prioritization</a>, announced last May during <a href="https://blog.cloudflare.com/tag/speed-week">Speed Week</a>. This was a joint project between the Speed team (Andrew Galloni, Pat Meenan, Kornel Lesiński) and Protocols team (Nick Jones, Shih-Chiang Chien) and others. It replaces the complicated priority tree with a simpler scheme that is well suited to web resources. Because the feature is implemented on the server side, we avoid requiring any modification of clients or the HTTP/2 protocol itself. Be sure to check out my colleague Nick's blog post that details some of the <a href="https://blog.cloudflare.com/nginx-structural-enhancements-for-http-2-performance">technical challenges and changes</a> needed to let our servers deliver smarter priorities.</p>
	<div class="flex anchor relative">
		<h2 id="the-extensible-prioritization-scheme-proposal">The Extensible Prioritization Scheme proposal</h2>
		<a href="https://blog.cloudflare.com/#the-extensible-prioritization-scheme-proposal" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The scheme specified in <a href="https://tools.ietf.org/html/draft-kazuho-httpbis-priority-04">draft-kazuho-httpbis-priority-04</a>, defines a way for priorities to be expressed in absolute terms. It replaces HTTP/2's dependency-based relative prioritization, the priority of a request is independent of others, which makes it easier to reason about and easier to schedule.</p>
	<p>Rather than send the priority signal in a frame, the scheme defines an HTTP header - tentatively named "Priority" - that can carry an urgency on a scale of 0 (highest) to 7 (lowest). For example, a client could express the priority of an important resource by sending a request with:</p>
	<p><code>Priority: u=0</code></p>
	<p>And a less important background resource could be requested with:</p>
	<p><code>Priority: u=7</code></p>
	<p>While Kazuho and I are the main authors of this specification, we were inspired by several ideas in the Internet community, and we have incorporated feedback or direct input from many of our peers in the Internet community over several drafts. The text today reflects the efforts-so-far of cross-industry work involving many engineers and researchers including organizations such Adobe, Akamai, Apple, Cloudflare, Fastly, Facebook, Google, Microsoft, Mozilla and UHasselt. Adoption in the HTTP Working Group means that we can help improve the design and specification by spending some IETF time and resources for broader discussion, feedback and implementation experience.</p>
	<div class="flex anchor relative">
		<h2 id="the-backstory">The backstory</h2>
		<a href="https://blog.cloudflare.com/#the-backstory" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>I work in Cloudflare's Protocols team which is responsible for terminating HTTP at the edge. We deal with things like TCP, TLS, QUIC, HTTP/1.x, HTTP/2 and HTTP/3 and since joining the company I've worked with Alessandro Ghedini, Junho Choi and Lohith Bellad to make <a href="https://blog.cloudflare.com/http3-the-past-present-and-future">QUIC and HTTP/3 generally available</a> last September.</p>
	<p>Working on emerging standards is fun. It involves an eclectic mix of engineering, meetings, document review, specification writing, time zones, personalities, and organizational boundaries. So while working on the codebase of <a href="https://github.com/cloudflare/quiche">quiche</a>, our open source implementation of QUIC and HTTP/3, I am also mulling over design details of the protocols and discussing them in cross-industry venues like the IETF.</p>
	<p>Because of <a href="https://blog.cloudflare.com/http-3-from-root-to-tip">HTTP/3's lineage</a>, it carries over a lot of features from HTTP/2 including the priority signals and tree described earlier in the post.</p>
	<p>One of the key benefits of HTTP/3 is that it is more resilient to the effect of lossy network conditions on performance; head-of-line blocking is limited because requests and responses can progress independently. This is, however, a double-edged sword because sometimes ordering is important. In HTTP/3 there is no guarantee that the requests are received in the same order that they were sent, so the priority tree can get out of sync between client and server. Imagine a client that makes two requests that include priority signals stating request 1 depends on root, request 2 depends on request 1. If request 2 arrives before request 1, the dependency cannot be resolved and becomes dangling. In such a case what is the best thing for a server to do? Ambiguity in behaviour leads to assumptions and disappointment. We should try to avoid that.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/68BpLWmGQLImEc9Bj4BczY/d37a2841eca4bb18f80c473db2e7440f/h3tree.png" alt="" class="kg-image" width="500" height="581" loading="lazy">

	</figure>
	<p>Request 1 depends on root and request 2 depends on request 1. If an HTTP/3 server receives request 2 first, the dependency cannot be resolved.</p>
	<p>This is just one example where things get tricky quickly. Unfortunately the WG kept finding edge case upon edge case with the priority tree model. We tried to find solutions but each additional fix seemed to create further complexity to the HTTP/3 design. This is a problem because it makes it hard to implement a server that handles priority correctly.</p>
	<p>In parallel to Cloudflare's work on implementing a <a href="https://blog.cloudflare.com/better-http-2-prioritization-for-a-faster-web">better prioritization for HTTP/2</a>, in January 2019 Pat posted his proposal for an <a href="https://github.com/pmeenan/http3-prioritization-proposal/blob/master/README.md">alternative prioritization scheme for HTTP/3</a> in a <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019JanMar/0073.html">message to the IETF HTTP WG</a>.</p>
	<p>Arguably HTTP/2 prioritization never lived up to its hype. However, replacing it with something else in HTTP/3 is a challenge because the QUIC WG charter required us to try and maintain parity between the protocols. Mark Nottingham, co-chair of the HTTP and QUIC WGs <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019JanMar/0074.html">responded with</a> a good summary of the situation. To quote part of that response:</p>
	<blockquote>
		<p>My sense is that people know that we need to do something about prioritisation, but we're not yet confident about any particular solution. Experimentation with new schemes as HTTP/2 extensions would be very helpful, as it would give us some data to work with. If you'd like to propose such an extension, this is the right place to do it.</p>
	</blockquote>
	<p>And so started a very interesting year of cross-industry discussion on the future of HTTP prioritization.</p>
	<div class="flex anchor relative">
		<h2 id="a-year-of-prioritization">A year of prioritization</h2>
		<a href="https://blog.cloudflare.com/#a-year-of-prioritization" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The following is an account of my personal experiences during 2019. It's been a busy year and there may be unintentional errors or omissions, please let me know if you think that is the case. But I hope it gives you a taste of the standardization process and a look behind the scenes of how new Internet protocols that benefit everyone come to life.</p>
	<div class="flex anchor relative">
		<h3 id="january">January</h3>
		<a href="https://blog.cloudflare.com/#january" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Pat's email came at the same time that I was attending the QUIC WG Tokyo interim meeting hosted at Akamai (thanks to Mike Bishop for arrangements). So I was able to speak to a few people face-to-face on the topic. There was a bit of mailing list chatter but it tailed off after a few days.</p>
	<div class="flex anchor relative">
		<h3 id="february-to-april">February to April</h3>
		<a href="https://blog.cloudflare.com/#february-to-april" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Things remained quiet in terms of prioritization discussion. I knew the next best opportunity to get the ball rolling would be the <a href="https://httpwork.shop">HTTP Workshop 2019</a> held in April. The workshop is a multi-day event not associated with a standards-defining-organization (even if many of the attendees also go to meetings such as the IETF or W3C). It is structured in a way that allows the agenda to be more fluid than a typical standards meeting and gives plenty of time for organic conversation. This sometimes helps overcome gnarly problems, such as the community finding a path forward for <a href="https://tools.ietf.org/html/rfc8441">WebSockets over HTTP/2</a> due to a productive discussion during the 2017 workshop. HTTP prioritization is a gnarly problem, so I was inspired to pitch it as a talk idea. It was selected and you can find the <a href="https://github.com/HTTPWorkshop/workshop2019/blob/master/talks/pardue-jones-priorities.pdf">full slide deck here</a>.</p>
	<p>During the presentation I recounted the history of HTTP prioritization. The great thing about working on open standards is that many email threads, presentation materials and meeting materials are publicly archived. It's fun digging through this history. Did you know: HTTP/2 is based on SPDY and inherited its weight-based prioritization scheme, the tree-based scheme we are familiar with today was only introduced in <a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2-11">draft-ietf-httpbis-http2-11</a>? One of the reasons for the more-complicated tree was to help HTTP intermediaries (a.k.a. proxies) implement clever resource management. However, it became clear during the discussion that no intermediaries implement this, and none seem to plan to. I also explained a bit more about Pat's alternative scheme and Nick described his implementation experiences. Despite some interesting discussion around the topic however, we didn't come to any definitive solution. There were a lot of other <a href="https://github.com/HTTPWorkshop/workshop2019/blob/master/talks/pardue-pcaps.pdf">interesting topics</a> to discover <a href="https://daniel.haxx.se/blog/2019/04/02/the-http-workshop-2019-begins">that week</a>.</p>
	<div class="flex anchor relative">
		<h3 id="may">May</h3>
		<a href="https://blog.cloudflare.com/#may" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>In early May, Ian Swett (Google) <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019AprJun/0107.html">restarted interest</a> in Pat's mailing list thread. Unfortunately he was not present at the HTTP Workshop so had some catching up to do. A little while later Ian submitted a <a href="https://github.com/quicwg/base-drafts/pull/2700">Pull Request to the HTTP/3 specification</a> called "Strict Priorities". This incorporated Pat's proposal and attempted to fix a number of those prioritization edge cases that I mentioned earlier.</p>
	<p>In late May, another QUIC WG interim meeting was held in London at the new Cloudflare offices, here is the view from the meeting room window. Credit to Alessandro for handling the meeting arrangements.</p>
	<blockquote>
		<p>Thanks to <a href="https://twitter.com/Cloudflare?ref_src=twsrc%5Etfw">@cloudflare</a> for hosting our interop and interim meetings in London this week! <a href="https://t.co/LIOA3OqEjr">pic.twitter.com/LIOA3OqEjr</a></p>
		<p>— IETF QUIC WG (@quicwg) <a href="https://twitter.com/quicwg/status/1131467406059212801?ref_src=twsrc%5Etfw">May 23, 2019</a></p>
	</blockquote>
	<p>Mike, the editor of the HTTP/3 specification <a href="https://github.com/quicwg/wg-materials/blob/master/interim-19-05/h3issues.pdf">presented some of the issues</a> with prioritization and we attempted to solve them with the conventional tree-based scheme. Ian, with contribution from Robin Marx (UHasselt), also <a href="https://github.com/quicwg/wg-materials/blob/master/interim-19-05/priorities.pdf">presented</a> an explanation about his "Strict Priorities" proposal. I recommend taking a look at Robin's priority tree visualisations which do a great job of explaining things. From that presentation I particularly liked "The prioritization spectrum", it's a concise snapshot of the state of things at that time:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1JveyeZmmt60QOPXKbnZym/dc50d185e0c9f3afc0e077961050b1ae/priotizationspectrum.png" alt="" class="kg-image" width="1303" height="630" loading="lazy">

	</figure>
	<p>An overview of HTTP/3 prioritization issues, fixes and possible alternatives. Presented by Ian Swett at the QUIC Interim Meeting May 2019.</p>
	<div class="flex anchor relative">
		<h3 id="june-and-july">June and July</h3>
		<a href="https://blog.cloudflare.com/#june-and-july" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Following the interim meeting, the prioritization "debate" continued electronically across GitHub and email. Some time in June Kazuho started work on a proposal that would use a scheme similar to Pat and Ian's absolute priorities. The major difference was that rather than send the priority signal in an HTTP frame, it would use a header field. This isn't a new concept, <a href="https://tools.ietf.org/agenda/83/slides/slides-83-httpbis-5.pdf">Roy Fielding proposed</a> something similar at IETF 83.</p>
	<p>In HTTP/2 and HTTP/3 requests are made up of frames that are sent on streams. Using a simple GET request as an example: a client sends a HEADERS frame that contains the scheme, method, path, and other request header fields. A server responds with a HEADERS frame that contains the status and response header fields, followed by DATA frame(s) that contain the payload.</p>
	<p>To signal priority, a client could also send a PRIORITY frame. In the tree-based scheme the frame carries several fields that express dependencies and weights. Pat and Ian's proposals changed the contents of the PRIORITY frame. Kazuho's proposal encodes the priority as a header field that can be carried in the HEADERS frame as normal metadata, removing the need for the PRIORITY frame altogether.</p>
	<p>I liked the simplification of Kazuho's approach and the new opportunities it might create for application developers. HTTP/2 and HTTP/3 implementations (in particular browsers) abstract away a lot of connection-level details such as stream or frames. That makes it hard to understand what is happening or to tune it.</p>
	<p>The lingua franca of the Web is HTTP requests and responses, which are formed of header fields and payload data. In browsers, APIs such as <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Worker</a> allow handling of these primitives. In servers, there may be ways to interact with the primitives via configuration or programming languages. As part of <a href="https://blog.cloudflare.com/better-http-2-prioritization-for-a-faster-web">Enhanced HTTP/2 Prioritization</a>, we have exposed prioritization to Cloudflare Workers to allow rich behavioural customization. If a Worker adds the "cf-priority" header to a response, Cloudflare’s edge servers use the specified priority to serve the response. This might be used to boost the priority of a resource that is important to the load time of a page. To help inform this decision making, the incoming browser priority signal is encapsulated in the request object passed to a Worker's fetch event listener (request.cf.requestPriority).</p>
	<p>Standardising approaches to problems is part of helping to build a better Internet. Because of the resonance between Cloudflare's work and Kazuho's proposal, I asked if he would consider letting me come aboard as a co-author. He kindly accepted and on July 8th we published the <a href="https://tools.ietf.org/html/draft-kazuho-httpbis-priority-00">first version</a> as an Internet-Draft.</p>
	<p>Meanwhile, Ian was helping to drive the overall prioritization discussion and proposed that we use time during IETF 105 in Montreal to speak to a wider group of people. We kicked off the week with a short <a href="https://github.com/httpwg/wg-materials/blob/gh-pages/ietf105/priorities.pdf">presentation to the HTTP WG</a> from Ian, and Kazuho and I <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019JulSep/0095.html">presented</a> our draft in a side-meeting that saw a healthy discussion. There was a realization that the concepts of prioritization scheme, priority signalling and server resource scheduling (enacting prioritization) were conflated and made effective communication and progress difficult. HTTP/2's model was seen as one aspect, and two different I-Ds were created to deprecate it in some way (<a href="https://tools.ietf.org/html/draft-lassey-priority-setting-00">draft-lassey-priority-setting</a>, <a href="https://tools.ietf.org/html/draft-peon-httpbis-h2-priority-one-less-00">draft-peon-httpbis-h2-priority-one-less</a>). Martin Thomson (Mozilla) also created a Pull Request that simply <a href="https://github.com/quicwg/base-drafts/pull/2922">removed the PRIORITY frame from HTTP/3</a>.</p>
	<p>To round off the week, in the second HTTP session it was decided that there was sufficient interest in resolving the prioritization debate via the creation of a design team. I joined the team led by Ian Swett along with others from Adobe, Akamai, Apple, Cloudflare, Fastly, Facebook, Google, Microsoft, and UHasselt.</p>
	<div class="flex anchor relative">
		<h3 id="august-to-october">August to October</h3>
		<a href="https://blog.cloudflare.com/#august-to-october" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Martin's PR generated a lot of conversation. It was merged under proviso that <i>some</i> solution be found before the HTTP/3 specification was finalized. Between May and August we went from something very complicated (e.g. <i>Orphan placeholder, with PRIORITY only on control stream, plus exclusive priorities</i>) to a blank canvas. The pressure was now on!</p>
	<p>The design team held several teleconference meetings across the months. Logistics are a bit difficult when you have team members distributed across West Coast America, East Coast America, Western Europe, Central Europe, and Japan. However, thanks to some late nights and early mornings we managed to all get on the call at the same time.</p>
	<p>In October most of us travelled to Cupertino, CA to attend another QUIC interim meeting hosted at Apple's Infinite Loop (Eric Kinnear helping with arrangements). &nbsp;The first two days of the meeting were used for interop testing and were loosely structured, so the design team took the opportunity to hold the first face-to-face meeting. We made some progress and helped Ian to form up some <a href="https://github.com/quicwg/wg-materials/blob/master/interim-19-10/HTTP%20Priorities%20Update.pdf">new slides to present</a> later in the week. Again, there was some useful discussion and signs that we should put some time in the agenda in IETF 106.</p>
	<div class="flex anchor relative">
		<h3 id="november">November</h3>
		<a href="https://blog.cloudflare.com/#november" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The design team came to agreement that draft-kazuho-httpbis-priority was a good basis for a new prioritization scheme. We decided to consolidate the various I-Ds that had sprung up during IETF 105 into the document, making it a single source that was easier for people to track progress and open issues if required. This is why, even though Kazuho and I are the named authors, the document reflects a broad input from the community. We published <a href="https://tools.ietf.org/html/draft-kazuho-httpbis-priority-03">draft 03</a> in November, just ahead of the deadline for IETF 106 in Singapore.</p>
	<p>Many of us travelled to Singapore ahead of the actual start of IETF 106. This wasn't to squeeze in some sightseeing (sadly) but rather to attend the IETF Hackathon. These are events where engineers and researchers can really put the concept of "running code" to the test. I really enjoy attending and I'm grateful to Charles Eckel and the team that organised it. If you'd like to read more about the event, Charles wrote up a nice blog post that, through some strange coincidence, features a picture of me, Kazuho and Robin talking at the QUIC table.</p>
	<blockquote>
		<p>Link: <a href="https://t.co/8qP78O6cPS">https://t.co/8qP78O6cPS</a></p>
		<p>— Lucas Pardue (@SimmerVigor) <a href="https://twitter.com/SimmerVigor/status/1207049013301796864?ref_src=twsrc%5Etfw">December 17, 2019</a></p>
	</blockquote>
	<p>The design team held another face-to-face during a Hackathon lunch break and decided that we wanted to make some tweaks to the design written up in draft 03. Unfortunately the freeze was still in effect so we could not issue a new draft. Instead, we presented the most recent thinking to the HTTP session on Monday where Ian put forward draft-kazuho-httpbis-priority as the group's proposed design solution. Ian and Robin also shared results of <a href="https://github.com/httpwg/wg-materials/blob/gh-pages/ietf106/priorities.pdf">prioritization experiments</a>. We received some great feedback in the meeting and during the week pulled out all the stops to issue a new draft <a href="https://tools.ietf.org/html/draft-kazuho-httpbis-priority-04">04</a> before the next HTTP session on Thursday. The question now was: Did the WG think this was suitable to adopt as the basis of an alternative prioritization scheme? I think we addressed a lot of the feedback in this draft and there was a general feeling of support in the room. However, in the IETF consensus is declared via mailing lists and so Tommy Pauly, co-chair of the HTTP WG, put out a <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019OctDec/0125.html">Call for Adoption</a> on November 21st.</p>
	<div class="flex anchor relative">
		<h3 id="december">December</h3>
		<a href="https://blog.cloudflare.com/#december" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>In the Cloudflare London office, preparations begin for mince pie <a href="https://blog.cloudflare.com/imdb-2017">acquisition</a> and <a href="https://blog.cloudflare.com/internet-mince-pie-database">assessment</a>.</p>
	<p>The HTTP priorities team played the waiting game and watched the mailing list discussion. On the whole people supported the concept but there was one topic that divided opinion. Some people loved the use of headers to express priorities, some people didn't and wanted to stick to frames.</p>
	<p>On December 13th Tommy <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/2019OctDec/0181.html">announced</a> that the group had decided to adopt our document and assign Kazuho and I as editors. The header/frame divide was noted as something that needed to be resolved.</p>
	<div class="flex anchor relative">
		<h2 id="the-next-step-of-the-journey">The next step of the journey</h2>
		<a href="https://blog.cloudflare.com/#the-next-step-of-the-journey" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Just because the document has been adopted does not mean we are done. In some ways we are just getting started. Perfection is often the enemy of getting things done and so sometimes adoption occurs at the first incarnation of a "good enough" proposal.</p>
	<p>Today HTTP/3 has no prioritization signal. Without priority information there is a small danger that servers pick a scheduling strategy that is not optimal, that could cause the web performance of HTTP/3 to be worse than HTTP/2. To avoid that happening we'll refine and complete the design of the Extensible Priority Scheme. To do so there are open issues that we have to resolve, we'll need to square the circle on headers vs. frames, and we'll no doubt hit unknown unknowns. We'll need the input of the WG to make progress and their help to document the design that fits the need, and so I look forward to continued collaboration across the Internet community.</p>
	<p>2019 was quite a ride and I'm excited to see what 2020 brings.</p>
	<p>If working on protocols is your interest and you like what Cloudflare is doing, please visit our <a href="https://www.cloudflare.com/careers">careers page</a>. Our journey isn’t finished, in fact far from it.</p>
</div>