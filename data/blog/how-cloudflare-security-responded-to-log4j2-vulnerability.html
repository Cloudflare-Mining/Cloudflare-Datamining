<div class="mb2 gray5">7 min read</div>
<div class="mt4">This post is also available in <a href="https://blog.cloudflare.com/zh-cn/how-cloudflare-security-responded-to-log4j2-vulnerability">简体中文</a>, <a href="https://blog.cloudflare.com/fr-fr/how-cloudflare-security-responded-to-log4j2-vulnerability">Français</a>, <a href="https://blog.cloudflare.com/de-de/how-cloudflare-security-responded-to-log4j2-vulnerability">Deutsch</a>, <a href="https://blog.cloudflare.com/ja-jp/how-cloudflare-security-responded-to-log4j2-vulnerability">日本語</a>, <a href="https://blog.cloudflare.com/ko-kr/how-cloudflare-security-responded-to-log4j2-vulnerability">한국어</a> and <a href="https://blog.cloudflare.com/zh-tw/how-cloudflare-security-responded-to-log4j2-vulnerability">繁體中文</a>.</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/7q86dAP1OsXFJXUB4Uneh7/896156434bf9ea31f465dde1c14b5bba/how-cloudflare-security-responded-to-log4j2-vulnerability.jpeg" alt="">
<div class="post-content lh-copy gray1">
	<p>At Cloudflare, when we learn about a new security vulnerability, we quickly bring together teams to answer two distinct questions: (1) what can we do to ensure our customers’ infrastructures are protected, and (2) what can we do to ensure that our own environment is secure. Yesterday, December 9, 2021, when a serious vulnerability in the popular Java-based logging package <a href="https://logging.apache.org/log4j/2.x/index.html">Log4j</a> was publicly disclosed, our security teams jumped into action to help respond to the first question and answer the second question. This post explores the second.</p>
	<p>We cover the details of how this vulnerability works in a separate blog post: <a href="https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228">Inside the Log4j2 vulnerability (CVE-2021-44228)</a>, but in summary, this vulnerability allows an attacker to execute code on a remote server. Because of the widespread use of Java and Log4j, this is likely one of the most serious vulnerabilities on the Internet since both <a href="https://blog.cloudflare.com/searching-for-the-prime-suspect-how-heartbleed-leaked-private-keys">Heartbleed</a> and <a href="https://blog.cloudflare.com/inside-shellshock">ShellShock</a>. The vulnerability is listed as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228</a>. The CVE description states that the vulnerability affects Log4j2 &lt;=2.14.1 and is patched in 2.15. The vulnerability additionally <a href="https://github.com/apache/logging-log4j2/pull/608#issuecomment-990494126">impacts all versions of log4j 1.x</a>; however, it is End of Life and has other security vulnerabilities that will not be fixed. Upgrading to 2.15 is the recommended action to take. You can also read about how we updated our WAF rules to help protect our customers in this post: <a href="https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation">CVE-2021-44228 - Log4j RCE 0-day mitigation</a></p>
	<h3>Timeline</h3>
	<p>One of the first things we do whenever we respond to an incident is start drafting a timeline of events we need to review and understand within the context of the situation. Some examples from our timeline here include:</p>
	<ul>
		<li>
			<p>2021-12-09 16:57 UTC - Hackerone report received regarding Log4j RCE on developers.cloudflare.com</p>
		</li>
		<li>
			<p>2021-12-10 09:56 UTC - First WAF rule shipped to Cloudflare Specials ruleset</p>
		</li>
		<li>
			<p>2021-12-10 10:00 UTC - Formal engineering INCIDENT is opened and work begins to identify areas we need to patch Log4j</p>
		</li>
		<li>
			<p>2021-12-10 10:33 UTC - Logstash deployed with patch to mitigate vulnerability.</p>
		</li>
		<li>
			<p>2021-12-10 10:44 UTC - Second WAF rule is live as part of Cloudflare managed rules</p>
		</li>
		<li>
			<p>2021-12-10 10:50 UTC - ElasticSearch restart begins with patch to mitigate vulnerability</p>
		</li>
		<li>
			<p>2021-12-10 11:05 UTC - ElasticSearch restart concludes and is no longer vulnerable</p>
		</li>
		<li>
			<p>2021-12-10 11:45 UTC - Bitbucket is patched and no longer vulnerable</p>
		</li>
		<li>
			<p>2021-12-10 21:22 UTC - Hackerone report closed as Informative after it was unable to be reproduced</p>
		</li>
	</ul>
	<h3>Addressing internal impact</h3>
	<p>An important question when dealing with any software vulnerability, and what may actually be the hardest question that every company has to answer in this particular case is: where are all the places that the vulnerable software is actually running?</p>
	<p>If the vulnerability is in a proprietary piece of software licensed by one company to the rest of the world, that is easy to answer - you just find that one piece of software. But in this case that was much harder. Log4j is a widely used piece of software but not one that people who are not Java developers are likely to be familiar with. Our first action was to refamiliarize ourselves with all places in our infrastructure where we were running software on the JVM, in order to determine which software components could be vulnerable to this issue.</p>
	<p>We were able to create an inventory of all software we have running on the JVM using our centralized code repositories. We used this information to research and determine each individual Java application we had, whether it contained Log4j, and which version of Log4j was compiled into it.</p>
	<p>We discovered that our ElasticSearch, LogStash, and Bitbucket contained instances of the vulnerable Log4j package that was between versions 2.0 and 2.14.1. We were able to use the mitigation strategies described in the official Log4j security documentation to patch the issue. For each instance of Log4j we either removed the JndiLookup class from the classpath:</p>
	<p><code>zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code></p>
	<p>Or we set the mitigating system property in the log4j configuration:</p>
	<p><code>log4j2.formatMsgNoLookups</code></p>
	<p>We were able to quickly mitigate this issue in these packages using these strategies while waiting for new versions of the packages to be released.</p>
	<h3>Reviewing External Reports</h3>
	<p>Even before we were done making the list of internal places where the vulnerable software was running, we started by looking at external reports - from HackerOne, our bug bounty program, and a public post in GitHub suggesting that we might be at risk.</p>
	<p>We identified at least two reports that seemed to indicate that Cloudflare was vulnerable and compromised. In one of the reports was the following screenshot:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2qkLHVM69u2bAYEKAWf0UV/7755bfa4c326c8d32a0782070edd2519/65876613-4802-4014-B265-A28C1B807847.png" alt="" class="kg-image" width="1155" height="532" loading="lazy">

	</figure>
	<p>This example is targeting our developer documentation hosted at <a href="https://developer.cloudflare.com">https://developer.cloudflare.com</a>. On the right-hand side, the attacker demonstrates that a DNS query was received for the payload he sent to our server. However, the IP address flagged here is <code>173.194.95.134</code>, a member of a Google owned IPv4 subnet (<code>173.194.94.0/23</code>).</p>
	<p>Cloudflare’s developer documentation is hosted as a Cloudflare Worker and only serves static assets. The repository is <a href="https://github.com/cloudflare/cloudflare-docs">public</a>. The Worker relies on Google’s analytics library as seen <a href="https://github.com/cloudflare/cloudflare-docs/blob/production/developers.cloudflare.com/workers-site/index.js#L48">here</a>, therefore, we hypothesize that the attacker was not receiving a request from Cloudflare but through Google's servers.</p>
	<p>Our backend servers receive logging from Workers, but exploitation was also not possible in this instance as we leverage robust Kubernetes egress policies that prevent calling out to the Internet. The only communication allowed is to a curated set of internal services.</p>
	<p>When we received a similar report in our vulnerability disclosure program while gathering more information, the researcher was unable to reproduce the issue. This further enforced our hypothesis that it was third party servers, and they may have patched the issue.</p>
	<h3>Was Cloudflare compromised?</h3>
	<p>While we were running versions of the software as described above, thanks to our speed of response and defense in depth approach, we do not believe Cloudflare was compromised. We have invested significant efforts into validating this, and we will continue working on this effort until everything is known about this vulnerability. Here is a bit about that part of our efforts.</p>
	<p>As we were working to evaluate and isolate all the contexts in which the vulnerable software might be running and remediate them, we started a separate workstream to analyze whether any of those instances had been exploited. &nbsp;Our detection and response methodology follows industry standard Incident Response practices and was thoroughly deployed to validate whether any of our assets were indeed compromised. We followed a multi-pronged approach described next.</p>
	<h3>Reviewing Internal Data</h3>
	<p>Our asset inventory and code scanning tooling allowed us to identify all applications and services reliant on Apache Log4j. While these applications were being reviewed and upgraded if needed, we were performing a thorough scan of these services and hosts. Specifically, the exploit for CVE-2021-44228 relies on particular patterns in log messages and parameters, for example <code>\$\{jndi:(ldap[s]?|rmi|dns):/[^\n]+</code>. For each potentially impacted service, we performed a log analysis to expose any attempts at exploitation.</p>
	<h3>Reviewing Network Analytics</h3>
	<p>Our network analytics allow us to identify suspicious network behavior that may be indicative of attempted or actual exploitation of our infrastructure. We scrutinised our network data to identify the following:</p>
	<ol>
		<li>
			<p>Suspicious Inbound and Outbound ActivityBy analyzing suspicious inbound and outbound connections, we were able to sweep our environment and identify whether any of our systems were displaying signs of active compromise.</p>
		</li>
		<li>
			<p>Targeted Systems &amp; ServicesBy leveraging pattern analytics against our network data, we uncovered systems and services targeted by threat-actors. This allowed us to perform correlative searches against our asset inventory, and drill down to each host to determine if any of those machines were exposed to the vulnerability or actively exploited.</p>
		</li>
		<li>
			<p>Network IndicatorsFrom the aforementioned analysis, we gained insight into the infrastructure of various threat actors and identified network indicators being utilized in attempted exploitation of this vulnerability. Outbound activity to these indicators was blocked in Cloudflare Gateway.</p>
		</li>
	</ol>
	<h3>Reviewing endpoints</h3>
	<p>We were able to correlate our log analytics and network analytics workflows to supplement our endpoint analysis. From our findings from both of those analyses, we were able to craft endpoint scanning criteria to identify any additional potentially impacted systems and analyze individual endpoints for signs of active compromise. We utilized the following techniques:</p>
	<h5>Signature Based Scanning</h5>
	<p>We are in the process of deploying custom Yara detection rules to alert on exploitation of the vulnerability. These rules will be deployed in the Endpoint Detection and Response agent running on all of our infrastructure and our centralized Security Information and Events Management (SIEM) tool.</p>
	<h5>Anomalous Process Execution and Persistence Analysis</h5>
	<p>Cloudflare continuously collects and analyzes endpoint process events from our infrastructure. We used these events to search for post-exploitation techniques like download of second stage exploits, anomalous child processes, etc.</p>
	<p>Using all of these approaches, we have found no evidence of compromise.</p>
	<h3>Third-Party risk</h3>
	<p>In the analysis above, we focused on reviewing code and data we generate ourselves. But like most companies, we also rely on software that we have licensed from third parties. When we started our investigation into this matter, we also partnered with the company’s information technology team to pull together a list of each and every primary third-party provider and all sub-processors to inquire about whether they were affected. We’re in the process of receiving and reviewing responses from the providers. Any providers who we deem critical that are impacted by this vulnerability will be disabled and blocked until they are fully remediated.</p>
	<h3>Validation that our defense-in depth approach worked</h3>
	<p>As we responded to this incident, we found several places where our defense in depth approach worked.</p>
	<ol>
		<li>
			<p>Restricting outbound traffic</p>
		</li>
	</ol>
	<p>Restricting the ability to <i>call home</i> is an essential part of the <i>kill-chain</i> to make exploitation of vulnerabilities much harder. As noted above, we leverage Kubernetes network policies to restrict egress to the Internet on our deployments. In this context, it prevents the next-stage of the attack, and the network connection to attacker controlled resources is dropped.</p>
	<p>All of our externally facing services are protected by Cloudflare. The origin servers for these services are set up via authenticated origin pulls. This means that none of the servers are exposed directly to the Internet.</p>
	<p>2. &nbsp; Using Cloudflare to secure Cloudflare</p>
	<p>All of our internal services are protected by our Zero-trust product, Cloudflare Access. Therefore, once we had patched the limited <a href="https://www.cloudflare.com/learning/security/what-is-an-attack-surface">attack surface</a> we had identified, any exploit attempts to Cloudflare’s systems or customers leveraging Access would have required the attacker to authenticate.</p>
	<p>And because we have the Cloudflare WAF product deployed as part of our effort to secure Cloudflare using Cloudflare, we benefited from all the work being done to protect our customers. All new WAF rules written to protect against this vulnerability were updated with a default action of <code>BLOCK</code>. Like every other customer who has the WAF deployed, we are now receiving protection without any action required on our side.</p>
	<h2>Conclusion</h2>
	<p>While our response to this challenging situation continues, we hope that this outline of our efforts helps others. We are grateful for all the support we have received from within and outside of Cloudflare.</p>
	<p><i>Thank you to Evan Johnson, Anjum Ahuja, Sourov Zaman, David Haynes, and Jackie Keith who also contributed to this blog.</i></p>
</div>