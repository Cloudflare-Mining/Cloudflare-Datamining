<div class="mb2 gray5">7 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5lvkA4iYSwJOxeROzA6S5L/cbe3da846e88b2480bf40d7cd0426aa1/two-weeks-later-finding-and-eliminating-long-tail-latencies.png" alt="">
<div class="post-content lh-copy gray1">
	<p><i>This blog was published on 2 October, 2021. As we continue to optimize our network we're publishing regular updates, which are available </i><a href="https://blog.cloudflare.com/tag/network-performance-update"><i>here</i></a><i>.</i></p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2j8el9UlTTSiqyD4LBGxkr/7bf74ce742072fb057219733d5aa7999/image8-4.png" alt="Two Weeks Later: Finding and Eliminating Long Tail Latencies" class="kg-image" width="1800" height="1013" loading="lazy">

	</figure>
	<p>A little over two weeks ago, <a href="https://blog.cloudflare.com/benchmarking-edge-network-performance">we shared extensive benchmarking results</a> of edge networks all around the world. &nbsp;It showed that on a range of tests (TCP connection time, time to first byte, time to last byte), and on a range of measurements (p95, mean), that Cloudflare had some impressive network performance. But we weren't the fastest everywhere. So we made a commitment: <a href="https://blog.cloudflare.com/benchmarking-edge-network-performance">we would improve in at least 10%</a> of networks where we were not #1.</p>
	<p>Today, we’re happy to tell you that we’ve delivered as promised. Of the networks where our average latency exceeded 100ms behind the leading provider during Speed Week, we’ve dramatically improved our performance. There were 61 networks; now, we’re the fastest in 29 of them. Of course, we’re not done yet — but we wanted to share with you the latest results, and explain how we did it.</p>
	<div class="flex anchor relative">
		<h3 id="measuring-what-matters">Measuring What Matters</h3>
		<a href="https://blog.cloudflare.com/#measuring-what-matters" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>In the process of quantifying network performance, it became clear where we were not the fastest everywhere. There were 61 country/network pairs where we more than 100ms behind the leading provider:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2jiNczP9zuLey1Aa4pjtIC/94bce68aff9892ee7973d8262d122922/image3-4.png" alt="" class="kg-image" width="1530" height="936" loading="lazy">

	</figure>
	<p>Once that was done, the fun began: we needed to go through the process of figuring out <i>why</i> we were slow — and then improve. The challenges we faced were unique to each network and highlighted a variety of different issues that are prevalent on the Internet. We’re going to deep dive into a couple of networks, and show how we diagnosed and then improved performance.</p>
	<p>But before we do, here are the results of our efforts in the past two weeks: of the 61 networks where our performance was over 100ms behind the leader, we are now the #1 network in 29 of them.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/7z0tWvvIzmh1iRiOdcxlZY/b943cc6a30add5850a25fde2b3b72649/image2-5.png" alt="" class="kg-image" width="1530" height="940" loading="lazy">

	</figure>
	<p>And it’s not that we just focused on those 29 networks, either. We’ve dramatically improved our performance in almost all the networks where we were over 100ms behind the leader.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/67Ne7rTbMeVI2wY6LdmDLI/bd7d1f095c3462d4e9bbaa4554474a15/image7-1.png" alt="" class="kg-image" width="976" height="371" loading="lazy">

	</figure>
	<p>With the results out of the way, let’s share the story of chasing peak performance in three very different geographies — each with three very different sets of challenges. Before we begin: a lot of Cloudflare’s internal network performance is automatically tuned. However, by its very nature, the Internet is a network of networks — and that inherently relies on us talking to other network operators to maximize performance. That’s often what we had to do here.</p>
	<div class="flex anchor relative">
		<h3 id="rectifying-route-advertisement-in-brazil">Rectifying Route Advertisement in Brazil</h3>
		<a href="https://blog.cloudflare.com/#rectifying-route-advertisement-in-brazil" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>One particular network that was flagged for improvement during <a href="https://blog.cloudflare.com/benchmarking-edge-network-performance">Speed Week</a> stood out: we’ll refer to it as Network-A. This network was well known to our edge team (the team that looks after our network connectivity in <a href="https://www.cloudflare.com/network">Cloudflare data centers</a>) for frequently congesting the dedicated interconnection we have with the network in São Paulo. This type of dedicated connection is called a Private Network Interconnect (PNI), or private peering, and it helps Cloudflare talk to Network-A without any intermediaries using the <a href="https://www.cloudflare.com/learning/security/glossary/what-is-bgp">BGP</a> protocol.</p>
	<p>At a first look, we noticed that a significant chunk of traffic to Network-A was not using the PNI, but instead was being sent through one of our transit providers. A transit provider is an intermediary network that provides connectivity to the rest of the Internet.</p>
	<p>This is not uncommon. The most likely reason for this behavior is that at some point in the past traffic was shifted away from the PNI due to capacity issues mentioned earlier.</p>
	<p>We then started to take a more in-depth look at the path from this particular transit provider and identified that traffic was routed all the way to the USA before coming back to Brazil. The transit provider was exhibiting behavior known as tromboning: traffic from one location destined to a network in the same location travels vast distances only to be exchanged and then returns again. Tromboning typically occurs as a result of networks preferring paths that are farther away from the best possible path. This can happen due to peering preferences, BGP configurations, or the presence of direct interconnection farther away from end users. This explained the higher <a href="https://www.cloudflare.com/learning/performance/glossary/what-is-latency">latency</a> on this network we saw during Speed Week.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4E1eWRehe2YDxQ56OnIi6M/dd20b6a50c951670dd33bd1e4473c1ab/image9-1.png" alt="" class="kg-image" width="1836" height="1698" loading="lazy">

	</figure>
	<p>The next step we took was to look into alternatives to this transit connection. We have a nearby data center in Rio de Janeiro — where we also had a PNI with Network-A. Moreover, São Paulo and Rio de Janeiro are connected via our <a href="https://blog.cloudflare.com/cloudflare-backbone-internet-fast-lane">backbone</a> network. After making the necessary checks to ensure we had room to carry traffic towards Network-A through our backbone and out through the PNI in Rio, we proceeded to prepare the network configuration changes.</p>
	<p>We first started announcing Network-A IP addresses out of our backbone in Rio and then accepting them into São Paulo. We then ensured we preferred the path via our backbone over the PNI by changing the BGP behavior through the LOCAL_PREF path attribute. We then removed all the configuration specifying that transit provider as the preferred route for the previously identified traffic from Network-A.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5wA5qDrCMk3jp5kuEBTvcc/a838d53134e03808c820fff3bb4286e2/1EF832A7-05BF-4D6D-8828-A24EC4CBE445.png" alt="" class="kg-image" width="1598" height="1456" loading="lazy">

	</figure>
	<p>The result was as expected. Traffic moved away from the transit provider onto our backbone network. We confirmed we achieved a decrease in latency by monitoring our p95 TCP <a href="https://www.cloudflare.com/learning/cdn/glossary/round-trip-time-rtt">RTTs</a>, which went from 175ms to 90ms.</p>
	<p>We currently rank #1 with Network-A, moving up from #5 during Speed Week, as seen in the chart below.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5mgJnmGVrbvhJZ0NnEBHQF/d91d5d72f6ef373dd42c151f88d2939a/image6-3.png" alt="" class="kg-image" width="1542" height="940" loading="lazy">

	</figure>
	<div class="flex anchor relative">
		<h3 id="immaculate-ingress-in-spain">Immaculate Ingress in Spain</h3>
		<a href="https://blog.cloudflare.com/#immaculate-ingress-in-spain" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Another network that stood out was a European ISP with a global presence. We’ll refer to it as Network-B. Our RUM measurements showed that we were experiencing high latencies in several parts of the world, including Spain.</p>
	<p>The first thing we did was to check how we handled traffic from Spain for Network-B. Our data showed that we had several data centers outside the country which were serving users from Network-B: Milan in Italy and Marseille in France. This obviously raised a question: why is traffic not staying locally in Spain?</p>
	<p>The traffic was not staying local because Network-B had not peered with us in Madrid. If private peering describes a connection between exactly two networks using a dedicated circuit, public peering allows multiple networks to interconnect, if they wish so, at an <a href="https://www.cloudflare.com/learning/cdn/glossary/internet-exchange-point-ixp">Internet Exchange Point</a> (IXP) location using a shared infrastructure. We looked at our <a href="https://peering.cloudflare.com">Peering Portal</a> to identify any potential peering opportunities with Network-B and established peering sessions in various locations where we saw high latency, including Madrid.</p>
	<p>We looked at the traffic breakdown for these locations and identified the top destinations not being advertised in-country. We then checked whether our Spanish data centers were advertising these destinations and found that the corresponding anycast IP addresses were not enabled in Barcelona. We enabled the additional anycast IP addresses in Barcelona, and this change resulted in traffic for Network-B to be handled locally, which helped reduce latency.</p>
	<p>Since we were looking into public peering status with Network-B, we also noticed that they had turned off their public peering session with Cloudflare in Milan. Our logs showed that the session with Network-B was down because it thought Cloudflare was sending more IP prefixes than allowed. We contacted Network-B and advised them to update the configuration according to the data we publish in <a href="https://www.peeringdb.com/asn/13335">PeeringDB</a>. While it is a public peering session which comes with its own pros and cons, it still represents a more direct path than using a transit provider.</p>
	<p>These changes pushed us up from ranking #2 during Speed Week to #1, as shown by the graph below:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2G2dx8I8rTRD6iviYmZy2s/7e5257090d9052ee557f473bc9d6f747/image4-5.png" alt="" class="kg-image" width="1190" height="728" loading="lazy">

	</figure>
	<p>You may notice that going from #2 to #1 still means we have a latency of about 300ms. &nbsp;We want to ensure that every network has amazing performance, but we <a href="https://blog.cloudflare.com/last-mile-insights">can’t control all network providers</a> and how they connect with the rest of the Internet. We’re constantly working to ensure that end users see the best experience possible.</p>
	<div class="flex anchor relative">
		<h3 id="upstream-selection-in-africa">Upstream Selection in Africa</h3>
		<a href="https://blog.cloudflare.com/#upstream-selection-in-africa" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>We’ve previously discussed private peering and transit providers and how a direct connection is better than a transit connection which usually routes through intermediary networks. However, sometimes this might not be true. This was the case for a network in Africa, which we will call Network-C.</p>
	<p>As before, we started by looking at the locations from where we serve traffic to Network-C. This was mostly from our data centers in Western Europe. Looking at the parent <a href="https://www.cloudflare.com/learning/network-layer/what-is-an-autonomous-system">ASNs</a> for Network-C, we expected this outcome since we don’t peer with either of them anywhere in Africa.</p>
	<p>Let’s take our data center in London. There, we had a private peering connection with Parent-1 and a transit connection with Parent-2. We were receiving IP addresses belonging to Network-C from both parents, however we were only sending traffic to Parent-1 since that was our private peer.</p>
	<p>As Parent-2 also provided a direct path to Network-C and, moreover, they belonged to the same organization, we decided to test the latency via Parent-2. It is generally tricky to identify potential upstream bottlenecks especially for transit providers, as each network has its own internal mechanisms for routing. However, in this case we were directly connected.</p>
	<p>Once again, we modified the <a href="https://www.cloudflare.com/learning/security/glossary/what-is-bgp">BGP</a> behaviour. Let’s go into more detail this time. Our routing policies are configured differently depending on the type of network we peer with and the type of connection we use. Our policies configure the BGP LOCAL_PREF path attribute, which is the first decisive step in the selection of a path. In our case, Network-C prefixes from Parent-1 had a higher associated value than the same prefixes learned from Parent-2 and were thus chosen for routing. In order to steer traffic away from the private peer and towards the transit provider, we needed to adjust our transit policy to set a higher LOCAL_PREF value only for Network-C prefixes. We also had to use a regular expression to match the desired prefixes by filtering Network-C ASN in the AS-path in a way that would not affect traffic to the other networks from the transit provider.</p>
	<p>This change produced better results in terms of latency. We were #2 during Speed Week. We are now #1, as seen by this chart:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/41Llttys5yJZtpvroQMbFz/edd8088b968c11d3892f3027a477795a/image5-4.png" alt="" class="kg-image" width="1322" height="804" loading="lazy">

	</figure>
	<div class="flex anchor relative">
		<h3 id="update-on-speed-week">Update on Speed Week</h3>
		<a href="https://blog.cloudflare.com/#update-on-speed-week" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Two weeks ago, when <a href="https://blog.cloudflare.com/benchmarking-edge-network-performance">we first reported our measurements</a>, there were two charts that stuck out where Cloudflare was not #1 in terms of number of networks where we had the lowest connection time or TTLB.</p>
	<p>The first was the mean TCP connection time in the top 1,000 networks by number of IP addresses. Since then, we’ve been optimizing and have measured our performance again, and we’ve now moved into the #1 spot.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4N2FWAq1EzQlOAM5YoUghZ/c124997f5c802b3dee1bf9c1421874e0/image4-6.png" alt="" class="kg-image" width="1068" height="822" loading="lazy">

	</figure>
	<p>The other measurement where we were #2 was mean TTLB in the top 1,000 networks by IP count. We’ve moved into the #1 spot, but there’s still work to do. Which makes sense because the work we’ve been doing over the last two weeks optimized network performance and not our software platform. Hence, connection times got a lot better while TTLB improved less dramatically.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4y2K8NiG4zsWGkL6D26AX/19e35d4629c808e99d19504c5df5a7b8/image9-2.png" alt="" class="kg-image" width="1068" height="822" loading="lazy">

	</figure>
	<div class="flex anchor relative">
		<h3 id="getting-ever-faster">Getting ever faster</h3>
		<a href="https://blog.cloudflare.com/#getting-ever-faster" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Improving performance on the Internet is a long tail problem: each issue requires a different solution because every network is unique and covers different end users. As we continue to grow our network and interconnect with more of the world, it’s important that we constantly examine our performance to ensure that we’re the fastest.</p>
	<p>The efforts of our team have yielded great improvements for our customers, but we’re not just stopping because Speed Week and Birthday Week are over. We’re automating the discovery process of poor performance on networks like these, and are working hard to also automate the remediation processes in order to deliver more incredible performance for our customers.</p>
	<p>And we have two more innovation weeks coming in 2021. We’ll be back each week to report on further progress on optimizing our performance globally.</p>
</div>