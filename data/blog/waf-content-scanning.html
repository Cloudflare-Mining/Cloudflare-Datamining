<div class="mb2 gray5">5 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4p8KGbQlMPzJhFe7twEIVs/cbc3cda5cfd72793d0ad82c7bace8593/waf-content-scanning.png" alt="">
<div class="post-content lh-copy gray1">
	<p></p>
	<p>Let’s assume you manage a job advert site. On a daily basis job-seekers will be uploading their CVs, cover letters and other supplementary documents to your servers. What if someone tried to upload malware instead?</p>
	<p>Today we’re making your security team job easier by providing a file content scanning engine integrated with our <a href="https://www.cloudflare.com/waf">Web Application Firewall (WAF)</a>, so that malicious files being uploaded by end users get blocked before they reach application servers.</p>
	<p>Enter WAF Content Scanning.</p>
	<p>If you are an enterprise customer, reach out to your account team to get access.</p>
	<div class="flex anchor relative">
		<h2 id="making-content-scanning-easy">Making content scanning easy</h2>
		<a href="https://blog.cloudflare.com/#making-content-scanning-easy" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>At Cloudflare, we pride ourselves on making our products very easy to use. WAF Content Scanning was built with that goal in mind. The main requirement to use the Cloudflare WAF is that application traffic is proxying via the <a href="https://www.cloudflare.com/network">Cloudflare network</a>. Once that is done, <a href="https://developers.cloudflare.com/waf/about/content-scanning/#1-enable-waf-content-scanning">turning on Content Scanning requires a single API call</a>.</p>
	<p>Once on, the <a href="https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf">WAF</a> will automatically detect any content being uploaded, and when found, scan it and provide the results for you to use when writing WAF Custom Rules or reviewing security analytics dashboards.</p>
	<p>The entire process runs inline with your HTTP traffic and requires no change to your application.</p>
	<p>As of today, we scan files up to 1 MB. You can easily block files that exceed this size or perform other actions such as log the upload.</p>
	<p>To block a malicious file, you could write a simple WAF Custom Rule like the following:</p>
	<p>if: <code>(cf.waf.content_scan.has_malicious_obj)</code></p>
	<p>then: <code>BLOCK</code></p>
	<p>In the dashboard the rule would look like this:</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6daRCuMMjCfLuvANxoRSbS/51056b8e1ff80c7ae1788c98c62956bb/image4.png" alt="a WAF Custom Rule to block malicious file uploads" class="kg-image" width="1578" height="840" loading="lazy">

	</figure>
	<p>Many other use cases can be achieved by leveraging the metadata exposed by the WAF Content Scanning engine. For example, let’s say you only wanted to allow PDF files to be uploaded on a given endpoint. You would achieve this by deploying the following WAF Custom Rule:</p>
	<p>if: <code>any(cf.waf.content_scan.obj_types[*] != "application/pdf") and http.request.uri.path eq "/upload"</code></p>
	<p>then: <code>BLOCK</code></p>
	<p>This rule will, for any content file being uploaded to the /upload endpoint, block the HTTP request if at least one file is not a PDF.</p>
	<p>More generally, let’s assume your application does not expect content to be uploaded at all. In this case, you can block any upload attempts with:</p>
	<p>if: <code>(cf.waf.content_scan.has_obj)</code></p>
	<p>then: <code>BLOCK</code></p>
	<p>Another very common use case is supporting file upload endpoints that accept JSON content. In this instance files are normally embedded into a JSON payload after being base64-encoded. If your application has such an endpoint, you can provide additional metadata to the scanning engine to recognise the traffic by submitting a <a href="https://developers.cloudflare.com/waf/about/content-scanning/#custom-scan-expressions">custom scan expression</a>. Once submitted, files within JSON payloads will be parsed, decoded, and scanned automatically. In the event you want to issue a block action, you can use a <a href="https://developers.cloudflare.com/waf/custom-rules/create-dashboard/#configuring-a-custom-response-for-blocked-requests">JSON custom response type</a> so that your web application front end can easily parse and display error messages:</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6lLy5oO6L0sSZuMpRwpYqf/3579d013c6073b33fe91eab44e3ad26d/image1.png" alt="a WAF Custom Rule to block malicious file uploads on JSON endpoints" class="kg-image" width="1662" height="1072" loading="lazy">

	</figure>
	<p>The full list of fields exposed by the WAF Content Scanning engine can be found on our <a href="https://developers.cloudflare.com/waf/about/content-scanning">developer documentation</a>.</p>
	<div class="flex anchor relative">
		<h2 id="the-engine">The engine</h2>
		<a href="https://blog.cloudflare.com/#the-engine" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>

	<div class="flex anchor relative">
		<h3 id="scanned-content-objects">Scanned content objects</h3>
		<a href="https://blog.cloudflare.com/#scanned-content-objects" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>A lot of time designing the system was spent defining what should be scanned. Defining this properly helps us ensure that we are not scanning unnecessary content reducing latency impact and CPU usage, and that there are no bypasses making the system complementary to existing WAF functionality.</p>
	<p>The complexity stems from the fact that there is no clear definition of a “file” in HTTP terms. That’s why in this blog post and in the system design, we refer to “content object” instead.</p>
	<p>At a high level, although this can loosely be defined as a “file”, not all “content objects” may end up being stored in the file system of an application server! Therefore, we need a definition that applies to HTTP. Additional complexity is given by the fact this is a security product, and attackers will always try to abuse HTTP to obfuscate/hide true intentions. So for example, although a <code>Content-Type</code> header may indicate that the request body is a <code>jpeg</code> image, it may actually be a <code>pdf</code>.</p>
	<p>With the above in mind, a “content object” as of today, is any request payload that is detected by heuristics (so no referring to the <code>Content-Type</code> header) to be anything that is <b>not</b> <code>text/html</code>, <code>text/x-shellscript</code>, <code>application/json</code> or <code>text/xml</code>. All other content types are considered a content object.</p>
	<p>Detecting via heuristics the content type of an HTTP request body is not enough, as content objects might be found within portions of the HTTP body or encoded following certain rules, such as when using <code>multipart/form-data</code>, which is the most common encoding used when creating standard HTML file input forms.</p>
	<p>So when certain payload formats are found, additional parsing applies. As of today the engine will automatically parse and perform content type heuristics on individual components of the payload, when the payload is either encoded using <code>multipart/form-data</code> or <code>multipart/mixed</code> or a <code>JSON</code> string that may have “content objects” embedded in base64 format <a href="https://developers.cloudflare.com/waf/about/content-scanning/#2-optional-configure-a-custom-scan-expression">as defined by the customer</a></p>
	<p>In these cases, we don’t scan the entire payload as a single content object, but we parse it following the relevant standard and apply scanning, if necessary, to the individual portions of the payload. That allows us to support scanning of more than one content object per request, such as an HTML form that has multiple file inputs. We plan to add additional automatic detections in the future on complex payloads moving forward.</p>
	<p>In the event we end up finding a malicious match, but we were not able to detect the content type correctly, we will default to reporting a content type of <code>application/octet-stream</code> in the Cloudflare logs/dashboards.</p>
	<p>Finally, it is worth noting that we explicitly avoid scanning anything that is plain text (HTML, JSON, XML etc.) as finding attack vectors in these payloads is already covered by the WAF, <a href="https://www.cloudflare.com/application-services/products/api-gateway">API Gateway</a> and other <a href="https://www.cloudflare.com/application-services/solutions">web application security solutions</a> already present in Cloudflare’s portfolio.</p>
	<div class="flex anchor relative">
		<h3 id="local-scans">Local scans</h3>
		<a href="https://blog.cloudflare.com/#local-scans" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>At Cloudflare, we try to leverage our horizontal architecture to build scalable software. This means the underlying scanner is deployed on every server that handles customer HTTP/S traffic. The diagram below describes the setup:</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/249nbQXwboFqmUXV7jTmph/06851ef35672f016e1ab600c3f39cd74/image5.png" alt="Diagram showing content scanning blocking malicious file upload before it reaches customer origin." class="kg-image" width="1999" height="870" loading="lazy">

	</figure>
	<p>Having each server perform the scanning locally helps ensure latency impact is reduced to a minimum to applicable HTTP requests. The actual scanning engine is the same one used by the <a href="https://www.cloudflare.com/products/zero-trust/gateway">Cloudflare Web Gateway</a>, our forward proxy solution that among many other things, helps keep end user devices safe by blocking attempts to download malware.</p>
	<p>Consequently, the scanning capabilities provided match <a href="https://developers.cloudflare.com/cloudflare-one/policies/filtering/http-policies/antivirus-scanning">those exposed by the Web Gateway AV scanning</a>. The main difference as of today, is the maximum file size currently limited at 1 MB versus 15 MB in Web Gateway. We are working on increasing this to match the Web Gateway in the coming months.</p>
	<div class="flex anchor relative">
		<h2 id="separating-detection-from-mitigation">Separating detection from mitigation</h2>
		<a href="https://blog.cloudflare.com/#separating-detection-from-mitigation" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>A new approach that we are adopting within our application security portfolio is the separation of detection from mitigation. The WAF Content Scanning features follow this approach, as once turned on, it simply enhances all available data and fields with scan results. The benefits here are twofold.</p>
	<p>First, this allows us to provide visibility into your application traffic, without you having to deploy any mitigation. This automatically opens up a great use case: discovery. For large enterprise applications security teams may not be aware of which paths or endpoints might be expecting file uploads from the Internet. Using our WAF Content Scanning feature in conjunction with our <a href="https://blog.cloudflare.com/security-analytics">new Security Analytics</a> they can now filter on request traffic that has a file content object (a file being uploaded) to observe top N paths and hostnames, exposing such endpoints.</p>
	<figure class="kg-card kg-image-card kg-width-wide">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/71OBMDvqbIhOdBnuROxNiu/5d74a14b6b2d9244f78d549cce2951da/image2.png" alt="File upload attempts to the Cloudflare blog by filtering on scanned object count greater than zero using the new Security Analytics." class="kg-image" width="1999" height="767" loading="lazy">

	</figure>
	<p>Second, as mentioned in the prior section, exposing the intelligence provided by Cloudflare as fields that can be used in our WAF Custom Rules allows us to provide a very flexible platform. As a plus, you don’t need to learn how to use a new feature, as you are likely already familiar with our WAF Custom Rule builder.</p>
	<p>This is not a novel idea, and our <a href="https://www.cloudflare.com/products/bot-management">Bot Management</a> solution was the first to trial it with great success. Any customer who uses Bot Management today gains access to a bot score field that indicates the likelihood of a request coming from automation or a human. Customers use this field to deploy rules that block bots.</p>
	<p>To that point, let’s assume you run a job applications site, and you do not wish for bots and crawlers to automatically submit job applications. You can now block file uploads coming from bots!</p>
	<p>if: <code>(cf.bot_management.score lt 10 and cf.waf.content_scan.has_obj)</code></p>
	<p>then: <code>BLOCK</code></p>
	<p>And that’s the power we wish to provide at your fingertips.</p>
	<div class="flex anchor relative">
		<h2 id="next-steps">Next steps</h2>
		<a href="https://blog.cloudflare.com/#next-steps" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Our WAF Content Scanning is a new feature, and we have several improvements planned, including increasing the max content size scanned, exposing the “rewrite” action, so you can send malicious files to a quarantine server, and exposing better analytics that allow you to explore the data more easily without deploying rules. Stay tuned!</p>
</div>