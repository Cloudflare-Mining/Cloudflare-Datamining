{
	"locale": "en-us",
	"localesAvailable": [],
	"post": {
		"authors": [
			{
				"name": "Michael Tremante",
				"slug": "michael-tremante",
				"bio": null,
				"profile_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/61VxyepuDMgPc2YC1SLjzq/9c78b998d374520b5ed7435b88659dc6/michael-tremante.jpg",
				"location": null,
				"website": null,
				"twitter": "@MichaelTremante",
				"facebook": null
			}
		],
		"excerpt": "Today, we’re making the job of application security teams easier, by providing a content scanning engine integrated with our Web Application Firewall (WAF), so that malicious files being uploaded by end users, never reach origin servers in the first place",
		"feature_image": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/4p8KGbQlMPzJhFe7twEIVs/d87a9ed9dd333244f842db9fcdeb6e47/waf-content-scanning.png",
		"featured": false,
		"html": "\n            <figure class=\"kg-card kg-image-card \">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/2UtLHKRNQe1iJlf68d8cTk/84d698e42dc7195f260439039bbfca58/image3-2.png\" alt=\"How Cloudflare can help stop malware before it reaches your app\" class=\"kg-image\" width=\"1800\" height=\"1013\" loading=\"lazy\"/>\n            \n            </figure><p>Let’s assume you manage a job advert site. On a daily basis job-seekers will be uploading their CVs, cover letters and other supplementary documents to your servers. What if someone tried to upload malware instead?</p><p>Today we’re making your security team job easier by providing a file content scanning engine integrated with our <a href=\"https://www.cloudflare.com/waf/\">Web Application Firewall (WAF)</a>, so that malicious files being uploaded by end users get blocked before they reach application servers.</p><p>Enter WAF Content Scanning.</p><p>If you are an enterprise customer, reach out to your account team to get access.</p><h2>Making content scanning easy</h2><p>At Cloudflare, we pride ourselves on making our products very easy to use. WAF Content Scanning was built with that goal in mind. The main requirement to use the Cloudflare WAF is that application traffic is proxying via the <a href=\"https://www.cloudflare.com/network/\">Cloudflare network</a>. Once that is done, <a href=\"https://developers.cloudflare.com/waf/about/content-scanning/#1-enable-waf-content-scanning\">turning on Content Scanning requires a single API call</a>.</p><p>Once on, the <a href=\"https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf/\">WAF</a> will automatically detect any content being uploaded, and when found, scan it and provide the results for you to use when writing WAF Custom Rules or reviewing security analytics dashboards.</p><p>The entire process runs inline with your HTTP traffic and requires no change to your application.</p><p>As of today, we scan files up to 1 MB. You can easily block files that exceed this size or perform other actions such as log the upload.</p><p>To block a malicious file, you could write a simple WAF Custom Rule like the following:</p><p>if: <code>(cf.waf.content_scan.has_malicious_obj)</code></p><p>then: <code>BLOCK</code></p><p>In the dashboard the rule would look like this:</p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/6daRCuMMjCfLuvANxoRSbS/2392b3281c41093cfb6c07303395ac6b/image4.png\" alt=\"a WAF Custom Rule to block malicious file uploads\" class=\"kg-image\" width=\"1578\" height=\"840\" loading=\"lazy\"/>\n            \n            </figure><p>Many other use cases can be achieved by leveraging the metadata exposed by the WAF Content Scanning engine. For example, let’s say you only wanted to allow PDF files to be uploaded on a given endpoint. You would achieve this by deploying the following WAF Custom Rule:</p><p>if: <code>any(cf.waf.content_scan.obj_types[*] != &quot;application/pdf&quot;) and http.request.uri.path eq &quot;/upload&quot;</code></p><p>then: <code>BLOCK</code></p><p>This rule will, for any content file being uploaded to the /upload endpoint, block the HTTP request if at least one file is not a PDF.</p><p>More generally, let’s assume your application does not expect content to be uploaded at all. In this case, you can block any upload attempts with:</p><p>if: <code>(cf.waf.content_scan.has_obj)</code></p><p>then: <code>BLOCK</code></p><p>Another very common use case is supporting file upload endpoints that accept JSON content. In this instance files are normally embedded into a JSON payload after being base64-encoded. If your application has such an endpoint, you can provide additional metadata to the scanning engine to recognise the traffic by submitting a <a href=\"https://developers.cloudflare.com/waf/about/content-scanning/#custom-scan-expressions\">custom scan expression</a>. Once submitted, files within JSON payloads will be parsed, decoded, and scanned automatically. In the event you want to issue a block action, you can use a <a href=\"https://developers.cloudflare.com/waf/custom-rules/create-dashboard/#configuring-a-custom-response-for-blocked-requests\">JSON custom response type</a> so that your web application front end can easily parse and display error messages:</p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/6lLy5oO6L0sSZuMpRwpYqf/5dd186d4063322ff514ab7a6c6324e66/image1.png\" alt=\"a WAF Custom Rule to block malicious file uploads on JSON endpoints\" class=\"kg-image\" width=\"1662\" height=\"1072\" loading=\"lazy\"/>\n            \n            </figure><p>The full list of fields exposed by the WAF Content Scanning engine can be found on our <a href=\"https://developers.cloudflare.com/waf/about/content-scanning/\">developer documentation</a>.</p><h2>The engine</h2><h3>Scanned content objects</h3><p>A lot of time designing the system was spent defining what should be scanned. Defining this properly helps us ensure that we are not scanning unnecessary content reducing latency impact and CPU usage, and that there are no bypasses making the system complementary to existing WAF functionality.</p><p>The complexity stems from the fact that there is no clear definition of a “file” in HTTP terms. That’s why in this blog post and in the system design, we refer to “content object” instead.</p><p>At a high level, although this can loosely be defined as a “file”, not all “content objects” may end up being stored in the file system of an application server! Therefore, we need a definition that applies to HTTP. Additional complexity is given by the fact this is a security product, and attackers will always try to abuse HTTP to obfuscate/hide true intentions. So for example, although a <code>Content-Type</code> header may indicate that the request body is a <code>jpeg</code> image, it may actually be a <code>pdf</code>.</p><p>With the above in mind, a “content object” as of today, is any request payload that is detected by heuristics (so no referring to the <code>Content-Type</code> header) to be anything that is <b>not</b> <code>text/html</code>, <code>text/x-shellscript</code>, <code>application/json</code> or <code>text/xml</code>. All other content types are considered a content object.</p><p>Detecting via heuristics the content type of an HTTP request body is not enough, as content objects might be found within portions of the HTTP body or encoded following certain rules, such as when using <code>multipart/form-data</code>, which is the most common encoding used when creating standard HTML file input forms.</p><p>So when certain payload formats are found, additional parsing applies. As of today the engine will automatically parse and perform content type heuristics on individual components of the payload, when the payload is either encoded using <code>multipart/form-data</code> or <code>multipart/mixed</code> or a <code>JSON</code> string that may have “content objects” embedded in base64 format <a href=\"https://developers.cloudflare.com/waf/about/content-scanning/#2-optional-configure-a-custom-scan-expression\">as defined by the customer</a></p><p>In these cases, we don’t scan the entire payload as a single content object, but we parse it following the relevant standard and apply scanning, if necessary, to the individual portions of the payload. That allows us to support scanning of more than one content object per request, such as an HTML form that has multiple file inputs. We plan to add additional automatic detections in the future on complex payloads moving forward.</p><p>In the event we end up finding a malicious match, but we were not able to detect the content type correctly, we will default to reporting a content type of <code>application/octet-stream</code> in the Cloudflare logs/dashboards.</p><p>Finally, it is worth noting that we explicitly avoid scanning anything that is plain text (HTML, JSON, XML etc.) as finding attack vectors in these payloads is already covered by the WAF, <a href=\"https://www.cloudflare.com/application-services/products/api-gateway/\">API Gateway</a> and other <a href=\"https://www.cloudflare.com/application-services/solutions/\">web application security solutions</a> already present in Cloudflare’s portfolio.</p><h3>Local scans</h3><p>At Cloudflare, we try to leverage our horizontal architecture to build scalable software. This means the underlying scanner is deployed on every server that handles customer HTTP/S traffic. The diagram below describes the setup:</p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/249nbQXwboFqmUXV7jTmph/f1c1e587d4371f1b8f73953ddc392ed1/image5.png\" alt=\"Diagram showing content scanning blocking malicious file upload before it reaches customer origin.\" class=\"kg-image\" width=\"1999\" height=\"870\" loading=\"lazy\"/>\n            \n            </figure><p>Having each server perform the scanning locally helps ensure latency impact is reduced to a minimum to applicable HTTP requests. The actual scanning engine is the same one used by the <a href=\"https://www.cloudflare.com/products/zero-trust/gateway/\">Cloudflare Web Gateway</a>, our forward proxy solution that among many other things, helps keep end user devices safe by blocking attempts to download malware.</p><p>Consequently, the scanning capabilities provided match <a href=\"https://developers.cloudflare.com/cloudflare-one/policies/filtering/http-policies/antivirus-scanning/\">those exposed by the Web Gateway AV scanning</a>. The main difference as of today, is the maximum file size currently limited at 1 MB versus 15 MB in Web Gateway. We are working on increasing this to match the Web Gateway in the coming months.</p><h2>Separating detection from mitigation</h2><p>A new approach that we are adopting within our application security portfolio is the separation of detection from mitigation. The WAF Content Scanning features follow this approach, as once turned on, it simply enhances all available data and fields with scan results. The benefits here are twofold.</p><p>First, this allows us to provide visibility into your application traffic, without you having to deploy any mitigation. This automatically opens up a great use case: discovery. For large enterprise applications security teams may not be aware of which paths or endpoints might be expecting file uploads from the Internet. Using our WAF Content Scanning feature in conjunction with our <a href=\"/security-analytics/\">new Security Analytics</a> they can now filter on request traffic that has a file content object (a file being uploaded) to observe top N paths and hostnames, exposing such endpoints.</p>\n            <figure class=\"kg-card kg-image-card kg-width-wide\">\n            \n            <Image src=\"https://cf-assets.www.cloudflare.com/slt3lc6tev37/71OBMDvqbIhOdBnuROxNiu/11db621da4dd1a0086c85ce5f84a0fc2/image2.png\" alt=\"File upload attempts to the Cloudflare blog by filtering on scanned object count greater than zero using the new Security Analytics.\" class=\"kg-image\" width=\"1999\" height=\"767\" loading=\"lazy\"/>\n            \n            </figure><p>Second, as mentioned in the prior section, exposing the intelligence provided by Cloudflare as fields that can be used in our WAF Custom Rules allows us to provide a very flexible platform. As a plus, you don’t need to learn how to use a new feature, as you are likely already familiar with our WAF Custom Rule builder.</p><p>This is not a novel idea, and our <a href=\"https://www.cloudflare.com/products/bot-management/\">Bot Management</a> solution was the first to trial it with great success. Any customer who uses Bot Management today gains access to a bot score field that indicates the likelihood of a request coming from automation or a human. Customers use this field to deploy rules that block bots.</p><p>To that point, let’s assume you run a job applications site, and you do not wish for bots and crawlers to automatically submit job applications. You can now block file uploads coming from bots!</p><p>if: <code>(cf.bot_management.score lt 10 and cf.waf.content_scan.has_obj)</code></p><p>then: <code>BLOCK</code></p><p>And that’s the power we wish to provide at your fingertips.</p><h2>Next steps</h2><p>Our WAF Content Scanning is a new feature, and we have several improvements planned, including increasing the max content size scanned, exposing the “rewrite” action, so you can send malicious files to a quarantine server, and exposing better analytics that allow you to explore the data more easily without deploying rules. Stay tuned!</p>",
		"id": "5ro1lRPNQcKSIEar34o4fM",
		"localeList": {
			"name": "How Cloudflare can help stop malware before it reaches your app Config",
			"enUS": "English for Locale",
			"zhCN": "No Page for Locale",
			"zhHansCN": "No Page for Locale",
			"zhTW": "No Page for Locale",
			"frFR": "No Page for Locale",
			"deDE": "No Page for Locale",
			"itIT": "No Page for Locale",
			"jaJP": "No Page for Locale",
			"koKR": "No Page for Locale",
			"ptBR": "No Page for Locale",
			"esLA": "No Page for Locale",
			"esES": "No Page for Locale",
			"enAU": "No Page for Locale",
			"enCA": "No Page for Locale",
			"enIN": "No Page for Locale",
			"enGB": "No Page for Locale",
			"idID": "No Page for Locale",
			"ruRU": "No Page for Locale",
			"svSE": "No Page for Locale",
			"viVN": "No Page for Locale",
			"plPL": "No Page for Locale",
			"arAR": "No Page for Locale",
			"nlNL": "No Page for Locale",
			"thTH": "No Page for Locale",
			"trTR": "No Page for Locale",
			"heIL": "No Page for Locale",
			"lvLV": "No Page for Locale",
			"etEE": "No Page for Locale",
			"ltLT": "No Page for Locale"
		},
		"meta_description": "Today, we’re making the job of application security teams easier, by providing a content scanning engine integrated with our Web Application Firewall (WAF), so that malicious files being uploaded by end users, never reach origin servers in the first place.",
		"metadata": {
			"title": "How Cloudflare can help stop malware before it reaches your app",
			"description": "Today, we’re making the job of application security teams easier, by providing a content scanning engine integrated with our Web Application Firewall (WAF), so that malicious files being uploaded by end users, never reach origin servers in the first place.",
			"imgPreview": "https://cf-assets.www.cloudflare.com/slt3lc6tev37/5eLjBfssJxVxr0ZxeTDiHC/0a4d0998904032d85c9e83a7963741ef/waf-content-scanning-j3rT4t.png"
		},
		"primary_author": {},
		"published_at": "2023-01-04T14:00:00.000+00:00",
		"reading_time": 6,
		"slug": "waf-content-scanning",
		"tags": [
			{
				"id": "lGCLqAT2SMojMzw5b6aio",
				"name": "WAF",
				"slug": "waf"
			},
			{
				"id": "6Mp7ouACN2rT3YjL1xaXJx",
				"name": "Security",
				"slug": "security"
			},
			{
				"id": "7xwk62YQcfV6Yatpt6Kyo4",
				"name": "Malware",
				"slug": "malware"
			}
		],
		"title": "How Cloudflare can help stop malware before it reaches your app",
		"updated_at": "2024-08-27T01:19:01.843Z",
		"url": "https://blog.cloudflare.com/waf-content-scanning"
	},
	"translations": {
		"posts.by": "By",
		"footer.gdpr": "GDPR",
		"lang_blurb1": "This post is also available in {lang1}.",
		"lang_blurb2": "This post is also available in {lang1} and {lang2}.",
		"lang_blurb3": "This post is also available in {lang1}, {lang2} and {lang3}.",
		"footer.blurb": "Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.",
		"footer.press": "Press",
		"header.title": "The Cloudflare Blog",
		"footer.careers": "Careers",
		"footer.company": "Company",
		"footer.support": "Support",
		"footer.the_net": "theNet",
		"footer.our_team": "Our team",
		"footer.webinars": "Webinars",
		"page.more_posts": "More posts",
		"posts.time_read": "{time} min read",
		"footer.community": "Community",
		"footer.resources": "Resources",
		"footer.solutions": "Solutions",
		"footer.trademark": "Trademark",
		"header.subscribe": "Subscribe",
		"footer.compliance": "Compliance",
		"footer.free_plans": "Free plans",
		"footer.impact_ESG": "Impact/ESG",
		"posts.follow_on_X": "Follow on X",
		"footer.help_center": "Help center",
		"footer.network_map": "Network Map",
		"header.please_wait": "Please Wait",
		"page.related_posts": "Related posts",
		"footer.case_studies": "Case Studies",
		"footer.connect_2024": "Connect 2024",
		"footer.terms_of_use": "Terms of Use",
		"footer.white_papers": "White Papers",
		"footer.cloudflare_tv": "Cloudflare TV",
		"footer.community_hub": "Community Hub",
		"footer.compare_plans": "Compare plans",
		"footer.contact_sales": "Contact Sales",
		"header.contact_sales": "Contact Sales",
		"header.email_address": "Email Address",
		"page.error.not_found": "Page not found",
		"footer.developer_docs": "Developer docs",
		"footer.privacy_policy": "Privacy Policy",
		"footer.request_a_demo": "Request a demo",
		"page.continue_reading": "Continue reading",
		"footer.analysts_report": "Analyst reports",
		"footer.for_enterprises": "For enterprises",
		"footer.getting_started": "Getting Started",
		"footer.learning_center": "Learning Center",
		"footer.project_galileo": "Project Galileo",
		"pagination.newer_posts": "Newer Posts",
		"pagination.older_posts": "Older Posts",
		"posts.social_buttons.x": "Discuss on X",
		"footer.about_cloudflare": "About Cloudflare",
		"footer.athenian_project": "Athenian Project",
		"footer.become_a_partner": "Become a partner",
		"footer.cloudflare_radar": "Cloudflare Radar",
		"footer.network_services": "Network services",
		"footer.trust_and_safety": "Trust & Safety",
		"header.get_started_free": "Get Started Free",
		"page.search.placeholder": "Search Cloudflare",
		"footer.cloudflare_status": "Cloudflare Status",
		"footer.cookie_preference": "Cookie Preferences",
		"header.valid_email_error": "Must be valid email.",
		"footer.connectivity_cloud": "Connectivity cloud",
		"footer.developer_services": "Developer services",
		"footer.investor_relations": "Investor relations",
		"page.not_found.error_code": "Error Code: 404",
		"footer.logos_and_press_kit": "Logos & press kit",
		"footer.application_services": "Application services",
		"footer.get_a_recommendation": "Get a recommendation",
		"posts.social_buttons.reddit": "Discuss on Reddit",
		"footer.sse_and_sase_services": "SSE and SASE services",
		"page.not_found.outdated_link": "You may have used an outdated link, or you may have typed the address incorrectly.",
		"footer.report_security_issues": "Report Security Issues",
		"page.error.error_message_page": "Sorry, we can't find the page you are looking for.",
		"header.subscribe_notifications": "Subscribe to receive notifications of new posts:",
		"footer.cloudflare_for_campaigns": "Cloudflare for Campaigns",
		"header.subscription_confimation": "Subscription confirmed. Thank you for subscribing!",
		"posts.social_buttons.hackernews": "Discuss on Hacker News",
		"footer.diversity_equity_inclusion": "Diversity, equity & inclusion",
		"footer.critical_infrastructure_defense_project": "Critical Infrastructure Defense Project"
	}
}